<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JAM Chat Module</title>
    <style>
        /* Chat Container Styles */
        .Bot-chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 20px;
        }

        .Bot-chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .Bot-chat-input-container {
            display: flex;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 24px;
            padding: 10px 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .Bot-chat-input {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            font-family: inherit;
            font-size: 1rem;
            resize: none;
            max-height: 100px;
            min-height: 24px;
            padding: 0;
        }

        .Bot-chat-send {
            background: #09ccfc;
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: 10px;
            flex-shrink: 0;
        }

        .Bot-chat-send:hover {
            background: #07a3ca;
        }

        .Bot-chat-send:disabled {
            background: #e9ecef;
            color: #adb5bd;
            cursor: not-allowed;
        }

        /* Message Styles */
        .Bot-message {
            display: flex;
            margin-bottom: 15px;
        }

        .Bot-user-message {
            justify-content: flex-end;
        }

        .Bot-bot-message {
            align-items: flex-start;
        }

        .Bot-message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e6f9ff;
            color: #09ccfc;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .Bot-user-message .Bot-message-avatar {
            background: #09ccfc;
            color: white;
            margin-left: 15px;
            margin-right: 0;
            order: 2;
        }

        .Bot-message-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 18px;
            max-width: 80%;
        }

        .Bot-bot-message .Bot-message-content {
            background: #e6f9ff;
            border-top-left-radius: 4px;
        }

        .Bot-user-message .Bot-message-content {
            background: #09ccfc;
            color: white;
            border-top-right-radius: 4px;
        }

        .Bot-message-typing {
            display: flex;
            align-items: center;
            padding: 10px 15px;
        }

        .Bot-typing-indicator {
            display: flex;
            align-items: center;
        }

        .Bot-typing-dot {
            width: 8px;
            height: 8px;
            background: #adb5bd;
            border-radius: 50%;
            margin: 0 2px;
            animation: typing-animation 1.5s infinite ease-in-out;
        }

        .Bot-typing-dot:nth-child(1) {
            animation-delay: 0s;
        }

        .Bot-typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .Bot-typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing-animation {

            0%,
            60%,
            100% {
                transform: translateY(0);
            }

            30% {
                transform: translateY(-5px);
            }
        }

        /* Message Button Styles */
        .Bot-message-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .Bot-message-button {
            background: #ffffff;
            border: 1px solid #09ccfc;
            color: #09ccfc;
            border-radius: 18px;
            padding: 8px 16px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .Bot-message-button:hover {
            background: #e6f9ff;
        }

        .Bot-message-button:active {
            background: #09ccfc;
            color: white;
        }

        /* Form Styles */
        .Bot-form-container {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .Bot-dispute-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .Bot-form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .Bot-form-group label {
            font-weight: bold;
            font-size: 14px;
        }

        .Bot-form-group input,
        .Bot-form-group textarea {
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        .Bot-form-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 10px;
        }

        .Bot-form-submit {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: bold;
        }

        .Bot-form-submit:hover {
            background-color: #0069d9;
        }

        .Bot-form-error {
            color: #dc3545;
            font-size: 14px;
            margin-top: 8px;
        }

        /* Add this CSS for the category filter */
        .category-filter {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .category-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .category-btn {
            padding: 8px 16px;
            border: 1px solid #007bff;
            background-color: white;
            color: #007bff;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .category-btn:hover {
            background-color: #007bff;
            color: white;
        }

        .category-btn.active {
            background-color: #007bff;
            color: white;
        }

        .category-btn.all {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
        }

        .dispute-items-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background-color: white;
        }

        .dispute-item {
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            background-color: #f8f9fa;
        }

        .dispute-item h5 {
            margin: 0 0 8px 0;
            color: #495057;
            font-size: 16px;
        }

        .dispute-item .creditor {
            font-weight: bold;
            color: #007bff;
        }

        .dispute-item .issue-type {
            color: #dc3545;
            font-weight: 500;
        }

        .dispute-item .confidence {
            float: right;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .confidence.high {
            background-color: #dc3545;
            color: white;
        }

        .confidence.medium {
            background-color: #ffc107;
            color: black;
        }

        .confidence.low {
            background-color: #28a745;
            color: white;
        }

        .item-count {
            font-size: 14px;
            color: #6c757d;
            margin-left: 10px;
        }
    </style>
</head>

<body>
    <script>
        // Add this debugging system at the top of your ChatModule.html script section
        const DEBUG_ENABLED = true;
        const functionCallStack = [];
        let debugCounter = 0;

        function debugLog(functionName, action = 'CALLED', data = null) {
            if (!DEBUG_ENABLED) return;

            debugCounter++;
            const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
            const logEntry = {
                counter: debugCounter,
                timestamp: timestamp,
                function: functionName,
                action: action,
                data: data
            };

            functionCallStack.push(logEntry);

            // Console log with clear formatting
            console.log(`🔍 [${debugCounter}] ${timestamp} - ${functionName} ${action}`, data ? data : '');

            // Keep only last 50 entries to prevent memory issues
            if (functionCallStack.length > 50) {
                functionCallStack.shift();
            }
        }

        function showDebugSummary() {
            console.log('=== FUNCTION CALL SUMMARY ===');
            functionCallStack.forEach(entry => {
                console.log(`${entry.counter}. ${entry.timestamp} - ${entry.function} ${entry.action}`);
            });
        }

        // Now add debugging to all your key functions:

        // 1. Add to handleButtonClick
        function handleButtonClick(value, container) {
            debugLog('handleButtonClick', 'STARTED', { value: value });

            console.log('Button clicked:', value);

            // Your existing code...

            debugLog('handleButtonClick', 'COMPLETED');
        }

        // 2. Add to sendReportsForAnalysis
        async function sendReportsForAnalysis(reportFiles) {
            debugLog('sendReportsForAnalysis', 'STARTED', { fileCount: reportFiles.length });

            console.log('=== SEND REPORTS FOR ANALYSIS DEBUG ===');
            console.log('Files to analyze:', reportFiles.length);

            try {
                // Your existing code...

                debugLog('sendReportsForAnalysis', 'SUCCESS', { extractedItemsCount: data.extractedItems?.length });
                return data.analysis || data.summary || 'Analysis completed successfully';

            } catch (error) {
                debugLog('sendReportsForAnalysis', 'ERROR', { error: error.message });
                throw error;
            }
        }

        // 3. Add to handleStartDispute
        function handleStartDispute() {
            debugLog('handleStartDispute', 'STARTED');

            console.log('=== HANDLE START DISPUTE DEBUG ===');
            console.log('User clicked to start dispute process');

            // Your existing code...

            if (!analysisData || !analysisData.extractedItems || analysisData.extractedItems.length === 0) {
                debugLog('handleStartDispute', 'NO_DATA_FOUND');
                addMessage("I couldn't find any analysis data. Please analyze your reports first before starting the dispute process.", 'bot');
                return;
            }

            debugLog('handleStartDispute', 'CALLING_DISPLAY_INTERFACE', { itemCount: analysisData.extractedItems.length });
            displayCategoryFilterInterface(analysisData);

            debugLog('handleStartDispute', 'COMPLETED');
        }

        // 4. Add to displayCategoryFilterInterface
        function displayCategoryFilterInterface(analysisData) {
            debugLog('displayCategoryFilterInterface', 'STARTED', {
                hasData: !!analysisData,
                itemCount: analysisData?.extractedItems ? Object.keys(analysisData.extractedItems).length : 0
            });

            console.log('=== DISPLAY CATEGORY FILTER INTERFACE ===');

            if (!analysisData || !analysisData.extractedItems) {
                debugLog('displayCategoryFilterInterface', 'NO_DATA', analysisData);
                addMessage("I couldn't find any dispute items to display. Please try analyzing your reports again.", 'bot');
                return;
            }

            // Convert extractedItems object to array if it's an object
            let itemsArray;
            if (Array.isArray(analysisData.extractedItems)) {
                itemsArray = analysisData.extractedItems;
                debugLog('displayCategoryFilterInterface', 'ITEMS_ALREADY_ARRAY', { arrayLength: itemsArray.length });
            } else if (typeof analysisData.extractedItems === 'object') {
                // Convert object to array of values
                itemsArray = Object.values(analysisData.extractedItems);
                debugLog('displayCategoryFilterInterface', 'CONVERTED_OBJECT_TO_ARRAY', {
                    originalType: 'object',
                    arrayLength: itemsArray.length,
                    objectKeys: Object.keys(analysisData.extractedItems).length
                });
            } else {
                debugLog('displayCategoryFilterInterface', 'INVALID_DATA_TYPE', typeof analysisData.extractedItems);
                addMessage("The analysis data format is not recognized. Please try analyzing your reports again.", 'bot');
                return;
            }

            if (itemsArray.length === 0) {
                debugLog('displayCategoryFilterInterface', 'NO_ITEMS_IN_ARRAY');
                addMessage("No dispute items were found in your analysis.", 'bot');
                return;
            }

            // Store the analysis data globally
            currentAnalysisData = analysisData;
            debugLog('displayCategoryFilterInterface', 'DATA_STORED_GLOBALLY');

            // Categorize items using the array
            const categorizedItems = {};
            itemsArray.forEach(item => {
                const category = item.analysis_pass || 'other';
                if (!categorizedItems[category]) {
                    categorizedItems[category] = [];
                }
                categorizedItems[category].push(item);
            });

            debugLog('displayCategoryFilterInterface', 'ITEMS_CATEGORIZED', {
                categories: Object.keys(categorizedItems),
                totalItems: itemsArray.length
            });

            console.log('Categorized items:', Object.keys(categorizedItems).map(cat => `${cat}: ${categorizedItems[cat].length}`));

            // Create the category selection message
            let categoryMessage = `Great! I found **${itemsArray.length}** potential dispute items in your credit reports.\n\n`;
            categoryMessage += `Here are the categories of issues I found:\n\n`;

            // Add category breakdown
            Object.keys(categorizedItems).forEach(category => {
                const count = categorizedItems[category].length;
                const categoryName = formatCategoryName(category);
                categoryMessage += `• **${categoryName}**: ${count} item${count > 1 ? 's' : ''}\n`;
            });

            categoryMessage += `\nHow would you like to proceed?`;

            debugLog('displayCategoryFilterInterface', 'CALLING_ADD_BOT_MESSAGE_WITH_BUTTONS');

            // Check if addBotMessageWithButtons exists
            if (typeof addBotMessageWithButtons === 'function') {
                debugLog('displayCategoryFilterInterface', 'FUNCTION_EXISTS', 'addBotMessageWithButtons');
                addBotMessageWithButtons(categoryMessage, [
                    { text: "View by Category", value: "view_by_category" },
                    { text: "Show High Priority Items", value: "show_high_priority" },
                    { text: "Search by Creditor", value: "search_creditor" },
                    { text: "Show All Items", value: "show_all_items" }
                ]);
            } else {
                debugLog('displayCategoryFilterInterface', 'FUNCTION_NOT_FOUND', 'addBotMessageWithButtons');
                console.error('addBotMessageWithButtons function not found!');

                // Fallback to regular message
                addMessage(categoryMessage, 'bot');
                addMessage("Please type: 1 for Category View, 2 for High Priority, 3 for Search, 4 for All Items", 'bot');
            }

            debugLog('displayCategoryFilterInterface', 'COMPLETED');
        }

        // 5. Add to addBotMessageWithButtons (if it exists)
        function addBotMessageWithButtons(message, buttons) {
            debugLog('addBotMessageWithButtons', 'STARTED', {
                messageLength: message.length,
                buttonCount: buttons.length
            });

            // Your existing code...

            debugLog('addBotMessageWithButtons', 'COMPLETED');
        }

        // 6. Add to addMessage
        function addMessage(content, type, buttons = null) {
            debugLog('addMessage', 'STARTED', {
                type: type,
                contentLength: content.length,
                hasButtons: !!buttons
            });

            // Your existing code...

            debugLog('addMessage', 'COMPLETED');
        }

        // 7. Add to handleCategoryAction
        function handleCategoryAction(action) {
            debugLog('handleCategoryAction', 'STARTED', { action: action });

            console.log('=== HANDLING CATEGORY ACTION ===');
            console.log('Action:', action);

            if (!currentAnalysisData || !currentAnalysisData.extractedItems) {
                debugLog('handleCategoryAction', 'NO_CURRENT_DATA');
                addMessage("Sorry, I lost the analysis data. Please analyze your reports again.", 'bot');
                return;
            }

            switch (action) {
                case 'view_by_category':
                    debugLog('handleCategoryAction', 'CALLING_SHOW_BY_CATEGORY');
                    showItemsByCategory();
                    break;
                case 'show_high_priority':
                    debugLog('handleCategoryAction', 'CALLING_SHOW_HIGH_PRIORITY');
                    showHighPriorityItems();
                    break;
                case 'search_creditor':
                    debugLog('handleCategoryAction', 'CALLING_SEARCH_CREDITOR');
                    addMessage("What creditor would you like to search for? (e.g., 'Capital One', 'Chase', 'Experian')", 'bot');
                    break;
                case 'show_all_items':
                    debugLog('handleCategoryAction', 'CALLING_SHOW_ALL_ITEMS');
                    showAllItems();
                    break;
                default:
                    debugLog('handleCategoryAction', 'UNKNOWN_ACTION', action);
                    addMessage("I didn't understand that option. Please try again.", 'bot');
            }

            debugLog('handleCategoryAction', 'COMPLETED');
        }

        // 8. Add debugging to check if functions exist
        function checkFunctionAvailability() {
            debugLog('checkFunctionAvailability', 'STARTED');

            const functionsToCheck = [
                'addBotMessageWithButtons',
                'addMessage',
                'addBotMessage',
                'handleButtonClick',
                'displayCategoryFilterInterface',
                'handleCategoryAction',
                'showItemsByCategory',
                'showHighPriorityItems',
                'showAllItems'
            ];

            functionsToCheck.forEach(funcName => {
                const exists = typeof window[funcName] === 'function';
                debugLog('checkFunctionAvailability', exists ? 'FUNCTION_EXISTS' : 'FUNCTION_MISSING', funcName);
            });

            debugLog('checkFunctionAvailability', 'COMPLETED');
        }

        // Call this when the page loads
        window.addEventListener('load', () => {
            debugLog('WINDOW_LOAD', 'TRIGGERED');
            checkFunctionAvailability();
        });

        // Add a helper to show what functions are being called in real-time
        function startRealTimeDebug() {
            console.log('🚀 Real-time debugging started. All function calls will be logged.');
            setInterval(() => {
                if (functionCallStack.length > 0) {
                    const lastCall = functionCallStack[functionCallStack.length - 1];
                    console.log(`📊 Last function: ${lastCall.function} ${lastCall.action}`);
                }
            }, 5000);
        }

        // Call this in console to start real-time monitoring
        // startRealTimeDebug();

        // Chat Module
        const ChatModule = (function () {
            // Private variables
            let isInitialized = false;
            let parentModule = null;
            let chatMessages = [];
            let isProcessingMessage = false;

            // Function to debug localStorage contents
            function debugLocalStorage() {
                console.log('--- Chat Module localStorage Debug ---');

                // Count all items
                let totalItems = 0;
                let jamBotItems = 0;
                let fileItems = 0;
                let fileSize = 0;

                console.log('All localStorage keys:');
                Object.keys(localStorage).forEach((key, index) => {
                    totalItems++;
                    const value = localStorage.getItem(key);
                    const size = (key.length + (value ? value.length : 0)) * 2; // Approximate size in bytes

                    if (key.startsWith('jamBot')) {
                        jamBotItems++;
                        console.log(`${index + 1}. ${key}: ${formatSize(size)}`);

                        if (key.startsWith('jamBotFile_')) {
                            fileItems++;
                            fileSize += size;

                            // Try to get file type
                            try {
                                const fileData = JSON.parse(value);
                                console.log(`   - File: ${fileData.name}, Type: ${fileData.type}, Size: ${formatSize(fileData.size)}`);
                            } catch (e) {
                                console.log('   - Could not parse file data');
                            }
                        }
                    }
                });

                console.log('\nSummary:');
                console.log(`Total localStorage items: ${totalItems}`);
                console.log(`JAM Bot items: ${jamBotItems}`);
                console.log(`File items: ${fileItems}`);
                console.log(`Total file size: ${formatSize(fileSize)}`);
                console.log('------------------------');
            }

            // Helper function to format file size
            function formatSize(bytes) {
                if (bytes < 1024) return bytes + ' bytes';
                else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
                else return (bytes / 1048576).toFixed(1) + ' MB';
            }

            // Function to initialize the module
            function init(container, parent) {
                if (!container) {
                    console.error('Container element is required');
                    return false;
                }

                // Set the parent module if provided
                if (parent) {
                    parentModule = parent;
                }

                // Check if this is a page refresh/new session
                const isNewSession = !sessionStorage.getItem('jamBotSessionActive');

                // If it's a new session, clear the chat history
                if (isNewSession) {
                    console.log('New session detected, clearing chat history');
                    clearChatHistory();
                    sessionStorage.setItem('jamBotSessionActive', 'true');
                }

                // Try to load saved messages
                try {
                    if (parentModule && typeof parentModule.getChatState === 'function') {
                        const savedMessages = parentModule.getChatState();
                        if (Array.isArray(savedMessages) && savedMessages.length > 0) {
                            console.log('DEBUG: Using existing chat messages, count:', savedMessages.length);
                            chatMessages = savedMessages;
                        } else {
                            console.log('DEBUG: No saved messages found, using default welcome message');
                            // Add welcome message
                            addBotMessage("Hi there! I'm your JAM AI assistant. How can I help you with credit repair today?");
                        }
                    } else {
                        console.log('DEBUG: No parent module or getChatState function, using default welcome message');
                        // Add welcome message
                        addBotMessage("Hi there! I'm your JAM AI assistant. How can I help you with credit repair today?");
                    }
                } catch (e) {
                    console.error('Error loading saved messages:', e);
                    // Add welcome message as fallback
                    addBotMessage("Hi there! I'm your JAM AI assistant. How can I help you with credit repair today?");
                }

                // Render the chat interface
                renderChatInterface(container);

                // Check if reports have been uploaded
                if (checkForUploadedReports()) {
                    console.log('Reports found, adding analysis prompt');
                    // Add the report analysis prompt if not already present
                    if (!chatMessages.some(msg => msg.content.includes("Would you like me to analyze them"))) {
                        addBotMessageWithButtons(
                            "I see you've uploaded your credit reports. Would you like me to analyze them for potential items to dispute?",
                            [
                                { text: "Yes, analyze my reports", value: "analyze_reports" },
                                { text: "No, I'll ask something else", value: "skip_analysis" }
                            ]
                        );
                    }
                }

                // Add form styles
                addFormStyles();

                return true;
            }

            // Function to render the chat interface
            function renderChatInterface(container) {
                console.log('Rendering chat interface');

                // Create the chat container
                container.innerHTML = `
                    <div class="Bot-chat-container">
                        <div class="Bot-chat-messages" id="chatMessages"></div>
                        <div class="Bot-chat-input-container">
                            <textarea class="Bot-chat-input" id="chatInput" placeholder="Type your message here..." rows="1"></textarea>
                            <button class="Bot-chat-send" id="chatSend" disabled>
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                `;

                // Set up event listeners
                setupEventListeners(container);

                // Update messages display
                updateMessagesDisplay(container);
            }

            // Function to set up event listeners
            function setupEventListeners(container) {
                const chatInput = container.querySelector('#chatInput');
                const sendButton = container.querySelector('#chatSend');

                if (chatInput && sendButton) {
                    // Send message on button click
                    sendButton.addEventListener('click', function () {
                        sendMessage(chatInput.value, container);
                    });

                    // Send message on Enter key (but allow Shift+Enter for new line)
                    chatInput.addEventListener('keydown', function (e) {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            sendMessage(this.value, container);
                        }
                    });

                    // Auto-resize textarea
                    chatInput.addEventListener('input', function () {
                        this.style.height = 'auto';
                        this.style.height = (this.scrollHeight) + 'px';
                    });

                    // Disable/enable send button based on input
                    chatInput.addEventListener('input', function () {
                        sendButton.disabled = this.value.trim() === '';
                    });

                    // Initial button state
                    sendButton.disabled = chatInput.value.trim() === '';
                }
            }

            // Function to send a message
            function sendMessage(message, container) {
                const chatInput = container.querySelector('#chatInput');
                const sendButton = container.querySelector('#chatSend');

                // Don't send empty messages
                message = message.trim();
                if (!message || isProcessingMessage) return;

                // Add user message to chat
                addUserMessage(message);

                // Clear input
                chatInput.value = '';
                chatInput.style.height = 'auto';
                sendButton.disabled = true;

                // Show typing indicator
                showTypingIndicator(container);

                // Process the message
                processMessage(message, container);

                // Update messages display
                updateMessagesDisplay(container);

                // Save chat state
                saveState();
            }

            // Function to process a message
            function processMessage(message, container) {
                isProcessingMessage = true;

                // Check if this is a response to the report analysis prompt
                const isAnalysisConfirmation =
                    checkForUploadedReports() &&
                    chatMessages.length === 2 && // Initial bot message + user response
                    (message.toLowerCase() === 'yes' ||
                        message.toLowerCase() === 'analyze' ||
                        message.toLowerCase().includes('analyze') ||
                        message.toLowerCase().includes('check my reports'));

                // Check if this is a response about wanting to dispute items
                const isDisputeConfirmation =
                    message.toLowerCase().includes('yes') &&
                    message.toLowerCase().includes('dispute') ||
                    message.toLowerCase() === 'yes' ||
                    message.toLowerCase().includes('generate letter') ||
                    message.toLowerCase().includes('create letter');

                // Check if user is selecting a specific item to dispute
                const isItemSelection = message.toLowerCase().includes('item') &&
                    (message.toLowerCase().includes('dispute') || /\d+/.test(message));

                // Notify parent module if available
                if (parentModule && typeof parentModule.onChatMessage === 'function') {
                    // If this is a confirmation to analyze reports, send a special message
                    let processPromise;

                    if (isAnalysisConfirmation) {
                        processPromise = parentModule.onChatMessage('__ANALYZE_CREDIT_REPORTS__');
                    } else if (isDisputeConfirmation) {
                        processPromise = parentModule.onChatMessage('__GENERATE_DISPUTE_LETTER__');
                    } else if (isItemSelection) {
                        processPromise = parentModule.onChatMessage(`__SELECT_DISPUTE_ITEM__:${message}`);
                    } else {
                        processPromise = parentModule.onChatMessage(message);
                    }

                    processPromise
                        .then(response => {
                            // Remove typing indicator
                            hideTypingIndicator(container);

                            // Add bot response
                            addBotMessage(response);

                            // If this was a dispute confirmation, offer item selection
                            if (isDisputeConfirmation) {
                                // Get the last analysis from localStorage
                                const lastAnalysis = JSON.parse(localStorage.getItem('jamBotLastAnalysis') || '{}');

                                if (lastAnalysis && lastAnalysis.extractedItems && lastAnalysis.extractedItems.length > 0) {
                                    // Create the category filter interface
                                    displayCategoryFilterInterface(container, lastAnalysis.extractedItems);
                                } else {
                                    addBotMessage("I couldn't identify specific items from the analysis. Please tell me which item you'd like to dispute.");
                                }
                            }

                            // If this was an item selection, offer to generate a letter
                            if (isItemSelection) {
                                addBotMessage("Great! I'll help you create a dispute letter for this item. Do you want to include any additional details about this dispute?");
                            }

                            // Update messages display
                            updateMessagesDisplay(container);

                            // Save chat state
                            saveState();

                            isProcessingMessage = false;
                        })
                        .catch(error => {
                            console.error('Error processing message:', error);

                            // Remove typing indicator
                            hideTypingIndicator(container);

                            // Add error message
                            addBotMessage("I'm sorry, I encountered an error processing your request. Please try again.");

                            // Update messages display
                            updateMessagesDisplay(container);

                            isProcessingMessage = false;
                        });
                } else {
                    // Simulate response if no parent handler
                    setTimeout(() => {
                        // Remove typing indicator
                        hideTypingIndicator(container);

                        // Add bot response based on message type
                        if (isAnalysisConfirmation) {
                            addBotMessage("I'm analyzing your credit reports now. I'll look for potential items to dispute such as late payments, collections, and accounts that may not belong to you. This analysis will help us identify the best items to focus on for improving your credit score.");
                        } else if (isDisputeConfirmation) {
                            const disputeOptions = "Based on the analysis, here are items you could dispute:\n\n" +
                                "1. Late payment on Capital One account from March 2023\n" +
                                "2. Collection account from ABC Collections ($450)\n" +
                                "3. Incorrect address information\n\n" +
                                "Which item would you like to dispute? (Please specify by number or description)";
                            addBotMessage(disputeOptions);
                        } else if (isItemSelection) {
                            addBotMessage("Great choice. I'll help you create a dispute letter for this item. Would you like to include any additional details about why you're disputing this item?");
                        } else {
                            addBotMessage("I'm here to help with credit repair questions. What specific information are you looking for?");
                        }

                        // Update messages display
                        updateMessagesDisplay(container);

                        isProcessingMessage = false;
                    }, 1500);
                }
            }

            // Function to extract dispute items from analysis text
            //Keep this for now, this is where the dispute items are extracted from the analysis text.
            function extractDisputeItemsFromAnalysis(analysisText) {
                if (!analysisText) return [];

                const items = [];
                const lines = analysisText.split('\n');

                // Look for numbered items in the analysis
                let currentItem = null;
                let itemNumber = null;
                let itemContent = '';

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();

                    // Check for numbered items (e.g., "1. Item name")
                    const numberMatch = line.match(/^(\d+)\.\s+(.+)/);

                    if (numberMatch) {
                        // If we were already collecting an item, save it
                        if (currentItem !== null && itemContent) {
                            items.push({
                                id: currentItem,
                                title: lines[currentItem].replace(/^\d+\.\s+/, '').trim(),
                                content: itemContent.trim()
                            });
                        }

                        // Start a new item
                        currentItem = i;
                        itemNumber = numberMatch[1];
                        itemContent = line + '\n';
                    }
                    // Continue collecting content for the current item
                    else if (currentItem !== null) {
                        itemContent += line + '\n';

                        // Check if we've reached the next numbered item or the end
                        const nextNumberMatch = (i < lines.length - 1) ?
                            lines[i + 1].trim().match(/^(\d+)\.\s+/) : null;

                        if (nextNumberMatch || i === lines.length - 1) {
                            items.push({
                                id: currentItem,
                                title: lines[currentItem].replace(/^\d+\.\s+/, '').trim(),
                                content: itemContent.trim()
                            });

                            if (nextNumberMatch) {
                                currentItem = null;
                                itemContent = '';
                            }
                        }
                    }
                }

                return items;
            }

            // Function to format dispute items for selection
            function formatDisputeItemsForSelection(items) {
                let message = "Based on the analysis, here are items you could dispute:\n\n";

                items.forEach((item, index) => {
                    message += `${index + 1}. ${item.title}\n${item.content}\n\n`;
                });

                message += "\nWhich item would you like to dispute? (Please specify by number or description)";

                return message;
            }

            // Function to add a user message
            //Keep this for now, this is where the user messages are added.
            function addUserMessage(message) {
                chatMessages.push({
                    type: 'user',
                    content: message,
                    timestamp: new Date()
                });
            }

            // Function to add a bot message
            //Keep this for now, this is where the bot messages are added.
            function addBotMessage(message) {
                chatMessages.push({
                    type: 'bot',
                    content: message,
                    timestamp: new Date()
                });
            }

            // Function to add a bot message with action buttons
            //Keep this for now, this is where the bot messages with buttons are added.
            function addBotMessageWithButtons(message, buttons) {
                chatMessages.push({
                    type: 'bot',
                    content: message,
                    buttons: buttons,
                    timestamp: new Date()
                });

                // Save state
                saveState();
            }

            // Function to show typing indicator
            //Keep this for now, these are our typing dots.
            function showTypingIndicator(container) {
                const messagesContainer = container.querySelector('#chatMessages');
                if (!messagesContainer) return;

                const typingIndicator = document.createElement('div');
                typingIndicator.className = 'Bot-message Bot-bot-message';
                typingIndicator.id = 'Bot-typing-indicator';
                typingIndicator.innerHTML = `
                    <div class="Bot-message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="Bot-message-content Bot-message-typing">
                        <div class="Bot-typing-indicator">
                            <div class="Bot-typing-dot"></div>
                            <div class="Bot-typing-dot"></div>
                            <div class="Bot-typing-dot"></div>
                        </div>
                    </div>
                `;

                messagesContainer.appendChild(typingIndicator);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            // Function to hide typing indicator
            //Keep this for now, this is where the typing indicator is removed.
            function hideTypingIndicator(container) {
                const typingIndicator = container.querySelector('#Bot-typing-indicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }

            // Function to update messages display
            //Keep this for now, this is where the messages are updated.
            function updateMessagesDisplay(container) {
                const messagesContainer = container.querySelector('#chatMessages');
                if (!messagesContainer) return;

                // Clear existing messages (except typing indicator)
                const typingIndicator = messagesContainer.querySelector('#Bot-typing-indicator');
                messagesContainer.innerHTML = '';

                // Add all messages
                chatMessages.forEach(message => {
                    const messageElement = document.createElement('div');
                    messageElement.className = `Bot-message Bot-${message.type}-message`;

                    let messageContent = `
                        <div class="Bot-message-avatar">
                            <i class="fas fa-${message.type === 'user' ? 'user' : 'robot'}"></i>
                        </div>
                        <div class="Bot-message-content">
                            ${formatMessageContent(message.content)}
                            ${message.buttons ? renderMessageButtons(message.buttons) : ''}
                        </div>
                    `;

                    messageElement.innerHTML = messageContent;
                    messagesContainer.appendChild(messageElement);

                    // Add event listeners to buttons if they exist
                    if (message.buttons) {
                        const buttonElements = messageElement.querySelectorAll('.Bot-message-button');
                        buttonElements.forEach(button => {
                            button.addEventListener('click', function () {
                                const value = this.getAttribute('data-value');
                                handleButtonClick(value, container);
                            });
                        });
                    }
                });

                // Re-add typing indicator if it existed
                if (typingIndicator) {
                    messagesContainer.appendChild(typingIndicator);
                }

                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            // Function to format message content (handle markdown, links, etc.)
            function formatMessageContent(content) {
                if (!content) return '';

                // Convert URLs to links
                content = content.replace(
                    /(https?:\/\/[^\s]+)/g,
                    '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
                );

                // Convert line breaks to <br>
                content = content.replace(/\n/g, '<br>');

                return content;
            }

            // Function to render message buttons
            function renderMessageButtons(buttons) {
                if (!buttons || !buttons.length) return '';

                return `
                    <div class="Bot-message-buttons">
                        ${buttons.map(button => `
                            <button class="Bot-message-button" data-value="${button.value}">
                                ${button.text}
                            </button>
                        `).join('')}
                    </div>
                `;
            }

            // Function to handle button clicks
            //Keep this for "Yes, analyze my reports" button. This is where event handling for all buttons is handled.
            function handleButtonClick(value, container) {
                debugLog('handleButtonClick', 'STARTED', { value: value });

                console.log('Button clicked:', value);

                if (value === 'analyze_reports') {
                    console.log('User clicked to analyze reports');

                    // Add user message
                    addUserMessage("Yes, analyze my reports");

                    // Show typing indicator
                    showTypingIndicator(container);

                    // Get the credit report files from localStorage
                    const reportFiles = getReportFilesFromLocalStorage();

                    if (reportFiles.length === 0) {
                        console.error('No report files found in localStorage');
                        hideTypingIndicator(container);
                        addBotMessage("I couldn't find any credit report files to analyze. Please make sure you've uploaded your reports in the Reports tab.");
                        updateMessagesDisplay(container);
                        saveState();
                        return;
                    }

                    // Send the files to the backend for analysis
                    sendReportsForAnalysis(reportFiles)
                        .then(response => {
                            // Hide typing indicator
                            hideTypingIndicator(container);

                            // Add bot response with the analysis results
                            addBotMessage(response);

                            // Add follow-up question with buttons
                            addBotMessageWithButtons(
                                "Would you like to dispute any of these items? I can help you generate a dispute letter.",
                                [
                                    { text: "Yes, help me dispute", value: "start_dispute" },
                                    { text: "No, just browsing", value: "skip_dispute" }
                                ]
                            );

                            // Update messages display
                            updateMessagesDisplay(container);

                            // Save chat state
                            saveState();
                        })
                        .catch(error => {
                            console.error('Error analyzing reports:', error);

                            // Hide typing indicator
                            hideTypingIndicator(container);

                            // Add error message
                            addBotMessage("I encountered an error while analyzing your reports. Please try again later or contact support if the problem persists.");

                            // Update messages display
                            updateMessagesDisplay(container);

                            // Save chat state
                            saveState();
                        });
                } else if (value === 'skip_analysis') {
                    console.log('User clicked to skip analysis');

                    // Add user message
                    addUserMessage("No, I'll ask something else");

                    // Add bot response
                    addBotMessage("No problem! I'm here to help with any credit repair questions you have. Feel free to ask me anything about credit repair, dispute strategies, or how to improve your credit score.");

                    // Update messages display
                    updateMessagesDisplay(container);

                    // Save chat state
                    saveState();
                } else if (value === 'start_dispute') {
                    handleStartDispute(container);
                } else if (value === 'skip_dispute') {
                    console.log('User clicked to skip dispute process');

                    // Add user message
                    addUserMessage("No, just browsing");

                    // Add bot response
                    addBotMessage("No problem! If you change your mind or have any questions about the items in your report, feel free to ask. I'm here to help with any credit repair questions you have.");

                    // Update messages display
                    updateMessagesDisplay(container);

                    // Save chat state
                    saveState();
                } else if (value.startsWith('dispute_item_')) {
                    // Extract the item ID from the button value
                    const itemId = parseInt(value.replace('dispute_item_', ''));

                    // Get the last analysis from localStorage
                    const lastAnalysis = JSON.parse(localStorage.getItem('jamBotLastAnalysis') || '{}');
                    const analysisText = lastAnalysis.formattedAnalysis || lastAnalysis.analysis || lastAnalysis.detailedAnalysis;

                    // Extract dispute items from the analysis
                    const disputeItems = extractDisputeItemsFromAnalysis(analysisText);

                    // Find the selected item
                    const selectedItem = disputeItems.find(item => item.id === itemId);

                    if (selectedItem) {
                        // Add user message with the selected item
                        addUserMessage(`I want to dispute: ${selectedItem.title}`);

                        // Store the selected item for later use
                        localStorage.setItem('jamBotSelectedDisputeItem', selectedItem.title);
                        localStorage.setItem('jamBotSelectedDisputeItemContent', selectedItem.content);

                        // Ask how the user wants to proceed with the dispute
                        addBotMessageWithButtons(
                            `You've selected to dispute: **${selectedItem.title}**\n\n${selectedItem.content}\n\nWould you like to add your own details about why this item should be disputed, or use standard dispute reasons?`,
                            [
                                { text: "I'll add details", value: "custom_dispute" },
                                { text: "Use standard reasons", value: "standard_dispute" }
                            ]
                        );

                        // Update messages display
                        updateMessagesDisplay(container);

                        // Save chat state
                        saveState();
                    } else {
                        console.error('Selected item not found');
                        addBotMessage("I couldn't find the item you selected. Please try again.");
                        updateMessagesDisplay(container);
                        saveState();
                    }
                } else if (value === 'standard_dispute') {
                    console.log('User chose standard dispute reasons');

                    // Add user message
                    addUserMessage("No, just use standard reasons");

                    // Get the selected dispute item
                    const selectedItem = localStorage.getItem('jamBotSelectedDisputeItem');

                    // Add bot response
                    addBotMessage(`I'll generate a dispute letter using standard reasons for: "${selectedItem}". Please provide your personal information so I can include it in the letter.`);

                    // Ask for user information with a structured form
                    addBotMessageWithButtons(
                        "What information would you like to include in the letter?",
                        [
                            { text: "Use my profile information", value: "use_profile_info" },
                            { text: "I'll enter my information", value: "enter_custom_info" }
                        ]
                    );

                    // Update messages display
                    updateMessagesDisplay(container);

                    // Save chat state
                    saveState();
                } else if (value === 'custom_dispute') {
                    console.log('User wants to add custom dispute details');

                    // Add user message
                    addUserMessage("Yes, I'll add details");

                    // Add bot response
                    addBotMessage("Please provide any additional details about why you're disputing this item. This will help me create a more personalized dispute letter.");

                    // Update messages display
                    updateMessagesDisplay(container);

                    // Save chat state
                    saveState();
                } else if (value === 'use_profile_info' || value === 'enter_custom_info') {
                    console.log('User selected information source:', value);

                    // Add user message
                    addUserMessage(value === 'use_profile_info' ? "Use my profile information" : "I'll enter my information");

                    // Get the selected dispute item
                    const selectedItem = localStorage.getItem('jamBotSelectedDisputeItem');

                    if (value === 'use_profile_info') {
                        // In a real implementation, you would fetch the user's profile information here
                        // For now, we'll simulate this

                        // Add bot response
                        addBotMessage("Great! I'll use your profile information to generate the dispute letter.");

                        // Show typing indicator to simulate letter generation
                        showTypingIndicator(container);

                        // Simulate letter generation delay
                        setTimeout(() => {
                            // Hide typing indicator
                            hideTypingIndicator(container);

                            // Add the generated letter
                            const sampleLetter = generateSampleDisputeLetter(selectedItem);
                            addLetterOptionsButtons(container, sampleLetter);
                        }, 2000);
                    } else {
                        // Ask for user information
                        addBotMessage("Please provide the following information for your dispute letter:\n\n1. Your full name\n2. Your address\n3. Your phone number\n4. Your email address\n\nYou can enter this information in a single message.");

                        // Update messages display
                        updateMessagesDisplay(container);

                        // Save chat state
                        saveState();
                    }
                } else if (value === 'download_letter') {
                    console.log('User clicked to download letter');

                    // Add user message
                    addUserMessage("Download this letter");

                    // Get the letter from localStorage
                    const letterContent = localStorage.getItem('jamBotDisputeLetter');

                    if (letterContent) {
                        // Download the letter
                        downloadDisputeLetter(letterContent);

                        // Add bot response
                        addBotMessage("I've prepared your dispute letter for download. Is there anything else you'd like help with?");
                    } else {
                        // Add error message
                        addBotMessage("I'm sorry, I couldn't find your dispute letter. Would you like me to generate a new one?", [
                            { text: "Generate new letter", value: "new_letter" }
                        ]);
                    }

                    // Update messages display
                    updateMessagesDisplay(container);

                    // Save chat state
                    saveState();
                } else if (value === 'view_all_letters') {
                    console.log('User clicked to view all dispute letters');

                    // Add user message
                    addUserMessage("View all dispute letters");

                    // Add bot response
                    addBotMessage("I'll take you to your saved dispute letters where you can view, download, or manage them.");

                    // Update messages display
                    updateMessagesDisplay(container);

                    // Save chat state
                    saveState();

                    // Navigate to the Letters tab
                    navigateToLettersTab();
                } else if (value === 'new_letter') {
                    console.log('User clicked to generate a new letter');

                    // Add user message
                    addUserMessage("Generate a new letter");

                    // Add bot response
                    addBotMessageWithButtons(
                        "I'd be happy to generate a new dispute letter for you. Would you like to dispute a different item or use different information for the same item?",
                        [
                            { text: "Dispute different item", value: "start_dispute" },
                            { text: "Same item, different info", value: "same_item_new_info" }
                        ]
                    );

                    // Update messages display
                    updateMessagesDisplay(container);

                    // Save chat state
                    saveState();
                } else if (value === 'same_item_new_info') {
                    console.log('User wants to use same item with different info');

                    // Add user message
                    addUserMessage("Same item, different info");

                    // Get the selected dispute item
                    const selectedItem = localStorage.getItem('jamBotSelectedDisputeItem');

                    if (selectedItem) {
                        // Add bot response
                        addBotMessageWithButtons(
                            `I'll create a new dispute letter for: "${selectedItem}". How would you like to provide your information?`,
                            [
                                { text: "Use my profile information", value: "use_profile_info" },
                                { text: "I'll enter my information", value: "enter_custom_info" }
                            ]
                        );
                    } else {
                        // Add error message
                        addBotMessage("I couldn't find the item you were disputing. Let's start over.", [
                            { text: "Start over", value: "start_dispute" }
                        ]);
                    }

                    // Update messages display
                    updateMessagesDisplay(container);

                    // Save chat state
                    saveState();
                } else if (value === 'enter_custom_info') {
                    console.log('User wants to enter custom information');

                    // Add user message
                    addUserMessage("I'll enter my information");

                    // Create a form for user information
                    const formHtml = `
                        <div class="Bot-form-container">
                            <h3>Please enter your information</h3>
                            <form id="disputeInfoForm" class="Bot-dispute-form">
                                <div class="Bot-form-group">
                                    <label for="fullName">Full Name:</label>
                                    <input type="text" id="fullName" name="fullName" required>
                                </div>
                                <div class="Bot-form-group">
                                    <label for="address">Address:</label>
                                    <textarea id="address" name="address" rows="3" required></textarea>
                                </div>
                                <div class="Bot-form-group">
                                    <label for="phone">Phone Number:</label>
                                    <input type="tel" id="phone" name="phone" required>
                                </div>
                                <div class="Bot-form-group">
                                    <label for="email">Email Address:</label>
                                    <input type="email" id="email" name="email" required>
                                </div>
                                <div class="Bot-form-group">
                                    <label for="ssn">Last 4 of SSN:</label>
                                    <input type="text" id="ssn" name="ssn" maxlength="4" pattern="[0-9]{4}" required>
                                </div>
                                <div class="Bot-form-actions">
                                    <button type="submit" class="Bot-form-submit">Submit Information</button>
                                </div>
                            </form>
                        </div>
                    `;

                    // Add the form as a bot message
                    addBotMessage(formHtml);

                    // Update messages display
                    updateMessagesDisplay(container);

                    // Save chat state
                    saveState();

                    // Add event listener for form submission
                    setTimeout(() => {
                        const form = container.querySelector('#disputeInfoForm');
                        if (form) {
                            form.addEventListener('submit', function (event) {
                                event.preventDefault();

                                // Get form data
                                const formData = {
                                    fullName: form.fullName.value.trim(),
                                    address: form.address.value.trim(),
                                    phone: form.phone.value.trim(),
                                    email: form.email.value.trim(),
                                    ssn: form.ssn.value.trim()
                                };

                                // Validate form data
                                if (!formData.fullName || !formData.address || !formData.phone ||
                                    !formData.email || !formData.ssn) {
                                    // Show error message
                                    const errorDiv = document.createElement('div');
                                    errorDiv.className = 'Bot-form-error';
                                    errorDiv.textContent = 'Please fill out all fields.';
                                    form.appendChild(errorDiv);
                                    return;
                                }

                                // Store user information
                                localStorage.setItem('jamBotUserInfo', JSON.stringify(formData));

                                // Remove the form
                                const formContainer = form.closest('.Bot-message-content');
                                if (formContainer) {
                                    formContainer.innerHTML = '<p>Thank you for providing your information.</p>';
                                }

                                // Get the selected dispute item
                                const selectedItem = localStorage.getItem('jamBotSelectedDisputeItem');

                                // Show typing indicator
                                showTypingIndicator(container);

                                // Simulate letter generation delay
                                setTimeout(() => {
                                    // Hide typing indicator
                                    hideTypingIndicator(container);

                                    // Add the generated letter with the user's information
                                    const sampleLetter = generateDisputeLetterWithUserInfo(selectedItem, formData);
                                    addLetterOptionsButtons(container, sampleLetter);
                                }, 2000);
                            });
                        }
                    }, 100);
                }

                debugLog('handleButtonClick', 'COMPLETED');
            }

            // Function to download the dispute letter as PDF
            function downloadDisputeLetter(letterContent) {
                // We'll use jsPDF library to generate the PDF
                // First, check if jsPDF is already loaded
                if (typeof jsPDF === 'undefined') {
                    // If not loaded, dynamically load the required libraries
                    loadPdfLibraries()
                        .then(() => {
                            generateAndDownloadPdf(letterContent);
                        })
                        .catch(error => {
                            console.error('Error loading PDF libraries:', error);
                            // Fallback to text download if PDF generation fails
                            downloadDisputeLetterAsText(letterContent);
                        });
                } else {
                    // jsPDF is already loaded, generate the PDF directly
                    generateAndDownloadPdf(letterContent);
                }
            }

            // Function to load PDF libraries dynamically
            function loadPdfLibraries() {
                return new Promise((resolve, reject) => {
                    // Load jsPDF library
                    const jsPdfScript = document.createElement('script');
                    jsPdfScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                    jsPdfScript.onload = () => {
                        // After jsPDF is loaded, load html2canvas
                        const html2canvasScript = document.createElement('script');
                        html2canvasScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                        html2canvasScript.onload = resolve;
                        html2canvasScript.onerror = reject;
                        document.head.appendChild(html2canvasScript);
                    };
                    jsPdfScript.onerror = reject;
                    document.head.appendChild(jsPdfScript);
                });
            }

            // Function to generate and download the PDF
            function generateAndDownloadPdf(letterContent) {
                try {
                    // Create a temporary div to render the letter content
                    const tempDiv = document.createElement('div');
                    tempDiv.className = 'dispute-letter-container';
                    tempDiv.style.width = '8.5in';
                    tempDiv.style.padding = '1in';
                    tempDiv.style.backgroundColor = 'white';
                    tempDiv.style.color = 'black';
                    tempDiv.style.fontFamily = 'Arial, sans-serif';
                    tempDiv.style.fontSize = '12pt';
                    tempDiv.style.lineHeight = '1.5';

                    // Convert markdown to HTML
                    tempDiv.innerHTML = convertMarkdownToHtml(letterContent);

                    // Append to body temporarily (needed for html2canvas to work)
                    tempDiv.style.position = 'absolute';
                    tempDiv.style.left = '-9999px';
                    document.body.appendChild(tempDiv);

                    // Use html2canvas to capture the rendered letter
                    html2canvas(tempDiv, {
                        scale: 2, // Higher scale for better quality
                        useCORS: true,
                        logging: false
                    }).then(canvas => {
                        // Create PDF with jsPDF
                        const pdf = new jspdf.jsPDF({
                            orientation: 'portrait',
                            unit: 'in',
                            format: 'letter' // 8.5 x 11 inches
                        });

                        // Add the canvas as an image to the PDF
                        const imgData = canvas.toDataURL('image/jpeg', 1.0);
                        pdf.addImage(imgData, 'JPEG', 0, 0, 8.5, 11);

                        // Save the PDF
                        pdf.save('Dispute_Letter.pdf');

                        // Clean up
                        document.body.removeChild(tempDiv);
                    });
                } catch (error) {
                    console.error('Error generating PDF:', error);
                    // Fallback to text download if PDF generation fails
                    downloadDisputeLetterAsText(letterContent);
                }
            }

            // Fallback function to download as text if PDF generation fails
            function downloadDisputeLetterAsText(letterContent) {
                console.warn('Falling back to text download');

                // Create a blob with the letter content
                const blob = new Blob([letterContent], { type: 'text/plain' });

                // Create a URL for the blob
                const url = URL.createObjectURL(blob);

                // Create a temporary link element
                const a = document.createElement('a');
                a.href = url;
                a.download = 'Dispute_Letter.txt';

                // Append the link to the body
                document.body.appendChild(a);

                // Trigger the download
                a.click();

                // Clean up
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
            }

            // Function to convert markdown to HTML
            function convertMarkdownToHtml(markdown) {
                // Basic markdown to HTML conversion
                let html = markdown
                    // Convert headers
                    .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                    .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                    .replace(/^### (.*$)/gm, '<h3>$1</h3>')

                    // Convert bold text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')

                    // Convert italic text
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')

                    // Convert line breaks
                    .replace(/\n/g, '<br>');

                return html;
            }

            // Helper function to generate a sample dispute letter (for demonstration)
            //Keep this for now, this is where the sample dispute letter is generated.
            function generateSampleDisputeLetter(item) {
                const currentDate = new Date().toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                return `
# DISPUTE LETTER

${currentDate}

John Doe
123 Main Street
Anytown, CA 12345
Phone: (555) 555-5555
Email: johndoe@example.com

Equifax Information Services LLC
P.O. Box 740256
Atlanta, GA 30374

**RE: Dispute of Inaccurate Information in Credit Report**

To Whom It May Concern:

I am writing to dispute the following information in my credit report:

**Item: ${item}**

Under the Fair Credit Reporting Act, Section 611(a), I am requesting that you investigate this matter and remove this inaccurate information from my credit report.

This item is inaccurate because [standard dispute reason based on item type]. I request that you verify this information with the furnisher and update my credit report accordingly.

Please investigate this matter and remove or correct the disputed information to ensure my credit report is accurate and complete. If you verify this information, please provide me with copies of any documentation used in your investigation.

Thank you for your prompt attention to this matter.

Sincerely,

John Doe
`;
            }

            // Function to get report files from localStorage
            //Keep this for now, this is where the report files are retrieved from localStorage
            function getReportFilesFromLocalStorage() {
                const reportFiles = [];

                try {
                    const savedReportsJson = localStorage.getItem('jamBotUploadedReports') || '[]';
                    const savedReports = JSON.parse(savedReportsJson);

                    for (const report of savedReports) {
                        const fileDataKey = 'jamBotFile_' + report.id;
                        const fileDataJson = localStorage.getItem(fileDataKey);

                        if (fileDataJson) {
                            try {
                                const fileData = JSON.parse(fileDataJson);
                                reportFiles.push({
                                    id: report.id,
                                    name: report.name,
                                    type: fileData.type,
                                    data: fileData.data, // This should be the base64 data of the file
                                    size: fileData.size
                                });
                            } catch (e) {
                                console.error(`Error parsing file data for ${report.name}:`, e);
                            }
                        }
                    }
                } catch (e) {
                    console.error('Error getting report files from localStorage:', e);
                }

                return reportFiles;
            }

            // Function to send reports to backend for analysis
            //Keep this for now, this is where the reports are sent to the backend for analysis.
            async function sendReportsForAnalysis(reportFiles) {
                debugLog('sendReportsForAnalysis', 'STARTED', { fileCount: reportFiles.length });

                console.log('=== SEND REPORTS FOR ANALYSIS DEBUG ===');
                console.log('Files to analyze:', reportFiles.length);

                try {
                    // Create FormData to send files
                    const formData = new FormData();

                    // Add each file to the FormData
                    for (let i = 0; i < reportFiles.length; i++) {
                        const reportFile = reportFiles[i];
                        console.log(`Processing file ${i + 1}:`, reportFile.name);

                        // Get file data from localStorage - it's stored as JSON
                        const fileDataJson = localStorage.getItem(`jamBotFile_${reportFile.id}`);
                        if (!fileDataJson) {
                            throw new Error(`File data not found for ${reportFile.name}`);
                        }

                        // Parse the JSON to get the file data object
                        let fileDataObj;
                        try {
                            fileDataObj = JSON.parse(fileDataJson);
                        } catch (parseError) {
                            throw new Error(`Failed to parse file data for ${reportFile.name}: ${parseError.message}`);
                        }

                        // Extract the base64 data from the data URL
                        const dataUrl = fileDataObj.data;
                        if (!dataUrl || !dataUrl.startsWith('data:')) {
                            throw new Error(`Invalid data URL format for ${reportFile.name}`);
                        }

                        // Split the data URL to get just the base64 part
                        const base64Data = dataUrl.split(',')[1];
                        if (!base64Data) {
                            throw new Error(`No base64 data found in data URL for ${reportFile.name}`);
                        }

                        console.log(`Base64 data length: ${base64Data.length}`);

                        // Validate base64 data before decoding
                        if (!base64Data.match(/^[A-Za-z0-9+/]*={0,2}$/)) {
                            throw new Error(`Invalid base64 format for ${reportFile.name}`);
                        }

                        try {
                            // Convert base64 back to blob
                            const byteCharacters = atob(base64Data);
                            const byteNumbers = new Array(byteCharacters.length);
                            for (let j = 0; j < byteCharacters.length; j++) {
                                byteNumbers[j] = byteCharacters.charCodeAt(j);
                            }
                            const byteArray = new Uint8Array(byteNumbers);
                            const blob = new Blob([byteArray], { type: fileDataObj.type || 'application/pdf' });

                            console.log(`Converted to blob: ${blob.size} bytes`);

                            // Add file to FormData
                            formData.append('reports', blob, reportFile.name);

                        } catch (decodeError) {
                            console.error(`Error decoding base64 for ${reportFile.name}:`, decodeError);
                            throw new Error(`Failed to decode file data for ${reportFile.name}: ${decodeError.message}`);
                        }
                    }

                    console.log('FormData prepared, sending request...');

                    // Send the request
                    const response = await fetch('http://localhost:3000/api/chat/analyze', {
                        method: 'POST',
                        body: formData
                    });

                    console.log('Response status:', response.status);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Server error:', errorText);
                        throw new Error(`Server error: ${response.status} - ${errorText}`);
                    }

                    const data = await response.json();

                    console.log('=== ANALYSIS RESPONSE DEBUG ===');
                    console.log('Response data keys:', Object.keys(data));
                    console.log('Response data.extractedItems exists:', !!data.extractedItems);
                    console.log('Response data.extractedItems length:', data.extractedItems?.length || 'N/A');

                    if (data.error) {
                        throw new Error(data.error);
                    }

                    // Store the analysis data globally AND in localStorage
                    currentAnalysisData = data;

                    // Store in localStorage for the dispute handler
                    localStorage.setItem('jamBotLastAnalysis', JSON.stringify(data));
                    localStorage.setItem('creditReportAnalysis', JSON.stringify(data));
                    localStorage.setItem('lastAnalysisData', JSON.stringify(data));

                    debugLog('sendReportsForAnalysis', 'SUCCESS', { extractedItemsCount: data.extractedItems?.length });
                    return data.analysis || data.summary || 'Analysis completed successfully';

                } catch (error) {
                    debugLog('sendReportsForAnalysis', 'ERROR', { error: error.message });
                    console.log('=== ANALYSIS ERROR ===', error);
                    throw error;
                }
            }

            // Function to update the view
            function updateView(container) {
                renderChatInterface(container);
            }

            // Function to save state
            //Keep this for now, this is where the chat state is saved.
            function saveState() {
                console.log('Saving chat state, messages count:', chatMessages.length);
                if (parentModule && typeof parentModule.saveChatState === 'function') {
                    parentModule.saveChatState(chatMessages);
                    console.log('Chat state saved via parent module');
                } else {
                    console.log('No parent module or saveChatState function available');
                }
            }

            // Function to check if reports have been uploaded
            function checkForUploadedReports() {
                console.log('Checking for uploaded reports...');

                // First check if we have any reports metadata
                try {
                    const savedReportsJson = localStorage.getItem('jamBotUploadedReports') || '[]';
                    const savedReports = JSON.parse(savedReportsJson);
                    console.log('Found', savedReports.length, 'reports in metadata');

                    if (savedReports.length === 0) {
                        console.log('No reports found in metadata');
                        // Clear the flag if it's set but no reports exist
                        if (localStorage.getItem('jamBotHasUploadedReports') === 'true') {
                            console.log('Clearing incorrect hasUploadedReports flag');
                            localStorage.removeItem('jamBotHasUploadedReports');
                        }
                        return false;
                    }

                    // Now check if any of these reports have actual file data in localStorage
                    // and if they are of the correct type (PDF, JPG, PNG)
                    let validFileFound = false;

                    for (const report of savedReports) {
                        const fileDataKey = 'jamBotFile_' + report.id;
                        const fileDataJson = localStorage.getItem(fileDataKey);

                        if (fileDataJson) {
                            try {
                                const fileData = JSON.parse(fileDataJson);
                                const fileType = fileData.type ? fileData.type.toLowerCase() : '';

                                // Check if it's a PDF, JPG, or PNG
                                if (fileType.includes('pdf') ||
                                    fileType.includes('jpg') ||
                                    fileType.includes('jpeg') ||
                                    fileType.includes('png')) {

                                    console.log(`Valid credit report file found: ${report.name} (${fileType})`);
                                    validFileFound = true;
                                    // No need to check further files
                                    break;
                                } else {
                                    console.log(`File found but not a valid credit report type: ${report.name} (${fileType})`);
                                }
                            } catch (e) {
                                console.error(`Error parsing file data for ${report.name}:`, e);
                            }
                        } else {
                            console.log(`No file data found for report: ${report.name}`);
                        }
                    }

                    // If no valid files were found but the flag is set, clear it
                    if (!validFileFound && localStorage.getItem('jamBotHasUploadedReports') === 'true') {
                        console.log('No valid files found, clearing hasUploadedReports flag');
                        localStorage.removeItem('jamBotHasUploadedReports');
                    }

                    return validFileFound;
                } catch (e) {
                    console.error('Error checking for uploaded reports:', e);
                    // Clear the flag if there's an error
                    if (localStorage.getItem('jamBotHasUploadedReports') === 'true') {
                        console.log('Error occurred, clearing hasUploadedReports flag');
                        localStorage.removeItem('jamBotHasUploadedReports');
                    }
                    return false;
                }
            }

            // Function to clear chat history but keep welcome message
            function clearChatHistory() {
                console.log('Clearing chat history');

                // Clear localStorage items related to chat
                localStorage.removeItem('jamBotChatMessages');
                localStorage.removeItem('jamBotLastAnalysis');
                localStorage.removeItem('jamBotSelectedDisputeItem');
                localStorage.removeItem('jamBotDisputeLetter');

                // Reset chat messages to just the welcome message
                chatMessages = [{
                    type: 'bot',
                    content: "Hi there! I'm your JAM AI assistant. How can I help you with credit repair today?"
                }];

                // Save the reset state
                saveState();

                console.log('Chat history cleared, reset to welcome message');
            }

            // Function to handle the start_dispute button click
            //Keep this for now, this is where the dispute process is started.
            function handleStartDispute(container) {
                debugLog('handleStartDispute', 'STARTED');

                console.log('=== HANDLE START DISPUTE DEBUG ===');
                console.log('User clicked to start dispute process');

                // Add user message
                addUserMessage("Yes, help me dispute");

                // Debug localStorage contents
                console.log('=== LOCALSTORAGE DEBUG ===');
                const allLocalStorageKeys = Object.keys(localStorage);
                console.log('All localStorage keys:', allLocalStorageKeys);

                // Check for different possible keys
                const possibleKeys = ['jamBotLastAnalysis', 'creditReportAnalysis', 'lastAnalysisData'];
                possibleKeys.forEach(key => {
                    const data = localStorage.getItem(key);
                    console.log(`localStorage['${key}']:`, data ? 'EXISTS' : 'NULL');
                    if (data) {
                        try {
                            const parsed = JSON.parse(data);
                            console.log(`${key} parsed:`, {
                                type: typeof parsed,
                                hasExtractedItems: !!parsed.extractedItems,
                                extractedItemsLength: parsed.extractedItems ? parsed.extractedItems.length : 'N/A',
                                keys: Object.keys(parsed)
                            });
                        } catch (e) {
                            console.log(`${key} parse error:`, e.message);
                        }
                    }
                });

                // Get the last analysis from localStorage with multiple fallbacks
                let lastAnalysis = null;
                let dataSource = 'none';

                // Try jamBotLastAnalysis first
                try {
                    const jamBotData = localStorage.getItem('jamBotLastAnalysis');
                    if (jamBotData) {
                        lastAnalysis = JSON.parse(jamBotData);
                        dataSource = 'jamBotLastAnalysis';
                        console.log('Found data in jamBotLastAnalysis');
                    }
                } catch (e) {
                    console.error('Error parsing jamBotLastAnalysis:', e);
                }

                // Fallback to creditReportAnalysis
                if (!lastAnalysis) {
                    try {
                        const creditData = localStorage.getItem('creditReportAnalysis');
                        if (creditData) {
                            lastAnalysis = JSON.parse(creditData);
                            dataSource = 'creditReportAnalysis';
                            console.log('Found data in creditReportAnalysis');
                        }
                    } catch (e) {
                        console.error('Error parsing creditReportAnalysis:', e);
                    }
                }

                // Fallback to lastAnalysisData
                if (!lastAnalysis) {
                    try {
                        const lastData = localStorage.getItem('lastAnalysisData');
                        if (lastData) {
                            lastAnalysis = JSON.parse(lastData);
                            dataSource = 'lastAnalysisData';
                            console.log('Found data in lastAnalysisData');
                        }
                    } catch (e) {
                        console.error('Error parsing lastAnalysisData:', e);
                    }
                }

                console.log('=== ANALYSIS DATA DEBUG ===');
                console.log('Data source:', dataSource);
                console.log('lastAnalysis exists:', !!lastAnalysis);

                if (lastAnalysis) {
                    console.log('lastAnalysis type:', typeof lastAnalysis);
                    console.log('lastAnalysis keys:', Object.keys(lastAnalysis));
                    console.log('lastAnalysis.extractedItems exists:', !!lastAnalysis.extractedItems);
                    console.log('lastAnalysis.extractedItems type:', typeof lastAnalysis.extractedItems);
                    console.log('lastAnalysis.extractedItems length:', lastAnalysis.extractedItems ? lastAnalysis.extractedItems.length : 'N/A');

                    // Log first few items for inspection
                    if (lastAnalysis.extractedItems && lastAnalysis.extractedItems.length > 0) {
                        console.log('First extracted item:', lastAnalysis.extractedItems[0]);
                        console.log('Sample of extracted items (first 3):', lastAnalysis.extractedItems.slice(0, 3));
                    }
                }

                if (!lastAnalysis || !lastAnalysis.extractedItems || lastAnalysis.extractedItems.length === 0) {
                    debugLog('handleStartDispute', 'NO_DATA_FOUND');
                    console.error('=== NO DISPUTE ITEMS FOUND ===');
                    console.error('lastAnalysis:', lastAnalysis);
                    console.error('extractedItems:', lastAnalysis ? lastAnalysis.extractedItems : 'lastAnalysis is null');

                    addMessage("I couldn't find your credit report analysis data. Let's analyze your reports first.", 'bot');
                    updateMessagesDisplay(container);
                    saveState();
                    return;
                }

                debugLog('handleStartDispute', 'CALLING_DISPLAY_INTERFACE', { itemCount: lastAnalysis.extractedItems.length });
                displayCategoryFilterInterface(lastAnalysis);

                debugLog('handleStartDispute', 'COMPLETED');
            }

            // Function to generate a dispute letter with user information
            function generateDisputeLetterWithUserInfo(item, userInfo) {
                const currentDate = new Date().toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                return `
# DISPUTE LETTER

${currentDate}

${userInfo.fullName}
${userInfo.address}
Phone: ${userInfo.phone}
Email: ${userInfo.email}
Last 4 of SSN: ${userInfo.ssn}

Equifax Information Services LLC
P.O. Box 740256
Atlanta, GA 30374

**RE: Dispute of Inaccurate Information in Credit Report**

To Whom It May Concern:

I am writing to dispute the following information in my credit report:

**Item: ${item}**

Under the Fair Credit Reporting Act, Section 611(a), I am requesting that you investigate this matter and remove this inaccurate information from my credit report.

This item is inaccurate because [standard dispute reason based on item type]. I request that you verify this information with the furnisher and update my credit report accordingly.

Please investigate this matter and remove or correct the disputed information to ensure my credit report is accurate and complete. If you verify this information, please provide me with copies of any documentation used in your investigation.

Thank you for your prompt attention to this matter.

Sincerely,

${userInfo.fullName}
`;
            }

            // Add CSS styles for the form
            function addFormStyles() {
                const styleElement = document.createElement('style');
                styleElement.textContent = `
                    .Bot-form-container {
                        background-color: #f8f9fa;
                        border-radius: 8px;
                        padding: 15px;
                        margin-top: 10px;
                    }
                    
                    .Bot-dispute-form {
                        display: flex;
                        flex-direction: column;
                        gap: 12px;
                    }
                    
                    .Bot-form-group {
                        display: flex;
                        flex-direction: column;
                        gap: 5px;
                    }
                    
                    .Bot-form-group label {
                        font-weight: bold;
                        font-size: 14px;
                    }
                    
                    .Bot-form-group input,
                    .Bot-form-group textarea {
                        padding: 8px;
                        border: 1px solid #ced4da;
                        border-radius: 4px;
                        font-size: 14px;
                    }
                    
                    .Bot-form-actions {
                        display: flex;
                        justify-content: flex-end;
                        margin-top: 10px;
                    }
                    
                    .Bot-form-submit {
                        background-color: #007bff;
                        color: white;
                        border: none;
                        border-radius: 4px;
                        padding: 8px 16px;
                        cursor: pointer;
                        font-weight: bold;
                    }
                    
                    .Bot-form-submit:hover {
                        background-color: #0069d9;
                    }
                    
                    .Bot-form-error {
                        color: #dc3545;
                        font-size: 14px;
                        margin-top: 8px;
                    }
                `;

                document.head.appendChild(styleElement);
            }

            // Function to navigate to the Letters tab
            function navigateToLettersTab() {
                // Check if the parent module (JamTipBotModule) is available
                if (window.jamTipBot && typeof window.jamTipBot.switchTab === 'function') {
                    // Use the switchTab function to navigate to the letters tab
                    window.jamTipBot.switchTab('letters');
                } else {
                    console.error('Cannot navigate to Letters tab: jamTipBot module not available');
                }
            }

            // Function to update the letter options to include "View all dispute letters"
            function addLetterOptionsButtons(container, letterContent) {
                // Hide typing indicator
                hideTypingIndicator(container);

                // Add the generated letter
                addBotMessage(letterContent);

                // Store the letter for download
                localStorage.setItem('jamBotDisputeLetter', letterContent);

                // Add follow-up options with the new "View all dispute letters" button
                addBotMessageWithButtons(
                    "Here's your dispute letter. What would you like to do next?",
                    [
                        { text: "Download this letter", value: "download_letter" },
                        { text: "Generate a new letter", value: "new_letter" },
                        { text: "View all dispute letters", value: "view_all_letters" }
                    ]
                );

                // Update messages display
                updateMessagesDisplay(container);

                // Save chat state
                saveState();
            }

            // Add this new function to create the category filter interface
            //Keep this for now, this is where the category filter interface is created.
            function displayCategoryFilterInterface(container, extractedItems) {
                // Categorize the items
                const categories = {};
                extractedItems.forEach(item => {
                    const category = item.analysis_pass || 'uncategorized';
                    if (!categories[category]) {
                        categories[category] = [];
                    }
                    categories[category].push(item);
                });

                // Create the category filter HTML
                const categoryFilterHTML = `
                    <div class="category-filter">
                        <h4>Select a Category to View Dispute Items:</h4>
                        <div class="category-buttons" id="categoryButtons"></div>
                        <div class="item-count" id="itemCount">Select a category to view items</div>
                        <div class="dispute-items-container" id="disputeItemsContainer">
                            <p style="text-align: center; color: #666; padding: 20px;">
                                Choose a category above to view the specific items you can dispute.
                            </p>
                        </div>
                        <div style="margin-top: 15px;">
                            <button class="category-btn" onclick="proceedWithSelectedItems()" style="background-color: #28a745; color: white; border-color: #28a745;">
                                Proceed with Selected Items
                            </button>
                        </div>
                    </div>
                `;

                // Add the category filter to the chat
                const chatMessages = container.querySelector('#chatMessages');
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'message bot-message';
                categoryDiv.innerHTML = categoryFilterHTML;
                chatMessages.appendChild(categoryDiv);

                // Initialize the category buttons and functionality
                initializeCategoryFilter(categories, extractedItems);
            }

            // Add this function to initialize the category filter
            //Keep this for now, this is where the category filter is initialized.
            function initializeCategoryFilter(categories, extractedItems) {
                const categoryButtons = document.getElementById('categoryButtons');
                const disputeItemsContainer = document.getElementById('disputeItemsContainer');
                const itemCount = document.getElementById('itemCount');

                // Track selected items
                window.selectedDisputeItems = [];

                // Add "All" button
                const allButton = document.createElement('button');
                allButton.className = 'category-btn all active';
                allButton.textContent = `All Items (${extractedItems.length})`;
                allButton.onclick = () => {
                    setActiveButton(allButton);
                    displayItems(extractedItems, 'All Categories');
                };
                categoryButtons.appendChild(allButton);

                // Add category buttons
                Object.keys(categories).forEach(category => {
                    const button = document.createElement('button');
                    button.className = 'category-btn';
                    button.textContent = `${formatCategoryName(category)} (${categories[category].length})`;
                    button.onclick = () => {
                        setActiveButton(button);
                        displayItems(categories[category], formatCategoryName(category));
                    };
                    categoryButtons.appendChild(button);
                });

                // Display all items initially
                displayItems(extractedItems, 'All Categories');

                function setActiveButton(activeButton) {
                    categoryButtons.querySelectorAll('.category-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    activeButton.classList.add('active');
                }

                function displayItems(items, categoryName) {
                    itemCount.textContent = `Showing ${items.length} items in ${categoryName}`;

                    disputeItemsContainer.innerHTML = items.map((item, index) => `
                        <div class="dispute-item" data-item-id="${item.creditor_name}-${index}">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <h5>
                                    <span class="creditor">${item.creditor_name || 'Unknown Creditor'}</span>
                                    <span class="confidence ${item.confidence_level || 'medium'}">${(item.confidence_level || 'medium').toUpperCase()}</span>
                                </h5>
                                <label class="item-checkbox">
                                    <input type="checkbox" onchange="toggleItemSelection('${item.creditor_name}-${index}', this.checked, ${JSON.stringify(item).replace(/"/g, '&quot;')})">
                                    <span>Select for Dispute</span>
                                </label>
                            </div>
                            <div class="issue-type"><strong>Issue:</strong> ${item.issue_type || 'Unknown Issue'}</div>
                            <div><strong>Account:</strong> ${item.account_number || 'N/A'} (${item.account_type || 'Unknown Type'})</div>
                            <div><strong>Details:</strong> ${item.issue_details || 'No details available'}</div>
                            <div><strong>Dispute Reason:</strong> ${item.dispute_reason || 'No reason provided'}</div>
                            ${item.original_text ? `<div><strong>Original Text:</strong> <em>${item.original_text.substring(0, 200)}${item.original_text.length > 200 ? '...' : ''}</em></div>` : ''}
                        </div>
                    `).join('');
                }
            }

            // Add this function to handle item selection
            function toggleItemSelection(itemId, isSelected, itemData) {
                if (!window.selectedDisputeItems) {
                    window.selectedDisputeItems = [];
                }

                if (isSelected) {
                    // Add item to selection
                    window.selectedDisputeItems.push({
                        id: itemId,
                        data: itemData
                    });
                } else {
                    // Remove item from selection
                    window.selectedDisputeItems = window.selectedDisputeItems.filter(item => item.id !== itemId);
                }

                console.log(`Selected items count: ${window.selectedDisputeItems.length}`);
            }

            // Add this function to proceed with selected items
            function proceedWithSelectedItems() {
                if (!window.selectedDisputeItems || window.selectedDisputeItems.length === 0) {
                    alert('Please select at least one item to dispute.');
                    return;
                }

                // Add user message
                addUserMessage(`I want to dispute ${window.selectedDisputeItems.length} selected items`);

                // Create summary of selected items
                let summaryMessage = `Perfect! You've selected ${window.selectedDisputeItems.length} items to dispute:\n\n`;

                window.selectedDisputeItems.forEach((item, index) => {
                    summaryMessage += `${index + 1}. **${item.data.creditor_name}** - ${item.data.issue_type}\n`;
                });

                summaryMessage += `\nWould you like me to generate dispute letters for these items?`;

                // Add bot response with options
                addBotMessageWithButtons(summaryMessage, [
                    { text: "Generate dispute letters", value: "generate_letters" },
                    { text: "Select different items", value: "reselect_items" },
                    { text: "Get more details first", value: "item_details" }
                ]);

                // Update messages display
                updateMessagesDisplay(document.querySelector('.Bot-chat-container'));
                saveState();
            }

            // Add the CSS for the new elements
            function addCategoryFilterStyles() {
                if (document.getElementById('categoryFilterStyles')) return;

                const style = document.createElement('style');
                style.id = 'categoryFilterStyles';
                style.textContent = `
                    .category-filter {
                        margin: 20px 0;
                        padding: 15px;
                        background-color: #f8f9fa;
                        border-radius: 8px;
                        border: 1px solid #dee2e6;
                    }

                    .category-buttons {
                        display: flex;
                        flex-wrap: wrap;
                        gap: 8px;
                        margin-bottom: 15px;
                    }

                    .category-btn {
                        padding: 8px 16px;
                        border: 1px solid #007bff;
                        background-color: white;
                        color: #007bff;
                        border-radius: 20px;
                        cursor: pointer;
                        font-size: 14px;
                        transition: all 0.3s ease;
                    }

                    .category-btn:hover {
                        background-color: #007bff;
                        color: white;
                    }

                    .category-btn.active {
                        background-color: #007bff;
                        color: white;
                    }

                    .category-btn.all {
                        background-color: #28a745;
                        color: white;
                        border-color: #28a745;
                    }

                    .dispute-items-container {
                        max-height: 500px;
                        overflow-y: auto;
                        border: 1px solid #dee2e6;
                        border-radius: 8px;
                        padding: 15px;
                        background-color: white;
                    }

                    .dispute-item {
                        padding: 12px;
                        margin-bottom: 10px;
                        border: 1px solid #e9ecef;
                        border-radius: 6px;
                        background-color: #f8f9fa;
                    }

                    .dispute-item h5 {
                        margin: 0 0 8px 0;
                        color: #495057;
                        font-size: 16px;
                    }

                    .dispute-item .creditor {
                        font-weight: bold;
                        color: #007bff;
                    }

                    .dispute-item .issue-type {
                        color: #dc3545;
                        font-weight: 500;
                    }

                    .dispute-item .confidence {
                        padding: 2px 8px;
                        border-radius: 12px;
                        font-size: 12px;
                        font-weight: bold;
                    }

                    .confidence.high {
                        background-color: #dc3545;
                        color: white;
                    }

                    .confidence.medium {
                        background-color: #ffc107;
                        color: black;
                    }

                    .confidence.low {
                        background-color: #28a745;
                        color: white;
                    }

                    .item-count {
                        font-size: 14px;
                        color: #666;
                        margin-bottom: 10px;
                        font-weight: 500;
                    }

                    .item-checkbox {
                        display: flex;
                        align-items: center;
                        gap: 5px;
                        font-size: 12px;
                        color: #007bff;
                        cursor: pointer;
                    }

                    .item-checkbox input[type="checkbox"] {
                        margin: 0;
                    }
                `;
                document.head.appendChild(style);
            }

            // Add the styles when the module loads
            addCategoryFilterStyles();

            function formatCategoryName(category) {
                const categoryNames = {
                    'personal_info': 'Personal Information',
                    'account_status': 'Account Status',
                    'payment_history': 'Payment History',
                    'duplicates': 'Duplicate Accounts',
                    'inquiries': 'Unauthorized Inquiries',
                    'collections': 'Collections & Charge-offs',
                    'unverifiable': 'Unverifiable Information',
                    'outdated': 'Outdated Information',
                    'uncategorized': 'Uncategorized'
                };
                return categoryNames[category] || category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            }

            // Add this function to check localStorage status
            function debugLocalStorage() {
                console.log('=== LOCALSTORAGE DEBUG CHECK ===');
                const jamBotData = localStorage.getItem('jamBotLastAnalysis');
                console.log('jamBotLastAnalysis exists:', !!jamBotData);

                if (jamBotData) {
                    try {
                        const parsed = JSON.parse(jamBotData);
                        console.log('Parsed data keys:', Object.keys(parsed));
                        console.log('extractedItems exists:', !!parsed.extractedItems);
                        console.log('extractedItems length:', parsed.extractedItems ? parsed.extractedItems.length : 'N/A');
                    } catch (e) {
                        console.error('Parse error:', e);
                    }
                }
            }

            // Public API
            return {
                init: init,

                getChatMessages: function () {
                    return chatMessages;
                },

                setChatMessages: function (messages) {
                    if (Array.isArray(messages)) {
                        chatMessages = messages;
                    }
                },

                updateView: updateView,

                addBotMessage: function (message, container) {
                    addBotMessage(message);
                    if (container) {
                        updateMessagesDisplay(container);
                    }
                },

                // Add this new method to handle report uploads
                onReportUploaded: function (container) {
                    console.log('ChatModule: Report uploaded notification received');

                    // Check if we already have the report message in the chat
                    const hasReportMessage = chatMessages.some(msg =>
                        msg.type === 'bot' && msg.content.includes("I see you've uploaded your credit reports")
                    );

                    // Only add the message if it doesn't already exist
                    if (!hasReportMessage) {
                        console.log('ChatModule: Adding report analysis prompt to chat');

                        // Add the report analysis prompt
                        addBotMessageWithButtons(
                            "I see you've uploaded your credit reports. Would you like me to analyze them for potential items to dispute?",
                            [
                                { text: "Yes, analyze my reports", value: "analyze_reports" },
                                { text: "No, I'll ask something else", value: "skip_analysis" }
                            ]
                        );

                        // Update the display if container is provided
                        if (container) {
                            updateMessagesDisplay(container);
                        } else {
                            // Try to find the container
                            const chatContainer = document.querySelector('.Bot-chat-container');
                            if (chatContainer) {
                                updateMessagesDisplay(chatContainer);
                            }
                        }

                        // Save state
                        saveState();
                    } else {
                        console.log('ChatModule: Report message already exists in chat, not adding again');
                    }
                }
            };
        })();

        // Make the module globally available
        window.chatModule = ChatModule;

        // Dispatch event when loaded
        window.dispatchEvent(new Event('chatModuleLoaded'));

        // Add event listener for page unload to mark session as ended
        window.addEventListener('beforeunload', function () {
            // Remove the session active flag when the page is unloaded
            sessionStorage.removeItem('jamBotSessionActive');
        });

        // Add this to your chatModule.html script section

        let currentAnalysisData = null;
        let selectedDisputeItems = [];

        // Function to handle analysis response and start guided conversation
        function handleAnalysisResponse(responseData) {
            currentAnalysisData = responseData;

            // Display the analysis summary first
            addMessage(responseData.analysis, 'bot');

            // Start the guided conversation
            setTimeout(() => {
                startDisputeGuidance();
            }, 1000);
        }

        function startDisputeGuidance() {
            const totalItems = currentAnalysisData.extractedItems.length;

            const guidanceMessage = `
Great! I found **${totalItems} potential dispute items** in your credit report. 

Let me help you prioritize which items to dispute first. I'll show you the items by category so you can choose the ones that are most important to you.

Would you like to:
1. 📋 See all items by category
2. 🎯 Focus on high-priority items only
3. 🔍 Search for specific creditors
4. ❓ Get recommendations on what to dispute first

Just type the number of your choice!
            `;

            addMessage(guidanceMessage, 'bot');
        }

        // Function to categorize and display items
        function showItemsByCategory() {
            const categories = {};

            // Group items by category
            currentAnalysisData.extractedItems.forEach((item, index) => {
                const category = item.analysis_pass || 'other';
                if (!categories[category]) {
                    categories[category] = [];
                }
                categories[category].push({ ...item, index });
            });

            let categoryMessage = "## 📊 Dispute Items by Category\n\n";

            Object.keys(categories).forEach(category => {
                const categoryName = formatCategoryName(category);
                const items = categories[category];

                categoryMessage += `### ${categoryName} (${items.length} items)\n`;

                items.slice(0, 3).forEach(item => {
                    categoryMessage += `• **${item.creditor_name}** - ${item.issue_type}\n`;
                });

                if (items.length > 3) {
                    categoryMessage += `• ...and ${items.length - 3} more items\n`;
                }

                categoryMessage += `\n`;
            });

            categoryMessage += "\nWhich category would you like to explore first? Just type the category name (e.g., 'personal information', 'account status', etc.)";

            addMessage(categoryMessage, 'bot');
        }

        function showHighPriorityItems() {
            const highPriorityItems = currentAnalysisData.extractedItems.filter(
                item => item.confidence_level === 'high'
            );

            if (highPriorityItems.length === 0) {
                addMessage("I didn't find any items marked as high priority. Let me show you medium priority items instead.", 'bot');
                showMediumPriorityItems();
                return;
            }

            let message = `## 🎯 High Priority Dispute Items (${highPriorityItems.length} items)\n\n`;
            message += "These items have the highest chance of successful dispute:\n\n";

            highPriorityItems.forEach((item, index) => {
                message += `**${index + 1}. ${item.creditor_name}**\n`;
                message += `   • Issue: ${item.issue_type}\n`;
                message += `   • Reason: ${item.dispute_reason}\n`;
                message += `   • Account: ${item.account_type}\n\n`;
            });

            message += "Would you like to:\n";
            message += "• Type a number to select an item for dispute\n";
            message += "• Type 'select multiple' to choose several items\n";
            message += "• Type 'back' to see other options";

            addMessage(message, 'bot');
        }

        function searchCreditors(searchTerm) {
            const matchingItems = currentAnalysisData.extractedItems.filter(item =>
                item.creditor_name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (matchingItems.length === 0) {
                addMessage(`I didn't find any items for "${searchTerm}". Try searching for another creditor name.`, 'bot');
                return;
            }

            let message = `## 🔍 Found ${matchingItems.length} items for "${searchTerm}"\n\n`;

            matchingItems.forEach((item, index) => {
                message += `**${index + 1}. ${item.creditor_name}**\n`;
                message += `   • Issue: ${item.issue_type}\n`;
                message += `   • Details: ${item.issue_details}\n`;
                message += `   • Priority: ${item.confidence_level}\n\n`;
            });

            message += "Type a number to select an item, or 'back' to return to the main menu.";

            addMessage(message, 'bot');
        }

        function selectDisputeItem(itemIndex) {
            const item = currentAnalysisData.extractedItems[itemIndex];

            if (!item) {
                addMessage("Sorry, I couldn't find that item. Please try again.", 'bot');
                return;
            }

            selectedDisputeItems.push(item);

            const confirmMessage = `
✅ **Selected for Dispute:**
**${item.creditor_name}** - ${item.issue_type}

**Details:** ${item.issue_details}
**Dispute Reason:** ${item.dispute_reason}

Would you like to:
1. 📝 Generate a dispute letter for this item now
2. ➕ Add more items to dispute together
3. 📋 Review all selected items
4. 🔄 Start over with different items

Type your choice (1-4)!
            `;

            addMessage(confirmMessage, 'bot');
        }

        function generateDisputeLetter() {
            if (selectedDisputeItems.length === 0) {
                addMessage("You haven't selected any items to dispute yet. Please select at least one item first.", 'bot');
                return;
            }

            addMessage("Perfect! I'll generate a professional dispute letter for your selected items. This may take a moment...", 'bot');

            // Prepare dispute details for the letter generation
            const disputeDetails = {
                items: selectedDisputeItems,
                disputeType: 'factual', // You can make this dynamic based on item types
                userInfo: {
                    // You'll need to collect this from the user or have it stored
                    name: 'User Name',
                    address: 'User Address',
                    city: 'City',
                    state: 'State',
                    zip: 'ZIP'
                }
            };

            // Call your dispute letter generation API
            fetch('http://localhost:3000/api/chat/generate-dispute-letter', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(disputeDetails)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const letterMessage = `
## 📄 Your Dispute Letter

${data.letter}

**Next Steps:**
1. Review the letter carefully
2. Print and sign the letter
3. Send via certified mail to the credit bureau
4. Keep copies for your records

Would you like to:
• Generate letters for other items
• Download this letter as PDF
• Get guidance on mailing procedures
                `;
                        addMessage(letterMessage, 'bot');
                    } else {
                        addMessage("Sorry, there was an error generating your dispute letter. Please try again.", 'bot');
                    }
                })
                .catch(error => {
                    console.error('Error generating dispute letter:', error);
                    addMessage("Sorry, there was an error generating your dispute letter. Please try again.", 'bot');
                });
        }

        // Enhanced message handler for the guided conversation
        function handleGuidedConversation(userMessage) {
            const message = userMessage.toLowerCase().trim();

            // Handle main menu choices
            if (message === '1' || message.includes('category')) {
                showItemsByCategory();
            } else if (message === '2' || message.includes('high priority')) {
                showHighPriorityItems();
            } else if (message === '3' || message.includes('search')) {
                addMessage("What creditor would you like to search for? (e.g., 'Capital One', 'Chase', 'Experian')", 'bot');
            } else if (message === '4' || message.includes('recommend')) {
                showRecommendations();
            }
            // Handle item selection
            else if (/^\d+$/.test(message)) {
                const itemIndex = parseInt(message) - 1;
                selectDisputeItem(itemIndex);
            }
            // Handle letter generation
            else if (message.includes('generate') || message === '1') {
                generateDisputeLetter();
            }
            // Handle creditor search
            else if (currentAnalysisData && message.length > 2) {
                searchCreditors(message);
            }
            // Handle navigation
            else if (message === 'back') {
                startDisputeGuidance();
            } else {
                // Default response
                addMessage("I'm not sure what you'd like to do. Type 'menu' to see your options again, or ask me a specific question about your credit report.", 'bot');
            }
        }

        // Helper functions
        function formatCategoryName(category) {
            const categoryNames = {
                'personal_info': '👤 Personal Information',
                'account_status': '📊 Account Status',
                'payment_history': '💳 Payment History',
                'duplicates': '🔄 Duplicate Accounts',
                'inquiries': '🔍 Inquiries',
                'collections': '⚠️ Collections',
                'unverifiable': '❓ Unverifiable Info',
                'outdated': '📅 Outdated Info',
                'inconsistencies': '⚡ Inconsistencies',
                'metro2': '🔧 Metro2 Compliance'
            };

            return categoryNames[category] || category.replace('_', ' ').toUpperCase();
        }

        function showRecommendations() {
            const message = `
## 💡 My Recommendations

Based on your credit report analysis, here's what I recommend disputing first:

**🎯 Start with High-Impact Items:**
1. **Personal Information Errors** - These are usually easy wins
2. **Duplicate Accounts** - Clear violations that should be removed
3. **Outdated Information** - Items older than 7 years

**📈 For Maximum Credit Score Impact:**
1. Focus on accounts with high balances first
2. Dispute recent late payments
3. Challenge unverifiable collections

**⚖️ Legal Strategy:**
1. Start with factual disputes (easiest to prove)
2. Then move to verification requests
3. Finally, use Metro2 compliance issues

Would you like me to show you items in any of these categories?
            `;

            addMessage(message, 'bot');
        }

        // Update your existing sendMessage function to handle the guided conversation
        function sendMessage() {
            const userInput = document.getElementById('userInput');
            const message = userInput.value.trim();

            if (message === '') return;

            addMessage(message, 'user');
            userInput.value = '';

            // If we have analysis data, handle guided conversation
            if (currentAnalysisData) {
                handleGuidedConversation(message);
            } else {
                // Regular chat handling
                handleRegularChat(message);
            }
        }

        // Update your file upload success handler
        function handleUploadSuccess(data) {
            // Store the analysis data
            currentAnalysisData = data;

            // Display initial analysis
            addMessage(data.analysis, 'bot');

            // Start guided conversation
            setTimeout(() => {
                startDisputeGuidance();
            }, 1500);
        }

        // Run this in your browser console to debug the stored file
        const reportFiles = getReportFilesFromLocalStorage();
        if (reportFiles.length > 0) {
            debugFileStorage(reportFiles[0].id);
        }

        // Add this after your sendReportsForAnalysis function
        function displayCategoryFilterInterface(analysisData) {
            console.log('=== DISPLAY CATEGORY FILTER INTERFACE ===');
            console.log('Analysis data:', analysisData);
            console.log('Extracted items count:', analysisData.extractedItems?.length);

            if (!analysisData || !analysisData.extractedItems || analysisData.extractedItems.length === 0) {
                addMessage("I couldn't find any dispute items to display. Please try analyzing your reports again.", 'bot');
                return;
            }

            // Store the analysis data globally
            currentAnalysisData = analysisData;

            // Categorize items
            const categorizedItems = {};
            analysisData.extractedItems.forEach(item => {
                const category = item.analysis_pass || 'other';
                if (!categorizedItems[category]) {
                    categorizedItems[category] = [];
                }
                categorizedItems[category].push(item);
            });

            console.log('Categorized items:', Object.keys(categorizedItems).map(cat => `${cat}: ${categorizedItems[cat].length}`));

            // Create the category selection message
            let categoryMessage = `Great! I found **${analysisData.extractedItems.length}** potential dispute items in your credit reports.\n\n`;
            categoryMessage += `Here are the categories of issues I found:\n\n`;

            // Add category breakdown
            Object.keys(categorizedItems).forEach(category => {
                const count = categorizedItems[category].length;
                const categoryName = formatCategoryName(category);
                categoryMessage += `• **${categoryName}**: ${count} item${count > 1 ? 's' : ''}\n`;
            });

            categoryMessage += `\nHow would you like to proceed?`;

            // Add the message
            addMessage(categoryMessage, 'bot');

            // Create buttons for different viewing options
            const buttons = [
                { text: "View by Category", action: "view_by_category" },
                { text: "Show High Priority Items", action: "show_high_priority" },
                { text: "Search by Creditor", action: "search_creditor" },
                { text: "Show All Items", action: "show_all_items" }
            ];

            // Add buttons to the interface
            addButtonsToChat(buttons);
        }

        // Function to add buttons to the chat interface
        function addButtonsToChat(buttons) {
            console.log('=== ADDING BUTTONS TO CHAT ===');
            console.log('Buttons to add:', buttons);

            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) {
                console.error('Chat messages container not found');
                return;
            }

            // Create button container
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'bot-message-buttons';
            buttonContainer.style.cssText = `
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                margin-top: 10px;
                padding: 10px;
            `;

            // Create buttons
            buttons.forEach(button => {
                const buttonElement = document.createElement('button');
                buttonElement.textContent = button.text;
                buttonElement.className = 'chat-option-button';
                buttonElement.style.cssText = `
                    background: #007bff;
                    color: white;
                    border: none;
                    padding: 8px 16px;
                    border-radius: 20px;
                    cursor: pointer;
                    font-size: 14px;
                    transition: background-color 0.3s;
                `;

                // Add hover effect
                buttonElement.onmouseover = () => buttonElement.style.background = '#0056b3';
                buttonElement.onmouseout = () => buttonElement.style.background = '#007bff';

                // Add click handler
                buttonElement.onclick = () => handleCategoryAction(button.action);

                buttonContainer.appendChild(buttonElement);
            });

            // Add to chat
            chatMessages.appendChild(buttonContainer);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Function to handle category actions
        function handleCategoryAction(action) {
            debugLog('handleCategoryAction', 'STARTED', { action: action });

            console.log('=== HANDLING CATEGORY ACTION ===');
            console.log('Action:', action);

            if (!currentAnalysisData || !currentAnalysisData.extractedItems) {
                debugLog('handleCategoryAction', 'NO_CURRENT_DATA');
                addMessage("Sorry, I lost the analysis data. Please analyze your reports again.", 'bot');
                return;
            }

            // Remove previous buttons
            const existingButtons = document.querySelectorAll('.bot-message-buttons');
            existingButtons.forEach(btn => btn.remove());

            switch (action) {
                case 'view_by_category':
                    debugLog('handleCategoryAction', 'CALLING_SHOW_BY_CATEGORY');
                    showItemsByCategory();
                    break;
                case 'show_high_priority':
                    debugLog('handleCategoryAction', 'CALLING_SHOW_HIGH_PRIORITY');
                    showHighPriorityItems();
                    break;
                case 'search_creditor':
                    debugLog('handleCategoryAction', 'CALLING_SEARCH_CREDITOR');
                    addMessage("What creditor would you like to search for? (e.g., 'Capital One', 'Chase', 'Experian')", 'bot');
                    break;
                case 'show_all_items':
                    debugLog('handleCategoryAction', 'CALLING_SHOW_ALL_ITEMS');
                    showAllItems();
                    break;
                default:
                    debugLog('handleCategoryAction', 'UNKNOWN_ACTION', action);
                    addMessage("I didn't understand that option. Please try again.", 'bot');
            }

            debugLog('handleCategoryAction', 'COMPLETED');
        }

        // Function to format category names
        function formatCategoryName(category) {
            const categoryMap = {
                'personal_info': 'Personal Information',
                'account_status': 'Account Status',
                'payment_history': 'Payment History',
                'duplicates': 'Duplicate Accounts',
                'inquiries': 'Unauthorized Inquiries',
                'collections': 'Collections',
                'unverifiable': 'Unverifiable Information',
                'outdated': 'Outdated Information',
                'inconsistencies': 'Data Inconsistencies',
                'metro2': 'Metro2 Compliance',
                'other': 'Other Issues'
            };

            return categoryMap[category] || category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        // Function to show items by category
        function showItemsByCategory() {
            if (!currentAnalysisData || !currentAnalysisData.extractedItems) {
                addMessage("No analysis data available.", 'bot');
                return;
            }

            // Categorize items
            const categorizedItems = {};
            currentAnalysisData.extractedItems.forEach(item => {
                const category = item.analysis_pass || 'other';
                if (!categorizedItems[category]) {
                    categorizedItems[category] = [];
                }
                categorizedItems[category].push(item);
            });

            let message = "**Items by Category:**\n\n";

            Object.keys(categorizedItems).forEach(category => {
                const items = categorizedItems[category];
                const categoryName = formatCategoryName(category);

                message += `**${categoryName} (${items.length} items):**\n`;
                items.forEach((item, index) => {
                    message += `${index + 1}. ${item.creditor_name} - ${item.issue_type}\n`;
                    message += `   Account: ${item.account_number || 'N/A'}\n`;
                    message += `   Issue: ${item.issue_details}\n\n`;
                });
            });

            message += "Which items would you like to dispute? You can tell me the numbers or category names.";

            addMessage(message, 'bot');
        }

        // Function to show high priority items
        function showHighPriorityItems() {
            if (!currentAnalysisData || !currentAnalysisData.extractedItems) {
                addMessage("No analysis data available.", 'bot');
                return;
            }

            const highPriorityItems = currentAnalysisData.extractedItems.filter(item =>
                item.confidence_level === 'high' ||
                item.issue_type.toLowerCase().includes('error') ||
                item.issue_type.toLowerCase().includes('unauthorized')
            );

            if (highPriorityItems.length === 0) {
                addMessage("I didn't find any high-priority items. Would you like to see all items instead?", 'bot');
                return;
            }

            let message = `**High Priority Items (${highPriorityItems.length} items):**\n\n`;

            highPriorityItems.forEach((item, index) => {
                message += `${index + 1}. **${item.creditor_name}** - ${item.issue_type}\n`;
                message += `   Account: ${item.account_number || 'N/A'}\n`;
                message += `   Issue: ${item.issue_details}\n`;
                message += `   Confidence: ${item.confidence_level}\n\n`;
            });

            message += "Which of these high-priority items would you like to dispute?";

            addMessage(message, 'bot');
        }

        // Function to show all items
        function showAllItems() {
            if (!currentAnalysisData || !currentAnalysisData.extractedItems) {
                addMessage("No analysis data available.", 'bot');
                return;
            }

            let message = `**All Dispute Items (${currentAnalysisData.extractedItems.length} total):**\n\n`;

            currentAnalysisData.extractedItems.forEach((item, index) => {
                message += `${index + 1}. **${item.creditor_name}** - ${item.issue_type}\n`;
                message += `   Account: ${item.account_number || 'N/A'}\n`;
                message += `   Issue: ${item.issue_details}\n\n`;
            });

            message += "Which items would you like to dispute? You can tell me the numbers.";

            addMessage(message, 'bot');
        }

        // Update your handleStartDispute function to call displayCategoryFilterInterface
        function handleStartDispute() {
            debugLog('handleStartDispute', 'STARTED');

            console.log('=== HANDLE START DISPUTE DEBUG ===');
            console.log('User clicked to start dispute process');

            // Check currentAnalysisData first
            let analysisData = currentAnalysisData;

            if (!analysisData) {
                // Fallback to localStorage
                try {
                    const storedData = localStorage.getItem('jamBotLastAnalysis') ||
                        localStorage.getItem('creditReportAnalysis') ||
                        localStorage.getItem('lastAnalysisData');
                    if (storedData) {
                        analysisData = JSON.parse(storedData);
                    }
                } catch (e) {
                    console.error('Error parsing stored analysis data:', e);
                }
            }

            console.log('=== ANALYSIS DATA DEBUG ===');
            console.log('Data source:', analysisData === currentAnalysisData ? 'currentAnalysisData' : 'localStorage');
            console.log('Analysis data exists:', !!analysisData);
            console.log('Extracted items count:', analysisData?.extractedItems?.length || 0);

            if (!analysisData || !analysisData.extractedItems || analysisData.extractedItems.length === 0) {
                debugLog('handleStartDispute', 'NO_DATA_FOUND');
                console.log('=== NO DISPUTE ITEMS FOUND ===');
                addMessage("I couldn't find any analysis data. Please analyze your reports first before starting the dispute process.", 'bot');
                return;
            }

            debugLog('handleStartDispute', 'CALLING_DISPLAY_INTERFACE', { itemCount: analysisData.extractedItems.length });
            displayCategoryFilterInterface(analysisData);

            debugLog('handleStartDispute', 'COMPLETED');
        }
    </script>
</body>

</html>