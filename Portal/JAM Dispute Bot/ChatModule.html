<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JAM Chat Module</title>
    <!-- Add jsPDF library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* CSS Variables for Design System Consistency */
        :root {
            --primary: #09ccfc;
            --primary-dark: #07a3ca;
            --primary-light: #e3f2fd;
            --secondary: #008080;
            --gray-50: #f8f9fa;
            --gray-100: #e9ecef;
            --gray-200: #dee2e6;
            --gray-300: #ced4da;
            --gray-400: #adb5bd;
            --gray-500: #6c757d;
            --gray-600: #495057;
            --gray-700: #343a40;
            --gray-800: #212529;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --blue-accent: #09ccfc;
        }

        /* Chat Container Styles - Enhanced */
        .Bot-chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 1.5rem;
            position: relative;
            background: var(--gray-50);
            min-height: 500px;
            overflow: hidden;
        }

        .Bot-chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 1.5rem;
            padding: 1.25rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--gray-200);
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        /* Removed chat input interface CSS - no longer needed for button-only interface */

        /* Message Styles - Enhanced */
        .Bot-message {
            margin-bottom: 1.25rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            animation: fadeInUp 0.3s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .Bot-message.user {
            flex-direction: row-reverse;
        }

        .Bot-message-content {
            max-width: 85%;
            padding: 1rem 1.25rem;
            border-radius: 18px;
            word-wrap: break-word;
            line-height: 1.5;
            font-size: 0.95rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            position: relative;
        }

        .Bot-message.bot .Bot-message-content {
            background: linear-gradient(135deg, var(--gray-50) 0%, white 100%);
            color: var(--gray-800);
            border: 1px solid var(--gray-200);
            border-bottom-left-radius: 6px;
        }

        .Bot-message.user .Bot-message-content {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-bottom-right-radius: 6px;
            box-shadow: 0 2px 8px rgba(9, 204, 252, 0.2);
        }

        .Bot-message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 2px solid white;
        }

        .Bot-message.bot .Bot-message-avatar {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .Bot-message.user .Bot-message-avatar {
            background: linear-gradient(135deg, var(--gray-600) 0%, var(--gray-700) 100%);
            color: white;
        }

        /* Button Styles - Enhanced */
        .Bot-message-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .Bot-chat-button {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s ease;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            box-shadow: 0 2px 8px rgba(9, 204, 252, 0.2);
            border: 2px solid var(--primary);
            line-height: 1.3;
        }

        .Bot-chat-button:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, #056080 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(9, 204, 252, 0.3);
        }

        .Bot-chat-button:active {
            transform: scale(0.98);
        }

        .Bot-chat-button i {
            margin-right: 0.5rem;
            font-size: 1rem;
        }

        /* Typing Indicator - Enhanced */
        .Bot-typing-indicator {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.25rem;
            background: linear-gradient(135deg, var(--gray-50) 0%, white 100%);
            border: 1px solid var(--gray-200);
            border-radius: 18px;
            border-bottom-left-radius: 6px;
            max-width: 80%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            animation: fadeInUp 0.3s ease-out;
        }

        .Bot-typing-dots {
            display: flex;
            gap: 0.25rem;
        }

        .Bot-typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary);
            animation: typing 1.4s infinite ease-in-out;
        }

        .Bot-typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .Bot-typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing {

            0%,
            80%,
            100% {
                transform: scale(0.8);
                opacity: 0.5;
            }

            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Loading Styles */
        .Bot-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
        }

        .Bot-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #09ccfc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Payment Modal Styles - Enhanced */
        .Bot-payment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 1.5rem;
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
            -webkit-overflow-scrolling: touch;
        }

        .Bot-payment-modal-content {
            background: linear-gradient(135deg, white 0%, var(--gray-50) 100%);
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--gray-200);
            animation: modalAppear 0.3s ease-out;
        }

        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .Bot-payment-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid #dee2e6;
            background: #f8f9fa;
        }

        .Bot-payment-modal-header h3 {
            color: #09ccfc;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .Bot-payment-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .Bot-payment-modal-close:hover {
            color: #495057;
        }

        .Bot-payment-modal-body {
            padding: 2rem;
        }

        .Bot-plan-summary {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .Bot-plan-summary h4 {
            color: #09ccfc;
            margin-bottom: 0.5rem;
            font-size: 1.3rem;
        }

        .Bot-price-display {
            font-size: 2.5rem;
            font-weight: 700;
            color: #28a745;
            margin-bottom: 1rem;
        }

        .Bot-price-display span {
            font-size: 1rem;
            color: #6c757d;
        }

        .Bot-plan-features-summary {
            list-style: none;
            padding: 0;
            text-align: left;
            max-width: 400px;
            margin: 0 auto;
        }

        .Bot-plan-features-summary li {
            padding: 0.3rem 0;
            color: #495057;
        }

        .Bot-plan-features-summary i {
            color: #28a745;
            margin-right: 0.5rem;
        }

        .Bot-payment-security {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .Bot-payment-security p {
            color: #6c757d;
            margin: 0.3rem 0;
        }

        .Bot-payment-security i {
            color: #28a745;
            margin-right: 0.5rem;
        }

        .Bot-payment-action-container {
            text-align: center;
            margin: 2rem 0;
        }

        .Bot-payment-note {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 0.5rem;
        }

        .Bot-proceed-payment-btn {
            background: linear-gradient(135deg, #09ccfc 0%, #08b5e0 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(9, 204, 252, 0.3);
        }

        .Bot-proceed-payment-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(9, 204, 252, 0.4);
        }

        .Bot-proceed-payment-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .Bot-cancel-payment-btn {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease;
        }

        .Bot-cancel-payment-btn:hover {
            background: #5a6268;
        }

        .Bot-payment-footer {
            text-align: center;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #dee2e6;
        }

        .Bot-guarantee-text {
            color: #28a745;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .Bot-guarantee-text i {
            margin-right: 0.5rem;
        }

        /* Popup blocked and status message styles */
        .Bot-popup-blocked-message,
        .Bot-payment-status-message {
            text-align: center;
            padding: 2rem;
        }

        .Bot-popup-blocked-message ol {
            text-align: left;
            max-width: 400px;
            margin: 1rem auto;
        }

        .Bot-payment-options,
        .Bot-status-options {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .Bot-payment-options a {
            text-decoration: none;
        }

        /* Success message styles */
        .Bot-success-message {
            text-align: center;
            padding: 2rem;
        }

        .Bot-success-message h4 {
            color: #28a745;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .Bot-success-message p {
            margin-bottom: 1rem;
            color: #6c757d;
        }

        /* Mobile-First Responsive Design */

        /* Base Mobile Styles (‚â§575px) */
        @media (max-width: 575.98px) {
            .Bot-chat-container {
                padding: 1rem;
                min-height: 400px;
            }

            .Bot-chat-messages {
                padding: 1rem;
                margin-bottom: 1rem;
                border-radius: 8px;
            }

            .Bot-message {
                margin-bottom: 1rem;
                gap: 0.5rem;
            }

            .Bot-message-content {
                max-width: 90%;
                padding: 0.875rem 1rem;
                border-radius: 16px;
                font-size: 0.9rem;
            }

            .Bot-message-avatar {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }

            .Bot-message-buttons {
                gap: 0.5rem;
                margin-top: 0.75rem;
            }

            .Bot-chat-button {
                padding: 0.75rem 1rem;
                font-size: 0.85rem;
                min-height: 48px;
                text-align: center;
                flex: 1;
                min-width: 120px;
            }

            .Bot-typing-indicator {
                max-width: 85%;
                padding: 0.875rem 1rem;
            }

            .Bot-payment-modal {
                padding: 1rem;
                align-items: flex-start;
                overflow-y: auto;
            }

            .Bot-payment-modal-content {
                max-height: 95vh;
                border-radius: 12px;
                margin-top: 1rem;
            }

            .Bot-payment-modal-header,
            .Bot-payment-modal-body {
                padding: 1.25rem;
            }

            .Bot-plan-summary {
                padding: 1.25rem;
                margin-bottom: 1.25rem;
            }

            .Bot-price-display {
                font-size: 2rem;
            }

            .Bot-proceed-payment-btn {
                padding: 1rem 1.5rem;
                font-size: 1rem;
                width: 100%;
            }

            .Bot-payment-options {
                flex-direction: column;
                gap: 0.75rem;
            }

            .Bot-payment-options .Bot-chat-button,
            .Bot-status-options .Bot-chat-button {
                width: 100%;
                justify-content: center;
            }
        }

        /* Small Devices (576px - 767px) */
        @media (min-width: 576px) and (max-width: 767.98px) {
            .Bot-chat-container {
                padding: 1.25rem;
            }

            .Bot-message-content {
                max-width: 88%;
            }

            .Bot-message-buttons {
                gap: 0.625rem;
            }

            .Bot-chat-button {
                min-width: 140px;
            }

            .Bot-payment-modal-content {
                border-radius: 14px;
            }
        }

        /* Tablets (768px - 991px) */
        @media (min-width: 768px) and (max-width: 991.98px) {
            .Bot-chat-container {
                padding: 1.5rem;
            }

            .Bot-message-content {
                max-width: 85%;
            }

            .Bot-chat-button {
                min-width: 160px;
            }

            .Bot-payment-modal {
                padding: 2rem;
            }
        }

        /* Desktop (‚â•992px) */
        @media (min-width: 992px) {
            .Bot-chat-container {
                padding: 2rem;
            }

            .Bot-chat-messages {
                padding: 1.5rem;
            }

            .Bot-message {
                margin-bottom: 1.5rem;
            }

            .Bot-message-content {
                max-width: 80%;
                padding: 1.125rem 1.375rem;
            }

            .Bot-message-avatar {
                width: 44px;
                height: 44px;
            }

            .Bot-chat-button {
                padding: 0.875rem 1.5rem;
                font-size: 0.95rem;
                min-width: 180px;
            }

            .Bot-payment-modal {
                padding: 2.5rem;
            }
        }

        /* Extra Large Screens (‚â•1200px) */
        @media (min-width: 1200px) {
            .Bot-chat-container {
                padding: 2.5rem;
                max-width: 1200px;
                margin: 0 auto;
            }

            .Bot-chat-messages {
                padding: 2rem;
            }

            .Bot-message-content {
                max-width: 75%;
                font-size: 1rem;
            }

            .Bot-chat-button {
                font-size: 1rem;
                min-width: 200px;
            }
        }

        /* Touch and Mobile Optimizations */
        @media (hover: none) and (pointer: coarse) {
            .Bot-chat-button:hover {
                transform: none;
                box-shadow: 0 2px 8px rgba(9, 204, 252, 0.2);
            }

            .Bot-chat-button:active {
                transform: scale(0.95);
                transition: transform 0.1s ease;
            }
        }

        /* Landscape Mobile Adjustments */
        @media (max-height: 500px) and (orientation: landscape) {
            .Bot-chat-container {
                padding: 0.75rem;
                min-height: 300px;
            }

            .Bot-chat-messages {
                padding: 0.75rem;
                margin-bottom: 0.75rem;
            }

            .Bot-message {
                margin-bottom: 0.75rem;
            }

            .Bot-payment-modal {
                padding: 0.75rem;
            }

            .Bot-payment-modal-content {
                max-height: 98vh;
            }
        }

        /* High DPI Displays */
        @media (-webkit-min-device-pixel-ratio: 2),
        (min-resolution: 192dpi) {

            .Bot-message-avatar,
            .Bot-chat-button {
                backface-visibility: hidden;
                -webkit-font-smoothing: antialiased;
            }
        }

        /* Reduced Motion Preference */
        @media (prefers-reduced-motion: reduce) {

            .Bot-message,
            .Bot-typing-indicator,
            .Bot-payment-modal-content {
                animation: none;
            }

            .Bot-chat-button,
            .Bot-proceed-payment-btn {
                transition: none;
            }

            .Bot-typing-dot {
                animation: none;
            }
        }

        /* Dark Mode Support 
        @media (prefers-color-scheme: dark) {
            .Bot-chat-container {
                background: #1a1a1a;
            }

            .Bot-chat-messages {
                background: #2d2d2d;
                border-color: #404040;
            }

            .Bot-message.bot .Bot-message-content {
                background: linear-gradient(135deg, #404040 0%, #2d2d2d 100%);
                color: #e9ecef;
                border-color: #555;
            }

            .Bot-typing-indicator {
                background: linear-gradient(135deg, #404040 0%, #2d2d2d 100%);
                border-color: #555;
            }

            .Bot-payment-modal-content {
                background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
                border-color: #404040;
            }
        }*/

        /* Print Styles */
        @media print {
            .Bot-chat-container {
                background: white;
                box-shadow: none;
                padding: 1rem;
            }

            .Bot-chat-messages {
                box-shadow: none;
                border: 1px solid #ccc;
            }

            .Bot-message-buttons,
            .Bot-payment-modal {
                display: none;
            }

            .Bot-message-content {
                box-shadow: none;
                border: 1px solid #ccc;
            }
        }
    </style>
</head>

<body>
    <script>
        // ChatModule - Properly structured like CreditReportUploaderModule
        const ChatModule = (function () {
            'use strict';

            // Private variables
            let messages = [];
            let currentAnalysisData = null;
            let parentModule = null;
            let typingIndicator = null;
            let isInitialized = false;
            let paymentModal = null;
            let selectedPlanType = null;

            // NEW: Conversation state management
            let conversationState = {
                phase: 'overview', // overview, category, item_review, letter_generation
                currentCategory: null,
                currentItemIndex: 0,
                selectedItems: [],
                skippedItems: [],
                completedCategories: [],
                userChoices: {},
                groupedItems: null,
                categoryOrder: ['high_impact', 'medium_impact', 'low_impact']
            };

            // Payment configuration
            const PAYMENT_LINKS = {
                starter: 'https://link.fastpaydirect.com/payment-link/6843a3290a574190c5525591',
                professional: 'https://link.fastpaydirect.com/payment-link/6843a3570a5741e44652559b',
                premium: 'https://link.fastpaydirect.com/payment-link/6843a3850263ae38e2780bda'
            };

            const PLAN_DETAILS = {
                starter: {
                    name: 'DIY Starter',
                    price: '$29',
                    target: 'Perfect for beginners',
                    description: 'Get started with essential credit repair tools and basic dispute capabilities.',
                    features: [
                        'Basic JAM Dispute Bot access',
                        'Generate 5 dispute letters/month',
                        'Basic progress tracking',
                        'Email support',
                        'Credit education resources'
                    ]
                },
                professional: {
                    name: 'DIY Professional',
                    price: '$59',
                    target: 'Most popular choice',
                    description: 'Comprehensive credit repair tools with advanced features for serious credit improvement.',
                    features: [
                        'Full JAM Dispute Bot access',
                        'Unlimited custom dispute letters',
                        'Advanced progress tracking',
                        'Credit score monitoring & alerts',
                        'Priority email support',
                        'Professional dispute templates',
                        'Automated follow-up reminders'
                    ]
                },
                premium: {
                    name: 'DIY Premium',
                    price: '$99',
                    target: 'For serious credit repair',
                    description: 'Everything you need for comprehensive credit repair with premium support and advanced tools.',
                    features: [
                        'Full JAM Dispute Bot access',
                        'Unlimited dispute letters',
                        'Real-time credit monitoring',
                        'Advanced analytics & reporting',
                        'Phone & email support',
                        'Premium dispute templates',
                        'Automated workflows',
                        'Credit building strategies',
                        'Debt validation letters'
                    ]
                }
            };

            // Private helper functions
            function debugLog(functionName, status, data = {}) {
                console.log(`[ChatModule] ${functionName} - ${status}`, data);
            }

            // NEW: Subscription-aware conversation starter
            async function startSubscriptionAwareConversation(container) {
                try {
                    console.log('üîç ChatModule: Starting subscription-aware conversation...');

                    // Get subscription status from global manager
                    const subscriptionStatus = await getGlobalSubscriptionStatus();

                    if (!subscriptionStatus) {
                        // Fallback welcome message if subscription check fails
                        showFallbackWelcomeMessage(container);
                        return;
                    }

                    console.log('üìä ChatModule subscription status:', subscriptionStatus);

                    // Create subscription-aware welcome message
                    showSubscriptionAwareWelcome(subscriptionStatus, container);

                } catch (error) {
                    console.error('‚ùå Error in subscription-aware conversation start:', error);
                    showFallbackWelcomeMessage(container);
                }
            }

            // NEW: Get subscription status from global manager
            async function getGlobalSubscriptionStatus() {
                try {
                    // Try to get global subscription manager
                    let globalManager = null;

                    // Check if available via parent module
                    if (parentModule && parentModule.getGlobalSubscriptionManager) {
                        globalManager = parentModule.getGlobalSubscriptionManager();
                    }

                    // Check if available via window
                    if (!globalManager && window.jamSubscriptionManager) {
                        globalManager = window.jamSubscriptionManager;
                    }

                    // Check if available via parent bot
                    if (!globalManager && window.jamTipBot && window.jamTipBot.getGlobalSubscriptionManager) {
                        globalManager = window.jamTipBot.getGlobalSubscriptionManager();
                    }

                    if (globalManager && typeof globalManager.getSubscriptionStatus === 'function') {
                        const status = globalManager.getSubscriptionStatus();
                        console.log('‚úÖ Got subscription status from global manager:', {
                            tier: status.tier,
                            isActive: status.isActive,
                            remainingCredits: status.remainingCredits,
                            tierName: status.tierName,
                            disputeLetterUsage: status.disputeLetterUsage
                        });
                        console.log('üìä ChatModule received disputeLetterUsage:', status.disputeLetterUsage);
                        return status;
                    } else {
                        console.warn('‚ö†Ô∏è Global subscription manager not available');
                        return null;
                    }
                } catch (error) {
                    console.error('‚ùå Error getting subscription status:', error);
                    return null;
                }
            }

            // NEW: Show subscription-aware welcome message
            function showSubscriptionAwareWelcome(subscriptionStatus, container) {
                const isFreeTier = subscriptionStatus.tier === 'free';
                const tierName = subscriptionStatus.tierName;
                const disputeLetterUsage = subscriptionStatus.disputeLetterUsage || {};

                // Calculate actual remaining credits using SAME logic as ManageSubscriptionModule
                let actualRemaining = 0;
                let displayText = '';

                if (isFreeTier) {
                    // Free tier: 2 lifetime credits total
                    const totalGenerated = disputeLetterUsage.totalLettersGenerated || 0;
                    const freeTrialLimit = 2;
                    actualRemaining = Math.max(0, freeTrialLimit - totalGenerated);
                    displayText = `üìù **Dispute Letters:** ${actualRemaining} remaining (lifetime)`;

                    console.log('üÜì ChatModule Free tier calculation:', {
                        lifetimeLimit: freeTrialLimit,
                        totalGenerated: totalGenerated,
                        remaining: actualRemaining
                    });
                } else {
                    // Paid tier: Use same calculation as ManageSubscriptionModule
                    const monthlyLimit = disputeLetterUsage.monthlyLimit || 0;
                    const monthlyUsed = disputeLetterUsage.monthlyLettersUsed || 0;
                    const backendRemaining = disputeLetterUsage.monthlyRemaining;

                    // Primary calculation: trust backend if available, otherwise calculate
                    const calculatedRemaining = Math.max(0, monthlyLimit - monthlyUsed);
                    actualRemaining = Math.max(0, backendRemaining !== undefined ? backendRemaining : calculatedRemaining);

                    displayText = `üìù **Dispute Letters:** ${actualRemaining} remaining this month`;

                    console.log('üí≥ ChatModule Paid tier calculation:', {
                        tier: subscriptionStatus.tier,
                        monthlyLimit: monthlyLimit,
                        monthlyUsed: monthlyUsed,
                        backendRemaining: backendRemaining,
                        calculatedRemaining: calculatedRemaining,
                        finalRemaining: actualRemaining,
                        legacyRemainingCredits: subscriptionStatus.remainingCredits
                    });
                }

                let welcomeMessage = `üëã **Welcome to JAM Dispute Bot!**\n\n`;
                welcomeMessage += `üí≥ **Your Plan:** ${tierName}\n`;
                welcomeMessage += `${displayText}\n\n`;

                // Create appropriate conversation flow based on subscription
                if (actualRemaining === 0) {
                    // No credits remaining - guide to upgrade
                    welcomeMessage += `üîí **No Credits Remaining**\n\n`;
                    welcomeMessage += `You've used all your dispute letter credits. To analyze credit reports and generate dispute letters, you'll need to upgrade.\n\n`;
                    welcomeMessage += `üí° **I can still help you with:**\n`;
                    welcomeMessage += `‚Ä¢ Credit repair advice\n`;
                    welcomeMessage += `‚Ä¢ Understanding your credit report\n`;
                    welcomeMessage += `‚Ä¢ Explaining dispute strategies\n`;
                    welcomeMessage += `‚Ä¢ General credit questions`;

                    addBotMessageWithButtons(welcomeMessage, [
                        { text: "üöÄ Upgrade My Plan", value: "upgrade_subscription" },
                        { text: "üìã View Pricing Plans", value: "view_plans" },
                        { text: "üí¨ Ask General Questions", value: "general_chat_mode" },
                        { text: "‚ÑπÔ∏è Learn About Credit Repair", value: "learn_credit_repair" }
                    ]);

                } else {
                    // Has credits - can proceed with normal flow
                    if (isFreeTier) {
                        welcomeMessage += `‚ö° **Ready to boost your credit score?** You have ${actualRemaining} dispute letters to use wisely!\n\n`;
                        welcomeMessage += `üí° **Tip:** Each dispute letter counts, so let's make sure we target the right items for maximum impact.`;
                    } else {
                        welcomeMessage += `‚ö° **Ready to boost your credit score?** Let's find the best items to dispute in your credit reports.`;
                    }

                    addBotMessageWithButtons(welcomeMessage, [
                        { text: "üìä Check My Credit Reports", value: "check_for_reports" },
                        { text: "üì§ Upload Reports First", value: "no_reports_uploaded" },
                        { text: "üí¨ Ask Questions First", value: "general_chat_mode" },
                        { text: "üìö Learn About Disputes", value: "learn_credit_repair" }
                    ]);
                }

                updateMessagesDisplay(container);
            }

            // NEW: Fallback welcome message when subscription check fails
            function showFallbackWelcomeMessage(container) {
                console.log('üîÑ Using fallback welcome message');

                addBotMessageWithButtons(
                    "üëã **Welcome to JAM Dispute Bot!**\n\nI'm here to help you improve your credit score! What would you like to do?",
                    [
                        { text: "üìä Check My Credit Reports", value: "check_for_reports" },
                        { text: "üì§ Upload Reports First", value: "no_reports_uploaded" },
                        { text: "üí¨ Ask Questions", value: "general_chat_mode" },
                        { text: "üìö Learn About Credit Repair", value: "learn_credit_repair" }
                    ]
                );

                updateMessagesDisplay(container);
            }

            // NEW: Handle report checking with subscription validation
            async function handleReportCheckingFlow(container) {
                try {
                    // First, check subscription status again to be sure
                    const subscriptionStatus = await getGlobalSubscriptionStatus();

                    if (subscriptionStatus) {
                        const isFreeTier = subscriptionStatus.tier === 'free';
                        const disputeLetterUsage = subscriptionStatus.disputeLetterUsage || {};
                        let actualRemaining = 0;

                        // Use SAME calculation logic as welcome message
                        if (isFreeTier) {
                            // Free tier: 2 lifetime credits total
                            const totalGenerated = disputeLetterUsage.totalLettersGenerated || 0;
                            const freeTrialLimit = 2;
                            actualRemaining = Math.max(0, freeTrialLimit - totalGenerated);
                        } else {
                            // Paid tier: Use same calculation as ManageSubscriptionModule
                            const monthlyLimit = disputeLetterUsage.monthlyLimit || 0;
                            const monthlyUsed = disputeLetterUsage.monthlyLettersUsed || 0;
                            const backendRemaining = disputeLetterUsage.monthlyRemaining;

                            // Primary calculation: trust backend if available, otherwise calculate
                            const calculatedRemaining = Math.max(0, monthlyLimit - monthlyUsed);
                            actualRemaining = Math.max(0, backendRemaining !== undefined ? backendRemaining : calculatedRemaining);
                        }

                        console.log('üìä Report checking flow - subscription check:', {
                            tier: subscriptionStatus.tier,
                            isFreeTier: isFreeTier,
                            disputeLetterUsage: disputeLetterUsage,
                            actualRemaining: actualRemaining,
                            legacyRemainingCredits: subscriptionStatus.remainingCredits
                        });

                        // Check if user has enough credits before proceeding
                        if (actualRemaining === 0) {
                            // No credits - block analysis and guide to upgrade
                            addBotMessageWithButtons(
                                `üîí **Credit Analysis Requires Dispute Letter Credits**\n\n` +
                                `You've used all your dispute letter credits (${isFreeTier ? 'lifetime' : 'monthly'} limit). To analyze credit reports and generate dispute letters, you'll need to upgrade.\n\n` +
                                `üí° **Why upgrade?**\n` +
                                `‚Ä¢ Unlimited credit report analysis\n` +
                                `‚Ä¢ AI-powered dispute strategies\n` +
                                `‚Ä¢ Professional dispute letters\n` +
                                `‚Ä¢ Higher success rates\n\n` +
                                `Ready to boost your credit score?`,
                                [
                                    { text: "üöÄ Upgrade Now", value: "upgrade_subscription" },
                                    { text: "üìã View Plans", value: "view_plans" },
                                    { text: "üí¨ Ask Questions Instead", value: "general_chat_mode" },
                                    { text: "üîÑ Check Credits Again", value: "refresh_subscription" }
                                ]
                            );
                            updateMessagesDisplay(container);
                            return;
                        }
                    }

                    // Has credits or couldn't check - proceed with report checking
                    addBotMessage("üîç Let me check for your uploaded credit reports...");
                    showTypingIndicator(container);

                    checkForUploadedReports().then(hasReports => {
                        hideTypingIndicator(container);

                        if (hasReports.hasReports && hasReports.count > 0) {
                            // Found reports - offer analysis with credit warning
                            let analysisMessage = `‚úÖ Great! I found ${hasReports.count} credit report${hasReports.count > 1 ? 's' : ''} in your account.\n\n`;

                            if (subscriptionStatus) {
                                const isFreeTier = subscriptionStatus.tier === 'free';
                                let actualRemaining = subscriptionStatus.remainingCredits;

                                if (isFreeTier && subscriptionStatus.disputeLetterUsage) {
                                    const totalGenerated = subscriptionStatus.disputeLetterUsage.totalLettersGenerated || 0;
                                    actualRemaining = Math.max(0, 2 - totalGenerated);
                                }

                                if (isFreeTier) {
                                    analysisMessage += `üí° **Important:** You have ${actualRemaining} dispute letters remaining. Analysis will help me create targeted dispute letters for maximum impact.\n\n`;
                                } else {
                                    analysisMessage += `üí° **Credit Status:** ${actualRemaining} dispute letters remaining this month.\n\n`;
                                }
                            }

                            analysisMessage += `Would you like me to analyze them for potential items to dispute?`;

                            addBotMessageWithButtons(analysisMessage, [
                                { text: "‚úÖ Yes, analyze my reports", value: "analyze_reports" },
                                { text: "üìä Show Report Details First", value: "show_report_details" },
                                { text: "üí¨ Ask Questions First", value: "general_chat_mode" },
                                { text: "‚ùå Not now", value: "skip_analysis" }
                            ]);
                        } else {
                            addBotMessage(`‚ùå I couldn't find any credit reports in your account. Please upload your credit reports first in the Reports tab, then come back and I'll help you analyze them for dispute opportunities.`);
                        }
                        updateMessagesDisplay(container);
                    }).catch(error => {
                        hideTypingIndicator(container);
                        addBotMessage("‚ùå I encountered an error checking for your reports. Please try again or upload your reports if you haven't already.");
                        updateMessagesDisplay(container);
                        console.error('Error checking for reports:', error);
                    });

                } catch (error) {
                    console.error('‚ùå Error in report checking flow:', error);
                    hideTypingIndicator(container);
                    addBotMessage("‚ùå I encountered an error. Please try again or contact support.");
                    updateMessagesDisplay(container);
                }
            }

            // NEW: Show credit repair education
            function showCreditRepairEducation(container) {
                let educationMessage = `üìö **Credit Repair Fundamentals**\n\n`;
                educationMessage += `**üéØ What Affects Your Credit Score:**\n`;
                educationMessage += `‚Ä¢ Payment History (35%) - Late payments hurt most\n`;
                educationMessage += `‚Ä¢ Credit Utilization (30%) - Keep below 30%\n`;
                educationMessage += `‚Ä¢ Length of History (15%) - Older accounts help\n`;
                educationMessage += `‚Ä¢ Credit Mix (10%) - Variety is good\n`;
                educationMessage += `‚Ä¢ New Credit (10%) - Too many inquiries hurt\n\n`;

                educationMessage += `**‚öñÔ∏è Dispute Process:**\n`;
                educationMessage += `1. **Identify** inaccurate items\n`;
                educationMessage += `2. **Document** the errors\n`;
                educationMessage += `3. **Dispute** with bureaus (30-day response)\n`;
                educationMessage += `4. **Follow up** if needed\n`;
                educationMessage += `5. **Monitor** for removals\n\n`;

                educationMessage += `**üìà Timeline:** Most disputes resolve in 30-45 days, with score improvements visible immediately after removal.`;

                addBotMessageWithButtons(educationMessage, [
                    { text: "üìä Now Check My Reports", value: "check_for_reports" },
                    { text: "üí¨ Ask Specific Questions", value: "general_chat_mode" },
                    { text: "üì§ Upload Reports First", value: "no_reports_uploaded" },
                    { text: "üîÑ Back to Start", value: "restart_conversation" }
                ]);

                updateMessagesDisplay(container);
                saveState();
            }

            // NEW: Show credit repair questions with buttons
            function showCreditRepairQuestions(container) {
                addBotMessageWithButtons(
                    "Perfect! I'm here to help with any credit repair questions. What would you like to know about?",
                    [
                        { text: "üìä How Credit Scores Work", value: "explain_credit_scores" },
                        { text: "‚ö†Ô∏è What Hurts Credit Most", value: "explain_credit_damage" },
                        { text: "üõ†Ô∏è Credit Repair Strategies", value: "explain_repair_strategies" },
                        { text: "üìÑ Understanding Credit Reports", value: "explain_credit_reports" },
                        { text: "‚úâÔ∏è Dispute Letter Basics", value: "explain_dispute_letters" },
                        { text: "‚è∞ Timeline for Improvement", value: "explain_timeline" },
                        { text: "üìà Score Improvement Tips", value: "explain_score_tips" },
                        { text: "üîÑ Back to Main Menu", value: "restart_conversation" }
                    ]
                );

                updateMessagesDisplay(container);
                saveState();
            }

            // NEW: Explain credit scores
            function explainCreditScores(container) {
                let message = `üìä **How Credit Scores Work**\n\n`;
                message += `**üéØ FICO Score Breakdown:**\n`;
                message += `‚Ä¢ **Payment History (35%)** - Most important factor\n`;
                message += `‚Ä¢ **Credit Utilization (30%)** - How much credit you use\n`;
                message += `‚Ä¢ **Length of History (15%)** - Age of accounts\n`;
                message += `‚Ä¢ **Credit Mix (10%)** - Types of credit\n`;
                message += `‚Ä¢ **New Credit (10%)** - Recent inquiries\n\n`;

                message += `**üìà Score Ranges:**\n`;
                message += `‚Ä¢ 800-850: Excellent\n`;
                message += `‚Ä¢ 740-799: Very Good\n`;
                message += `‚Ä¢ 670-739: Good\n`;
                message += `‚Ä¢ 580-669: Fair\n`;
                message += `‚Ä¢ 300-579: Poor\n\n`;

                message += `üí° **Key Insight:** Even small improvements can move you to the next score tier!`;

                addBotMessageWithButtons(message, [
                    { text: "‚ö†Ô∏è What Damages Credit", value: "explain_credit_damage" },
                    { text: "üõ†Ô∏è How to Improve", value: "explain_score_tips" },
                    { text: "üìÑ About Credit Reports", value: "explain_credit_reports" },
                    { text: "üí¨ Ask Another Question", value: "general_chat_mode" },
                    { text: "üìä Analyze My Reports", value: "check_for_reports" }
                ]);

                updateMessagesDisplay(container);
                saveState();
            }

            // NEW: Explain what damages credit
            function explainCreditDamage(container) {
                let message = `‚ö†Ô∏è **What Hurts Your Credit Score Most**\n\n`;
                message += `**üî• High Impact Damage:**\n`;
                message += `‚Ä¢ Late payments (30+ days): -60 to -110 points\n`;
                message += `‚Ä¢ Collections: -50 to -100 points\n`;
                message += `‚Ä¢ Charge-offs: -50 to -100 points\n`;
                message += `‚Ä¢ Bankruptcies: -130 to -200 points\n`;
                message += `‚Ä¢ Foreclosures: -85 to -160 points\n\n`;

                message += `**üìâ Medium Impact Damage:**\n`;
                message += `‚Ä¢ High credit utilization (over 30%): -10 to -45 points\n`;
                message += `‚Ä¢ Multiple hard inquiries: -5 to -10 points each\n`;
                message += `‚Ä¢ Closing old accounts: -5 to -15 points\n\n`;

                message += `**üéØ Good News:** Many of these can be disputed if inaccurate!`;

                addBotMessageWithButtons(message, [
                    { text: "‚úâÔ∏è How to Dispute These", value: "explain_dispute_letters" },
                    { text: "‚è∞ How Long to Fix", value: "explain_timeline" },
                    { text: "üõ†Ô∏è Repair Strategies", value: "explain_repair_strategies" },
                    { text: "üí¨ Ask Another Question", value: "general_chat_mode" },
                    { text: "üìä Analyze My Reports", value: "check_for_reports" }
                ]);

                updateMessagesDisplay(container);
                saveState();
            }

            // NEW: Explain repair strategies
            function explainRepairStrategies(container) {
                let message = `üõ†Ô∏è **Credit Repair Strategies**\n\n`;
                message += `**üéØ The Strategic Approach:**\n`;
                message += `1. **Get all 3 credit reports** (Experian, Equifax, TransUnion)\n`;
                message += `2. **Identify inaccuracies** (wrong dates, amounts, accounts)\n`;
                message += `3. **Prioritize high-impact items** (collections, charge-offs)\n`;
                message += `4. **Dispute systematically** (one round at a time)\n`;
                message += `5. **Monitor and follow up** (30-day cycles)\n\n`;

                message += `**‚öñÔ∏è Legal Rights:**\n`;
                message += `‚Ä¢ Fair Credit Reporting Act (FCRA) protects you\n`;
                message += `‚Ä¢ Bureaus must investigate within 30 days\n`;
                message += `‚Ä¢ Items must be removed if unverifiable\n`;
                message += `‚Ä¢ You can dispute the same item multiple times\n\n`;

                message += `üí° **Pro Tip:** Focus on accuracy, not just negative items!`;

                addBotMessageWithButtons(message, [
                    { text: "‚úâÔ∏è Dispute Letter Process", value: "explain_dispute_letters" },
                    { text: "üìÑ Understanding Reports", value: "explain_credit_reports" },
                    { text: "‚è∞ Expected Timeline", value: "explain_timeline" },
                    { text: "üí¨ Ask Another Question", value: "general_chat_mode" },
                    { text: "üìä Let's Analyze My Reports", value: "check_for_reports" }
                ]);

                updateMessagesDisplay(container);
                saveState();
            }

            // NEW: Explain credit reports
            function explainCreditReports(container) {
                let message = `üìÑ **Understanding Your Credit Report**\n\n`;
                message += `**üìã Main Sections:**\n`;
                message += `‚Ä¢ **Personal Information** - Name, address, SSN\n`;
                message += `‚Ä¢ **Account History** - All credit accounts\n`;
                message += `‚Ä¢ **Payment History** - On-time vs late payments\n`;
                message += `‚Ä¢ **Public Records** - Bankruptcies, liens, judgments\n`;
                message += `‚Ä¢ **Credit Inquiries** - Who checked your credit\n\n`;

                message += `**üîç What to Look For:**\n`;
                message += `‚Ä¢ Accounts that aren't yours\n`;
                message += `‚Ä¢ Wrong payment dates or amounts\n`;
                message += `‚Ä¢ Incorrect balances or limits\n`;
                message += `‚Ä¢ Duplicate accounts\n`;
                message += `‚Ä¢ Outdated information (7+ years old)\n\n`;

                message += `**üéØ Remember:** Each bureau may have different information!`;

                addBotMessageWithButtons(message, [
                    { text: "üîç Common Report Errors", value: "explain_common_errors" },
                    { text: "‚úâÔ∏è How to Dispute Errors", value: "explain_dispute_letters" },
                    { text: "üìä Analyze My Reports Now", value: "check_for_reports" },
                    { text: "üí¨ Ask Another Question", value: "general_chat_mode" },
                    { text: "üì§ Upload My Reports", value: "no_reports_uploaded" }
                ]);

                updateMessagesDisplay(container);
                saveState();
            }

            // NEW: Explain dispute letters
            function explainDisputeLetters(container) {
                let message = `‚úâÔ∏è **Dispute Letter Basics**\n\n`;
                message += `**üìù What Makes a Good Dispute Letter:**\n`;
                message += `‚Ä¢ Specific item identification\n`;
                message += `‚Ä¢ Clear reason for dispute\n`;
                message += `‚Ä¢ Professional language\n`;
                message += `‚Ä¢ Supporting documentation (when available)\n`;
                message += `‚Ä¢ Certified mail delivery\n\n`;

                message += `**üéØ Common Dispute Reasons:**\n`;
                message += `‚Ä¢ "This account is not mine"\n`;
                message += `‚Ä¢ "Payment dates are incorrect"\n`;
                message += `‚Ä¢ "Balance amount is wrong"\n`;
                message += `‚Ä¢ "Account was paid on time"\n`;
                message += `‚Ä¢ "This is a duplicate account"\n\n`;

                message += `**‚è∞ Process:** Mail ‚Üí 30-day investigation ‚Üí Result`;

                addBotMessageWithButtons(message, [
                    { text: "üìä Generate My Letters", value: "check_for_reports" },
                    { text: "‚è∞ How Long Does It Take", value: "explain_timeline" },
                    { text: "üîç Common Errors to Dispute", value: "explain_common_errors" },
                    { text: "üìà Success Rate Tips", value: "explain_success_tips" },
                    { text: "üí¨ Ask Another Question", value: "general_chat_mode" }
                ]);

                updateMessagesDisplay(container);
                saveState();
            }

            // NEW: Explain timeline
            function explainTimeline(container) {
                let message = `‚è∞ **Credit Repair Timeline**\n\n`;
                message += `**üìÖ Realistic Expectations:**\n`;
                message += `‚Ä¢ **Month 1:** Gather reports, identify errors\n`;
                message += `‚Ä¢ **Month 2:** Send first round of disputes\n`;
                message += `‚Ä¢ **Month 3:** Review results, send follow-ups\n`;
                message += `‚Ä¢ **Months 4-6:** Continue dispute cycles\n`;
                message += `‚Ä¢ **Months 6-12:** Focus on credit building\n\n`;

                message += `**üéØ Quick Wins (30-60 days):**\n`;
                message += `‚Ä¢ Personal information errors\n`;
                message += `‚Ä¢ Duplicate accounts\n`;
                message += `‚Ä¢ Unauthorized inquiries\n\n`;

                message += `**üìà Moderate Wins (3-6 months):**\n`;
                message += `‚Ä¢ Collections removal\n`;
                message += `‚Ä¢ Charge-off disputes\n`;
                message += `‚Ä¢ Payment history corrections\n\n`;

                message += `üí° **Remember:** Every situation is unique, but persistence pays off!`;

                addBotMessageWithButtons(message, [
                    { text: "üöÄ Start My Disputes Now", value: "check_for_reports" },
                    { text: "üìà Score Improvement Tips", value: "explain_score_tips" },
                    { text: "üéØ Success Rate Tips", value: "explain_success_tips" },
                    { text: "üí¨ Ask Another Question", value: "general_chat_mode" },
                    { text: "üîÑ Back to Main Menu", value: "restart_conversation" }
                ]);

                updateMessagesDisplay(container);
                saveState();
            }

            // NEW: Explain score improvement tips
            function explainScoreTips(container) {
                let message = `üìà **Score Improvement Tips**\n\n`;
                message += `**üöÄ Quick Boost Strategies:**\n`;
                message += `‚Ä¢ Pay down credit card balances (target under 10%)\n`;
                message += `‚Ä¢ Don't close old credit accounts\n`;
                message += `‚Ä¢ Pay all bills on time (even non-credit bills)\n`;
                message += `‚Ä¢ Dispute inaccurate negative items\n`;
                message += `‚Ä¢ Become an authorized user on family accounts\n\n`;

                message += `**üìä Credit Utilization Tips:**\n`;
                message += `‚Ä¢ Keep total utilization under 30%\n`;
                message += `‚Ä¢ Individual cards under 30% too\n`;
                message += `‚Ä¢ Pay before statement closes\n`;
                message += `‚Ä¢ Request credit limit increases\n\n`;

                message += `**‚ö° Pro Tip:** Small changes can boost your score 20-50 points quickly!`;

                addBotMessageWithButtons(message, [
                    { text: "‚ö†Ô∏è What Damages Credit", value: "explain_credit_damage" },
                    { text: "üìä How Scores Work", value: "explain_credit_scores" },
                    { text: "üõ†Ô∏è Repair Strategies", value: "explain_repair_strategies" },
                    { text: "üìä Analyze My Reports", value: "check_for_reports" },
                    { text: "üí¨ Ask Another Question", value: "general_chat_mode" }
                ]);

                updateMessagesDisplay(container);
                saveState();
            }

            // NEW: Explain common errors
            function explainCommonErrors(container) {
                let message = `üîç **Common Credit Report Errors**\n\n`;
                message += `**üë§ Personal Information Errors:**\n`;
                message += `‚Ä¢ Wrong name spellings or variations\n`;
                message += `‚Ä¢ Incorrect addresses or phone numbers\n`;
                message += `‚Ä¢ Mixed files (someone else's info)\n`;
                message += `‚Ä¢ Wrong social security number\n\n`;

                message += `**üí≥ Account Information Errors:**\n`;
                message += `‚Ä¢ Accounts that aren't yours\n`;
                message += `‚Ä¢ Duplicate accounts from same debt\n`;
                message += `‚Ä¢ Wrong balance amounts\n`;
                message += `‚Ä¢ Incorrect payment history\n`;
                message += `‚Ä¢ Wrong account status or dates\n\n`;

                message += `**üìä Status and Date Errors:**\n`;
                message += `‚Ä¢ Accounts showing open when closed\n`;
                message += `‚Ä¢ Wrong date of first delinquency\n`;
                message += `‚Ä¢ Incorrect charge-off dates\n`;
                message += `‚Ä¢ Old debts re-aged to look recent\n\n`;

                message += `**üéØ Success Rate:** Personal info errors have 90%+ dispute success rate!`;

                addBotMessageWithButtons(message, [
                    { text: "‚úâÔ∏è How to Dispute These", value: "explain_dispute_letters" },
                    { text: "üìä Analyze My Reports", value: "check_for_reports" },
                    { text: "üìà Success Rate Tips", value: "explain_success_tips" },
                    { text: "üí¨ Ask Another Question", value: "general_chat_mode" },
                    { text: "üîÑ Back to Main Menu", value: "restart_conversation" }
                ]);

                updateMessagesDisplay(container);
                saveState();
            }

            // NEW: Explain success tips
            function explainSuccessTips(container) {
                let message = `üìà **Dispute Success Rate Tips**\n\n`;
                message += `**üéØ High Success Rate Strategies:**\n`;
                message += `‚Ä¢ Be specific about the error\n`;
                message += `‚Ä¢ Include supporting documentation\n`;
                message += `‚Ä¢ Send via certified mail\n`;
                message += `‚Ä¢ Keep detailed records\n`;
                message += `‚Ä¢ Follow up consistently\n\n`;

                message += `**üìù Letter Writing Tips:**\n`;
                message += `‚Ä¢ Use professional language\n`;
                message += `‚Ä¢ Cite the Fair Credit Reporting Act\n`;
                message += `‚Ä¢ Request method of verification\n`;
                message += `‚Ä¢ Don't admit the debt is yours\n`;
                message += `‚Ä¢ Focus on accuracy, not fairness\n\n`;

                message += `**‚è∞ Timing Tips:**\n`;
                message += `‚Ä¢ Wait for 30-day response period\n`;
                message += `‚Ä¢ Send follow-ups if no response\n`;
                message += `‚Ä¢ Dispute same item multiple times if needed\n`;
                message += `‚Ä¢ Stagger disputes across different months\n\n`;

                message += `**üéñÔ∏è Pro Tip:** Success rates are highest for factual errors, not "please remove" requests!`;

                addBotMessageWithButtons(message, [
                    { text: "‚úâÔ∏è Generate My Letters", value: "check_for_reports" },
                    { text: "üîç Common Errors List", value: "explain_common_errors" },
                    { text: "‚è∞ Timeline Expectations", value: "explain_timeline" },
                    { text: "üí¨ Ask Another Question", value: "general_chat_mode" },
                    { text: "üîÑ Back to Main Menu", value: "restart_conversation" }
                ]);

                updateMessagesDisplay(container);
                saveState();
            }

            // NEW: Refresh subscription and restart conversation
            async function refreshSubscriptionAndRestart(container) {
                try {
                    addBotMessage("üîÑ Refreshing your subscription status...");
                    showTypingIndicator(container);

                    // Force refresh subscription data
                    if (window.jamSubscriptionManager && typeof window.jamSubscriptionManager.refresh === 'function') {
                        await window.jamSubscriptionManager.refresh();
                    }

                    // Also refresh global subscription state if available
                    if (window.dispatchEvent) {
                        window.dispatchEvent(new CustomEvent('refreshSubscriptionData'));
                    }

                    hideTypingIndicator(container);

                    // Wait a moment then restart conversation with fresh data
                    setTimeout(() => {
                        this.clearChatHistory();
                        startSubscriptionAwareConversation(container);
                    }, 1000);

                } catch (error) {
                    console.error('‚ùå Error refreshing subscription:', error);
                    hideTypingIndicator(container);
                    addBotMessage("‚ùå Error refreshing subscription data. Please try again or contact support.");
                    updateMessagesDisplay(container);
                }
            }

            // NEW: Show uploaded report details
            async function showUploadedReportDetails(container) {
                try {
                    addBotMessage("üìä Let me get details about your uploaded reports...");
                    showTypingIndicator(container);

                    const hasReports = await checkForUploadedReports();
                    hideTypingIndicator(container);

                    if (hasReports.hasReports && hasReports.reports && hasReports.reports.length > 0) {
                        let detailsMessage = `üìÑ **Your Uploaded Reports:**\n\n`;

                        hasReports.reports.forEach((report, index) => {
                            const uploadDate = new Date(report.createdAt).toLocaleDateString();
                            detailsMessage += `${index + 1}. **${report.fileName}**\n`;
                            if (report.bureau) detailsMessage += `   Bureau: ${report.bureau}\n`;
                            detailsMessage += `   Uploaded: ${uploadDate}\n`;
                            detailsMessage += `   Status: Ready for analysis\n\n`;
                        });

                        detailsMessage += `Ready to analyze these reports for dispute opportunities?`;

                        addBotMessageWithButtons(detailsMessage, [
                            { text: "‚úÖ Yes, analyze now", value: "analyze_reports" },
                            { text: "üì§ Upload more reports", value: "no_reports_uploaded" },
                            { text: "üí¨ Ask questions first", value: "general_chat_mode" },
                            { text: "üîÑ Back", value: "check_for_reports" }
                        ]);
                    } else {
                        addBotMessage("‚ùå No report details found. Please upload your reports first.");
                    }

                    updateMessagesDisplay(container);
                } catch (error) {
                    console.error('‚ùå Error showing report details:', error);
                    hideTypingIndicator(container);
                    addBotMessage("‚ùå Error getting report details. Please try again.");
                    updateMessagesDisplay(container);
                }
            }

            function formatMessageContent(content) {
                if (!content) return '';
                content = content.replace(
                    /(https?:\/\/[^\s]+)/g,
                    '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
                );
                content = content.replace(/\n/g, '<br>');
                return content;
            }

            function formatSize(bytes) {
                if (bytes < 1024) return bytes + ' bytes';
                else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
                else return (bytes / 1048576).toFixed(1) + ' MB';
            }

            function formatCategoryName(category) {
                const categoryMap = {
                    'personal_info': 'Personal Information',
                    'account_status': 'Account Status',
                    'payment_history': 'Payment History',
                    'duplicates': 'Duplicate Accounts',
                    'inquiries': 'Credit Inquiries',
                    'public_records': 'Public Records',
                    'collections': 'Collections',
                    'charge_offs': 'Charge-offs',
                    'late_payments': 'Late Payments',
                    'high_balances': 'High Balances',
                    'other': 'Other Issues'
                };
                return categoryMap[category] || category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            }

            // NEW: Smart categorization and impact calculation
            function calculateItemImpact(item) {
                let impact = 0;

                // Impact based on item type
                const typeImpacts = {
                    'collections': 80,
                    'charge_offs': 75,
                    'charge-offs': 75,
                    'late_payments': 60,
                    'payment_history': 60,
                    'public_records': 70,
                    'inquiries': 30,
                    'duplicates': 50,
                    'personal_info': 20,
                    'high_balances': 40,
                    'account_status': 45
                };

                const itemType = item.analysis_pass || item.issue_type || 'other';
                impact += typeImpacts[itemType] || 25;

                // Boost for high confidence
                if (item.confidence_level === 'high') impact += 20;
                if (item.confidence_level === 'medium') impact += 10;

                // Boost for specific dispute reasons
                const disputeReason = (item.dispute_reason || '').toLowerCase();
                if (disputeReason.includes('error') || disputeReason.includes('inaccurate')) impact += 15;
                if (disputeReason.includes('unverified') || disputeReason.includes('validation')) impact += 10;

                return Math.min(impact, 100); // Cap at 100
            }

            function groupItemsByImpactAndType(items) {
                if (!items || items.length === 0) return null;

                // Calculate impact for each item
                const itemsWithImpact = items.map(item => ({
                    ...item,
                    calculatedImpact: calculateItemImpact(item)
                }));

                // Group by impact level
                const highImpact = itemsWithImpact.filter(item => item.calculatedImpact >= 65);
                const mediumImpact = itemsWithImpact.filter(item => item.calculatedImpact >= 35 && item.calculatedImpact < 65);
                const lowImpact = itemsWithImpact.filter(item => item.calculatedImpact < 35);

                // Further group by type within each impact level
                const groupByType = (items) => {
                    const grouped = {};
                    items.forEach(item => {
                        const type = item.analysis_pass || item.issue_type || 'other';
                        if (!grouped[type]) {
                            grouped[type] = {
                                type: type,
                                displayName: formatCategoryName(type),
                                items: [],
                                avgImpact: 0
                            };
                        }
                        grouped[type].items.push(item);
                    });

                    // Calculate average impact for each type
                    Object.values(grouped).forEach(group => {
                        group.avgImpact = group.items.reduce((sum, item) => sum + item.calculatedImpact, 0) / group.items.length;
                        group.items.sort((a, b) => b.calculatedImpact - a.calculatedImpact);
                    });

                    return Object.values(grouped).sort((a, b) => b.avgImpact - a.avgImpact);
                };

                return {
                    high_impact: {
                        level: 'High Impact',
                        description: 'Biggest score boost potential',
                        emoji: 'üéØ',
                        items: highImpact,
                        groups: groupByType(highImpact),
                        totalItems: highImpact.length
                    },
                    medium_impact: {
                        level: 'Medium Impact',
                        description: 'Moderate score improvement',
                        emoji: 'üìä',
                        items: mediumImpact,
                        groups: groupByType(mediumImpact),
                        totalItems: mediumImpact.length
                    },
                    low_impact: {
                        level: 'Low Impact',
                        description: 'Small but worthwhile gains',
                        emoji: 'üìà',
                        items: lowImpact,
                        groups: groupByType(lowImpact),
                        totalItems: lowImpact.length
                    }
                };
            }

            function calculateScoreImpact(selectedCount) {
                // Rough estimate: each high-impact item could boost score 10-30 points
                return Math.min(selectedCount * 15, 150);
            }

            // NEW: Conversation flow functions
            function startDisputeConversationFlow(container) {
                if (!currentAnalysisData || !currentAnalysisData.extractedItems) {
                    addBotMessage("I don't have any analysis data. Please analyze your reports first.");
                    return;
                }

                // Initialize conversation state
                conversationState.groupedItems = groupItemsByImpactAndType(currentAnalysisData.extractedItems);
                conversationState.phase = 'overview';
                conversationState.selectedItems = [];
                conversationState.skippedItems = [];
                conversationState.completedCategories = [];

                showDisputeOverview(container);
            }

            function showDisputeOverview(container) {
                const grouped = conversationState.groupedItems;
                if (!grouped) return;

                const totalItems = currentAnalysisData.extractedItems.length;

                addBotMessageWithButtons(
                    `üéØ **Strategic Dispute Plan**
                    
                    I found **${totalItems} potential dispute items**. Let's be smart about this!
                    
                    üìä **Impact Breakdown:**
                    ‚Ä¢ ${grouped.high_impact.emoji} **${grouped.high_impact.totalItems} High Impact** - ${grouped.high_impact.description}
                    ‚Ä¢ ${grouped.medium_impact.emoji} **${grouped.medium_impact.totalItems} Medium Impact** - ${grouped.medium_impact.description}  
                    ‚Ä¢ ${grouped.low_impact.emoji} **${grouped.low_impact.totalItems} Low Impact** - ${grouped.low_impact.description}
                    
                    üí° **My Recommendation:** Start with high-impact items for maximum score improvement!`,
                    [
                        { text: `üéØ Start with High Impact (${grouped.high_impact.totalItems})`, value: "start_high_impact" },
                        { text: "üìã See All Categories", value: "show_all_categories" },
                        { text: "ü§î Explain Impact Levels", value: "explain_impact_levels" },
                        { text: "‚ö° Quick Auto-Select", value: "auto_select_best" }
                    ]
                );

                updateMessagesDisplay(container);
                saveState();
            }

            function showImpactLevelExplanation(container) {
                addBotMessageWithButtons(
                    `üéì **Understanding Impact Levels**
                    
                    **üéØ High Impact (65+ points)**
                    Collections, charge-offs, major derogatory marks
                    *Potential: +15-30 credit score points each*
                    
                    **üìä Medium Impact (35-64 points)**  
                    Late payments, inquiries, account errors
                    *Potential: +5-15 credit score points each*
                    
                    **üìà Low Impact (Under 35 points)**
                    Personal info errors, minor discrepancies  
                    *Potential: +2-8 credit score points each*
                    
                    üí∞ **Smart Strategy:** Focus on high-impact items first for fastest results!`,
                    [
                        { text: "üéØ Got it! Start with High Impact", value: "start_high_impact" },
                        { text: "üîÑ Back to Overview", value: "back_to_overview" }
                    ]
                );

                updateMessagesDisplay(container);
                saveState();
            }

            function showImpactCategory(impactLevel, container) {
                const grouped = conversationState.groupedItems;
                const category = grouped[impactLevel];

                if (!category || category.totalItems === 0) {
                    addBotMessage(`No items found in the ${category?.level || impactLevel} category.`);
                    updateMessagesDisplay(container);
                    return;
                }

                conversationState.phase = 'category';
                conversationState.currentCategory = impactLevel;

                let message = `${category.emoji} **${category.level} Items (${category.totalItems} total)**\n\n`;
                message += `${category.description}\n\n`;

                if (category.groups.length > 0) {
                    message += `**Categories to review:**\n\n`;
                    category.groups.forEach((group, index) => {
                        const avgImpact = Math.round(group.avgImpact);
                        message += `${getTypeEmoji(group.type)} **${group.displayName}** (${group.items.length} items, ~${avgImpact} impact)\n`;
                    });
                } else {
                    message += `No items available in this category.`;
                }

                const buttons = [];

                if (category.groups.length > 0) {
                    // Add buttons for each category group
                    category.groups.slice(0, 3).forEach(group => { // Limit to top 3 groups
                        buttons.push({
                            text: `${getTypeEmoji(group.type)} ${group.displayName} (${group.items.length})`,
                            value: `review_group_${impactLevel}_${group.type}`
                        });
                    });

                    if (category.groups.length > 3) {
                        buttons.push({ text: "üìã See More Categories", value: `show_more_groups_${impactLevel}` });
                    }
                }

                buttons.push({ text: "üîÑ Back to Overview", value: "back_to_overview" });

                addBotMessageWithButtons(message, buttons);
                updateMessagesDisplay(container);
                saveState();
            }

            function reviewItemGroup(impactLevel, groupType, container) {
                const grouped = conversationState.groupedItems;
                const category = grouped[impactLevel];
                const group = category.groups.find(g => g.type === groupType);

                if (!group || group.items.length === 0) {
                    addBotMessage("No items found in this group.");
                    updateMessagesDisplay(container);
                    return;
                }

                conversationState.phase = 'item_review';
                conversationState.currentItemIndex = 0;

                showItemForReview(group.items, 0, impactLevel, groupType, container);
            }

            function showItemForReview(items, index, impactLevel, groupType, container) {
                if (index >= items.length) {
                    // Finished reviewing this group
                    showGroupCompletionSummary(impactLevel, groupType, container);
                    return;
                }

                const item = items[index];
                const isFirst = index === 0;
                const isLast = index === items.length - 1;

                let message = '';

                if (isFirst) {
                    const grouped = conversationState.groupedItems;
                    const category = grouped[impactLevel];
                    const group = category.groups.find(g => g.type === groupType);
                    message += `${getTypeEmoji(groupType)} **${group.displayName} Review**\n\n`;
                }

                message += `**Item ${index + 1} of ${items.length}**\n\n`;
                message += `üè¢ **Creditor:** ${item.creditor_name || 'Unknown'}\n`;
                message += `üí≥ **Account:** ${item.account_number || 'N/A'}\n`;
                if (item.amount) message += `üí∞ **Amount:** $${item.amount}\n`;
                message += `‚ö†Ô∏è **Issue:** ${item.dispute_reason || 'General dispute'}\n`;
                message += `üéØ **Impact Score:** ${Math.round(item.calculatedImpact)}/100\n\n`;

                message += `**üí° Why dispute this:**\n${getDisputeStrategy(groupType)}\n\n`;
                message += `**üìà Success Rate:** ${getSuccessRate(groupType)}`;

                const buttons = [
                    { text: "‚úÖ Yes, dispute this", value: `select_item_${item.id || index}_${impactLevel}_${groupType}` },
                    { text: "‚ùì Need more info", value: `explain_item_${item.id || index}_${impactLevel}_${groupType}` },
                    { text: "‚è≠Ô∏è Skip this one", value: `skip_item_${item.id || index}_${impactLevel}_${groupType}` }
                ];

                if (!isLast) {
                    buttons.push({ text: `‚èØÔ∏è Select All Remaining (${items.length - index})`, value: `select_all_remaining_${impactLevel}_${groupType}` });
                }

                addBotMessageWithButtons(message, buttons);
                updateMessagesDisplay(container);
                saveState();
            }

            function getTypeEmoji(type) {
                const emojiMap = {
                    'collections': 'üè¶',
                    'charge_offs': 'üí≥',
                    'charge-offs': 'üí≥',
                    'late_payments': '‚è∞',
                    'payment_history': '‚è∞',
                    'inquiries': 'üîç',
                    'duplicates': 'üë•',
                    'personal_info': 'üë§',
                    'public_records': 'üìã',
                    'high_balances': 'üí∞',
                    'account_status': 'üìä',
                    'other': 'üìÑ'
                };
                return emojiMap[type] || 'üìÑ';
            }

            function getDisputeStrategy(type) {
                const strategies = {
                    'collections': 'Request debt validation - they must prove this debt is yours and accurate',
                    'charge_offs': 'Challenge accuracy of dates, amounts, or account status',
                    'charge-offs': 'Challenge accuracy of dates, amounts, or account status',
                    'late_payments': 'Request goodwill removal or dispute inaccurate payment dates',
                    'payment_history': 'Verify payment dates and amounts for accuracy',
                    'inquiries': 'Challenge unauthorized credit pulls or outdated inquiries',
                    'duplicates': 'Request removal of duplicate accounts reporting the same debt',
                    'personal_info': 'Correct inaccurate personal information affecting your profile',
                    'public_records': 'Verify accuracy of court records and dates',
                    'high_balances': 'Dispute incorrect balance amounts or account limits'
                };
                return strategies[type] || 'Challenge the accuracy and completeness of this item';
            }

            function getSuccessRate(type) {
                const rates = {
                    'collections': '65%',
                    'charge_offs': '55%',
                    'charge-offs': '55%',
                    'late_payments': '45%',
                    'payment_history': '50%',
                    'inquiries': '75%',
                    'duplicates': '80%',
                    'personal_info': '90%',
                    'public_records': '60%',
                    'high_balances': '70%'
                };
                return rates[type] || '60%';
            }

            function showGroupCompletionSummary(impactLevel, groupType, container) {
                const grouped = conversationState.groupedItems;
                const category = grouped[impactLevel];
                const group = category.groups.find(g => g.type === groupType);

                const selectedFromGroup = conversationState.selectedItems.filter(item =>
                    (item.analysis_pass === groupType || item.issue_type === groupType) &&
                    item.calculatedImpact >= (impactLevel === 'high_impact' ? 65 : impactLevel === 'medium_impact' ? 35 : 0)
                );

                let message = `‚úÖ **${group.displayName} Complete!**\n\n`;
                message += `üìä **Results:** ${selectedFromGroup.length}/${group.items.length} items selected for dispute\n`;
                message += `üìà **Potential Impact:** +${selectedFromGroup.length * 15} credit score points\n\n`;

                // Show next steps
                const remainingGroups = category.groups.filter(g =>
                    !conversationState.completedCategories.includes(`${impactLevel}_${g.type}`)
                );

                const buttons = [];

                if (remainingGroups.length > 1) {
                    const nextGroup = remainingGroups.find(g => g.type !== groupType);
                    if (nextGroup) {
                        buttons.push({
                            text: `‚ñ∂Ô∏è Next: ${nextGroup.displayName} (${nextGroup.items.length})`,
                            value: `review_group_${impactLevel}_${nextGroup.type}`
                        });
                    }
                }

                buttons.push({ text: "üìä Show Progress Summary", value: "show_progress" });
                buttons.push({ text: "üîÑ Back to Categories", value: `show_impact_${impactLevel}` });

                if (conversationState.selectedItems.length > 0) {
                    buttons.push({ text: "üìÑ Generate Dispute Letters", value: "generate_letters" });
                }

                // Mark this group as completed
                conversationState.completedCategories.push(`${impactLevel}_${groupType}`);

                addBotMessageWithButtons(message, buttons);
                updateMessagesDisplay(container);
                saveState();
            }

            function showProgress(container) {
                const total = currentAnalysisData.extractedItems.length;
                const reviewed = conversationState.selectedItems.length + conversationState.skippedItems.length;
                const selected = conversationState.selectedItems.length;
                const scoreImpact = calculateScoreImpact(selected);

                // Break down by category
                const grouped = conversationState.groupedItems;
                let breakdown = '';

                ['high_impact', 'medium_impact', 'low_impact'].forEach(level => {
                    const category = grouped[level];
                    const selectedFromCategory = conversationState.selectedItems.filter(item => {
                        const impact = item.calculatedImpact;
                        return level === 'high_impact' ? impact >= 65 :
                            level === 'medium_impact' ? (impact >= 35 && impact < 65) :
                                impact < 35;
                    });

                    breakdown += `‚Ä¢ ${category.emoji} ${category.level}: ${selectedFromCategory.length}/${category.totalItems} selected\n`;
                });

                let message = `üìä **Your Dispute Progress**\n\n`;
                message += `‚úÖ **Reviewed:** ${reviewed}/${total} items\n`;
                message += `üéØ **Selected for dispute:** ${selected} items\n`;
                message += `üìà **Potential score boost:** +${scoreImpact} points\n\n`;
                message += `**Breakdown:**\n${breakdown}\n`;
                message += `üí™ Keep going! You're making excellent progress!`;

                const buttons = [];

                if (reviewed < total) {
                    buttons.push({ text: "‚ñ∂Ô∏è Continue Reviewing", value: "continue_review" });
                }

                if (selected > 0) {
                    buttons.push({ text: "üìÑ Generate Letters Now", value: "generate_letters" });
                }

                buttons.push({ text: "üîÑ Back to Overview", value: "back_to_overview" });

                addBotMessageWithButtons(message, buttons);
                updateMessagesDisplay(container);
                saveState();
            }

            // Private core functions
            function addBotMessage(content, buttons = null) {
                const message = {
                    id: Date.now() + Math.random(),
                    type: 'bot',
                    content: content,
                    timestamp: new Date().toISOString(),
                    buttons: buttons
                };
                messages.push(message);
                return message;
            }

            function addUserMessage(content) {
                const message = {
                    id: Date.now() + Math.random(),
                    type: 'user',
                    content: content,
                    timestamp: new Date().toISOString()
                };
                messages.push(message);
                return message;
            }

            function addBotMessageWithButtons(content, buttons) {
                return addBotMessage(content, buttons);
            }

            function showTypingIndicator(container) {
                const messagesContainer = container.querySelector('.Bot-chat-messages');
                if (!messagesContainer) return;

                hideTypingIndicator(container);

                typingIndicator = document.createElement('div');
                typingIndicator.className = 'Bot-message bot typing-indicator';
                typingIndicator.innerHTML = `
                    <div class="Bot-message-avatar">ü§ñ</div>
                    <div class="Bot-message-content">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                `;

                messagesContainer.appendChild(typingIndicator);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            function hideTypingIndicator(container) {
                if (typingIndicator) {
                    typingIndicator.remove();
                    typingIndicator = null;
                }
            }

            function renderChatInterface(container) {
                const chatHtml = `
                    <div class="Bot-chat-container">
                        <div class="Bot-chat-messages" id="Bot-chat-messages"></div>
                    </div>
                `;

                container.innerHTML = chatHtml;
                // No need for event listeners since we're removing the input interface
            }

            function setupChatEventListeners(container) {
                const input = container.querySelector('#Bot-chat-input');
                const sendButton = container.querySelector('#Bot-chat-send');

                if (input && sendButton) {
                    input.addEventListener('input', function () {
                        sendButton.disabled = !this.value.trim();
                        this.style.height = 'auto';
                        this.style.height = Math.min(this.scrollHeight, 100) + 'px';
                    });

                    input.addEventListener('keydown', function (e) {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            if (this.value.trim()) {
                                sendMessage(this.value.trim(), container);
                                this.value = '';
                                this.style.height = 'auto';
                                sendButton.disabled = true;
                            }
                        }
                    });

                    sendButton.addEventListener('click', function () {
                        const message = input.value.trim();
                        if (message) {
                            sendMessage(message, container);
                            input.value = '';
                            input.style.height = 'auto';
                            this.disabled = true;
                        }
                    });
                }
            }

            function sendMessage(message, container) {
                addUserMessage(message);
                updateMessagesDisplay(container);
                // Don't save - we want fresh conversations each time

                showTypingIndicator(container);

                setTimeout(() => {
                    hideTypingIndicator(container);
                    addBotMessage("I'm JAM Dispute Bot, and I'm here to help! Could you please be more specific about what you'd like assistance with regarding credit repair?");
                    updateMessagesDisplay(container);
                    // Don't save - we want fresh conversations each time
                }, 1500);
            }

            function updateMessagesDisplay(container) {
                const messagesContainer = container.querySelector('.Bot-chat-messages');
                if (!messagesContainer) return;

                const existingTyping = messagesContainer.querySelector('.typing-indicator');
                if (existingTyping) {
                    typingIndicator = existingTyping;
                }

                messagesContainer.innerHTML = '';

                messages.forEach(message => {
                    const messageElement = document.createElement('div');
                    messageElement.className = `Bot-message ${message.type}`;

                    if (message.type === 'bot') {
                        messageElement.innerHTML = `
                            <div class="Bot-message-avatar">ü§ñ</div>
                            <div class="Bot-message-content">
                                ${formatMessageContent(message.content)}
                                ${message.buttons ? renderMessageButtons(message.buttons) : ''}
                            </div>
                        `;
                    } else {
                        messageElement.innerHTML = `
                            <div class="Bot-message-content">${formatMessageContent(message.content)}</div>
                            <div class="Bot-message-avatar">üë§</div>
                        `;
                    }

                    messagesContainer.appendChild(messageElement);
                });

                if (typingIndicator) {
                    messagesContainer.appendChild(typingIndicator);
                }

                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            function renderMessageButtons(buttons) {
                if (!buttons || !Array.isArray(buttons)) return '';

                const buttonsHtml = buttons.map(button =>
                    `<button class="Bot-chat-button" onclick="ChatModule.handleButtonClick('${button.value}', this.closest('.Bot-chat-container'))">${button.text}</button>`
                ).join('');

                return `<div class="Bot-message-buttons">${buttonsHtml}</div>`;
            }

            function saveState(forceSave = false) {
                // UPDATED: Only save state if explicitly requested or during active conversation
                // Since we want fresh conversations each time, we won't auto-save
                if (!forceSave) {
                    debugLog('saveState', 'SKIPPED - Fresh conversations enabled');
                    return;
                }

                try {
                    localStorage.setItem('jamBotChatMessages', JSON.stringify(messages));
                    localStorage.setItem('jamBotChatState', JSON.stringify({
                        messages: messages,
                        currentAnalysisData: currentAnalysisData,
                        conversationState: conversationState,
                        timestamp: new Date().toISOString()
                    }));
                    debugLog('saveState', 'SUCCESS - State saved to localStorage');
                } catch (error) {
                    console.error('Error saving chat state:', error);
                }
            }

            function loadState() {
                try {
                    const savedMessages = localStorage.getItem('jamBotChatMessages');
                    const savedState = localStorage.getItem('jamBotChatState');

                    if (savedMessages) {
                        messages = JSON.parse(savedMessages);
                    }

                    if (savedState) {
                        const state = JSON.parse(savedState);
                        if (state.currentAnalysisData) {
                            currentAnalysisData = state.currentAnalysisData;
                        }
                        if (state.conversationState) {
                            // Restore conversation state
                            conversationState = {
                                ...conversationState,
                                ...state.conversationState
                            };
                        }
                        return true;
                    }
                } catch (error) {
                    console.error('Error loading chat state:', error);
                }
                return false;
            }

            async function checkForUploadedReports() {
                try {
                    console.log('üîç Checking for uploaded credit reports...');

                    // Try to get user identifier and ID
                    let userIdentifier = null;
                    let userId = null;

                    // Method 1: URL parameters
                    const urlParams = new URLSearchParams(window.location.search);
                    userIdentifier = urlParams.get('userEmail') || urlParams.get('email') || urlParams.get('user');

                    // Method 2: Check localStorage for user info (PRIMARY METHOD)
                    if (!userIdentifier) {
                        const savedUserData = localStorage.getItem('userData');
                        if (savedUserData) {
                            const userData = JSON.parse(savedUserData);
                            userIdentifier = userData.email || userData.userEmail;
                            userId = userData.id;
                            console.log('Found user identifier from userData:', userIdentifier);
                            console.log('Found user ID from userData:', userId);
                        }

                        // Fallback to old key name
                        if (!userIdentifier) {
                            const savedUserInfo = localStorage.getItem('jamBotUserInfo');
                            if (savedUserInfo) {
                                const userInfo = JSON.parse(savedUserInfo);
                                userIdentifier = userInfo.email || userInfo.userEmail;
                                userId = userInfo.id;
                                console.log('Found user identifier from jamBotUserInfo:', userIdentifier);
                            }
                        }
                    }

                    if (!userIdentifier || !userId) {
                        console.log('‚ùå No user identifier or ID found - no reports available');
                        return { hasReports: false, count: 0, reports: [], source: 'no_user' };
                    }

                    // Get auth token
                    const authToken = localStorage.getItem('authToken') ||
                        localStorage.getItem('token') ||
                        sessionStorage.getItem('authToken') ||
                        sessionStorage.getItem('token');

                    if (!authToken) {
                        console.log('‚ùå No auth token found - cannot check backend');
                        return { hasReports: false, count: 0, reports: [], source: 'no_auth' };
                    }

                    console.log('üåê Checking backend for reports with user ID:', userId);

                    // Make backend request to get user documents
                    const response = await fetch(`https://jam-capital-backend.azurewebsites.net/api/admin/get-user-documents?userId=${userId}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        console.log(`‚ùå Backend request failed with status: ${response.status}`);
                        return { hasReports: false, count: 0, reports: [], source: 'backend_failed' };
                    }

                    const result = await response.json();
                    console.log('üìä Backend response:', result);

                    // Filter for credit reports specifically
                    const creditReports = result.documents ?
                        result.documents.filter(doc => doc.documentType === 'credit-report') : [];

                    const reportCount = creditReports.length;

                    console.log(`‚úÖ Found ${reportCount} credit reports for user ${userIdentifier}`);
                    console.log('üìã Credit reports:', creditReports.map(r => ({
                        fileName: r.fileName,
                        bureau: r.bureau,
                        uploadedBy: r.uploadedBy,
                        createdAt: r.createdAt
                    })));

                    // Only return true if we have actual credit reports from backend
                    const hasActualReports = reportCount > 0;

                    return {
                        hasReports: hasActualReports,
                        count: reportCount,
                        reports: creditReports,
                        source: 'backend'
                    };

                } catch (error) {
                    console.error('‚ùå Error checking for uploaded reports:', error);

                    // For any errors, return false - we don't want to show the question if we can't verify
                    return {
                        hasReports: false,
                        count: 0,
                        reports: [],
                        source: 'error',
                        error: error.message
                    };
                }
            }

            async function analyzeBackendReports(container) {
                try {
                    console.log('=== ANALYZING BACKEND REPORTS ===');

                    // ENHANCED SUBSCRIPTION CHECK: Verify credits using global manager
                    const subscriptionStatus = await getGlobalSubscriptionStatus();
                    if (subscriptionStatus) {
                        const isFreeTier = subscriptionStatus.tier === 'free';
                        let actualRemaining = subscriptionStatus.remainingCredits;

                        // For free tier, calculate actual remaining based on usage
                        if (isFreeTier && subscriptionStatus.disputeLetterUsage) {
                            const totalGenerated = subscriptionStatus.disputeLetterUsage.totalLettersGenerated || 0;
                            const freeTrialLimit = 2;
                            actualRemaining = Math.max(0, freeTrialLimit - totalGenerated);
                        }

                        console.log('üìä Analysis subscription check:', {
                            tier: subscriptionStatus.tier,
                            isFreeTier: isFreeTier,
                            remainingCredits: subscriptionStatus.remainingCredits,
                            actualRemaining: actualRemaining
                        });

                        // Block analysis if no credits remaining
                        if (actualRemaining === 0) {
                            hideTypingIndicator(container);

                            let subscriptionMessage = `üîí **Analysis Blocked - No Credits Remaining**\n\n`;
                            subscriptionMessage += `You've used all your dispute letter credits (${isFreeTier ? 'lifetime' : 'monthly'} limit).\n\n`;
                            subscriptionMessage += `üí° **To analyze credit reports and generate dispute letters:**\n`;
                            subscriptionMessage += `‚Ä¢ Upgrade to a paid plan\n`;
                            subscriptionMessage += `‚Ä¢ Get unlimited analysis\n`;
                            subscriptionMessage += `‚Ä¢ Access professional dispute strategies\n`;
                            subscriptionMessage += `‚Ä¢ Higher success rates\n\n`;
                            subscriptionMessage += `Ready to boost your credit score?`;

                            addBotMessageWithButtons(subscriptionMessage, [
                                { text: "üöÄ Upgrade Now", value: "upgrade_subscription" },
                                { text: "üìã View Plans", value: "view_plans" },
                                { text: "üí¨ Ask Questions Instead", value: "general_chat_mode" },
                                { text: "üîÑ Check Credits Again", value: "refresh_subscription" }
                            ]);

                            updateMessagesDisplay(container);
                            saveState();
                            return;
                        } else if (isFreeTier && actualRemaining > 0) {
                            // Show warning for free tier users
                            addBotMessage(`üí° **Free Trial Notice:** You have ${actualRemaining} dispute letters remaining. This analysis will help target the best items to dispute for maximum credit score impact.`);
                            updateMessagesDisplay(container);
                        }
                    }

                    // Legacy fallback check for compatibility
                    const parentBot = window.jamTipBot || window.parent?.jamTipBot;
                    if (parentBot && typeof parentBot.checkBeforeExpensiveOperation === 'function') {
                        const canProceed = parentBot.checkBeforeExpensiveOperation('credit_analysis');
                        if (!canProceed) {
                            hideTypingIndicator(container);

                            addBotMessageWithButtons("üîí **Analysis Requires Credits**\n\nYou need dispute letter credits to analyze reports. Please upgrade your subscription.", [
                                { text: "üöÄ Upgrade Now", value: "upgrade_subscription" },
                                { text: "üìã View Plans", value: "view_plans" },
                                { text: "‚ùå Cancel", value: "cancel_analysis" }
                            ]);

                            updateMessagesDisplay(container);
                            saveState();
                            return;
                        }
                    }

                    // Try to get user email from multiple sources
                    let userEmail = null;

                    // Method 1: URL parameters
                    const urlParams = new URLSearchParams(window.location.search);
                    userEmail = urlParams.get('userEmail') || urlParams.get('email');

                    // Method 2: Check localStorage for userData (PRIMARY METHOD)
                    if (!userEmail) {
                        const savedUserData = localStorage.getItem('userData');
                        if (savedUserData) {
                            const userData = JSON.parse(savedUserData);
                            userEmail = userData.email;
                            console.log('Found user email from userData:', userEmail);
                        }
                    }

                    // Method 3: Fallback to old localStorage key
                    if (!userEmail) {
                        const savedUserInfo = localStorage.getItem('jamBotUserInfo');
                        if (savedUserInfo) {
                            const userInfo = JSON.parse(savedUserInfo);
                            userEmail = userInfo.email || userInfo.userEmail;
                            console.log('Found user email from jamBotUserInfo:', userEmail);
                        }
                    }

                    if (!userEmail) {
                        console.error('No user email found in URL parameters or localStorage');
                        hideTypingIndicator(container);
                        addBotMessage("I couldn't identify your account. Please refresh the page and try again.");
                        updateMessagesDisplay(container);
                        saveState();
                        return;
                    }

                    console.log('Analyzing reports for user:', userEmail);

                    // ENHANCED: Show progressive analysis with educational content
                    hideTypingIndicator(container);
                    showProgressiveAnalysis(container, userEmail);

                } catch (error) {
                    console.error('=== ANALYSIS ERROR ===', error);

                    hideTypingIndicator(container);

                    let errorMessage = "I encountered an error while analyzing your reports. ";

                    if (error.message.includes('404')) {
                        errorMessage += "It looks like you haven't uploaded any credit reports yet. Please upload your reports in the Reports tab first.";
                    } else if (error.message.includes('500')) {
                        errorMessage += "There was a server error. Please try again in a few moments.";
                    } else {
                        errorMessage += "Please try again or contact support if the problem persists.";
                    }

                    addBotMessage(errorMessage);
                    updateMessagesDisplay(container);
                    saveState();

                    debugLog('analyzeBackendReports', 'ERROR', { error: error.message });
                }
            }

            // NEW: Progressive analysis with educational content and status updates
            async function showProgressiveAnalysis(container, userEmail) {
                const steps = [
                    {
                        message: "üîç **Starting Deep Analysis...**\n\nI'm examining your credit reports line by line to identify potential disputes.",
                        duration: 2000,
                        tip: "üí° **Did you know?** The Fair Credit Reporting Act gives you the right to dispute any inaccurate information on your credit reports."
                    },
                    {
                        message: "üìä **Scanning Personal Information...**\n\nChecking for incorrect names, addresses, employment, or other personal details.",
                        duration: 2500,
                        tip: "‚ö° **Quick Tip:** Personal information errors are often the easiest disputes to win - 90% success rate!"
                    },
                    {
                        message: "üí≥ **Analyzing Account Data...**\n\nReviewing payment histories, balances, and account statuses for inconsistencies.",
                        duration: 3000,
                        tip: "üìà **Impact:** Removing just one collection account can boost your score by 20-50 points!"
                    },
                    {
                        message: "üè¶ **Cross-Referencing Creditors...**\n\nComparing information across all three bureaus to find discrepancies.",
                        duration: 2500,
                        tip: "üéØ **Strategy:** Different bureaus often have different information - we can dispute mismatches!"
                    },
                    {
                        message: "‚öñÔ∏è **Checking Legal Compliance...**\n\nVerifying dates, amounts, and account details meet legal reporting standards.",
                        duration: 3500,
                        tip: "üìö **Fact:** Credit bureaus must remove items they can't verify within 30 days of your dispute."
                    },
                    {
                        message: "üî¨ **AI Pattern Recognition...**\n\nUsing advanced algorithms to identify subtle errors and opportunities.",
                        duration: 3000,
                        tip: "ü§ñ **AI Power:** Our system catches errors human eyes might miss, like inconsistent reporting patterns."
                    },
                    {
                        message: "üìã **Compiling Dispute Opportunities...**\n\nPrioritizing items by impact potential and success probability.",
                        duration: 2000,
                        tip: "üéØ **Smart Strategy:** We focus on high-impact items first for maximum score improvement!"
                    }
                ];

                let currentStep = 0;
                let progressMessageId = null;

                // Function to update the progress message
                const updateProgress = () => {
                    if (currentStep < steps.length) {
                        const step = steps[currentStep];
                        const progressPercent = Math.round(((currentStep + 1) / steps.length) * 100);

                        let progressMessage = `${step.message}\n\n`;
                        progressMessage += `üìä **Progress:** ${progressPercent}% Complete\n\n`;
                        progressMessage += `${step.tip}\n\n`;

                        // Add visual progress bar
                        const filledBars = Math.floor(progressPercent / 10);
                        const emptyBars = 10 - filledBars;
                        const progressBar = 'üü¶'.repeat(filledBars) + '‚¨ú'.repeat(emptyBars);
                        progressMessage += `${progressBar} ${progressPercent}%`;

                        if (progressMessageId) {
                            // Update the existing message
                            const existingMessage = messages.find(msg => msg.id === progressMessageId);
                            if (existingMessage) {
                                existingMessage.content = progressMessage;
                            }
                        } else {
                            // Create new progress message
                            const message = addBotMessage(progressMessage);
                            progressMessageId = message.id;
                        }

                        updateMessagesDisplay(container);
                        currentStep++;

                        // Schedule next update
                        setTimeout(updateProgress, step.duration);
                    } else {
                        // All steps complete, now perform actual analysis
                        performActualAnalysis(userEmail, container, progressMessageId);
                    }
                };

                // Start the progress updates
                updateProgress();
            }

            // NEW: Continuous waiting animation for API processing
            let waitingInterval = null;
            let waitingMessageId = null;
            let waitingTipIndex = 0;

            const waitingTips = [
                "üîç **Deep Scanning:** Analyzing every line of your credit reports for inaccuracies...",
                "‚öñÔ∏è **Legal Review:** Checking compliance with Fair Credit Reporting Act standards...",
                "üéØ **Strategy Building:** Calculating the best dispute approach for maximum impact...",
                "üìä **Impact Analysis:** Determining which items will boost your score the most...",
                "üî¨ **AI Processing:** Using machine learning to identify subtle reporting errors...",
                "üí° **Opportunity Detection:** Finding dispute opportunities you might have missed...",
                "üìà **Score Modeling:** Predicting your potential credit score improvements...",
                "üõ°Ô∏è **Validation Check:** Ensuring all dispute reasons meet legal requirements...",
                "üé™ **Final Assembly:** Compiling your personalized dispute strategy..."
            ];

            async function startContinuousWaiting(container, originalProgressMessageId) {
                // Create initial waiting message
                const waitingMessage = addBotMessage(
                    "‚è≥ **Processing Your Analysis...**\n\nThis may take a moment as we thoroughly examine your credit reports.\n\nüîç **Deep Scanning:** Analyzing every line of your credit reports for inaccuracies...\n\n" +
                    "üü¶üü¶üü¶‚¨ú‚¨ú‚¨ú‚¨ú‚¨ú‚¨ú‚¨ú Processing..."
                );
                waitingMessageId = waitingMessage.id;
                updateMessagesDisplay(container);

                // Start continuous updates every 3 seconds
                waitingInterval = setInterval(() => {
                    if (waitingMessageId) {
                        waitingTipIndex = (waitingTipIndex + 1) % waitingTips.length;
                        const currentTip = waitingTips[waitingTipIndex];

                        // Create animated progress bars
                        const progressBarOptions = [
                            "üü¶üü¶üü¶üü¶‚¨ú‚¨ú‚¨ú‚¨ú‚¨ú‚¨ú",
                            "üü¶üü¶üü¶üü¶üü¶üü¶‚¨ú‚¨ú‚¨ú‚¨ú",
                            "üü¶üü¶üü¶üü¶üü¶üü¶üü¶üü¶‚¨ú‚¨ú",
                            "üü¶üü¶üü¶üü¶üü¶üü¶üü¶üü¶üü¶üü¶"
                        ];
                        const progressBar = progressBarOptions[waitingTipIndex % progressBarOptions.length];

                        const updatedMessage = "‚è≥ **Processing Your Analysis...**\n\nThis may take a moment as we thoroughly examine your credit reports.\n\n" +
                            currentTip + "\n\n" +
                            progressBar + " Processing...";

                        const existingMessage = messages.find(msg => msg.id === waitingMessageId);
                        if (existingMessage) {
                            existingMessage.content = updatedMessage;
                            updateMessagesDisplay(container);
                        }
                    }
                }, 3000);

                return waitingMessageId;
            }

            function stopContinuousWaiting() {
                if (waitingInterval) {
                    clearInterval(waitingInterval);
                    waitingInterval = null;
                }

                if (waitingMessageId) {
                    // Update the waiting message to show completion
                    const existingMessage = messages.find(msg => msg.id === waitingMessageId);
                    if (existingMessage) {
                        existingMessage.content = "‚úÖ **Analysis Processing Complete!**\n\nGenerating your comprehensive dispute strategy...\n\nüü¶üü¶üü¶üü¶üü¶üü¶üü¶üü¶üü¶üü¶ Complete!";
                    }
                    waitingMessageId = null;
                }

                // Reset the tip index for next time
                waitingTipIndex = 0;
            }

            // NEW: Perform the actual analysis call
            async function performActualAnalysis(userEmail, container, progressMessageId) {
                try {
                    // Final status update
                    const finalMessage = "üöÄ **Analysis Complete!**\n\nProcessing results and generating your personalized dispute strategy...\n\nüìä **Progress:** 100% Complete\n\n‚ú® **Almost done!** Preparing your comprehensive credit report analysis.";

                    if (progressMessageId) {
                        const existingMessage = messages.find(msg => msg.id === progressMessageId);
                        if (existingMessage) {
                            existingMessage.content = finalMessage;
                        }
                    }
                    updateMessagesDisplay(container);

                    // Small delay for dramatic effect
                    await new Promise(resolve => setTimeout(resolve, 1500));

                    // Start continuous waiting animation for the API processing
                    const waitingMessageId = await startContinuousWaiting(container, progressMessageId);

                    // Now make the actual API call
                    const response = await fetch(`https://jam-capital-backend.azurewebsites.net/api/chat/analyze?userEmail=${encodeURIComponent(userEmail)}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    console.log('Analysis request sent, response status:', response.status);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Server error:', errorText);
                        throw new Error(`Server error: ${response.status} - ${errorText}`);
                    }

                    const data = await response.json();

                    // Stop the continuous waiting animation
                    stopContinuousWaiting();

                    // Small delay to show completion animation
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    console.log('=== ANALYSIS RESPONSE DEBUG ===');
                    console.log('Response data keys:', Object.keys(data));
                    console.log('Response data.extractedItems exists:', !!data.extractedItems);
                    console.log('Response data.extractedItems length:', data.extractedItems?.length || 'N/A');

                    if (data.error) {
                        throw new Error(data.error);
                    }

                    // Store analysis results
                    currentAnalysisData = data;
                    localStorage.setItem('jamBotLastAnalysis', JSON.stringify(data));
                    localStorage.setItem('creditReportAnalysis', JSON.stringify(data));
                    localStorage.setItem('lastAnalysisData', JSON.stringify(data));

                    // Show results with enhanced presentation
                    showAnalysisResults(data, container, progressMessageId);

                    debugLog('performActualAnalysis', 'SUCCESS', { extractedItemsCount: data.extractedItems?.length });

                } catch (error) {
                    console.error('=== ANALYSIS ERROR ===', error);

                    // Stop the continuous waiting animation on error
                    stopContinuousWaiting();

                    let errorMessage = "‚ùå **Analysis Error**\n\nI encountered an error while analyzing your reports. ";

                    if (error.message.includes('404')) {
                        errorMessage += "It looks like you haven't uploaded any credit reports yet. Please upload your reports in the Reports tab first.";
                    } else if (error.message.includes('500')) {
                        errorMessage += "There was a server error. Please try again in a few moments.";
                    } else {
                        errorMessage += "Please try again or contact support if the problem persists.";
                    }

                    // Update the progress message to show error
                    if (progressMessageId) {
                        const existingMessage = messages.find(msg => msg.id === progressMessageId);
                        if (existingMessage) {
                            existingMessage.content = errorMessage;
                        }
                    } else {
                        addBotMessage(errorMessage);
                    }

                    updateMessagesDisplay(container);
                    saveState();

                    debugLog('performActualAnalysis', 'ERROR', { error: error.message });
                }
            }

            // NEW: Enhanced results presentation
            function showAnalysisResults(data, container, progressMessageId) {
                const itemCount = data.extractedItems?.length || 0;

                let resultsMessage = "üéâ **Analysis Complete!**\n\n";

                if (itemCount > 0) {
                    // Calculate potential impact
                    const estimatedScoreBoost = Math.min(itemCount * 12, 200);

                    resultsMessage += `‚úÖ **Found ${itemCount} Dispute Opportunities**\n\n`;
                    resultsMessage += `üìà **Potential Score Boost:** +${estimatedScoreBoost} points\n`;
                    resultsMessage += `‚ö° **Success Rate:** 65-85% (industry average)\n`;
                    resultsMessage += `‚è±Ô∏è **Timeline:** Results in 30-45 days\n\n`;

                    if (itemCount >= 50) {
                        resultsMessage += `üéØ **Wow!** That's a lot of opportunities (${itemCount} total). Let me help you tackle them strategically for maximum impact.`;
                    } else if (itemCount >= 20) {
                        resultsMessage += `üìä **Excellent!** I found ${itemCount} potential dispute items. Let's prioritize them for best results.`;
                    } else {
                        resultsMessage += `‚ú® **Great news!** I found ${itemCount} potential dispute items. Ready to boost your credit score?`;
                    }

                    // Update progress message with results
                    if (progressMessageId) {
                        const existingMessage = messages.find(msg => msg.id === progressMessageId);
                        if (existingMessage) {
                            existingMessage.content = resultsMessage;
                        }
                    } else {
                        addBotMessage(resultsMessage);
                    }

                    // Add strategy buttons
                    const buttons = [
                        { text: "üéØ Start Smart Dispute Guide", value: "start_dispute" },
                        { text: "üìä Show High Priority Items", value: "show_high_priority" },
                        { text: "‚ö° Auto-Select Best Items", value: "auto_select_best" },
                        { text: "üìÑ Generate All Letters Now", value: "view_letters" }
                    ];

                    // Additional context based on analysis
                    const analysisMessage = data.analysis || data.summary || '';
                    if (analysisMessage && analysisMessage.length > 10) {
                        addBotMessage(`üìã **Detailed Analysis:**\n\n${analysisMessage}`);
                    }

                    addBotMessageWithButtons(
                        "üöÄ **What would you like to do next?**\n\nI recommend starting with the Smart Dispute Guide for the best strategy!",
                        buttons
                    );

                } else {
                    resultsMessage += `‚úÖ **Great News!**\n\nI didn't find any items that appear to need disputing in your credit reports. Your reports look quite good!\n\n`;
                    resultsMessage += `üéØ **This means:**\n`;
                    resultsMessage += `‚Ä¢ Your credit information appears accurate\n`;
                    resultsMessage += `‚Ä¢ No obvious errors to dispute\n`;
                    resultsMessage += `‚Ä¢ Your credit management is on track\n\n`;
                    resultsMessage += `üí° **Keep up the good work!** Focus on maintaining low balances and making on-time payments.`;

                    // Update progress message with results
                    if (progressMessageId) {
                        const existingMessage = messages.find(msg => msg.id === progressMessageId);
                        if (existingMessage) {
                            existingMessage.content = resultsMessage;
                        }
                    } else {
                        addBotMessage(resultsMessage);
                    }
                }

                updateMessagesDisplay(container);
                saveState();
            }

            function handleButtonClick(value, container) {
                debugLog('handleButtonClick', 'STARTED', { value: value });

                console.log('Button clicked:', value);

                // Original handlers
                if (value === 'analyze_reports') {
                    console.log('User clicked to analyze reports');
                    addUserMessage("Yes, analyze my reports");
                    showTypingIndicator(container);
                    analyzeBackendReports(container);

                } else if (value === 'skip_analysis') {
                    addUserMessage("No, I'll ask something else");
                    addBotMessage("No problem! Feel free to ask me anything about credit repair, dispute letters, or any other questions you might have.");
                    updateMessagesDisplay(container);
                    saveState();

                } else if (value === 'check_for_reports') {
                    addUserMessage("üìä Check my credit reports");
                    handleReportCheckingFlow(container);

                } else if (value === 'no_reports_uploaded') {
                    addUserMessage("üì§ I need to upload reports first");
                    addBotMessage("No problem! Here's what you need to do:\n\nüìÑ **Step 1:** Go to the **Reports tab** and upload your credit reports from all three bureaus (Experian, Equifax, TransUnion)\n\nüîç **Step 2:** Come back to this chat and I'll analyze them for dispute opportunities\n\nüí° **Tip:** You can get free credit reports from annualcreditreport.com or through your credit monitoring service.");
                    updateMessagesDisplay(container);
                    saveState();

                } else if (value === 'general_chat_mode') {
                    addUserMessage("üí¨ I want to ask questions first");
                    showCreditRepairQuestions(container);

                } else if (value === 'learn_credit_repair') {
                    addUserMessage("üìö Teach me about credit repair");
                    showCreditRepairEducation(container);

                } else if (value === 'start_dispute') {
                    addUserMessage("Yes, let's start the dispute process");
                    startDisputeConversationFlow(container);

                } else if (value === 'show_high_priority') {
                    addUserMessage("Show me high priority items");
                    showHighPriorityItems(container);
                    updateMessagesDisplay(container);
                    saveState();

                } else if (value === 'show_all_items') {
                    addUserMessage("Show me all items");
                    showAllItems(container);
                    updateMessagesDisplay(container);
                    saveState();

                } else if (value === 'view_letters') {
                    addUserMessage("Yes, show me the letters");

                    // Add generated letters to the LettersModule if available
                    const savedLetters = localStorage.getItem('jamBotGeneratedLetters');
                    if (savedLetters) {
                        try {
                            const letters = JSON.parse(savedLetters);
                            console.log('Found generated letters:', letters.length);

                            // Convert ChatGPT generated letters to LettersModule format
                            letters.forEach((letter, index) => {
                                const formattedLetter = {
                                    id: `generated_${Date.now()}_${index}`,
                                    name: `Dispute Letter - ${letter.bureau || `Letter ${index + 1}`}`,
                                    content: letter.letter || letter.content,
                                    createdAt: new Date().toISOString(),
                                    bureau: letter.bureau,
                                    itemCount: letter.itemCount || 0
                                };

                                // Add to LettersModule via parent
                                if (parentModule && parentModule.addGeneratedLetter) {
                                    parentModule.addGeneratedLetter(formattedLetter);
                                }
                            });

                            addBotMessage("üéâ I've added your generated dispute letters to the Letters tab! Switching you over now...");

                        } catch (error) {
                            console.error('Error processing generated letters:', error);
                        }
                    } else {
                        addBotMessage("üéâ Switching you to the Letters tab to view your dispute letters...");
                    }

                    // Switch to letters tab - try multiple methods to ensure it works
                    if (parentModule && typeof parentModule.switchTab === 'function') {
                        setTimeout(() => {
                            parentModule.switchTab('letters');
                        }, 1500);
                    } else if (window.jamTipBot && typeof window.jamTipBot.switchTab === 'function') {
                        setTimeout(() => {
                            window.jamTipBot.switchTab('letters');
                        }, 1500);
                    } else {
                        // Fallback - try to trigger a custom event
                        setTimeout(() => {
                            window.dispatchEvent(new CustomEvent('switchToLettersTab'));
                        }, 1500);
                    }

                    updateMessagesDisplay(container);
                    saveState();

                } else if (value === 'start_high_impact') {
                    addUserMessage("üéØ Start with High Impact items");
                    showImpactCategory('high_impact', container);

                } else if (value === 'show_all_categories') {
                    addUserMessage("üìã Show me all categories");
                    showAllCategoriesOverview(container);

                } else if (value === 'explain_impact_levels') {
                    addUserMessage("ü§î Explain impact levels");
                    showImpactLevelExplanation(container);

                } else if (value === 'auto_select_best') {
                    addUserMessage("‚ö° Auto-select the best items");
                    autoSelectBestItems(container);

                } else if (value === 'back_to_overview') {
                    addUserMessage("üîÑ Back to overview");
                    showDisputeOverview(container);

                } else if (value.startsWith('show_impact_')) {
                    const impactLevel = value.replace('show_impact_', '');
                    addUserMessage(`Show ${impactLevel.replace('_', ' ')} items`);
                    showImpactCategory(impactLevel, container);

                } else if (value.startsWith('review_group_')) {
                    const parts = value.replace('review_group_', '').split('_');
                    const impactLevel = parts[0] + '_' + parts[1]; // high_impact, medium_impact, low_impact
                    const groupType = parts.slice(2).join('_'); // rejoin any underscores in group type
                    const grouped = conversationState.groupedItems;
                    const category = grouped[impactLevel];
                    const group = category.groups.find(g => g.type === groupType);

                    addUserMessage(`Review ${group ? group.displayName : groupType}`);
                    reviewItemGroup(impactLevel, groupType, container);

                } else if (value.startsWith('select_item_')) {
                    const parts = value.replace('select_item_', '').split('_');
                    const itemId = parts[0];
                    const impactLevel = parts[1] + '_' + parts[2];
                    const groupType = parts.slice(3).join('_');

                    selectItemForDispute(itemId, impactLevel, groupType, container);

                } else if (value.startsWith('skip_item_')) {
                    const parts = value.replace('skip_item_', '').split('_');
                    const itemId = parts[0];
                    const impactLevel = parts[1] + '_' + parts[2];
                    const groupType = parts.slice(3).join('_');

                    skipItem(itemId, impactLevel, groupType, container);

                } else if (value.startsWith('explain_item_')) {
                    const parts = value.replace('explain_item_', '').split('_');
                    const itemId = parts[0];
                    const impactLevel = parts[1] + '_' + parts[2];
                    const groupType = parts.slice(3).join('_');

                    explainItem(itemId, impactLevel, groupType, container);

                } else if (value.startsWith('select_all_remaining_')) {
                    const parts = value.replace('select_all_remaining_', '').split('_');
                    const impactLevel = parts[0] + '_' + parts[1];
                    const groupType = parts.slice(2).join('_');

                    selectAllRemainingItems(impactLevel, groupType, container);

                } else if (value === 'show_progress') {
                    addUserMessage("üìä Show my progress");
                    showProgress(container);

                } else if (value === 'continue_review') {
                    addUserMessage("‚ñ∂Ô∏è Continue reviewing");
                    continueReview(container);

                } else if (value === 'upgrade_subscription') {
                    addUserMessage("üöÄ Upgrade my subscription");

                    // Trigger parent module's upgrade interface
                    const parentBot = window.jamTipBot || window.parent?.jamTipBot;
                    if (parentBot && typeof parentBot.showUpgradeModal === 'function') {
                        parentBot.showUpgradeModal('free_trial_exhausted');
                    } else {
                        addBotMessage("Redirecting you to upgrade your subscription. This would integrate with Stripe or your payment processor.");
                    }
                    updateMessagesDisplay(container);
                    saveState();

                } else if (value === 'view_plans') {
                    addUserMessage("üìã View subscription plans");
                    showSubscriptionPlans(container);

                } else if (value === 'cancel_analysis') {
                    addUserMessage("‚ùå Cancel analysis");
                    addBotMessage("No problem! Feel free to ask me other questions about credit repair. When you're ready to analyze your reports and create dispute letters, just let me know!");
                    updateMessagesDisplay(container);
                    saveState();

                } else if (value === 'proceed_with_analysis') {
                    addUserMessage("‚úÖ Yes, proceed with analysis");
                    addBotMessage("Great! Starting your credit report analysis...");
                    showTypingIndicator(container);
                    // Continue with normal analysis flow
                    analyzeBackendReports(container);

                } else if (value === 'refresh_subscription') {
                    addUserMessage("üîÑ Check my credits again");
                    refreshSubscriptionAndRestart(container);

                } else if (value === 'show_report_details') {
                    addUserMessage("üìä Show me my report details first");
                    showUploadedReportDetails(container);

                } else if (value === 'restart_conversation') {
                    addUserMessage("üîÑ Start over");
                    this.restartConversation(container);

                } else if (value === 'generate_letters') {
                    addUserMessage("üìÑ Generate dispute letters");
                    generateDisputeLetters(container);

                } else if (value === 'download_letters') {
                    addUserMessage("üíæ Download my letters as PDF");
                    downloadGeneratedLetters(container);

                } else if (value === 'email_letters') {
                    addUserMessage("üìß Email letters to me");
                    emailGeneratedLetters(container);

                } else if (value === 'show_final_summary') {
                    addUserMessage("üìä Show final summary");
                    showFinalDisputeSummary(container);

                } else if (value === 'restart_analysis') {
                    addUserMessage("üîÑ Start new analysis");
                    restartAnalysisProcess(container);

                    // NEW: User information collection handlers
                } else if (value === 'confirm_user_info') {
                    addUserMessage("‚úÖ Information is correct");
                    // Use existing user data and proceed with letter generation
                    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                    addBotMessage(`üìÑ Perfect! Generating dispute letters for ${conversationState.selectedItems.length} selected items with your confirmed information...`);
                    showTypingIndicator(container);
                    generateLettersFromBackend(conversationState.selectedItems, container);

                } else if (value === 'update_user_info') {
                    addUserMessage("‚úèÔ∏è I want to update my information");
                    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                    startUserInfoCollection(userData, container);

                } else if (value === 'confirm_user_info_and_generate') {
                    confirmUserInfoAndGenerate(container);

                } else if (value === 'edit_collected_info') {
                    editCollectedInfo(container);

                } else if (value === 'finish_editing_info') {
                    addUserMessage("‚úÖ Done editing information");
                    showCollectedUserInfoSummary(container);

                } else if (value.startsWith('edit_field_')) {
                    const field = value.replace('edit_field_', '');
                    editSpecificField(field, container);

                    // NEW: Subscription plan selection handlers
                } else if (value === 'select_starter_plan') {
                    addUserMessage("üíº I want the DIY Starter plan");
                    showPaymentModal('starter', container);

                } else if (value === 'select_professional_plan') {
                    addUserMessage("üöÄ I want the DIY Professional plan");
                    showPaymentModal('professional', container);

                } else if (value === 'select_premium_plan') {
                    addUserMessage("‚≠ê I want the DIY Premium plan");
                    showPaymentModal('premium', container);

                } else if (value === 'keep_free_plan') {
                    addUserMessage("üÜì I'll stay on the free plan");
                    addBotMessage("No problem! You'll stay on the free plan with your 2 lifetime dispute letters. Remember, you can upgrade anytime when you're ready for more features and letters.");
                    updateMessagesDisplay(container);
                    saveState();

                } else if (value === 'cancel_upgrade') {
                    addUserMessage("‚ùå Not now, maybe later");
                    addBotMessage("That's perfectly fine! I'm here whenever you need help with credit repair questions. Feel free to ask me anything about improving your credit score!");
                    updateMessagesDisplay(container);
                    saveState();

                    // NEW: Question-specific handlers
                } else if (value === 'explain_credit_scores') {
                    addUserMessage("üìä How do credit scores work?");
                    explainCreditScores(container);

                } else if (value === 'explain_credit_damage') {
                    addUserMessage("‚ö†Ô∏è What hurts my credit score the most?");
                    explainCreditDamage(container);

                } else if (value === 'explain_repair_strategies') {
                    addUserMessage("üõ†Ô∏è What are the best credit repair strategies?");
                    explainRepairStrategies(container);

                } else if (value === 'explain_credit_reports') {
                    addUserMessage("üìÑ Help me understand credit reports");
                    explainCreditReports(container);

                } else if (value === 'explain_dispute_letters') {
                    addUserMessage("‚úâÔ∏è Tell me about dispute letters");
                    explainDisputeLetters(container);

                } else if (value === 'explain_timeline') {
                    addUserMessage("‚è∞ How long does credit repair take?");
                    explainTimeline(container);

                } else if (value === 'explain_score_tips') {
                    addUserMessage("üìà How can I improve my credit score?");
                    explainScoreTips(container);

                } else if (value === 'explain_common_errors') {
                    addUserMessage("üîç What are common credit report errors?");
                    explainCommonErrors(container);

                } else if (value === 'explain_success_tips') {
                    addUserMessage("üìà How can I increase my success rate?");
                    explainSuccessTips(container);

                } else {
                    // Fallback for unhandled button clicks
                    console.log('Unhandled button click:', value);
                    addBotMessage("I didn't understand that action. Please try again or use the available buttons.");
                    updateMessagesDisplay(container);
                    saveState();
                }

                debugLog('handleButtonClick', 'COMPLETED', { value: value });
            }

            // NEW: Payment modal functions
            function showPaymentModal(planType, container) {
                console.log(`üí≥ Opening payment modal for plan: ${planType}`);

                const plan = PLAN_DETAILS[planType];
                if (!plan) {
                    console.error('Invalid plan type:', planType);
                    return;
                }

                selectedPlanType = planType;

                // Show confirmation in chat
                addBotMessage(`Perfect! Let me set up your ${plan.name} payment. Opening secure payment modal...`);
                updateMessagesDisplay(container);

                // Create and show modal
                setTimeout(() => {
                    createPaymentModal(planType, container);
                }, 500);
            }

            function createPaymentModal(planType, container) {
                const plan = PLAN_DETAILS[planType];

                // Remove existing modal if present
                const existingModal = document.getElementById('Bot-payment-modal');
                if (existingModal) {
                    existingModal.remove();
                }

                // Create modal element
                paymentModal = document.createElement('div');
                paymentModal.id = 'Bot-payment-modal';
                paymentModal.className = 'Bot-payment-modal';
                paymentModal.innerHTML = `
                    <div class="Bot-payment-modal-content">
                        <div class="Bot-payment-modal-header">
                            <h3>Complete Your ${plan.name} Purchase</h3>
                            <span class="Bot-payment-modal-close" onclick="ChatModule.closePaymentModal()">&times;</span>
                        </div>
                        <div class="Bot-payment-modal-body">
                            <div class="Bot-plan-summary">
                                <h4>${plan.name}</h4>
                                <div class="Bot-price-display">${plan.price}<span>/month</span></div>
                                <ul class="Bot-plan-features-summary">
                                    ${plan.features.slice(0, 5).map(feature => `
                                        <li><i class="fas fa-check"></i> ${feature}</li>
                                    `).join('')}
                                    ${plan.features.length > 5 ? '<li><i class="fas fa-plus"></i> And more...</li>' : ''}
                                </ul>
                            </div>
                            
                            <div class="Bot-payment-security">
                                <p><i class="fas fa-shield-alt"></i> Secure payment processing</p>
                                <p><i class="fas fa-lock"></i> 256-bit SSL encryption</p>
                            </div>
                            
                            <div class="Bot-payment-action-container">
                                <button class="Bot-proceed-payment-btn" onclick="ChatModule.proceedToPayment('${planType}')">
                                    <i class="fas fa-credit-card"></i>
                                    Proceed to Secure Payment
                                </button>
                                <p class="Bot-payment-note">You'll be redirected to our secure payment processor</p>
                            </div>
                            
                            <div class="Bot-payment-footer">
                                <p class="Bot-guarantee-text">
                                    <i class="fas fa-medal"></i> 
                                    30-day money-back guarantee
                                </p>
                                <button class="Bot-cancel-payment-btn" onclick="ChatModule.closePaymentModal()">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;

                // Add to document body (not container to ensure it's on top)
                document.body.appendChild(paymentModal);

                // Show modal with animation
                setTimeout(() => {
                    paymentModal.style.display = 'flex';
                }, 100);

                // Setup modal event listeners
                setupPaymentModalEventListeners();
            }

            function setupPaymentModalEventListeners() {
                // Close when clicking outside the modal content
                if (paymentModal) {
                    paymentModal.addEventListener('click', function (e) {
                        if (e.target === paymentModal) {
                            closePaymentModal();
                        }
                    });

                    // Close on Escape key
                    document.addEventListener('keydown', function handleEscape(e) {
                        if (e.key === 'Escape') {
                            closePaymentModal();
                            document.removeEventListener('keydown', handleEscape);
                        }
                    });
                }
            }

            function proceedToPayment(planType) {
                if (!PAYMENT_LINKS[planType]) {
                    console.error('No payment link found for plan:', planType);
                    return;
                }

                const plan = PLAN_DETAILS[planType];
                const proceedBtn = document.querySelector('.Bot-proceed-payment-btn');

                if (proceedBtn) {
                    // Show loading state
                    proceedBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Opening secure payment...';
                    proceedBtn.disabled = true;
                }

                // Open payment in new window
                const paymentWindow = window.open(
                    PAYMENT_LINKS[planType],
                    'payment',
                    'width=800,height=700,scrollbars=yes,resizable=yes,toolbar=no,menubar=no'
                );

                // Check if popup was blocked
                if (!paymentWindow || paymentWindow.closed || typeof paymentWindow.closed == 'undefined') {
                    // Popup blocked, show alternative
                    showPopupBlockedInModal(planType);
                } else {
                    // Monitor the payment window
                    monitorPaymentWindow(paymentWindow, planType);
                }
            }

            function showPopupBlockedInModal(planType) {
                if (!paymentModal || !PAYMENT_LINKS[planType]) return;

                const modalContent = paymentModal.querySelector('.Bot-payment-modal-content');
                if (modalContent) {
                    modalContent.innerHTML = `
                        <div class="Bot-payment-modal-header">
                            <h3>Complete Your Payment</h3>
                            <span class="Bot-payment-modal-close" onclick="ChatModule.closePaymentModal()">&times;</span>
                        </div>
                        <div class="Bot-payment-modal-body">
                            <div class="Bot-popup-blocked-message">
                                <i class="fas fa-exclamation-triangle" style="color: #ffc107; font-size: 3rem; margin-bottom: 1rem;"></i>
                                <h4>Popup Blocked</h4>
                                <p>Your browser blocked the payment window. Please:</p>
                                <ol>
                                    <li>Allow popups for this site, or</li>
                                    <li>Click the button below to open payment in a new tab</li>
                                </ol>
                                
                                <div class="Bot-payment-options">
                                    <a href="${PAYMENT_LINKS[planType]}" target="_blank" class="Bot-proceed-payment-btn">
                                        <i class="fas fa-external-link-alt"></i>
                                        Open Payment in New Tab
                                    </a>
                                    <button class="Bot-cancel-payment-btn" onclick="ChatModule.retryPayment('${planType}')">Try Again</button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            function monitorPaymentWindow(paymentWindow, planType) {
                const checkClosed = setInterval(function () {
                    if (paymentWindow.closed) {
                        clearInterval(checkClosed);
                        // Show completion message in modal
                        showPaymentCompletionInModal(planType);
                    }
                }, 1000);
            }

            function showPaymentCompletionInModal(planType) {
                if (!paymentModal) return;

                const modalContent = paymentModal.querySelector('.Bot-payment-modal-content');
                if (modalContent) {
                    modalContent.innerHTML = `
                        <div class="Bot-payment-modal-header">
                            <h3>Payment Status</h3>
                            <span class="Bot-payment-modal-close" onclick="ChatModule.closePaymentModal()">&times;</span>
                        </div>
                        <div class="Bot-payment-modal-body">
                            <div class="Bot-payment-status-message">
                                <i class="fas fa-info-circle" style="color: #09ccfc; font-size: 3rem; margin-bottom: 1rem;"></i>
                                <h4>Payment Window Closed</h4>
                                <p>If you completed your payment, you should receive a confirmation email shortly.</p>
                                <p>If you didn't complete the payment, you can try again anytime.</p>
                                
                                <div class="Bot-status-options">
                                    <button class="Bot-proceed-payment-btn" onclick="ChatModule.paymentCompleted('${planType}')">
                                        <i class="fas fa-check"></i>
                                        I Completed Payment
                                    </button>
                                    <button class="Bot-cancel-payment-btn" onclick="ChatModule.retryPayment('${planType}')">
                                        Try Payment Again
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            function paymentCompleted(planType) {
                const plan = PLAN_DETAILS[planType];

                if (!paymentModal) return;

                const modalContent = paymentModal.querySelector('.Bot-payment-modal-content');
                if (modalContent) {
                    modalContent.innerHTML = `
                        <div class="Bot-payment-modal-header">
                            <h3>Payment Successful!</h3>
                            <span class="Bot-payment-modal-close" onclick="ChatModule.closePaymentModal()">&times;</span>
                        </div>
                        <div class="Bot-payment-modal-body">
                            <div class="Bot-success-message">
                                <i class="fas fa-check-circle" style="color: #28a745; font-size: 3rem; margin-bottom: 1rem;"></i>
                                <h4>Thank you for your purchase!</h4>
                                <p>Your ${plan.name} is now active.</p>
                                <p>You now have access to all the tools and features included in your plan.</p>
                                <p>You should receive a confirmation email with login instructions shortly.</p>
                                <button class="Bot-proceed-payment-btn" onclick="ChatModule.closePaymentModal()">Continue to Dashboard</button>
                            </div>
                        </div>
                    `;
                }

                // Add success message to chat
                setTimeout(() => {
                    addBotMessage(`üéâ **Congratulations!** Your ${plan.name} subscription is now active! You can now access all premium features and start improving your credit score with professional dispute letters.`);
                    updateMessagesDisplay(document.querySelector('.Bot-chat-container'));
                }, 1500);
            }

            function retryPayment(planType) {
                createPaymentModal(planType, document.querySelector('.Bot-chat-container'));
            }

            function closePaymentModal() {
                if (paymentModal) {
                    paymentModal.style.display = 'none';
                    paymentModal.remove();
                    paymentModal = null;
                    selectedPlanType = null;

                    // Add message to chat
                    addBotMessage("No problem! I'm here whenever you're ready to upgrade your subscription. Feel free to ask me anything about credit repair!");
                    updateMessagesDisplay(document.querySelector('.Bot-chat-container'));
                }
            }

            // NEW: Additional conversation flow helper functions
            function showAllCategoriesOverview(container) {
                const grouped = conversationState.groupedItems;
                if (!grouped) return;

                let message = `üìã **All Categories Overview**\n\n`;

                ['high_impact', 'medium_impact', 'low_impact'].forEach(level => {
                    const category = grouped[level];
                    message += `${category.emoji} **${category.level}** (${category.totalItems} items)\n`;
                    message += `${category.description}\n`;

                    if (category.groups.length > 0) {
                        category.groups.slice(0, 3).forEach(group => {
                            message += `  ‚Ä¢ ${getTypeEmoji(group.type)} ${group.displayName} (${group.items.length})\n`;
                        });
                        if (category.groups.length > 3) {
                            message += `  ‚Ä¢ ...and ${category.groups.length - 3} more categories\n`;
                        }
                    }
                    message += `\n`;
                });

                const buttons = [
                    { text: `üéØ Start with High Impact (${grouped.high_impact.totalItems})`, value: "start_high_impact" },
                    { text: `üìä Review Medium Impact (${grouped.medium_impact.totalItems})`, value: "show_impact_medium_impact" },
                    { text: `üìà Check Low Impact (${grouped.low_impact.totalItems})`, value: "show_impact_low_impact" },
                    { text: "üîÑ Back to Overview", value: "back_to_overview" }
                ];

                addBotMessageWithButtons(message, buttons);
                updateMessagesDisplay(container);
                saveState();
            }

            function autoSelectBestItems(container) {
                if (!conversationState.groupedItems) return;

                // Auto-select high-impact items with high confidence
                const highImpactItems = conversationState.groupedItems.high_impact.items.filter(item =>
                    item.confidence_level === 'high' && item.calculatedImpact >= 75
                );

                conversationState.selectedItems = [...highImpactItems];

                let message = `‚ö° **Auto-Selection Complete!**\n\n`;
                message += `I've automatically selected **${highImpactItems.length} high-impact items** with the highest success probability.\n\n`;
                message += `üìà **Potential Score Boost:** +${calculateScoreImpact(highImpactItems.length)} points\n\n`;
                message += `These are your best bets for quick credit score improvement!`;

                const buttons = [
                    { text: "üìÑ Generate Letters Now", value: "generate_letters" },
                    { text: "‚ûï Add More Items", value: "continue_review" },
                    { text: "üìä Review Selections", value: "show_progress" },
                    { text: "üîÑ Start Over", value: "back_to_overview" }
                ];

                addBotMessageWithButtons(message, buttons);
                updateMessagesDisplay(container);
                saveState();
            }

            function selectItemForDispute(itemId, impactLevel, groupType, container) {
                const grouped = conversationState.groupedItems;
                const category = grouped[impactLevel];
                const group = category.groups.find(g => g.type === groupType);

                if (!group) return;

                const item = group.items.find(i => (i.id || group.items.indexOf(i)) == itemId);
                if (!item) return;

                // Add to selected items
                conversationState.selectedItems.push(item);

                addUserMessage("‚úÖ Yes, dispute this item");

                // Continue to next item
                const currentIndex = group.items.indexOf(item);
                const nextIndex = currentIndex + 1;

                if (nextIndex < group.items.length) {
                    setTimeout(() => {
                        showItemForReview(group.items, nextIndex, impactLevel, groupType, container);
                    }, 500);
                } else {
                    // Finished this group
                    setTimeout(() => {
                        showGroupCompletionSummary(impactLevel, groupType, container);
                    }, 500);
                }
            }

            function skipItem(itemId, impactLevel, groupType, container) {
                const grouped = conversationState.groupedItems;
                const category = grouped[impactLevel];
                const group = category.groups.find(g => g.type === groupType);

                if (!group) return;

                const item = group.items.find(i => (i.id || group.items.indexOf(i)) == itemId);
                if (!item) return;

                // Add to skipped items
                conversationState.skippedItems.push(item);

                addUserMessage("‚è≠Ô∏è Skip this item");

                // Continue to next item
                const currentIndex = group.items.indexOf(item);
                const nextIndex = currentIndex + 1;

                setTimeout(() => {
                    showItemForReview(group.items, nextIndex, impactLevel, groupType, container);
                }, 500);
            }

            function explainItem(itemId, impactLevel, groupType, container) {
                const grouped = conversationState.groupedItems;
                const category = grouped[impactLevel];
                const group = category.groups.find(g => g.type === groupType);

                if (!group) return;

                const item = group.items.find(i => (i.id || group.items.indexOf(i)) == itemId);
                if (!item) return;

                addUserMessage("‚ùì Tell me more about this item");

                let explanation = `üîç **Detailed Analysis**\n\n`;
                explanation += `**Why this item appeared:**\n`;
                explanation += `${item.issue_details || item.dispute_reason || 'This item was flagged as potentially inaccurate'}\n\n`;

                explanation += `**How disputes work for ${getTypeEmoji(groupType)} ${formatCategoryName(groupType)}:**\n`;
                explanation += `${getDisputeStrategy(groupType)}\n\n`;

                explanation += `**What happens next:**\n`;
                explanation += `1. We generate a professional dispute letter\n`;
                explanation += `2. You mail it to the credit bureaus\n`;
                explanation += `3. They have 30 days to investigate\n`;
                explanation += `4. If they can't verify, they must remove it\n\n`;

                explanation += `**Success rate:** ${getSuccessRate(groupType)} of similar disputes succeed`;

                const buttons = [
                    { text: "‚úÖ Sounds good, dispute it", value: `select_item_${itemId}_${impactLevel}_${groupType}` },
                    { text: "‚è≠Ô∏è Skip this one", value: `skip_item_${itemId}_${impactLevel}_${groupType}` },
                    { text: "üîÑ Back to item", value: `back_to_item_${itemId}_${impactLevel}_${groupType}` }
                ];

                addBotMessageWithButtons(explanation, buttons);
                updateMessagesDisplay(container);
                saveState();
            }

            function selectAllRemainingItems(impactLevel, groupType, container) {
                const grouped = conversationState.groupedItems;
                const category = grouped[impactLevel];
                const group = category.groups.find(g => g.type === groupType);

                if (!group) return;

                // Find items not yet selected or skipped
                const remainingItems = group.items.filter(item =>
                    !conversationState.selectedItems.includes(item) &&
                    !conversationState.skippedItems.includes(item)
                );

                // Add all remaining to selected
                conversationState.selectedItems.push(...remainingItems);

                addUserMessage(`‚èØÔ∏è Select all remaining ${remainingItems.length} items`);

                setTimeout(() => {
                    showGroupCompletionSummary(impactLevel, groupType, container);
                }, 500);
            }

            function continueReview(container) {
                // Find next unreviewed category/group
                const grouped = conversationState.groupedItems;

                for (const level of conversationState.categoryOrder) {
                    const category = grouped[level];
                    for (const group of category.groups) {
                        const hasUnreviewedItems = group.items.some(item =>
                            !conversationState.selectedItems.includes(item) &&
                            !conversationState.skippedItems.includes(item)
                        );

                        if (hasUnreviewedItems) {
                            reviewItemGroup(level, group.type, container);
                            return;
                        }
                    }
                }

                // All items reviewed
                addBotMessage("üéâ You've reviewed all items! Great work!");
                showProgress(container);
            }

            function generateDisputeLetters(container) {
                if (conversationState.selectedItems.length === 0) {
                    addBotMessage("You haven't selected any items to dispute yet. Please review and select items first.");
                    updateMessagesDisplay(container);
                    return;
                }

                // SUBSCRIPTION CHECK: Verify credits before letter generation
                const creditCheck = checkCreditsBeforeLetterGeneration();
                if (!creditCheck.canUse) {
                    let subscriptionMessage = '';

                    if (creditCheck.reason === 'free_trial_exhausted') {
                        subscriptionMessage = `üîí **Free Trial Exhausted**\n\n` +
                            `You've used all your free dispute letters! To generate professional dispute letters, please upgrade to a paid plan.\n\n` +
                            `‚ú® **Your selected items are saved** - upgrade now to create letters for:\n` +
                            `‚Ä¢ ${conversationState.selectedItems.length} dispute items\n` +
                            `‚Ä¢ Estimated score boost: ${calculateScoreImpact(conversationState.selectedItems.length)} points\n\n` +
                            `üí° Paid plans include unlimited analysis + premium features!`;
                    } else if (creditCheck.reason === 'insufficient_credits') {
                        subscriptionMessage = `‚ö†Ô∏è **Insufficient Credits**\n\n` +
                            `You need letter credits to generate dispute letters.\n\n` +
                            `‚Ä¢ Selected items: ${conversationState.selectedItems.length}\n` +
                            `‚Ä¢ Credits needed: ${conversationState.selectedItems.length}\n` +
                            `‚Ä¢ Credits available: ${creditCheck.remainingAfter || 0}\n\n` +
                            `Upgrade your plan or purchase additional letters to continue.`;
                    }

                    addBotMessageWithButtons(subscriptionMessage, [
                        { text: "üöÄ Upgrade Now", value: "upgrade_subscription" },
                        { text: "üìã View Plans", value: "view_plans" },
                        { text: "üí∞ Buy Credits", value: "buy_additional_credits" },
                        { text: "üîô Back", value: "show_progress" }
                    ]);
                    updateMessagesDisplay(container);
                    saveState();
                    return;
                }

                // NEW: Check if we have complete user information before generating letters
                checkAndCollectUserInfo(container);
            }

            // NEW: Function to check and collect user information
            function checkAndCollectUserInfo(container) {
                // Get existing user data
                const userData = JSON.parse(localStorage.getItem('userData') || '{}');

                // Check what information we have
                const hasName = userData.name || (userData.firstName && userData.lastName);
                const hasAddress = userData.address && userData.city && userData.state && userData.zipCode;
                const hasEmail = userData.email || userData.userEmail;
                const hasPhone = userData.phone || userData.phoneNumber;

                console.log('Current user data check:', {
                    hasName,
                    hasAddress,
                    hasEmail,
                    hasPhone,
                    userData: userData
                });

                if (hasName && hasAddress && hasEmail && hasPhone) {
                    // We have all required information, show confirmation
                    showUserInfoConfirmation(userData, container);
                } else {
                    // Missing information, collect it
                    startUserInfoCollection(userData, container);
                }
            }

            // NEW: Show confirmation of existing user information
            function showUserInfoConfirmation(userData, container) {
                const fullName = userData.name || `${userData.firstName || ''} ${userData.lastName || ''}`.trim();
                const fullAddress = `${userData.address || ''}, ${userData.city || ''}, ${userData.state || ''} ${userData.zipCode || ''}`;
                const email = userData.email || userData.userEmail || '';
                const phone = userData.phone || userData.phoneNumber || '';

                let message = `üìã **Confirm Your Information**\n\n`;
                message += `Before generating your dispute letters, please confirm your information:\n\n`;
                message += `üë§ **Name:** ${fullName}\n`;
                message += `üè† **Address:** ${fullAddress}\n`;
                message += `üìß **Email:** ${email}\n`;
                message += `üìû **Phone:** ${phone}\n\n`;
                message += `üí° This information will be used in your professional dispute letters.`;

                const buttons = [
                    { text: "‚úÖ Information is Correct", value: "confirm_user_info" },
                    { text: "‚úèÔ∏è Update My Information", value: "update_user_info" },
                    { text: "üîô Back to Selection", value: "show_progress" }
                ];

                addBotMessageWithButtons(message, buttons);
                updateMessagesDisplay(container);
                saveState();
            }

            // NEW: Start collecting missing user information
            function startUserInfoCollection(existingData, container) {
                // Store what we need to collect
                conversationState.userInfoCollection = {
                    step: 'name',
                    collectedData: { ...existingData },
                    requiredFields: ['name', 'address', 'city', 'state', 'zipCode', 'email', 'phone']
                };

                let message = `üìù **Personal Information Required**\n\n`;
                message += `To generate professional dispute letters, I need to collect some personal information.\n\n`;
                message += `üîí **Privacy Note:** This information is only used for your dispute letters and stored securely.\n\n`;
                message += `Let's start with your full legal name:`;

                // Create input form for name
                showUserInfoInputForm('name', 'Your Full Legal Name', existingData.name || `${existingData.firstName || ''} ${existingData.lastName || ''}`.trim(), container);
            }

            // NEW: Show input form for collecting user information
            function showUserInfoInputForm(field, label, currentValue, container) {
                const fieldDescriptions = {
                    'name': 'Enter your full legal name as it should appear on the dispute letters',
                    'address': 'Enter your street address (e.g., 123 Main Street)',
                    'city': 'Enter your city',
                    'state': 'Enter your state (e.g., CA, NY, TX)',
                    'zipCode': 'Enter your ZIP code',
                    'email': 'Enter your email address',
                    'phone': 'Enter your phone number (e.g., (555) 123-4567)'
                };

                let message = `üìù **${label}**\n\n`;
                message += `${fieldDescriptions[field]}\n\n`;

                if (currentValue) {
                    message += `Current value: "${currentValue}"\n\n`;
                }

                // Add custom input interface
                addBotMessage(message);

                // Create a custom input form
                const messagesContainer = container.querySelector('.Bot-chat-messages');
                const inputFormElement = document.createElement('div');
                inputFormElement.className = 'Bot-message bot user-info-form';
                inputFormElement.innerHTML = `
                    <div class="Bot-message-avatar">ü§ñ</div>
                    <div class="Bot-message-content">
                        <div style="margin-bottom: 15px;">
                            <input type="text" 
                                   id="userInfoInput" 
                                   placeholder="${label}" 
                                   value="${currentValue || ''}"
                                   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;"
                                   onkeydown="if(event.key==='Enter') ChatModule.handleUserInfoSubmit('${field}', this.value, this.closest('.Bot-chat-container'))">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="ChatModule.handleUserInfoSubmit('${field}', document.getElementById('userInfoInput').value, this.closest('.Bot-chat-container'))" 
                                    style="background: #09ccfc; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer;">
                                Continue ‚úì
                            </button>
                            ${currentValue ? `<button onclick="ChatModule.handleUserInfoSubmit('${field}', '${currentValue}', this.closest('.Bot-chat-container'))" 
                                              style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer;">
                                Keep Current
                            </button>` : ''}
                        </div>
                    </div>
                `;

                messagesContainer.appendChild(inputFormElement);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                // Focus the input
                setTimeout(() => {
                    const input = document.getElementById('userInfoInput');
                    if (input) input.focus();
                }, 100);
            }

            // NEW: Handle user info form submission
            function handleUserInfoSubmit(field, value, container) {
                if (!value || value.trim() === '') {
                    addBotMessage("Please enter a value to continue.");
                    updateMessagesDisplay(container);
                    return;
                }

                // Remove the input form
                const inputForm = container.querySelector('.user-info-form');
                if (inputForm) {
                    inputForm.remove();
                }

                // Store the collected value
                if (!conversationState.userInfoCollection) {
                    conversationState.userInfoCollection = {
                        step: field,
                        collectedData: {},
                        requiredFields: ['name', 'address', 'city', 'state', 'zipCode', 'email', 'phone']
                    };
                }

                conversationState.userInfoCollection.collectedData[field] = value.trim();

                // Show what was entered
                addUserMessage(`${field}: ${value.trim()}`);
                addBotMessage(`‚úÖ Got it! ${field === 'name' ? 'Name' : field === 'address' ? 'Address' : field === 'city' ? 'City' : field === 'state' ? 'State' : field === 'zipCode' ? 'ZIP Code' : field === 'email' ? 'Email' : 'Phone'}: ${value.trim()}`);

                // Move to next field
                proceedToNextUserInfoField(container);
            }

            // NEW: Proceed to next field in user info collection
            function proceedToNextUserInfoField(container) {
                const { collectedData, requiredFields } = conversationState.userInfoCollection;

                // Find next missing field
                let nextField = null;
                for (const field of requiredFields) {
                    if (!collectedData[field] || collectedData[field].trim() === '') {
                        nextField = field;
                        break;
                    }
                }

                if (nextField) {
                    // Continue collecting
                    conversationState.userInfoCollection.step = nextField;

                    const fieldLabels = {
                        'name': 'Your Full Legal Name',
                        'address': 'Street Address',
                        'city': 'City',
                        'state': 'State',
                        'zipCode': 'ZIP Code',
                        'email': 'Email Address',
                        'phone': 'Phone Number'
                    };

                    setTimeout(() => {
                        showUserInfoInputForm(nextField, fieldLabels[nextField], collectedData[nextField] || '', container);
                    }, 1000);
                } else {
                    // All fields collected, show summary
                    showCollectedUserInfoSummary(container);
                }
            }

            // NEW: Show summary of collected user information
            function showCollectedUserInfoSummary(container) {
                const data = conversationState.userInfoCollection.collectedData;

                let message = `üìã **Information Summary**\n\n`;
                message += `Please review the information you provided:\n\n`;
                message += `üë§ **Name:** ${data.name}\n`;
                message += `üè† **Address:** ${data.address}\n`;
                message += `üèôÔ∏è **City:** ${data.city}\n`;
                message += `üó∫Ô∏è **State:** ${data.state}\n`;
                message += `üìÆ **ZIP Code:** ${data.zipCode}\n`;
                message += `üìß **Email:** ${data.email}\n`;
                message += `üìû **Phone:** ${data.phone}\n\n`;
                message += `Is this information correct?`;

                const buttons = [
                    { text: "‚úÖ Yes, Generate Letters", value: "confirm_user_info_and_generate" },
                    { text: "‚úèÔ∏è Edit Information", value: "edit_collected_info" },
                    { text: "üîô Back to Selection", value: "show_progress" }
                ];

                addBotMessageWithButtons(message, buttons);
                updateMessagesDisplay(container);
                saveState();
            }

            // NEW: Handle confirmed user information and generate letters
            function confirmUserInfoAndGenerate(container) {
                // Save the collected information to localStorage
                const collectedData = conversationState.userInfoCollection?.collectedData;

                if (collectedData) {
                    const userData = JSON.parse(localStorage.getItem('userData') || '{}');

                    // Update userData with collected information
                    const updatedUserData = {
                        ...userData,
                        name: collectedData.name,
                        address: collectedData.address,
                        city: collectedData.city,
                        state: collectedData.state,
                        zipCode: collectedData.zipCode,
                        email: collectedData.email || userData.email || userData.userEmail,
                        userEmail: collectedData.email || userData.email || userData.userEmail,
                        phone: collectedData.phone
                    };

                    localStorage.setItem('userData', JSON.stringify(updatedUserData));
                    console.log('Updated user data saved:', updatedUserData);
                }

                addUserMessage("‚úÖ Information confirmed, generate my letters");
                addBotMessage(`üìÑ Perfect! Generating dispute letters for ${conversationState.selectedItems.length} selected items with your confirmed information...`);

                showTypingIndicator(container);

                // Proceed with letter generation
                generateLettersFromBackend(conversationState.selectedItems, container);
            }

            // NEW: Handle editing collected information
            function editCollectedInfo(container) {
                addUserMessage("‚úèÔ∏è Let me edit my information");

                const data = conversationState.userInfoCollection?.collectedData || {};

                let message = `‚úèÔ∏è **Edit Your Information**\n\n`;
                message += `Which field would you like to update?\n\n`;
                message += `üë§ **Name:** ${data.name || 'Not set'}\n`;
                message += `üè† **Address:** ${data.address || 'Not set'}\n`;
                message += `üèôÔ∏è **City:** ${data.city || 'Not set'}\n`;
                message += `üó∫Ô∏è **State:** ${data.state || 'Not set'}\n`;
                message += `üìÆ **ZIP Code:** ${data.zipCode || 'Not set'}\n`;
                message += `üìß **Email:** ${data.email || 'Not set'}\n`;
                message += `üìû **Phone:** ${data.phone || 'Not set'}`;

                const buttons = [
                    { text: "üë§ Edit Name", value: "edit_field_name" },
                    { text: "üè† Edit Address", value: "edit_field_address" },
                    { text: "üèôÔ∏è Edit City", value: "edit_field_city" },
                    { text: "üó∫Ô∏è Edit State", value: "edit_field_state" },
                    { text: "üìÆ Edit ZIP", value: "edit_field_zipCode" },
                    { text: "üìß Edit Email", value: "edit_field_email" },
                    { text: "üìû Edit Phone", value: "edit_field_phone" },
                    { text: "‚úÖ Done Editing", value: "finish_editing_info" }
                ];

                addBotMessageWithButtons(message, buttons);
                updateMessagesDisplay(container);
                saveState();
            }

            // NEW: Handle editing a specific field
            function editSpecificField(field, container) {
                const data = conversationState.userInfoCollection?.collectedData || {};
                const currentValue = data[field] || '';

                const fieldLabels = {
                    'name': 'Your Full Legal Name',
                    'address': 'Street Address',
                    'city': 'City',
                    'state': 'State',
                    'zipCode': 'ZIP Code',
                    'email': 'Email Address',
                    'phone': 'Phone Number'
                };

                addUserMessage(`Edit ${fieldLabels[field]}`);
                showUserInfoInputForm(field, fieldLabels[field], currentValue, container);
            }

            // NEW: Function to send letter generation requests to backend
            async function generateLettersFromBackend(selectedItems, container) {
                try {
                    console.log('üìÑ Sending letter generation request to backend...', {
                        itemCount: selectedItems.length,
                        items: selectedItems.map(item => ({
                            creditor: item.creditor_name,
                            dispute_reason: item.dispute_reason,
                            impact: item.calculatedImpact
                        }))
                    });

                    // Get user data and auth token
                    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                    const userId = userData.id;
                    const userEmail = userData.email;
                    const authToken = localStorage.getItem('authToken') ||
                        localStorage.getItem('token') ||
                        sessionStorage.getItem('authToken') ||
                        sessionStorage.getItem('token');

                    if (!userId || !userEmail || !authToken) {
                        throw new Error('User authentication required for letter generation');
                    }

                    // Prepare detailed user information for letter generation
                    const detailedUserInfo = {
                        userId: userId,
                        userEmail: userEmail,
                        name: userData.name || userData.firstName + ' ' + userData.lastName || userData.username || 'User',
                        firstName: userData.firstName || userData.name?.split(' ')[0] || 'First',
                        lastName: userData.lastName || userData.name?.split(' ').slice(1).join(' ') || 'Last',
                        address: userData.address || userData.streetAddress || null,
                        city: userData.city || null,
                        state: userData.state || null,
                        zipCode: userData.zipCode || userData.zip || null,
                        phone: userData.phone || userData.phoneNumber || null,
                        email: userEmail
                    };

                    console.log('Detailed user info for letter generation:', detailedUserInfo);

                    // Prepare letter generation request
                    const requestData = {
                        userId: userId,
                        userEmail: userEmail,
                        selectedItems: selectedItems.map(item => ({
                            id: item.id,
                            creditor_name: item.creditor_name,
                            account_number: item.account_number,
                            dispute_reason: item.dispute_reason,
                            bureau: item.bureau,
                            amount: item.amount,
                            analysis_pass: item.analysis_pass,
                            confidence_level: item.confidence_level,
                            calculatedImpact: item.calculatedImpact,
                            issue_details: item.issue_details
                        })),
                        analysisData: currentAnalysisData,
                        conversationState: {
                            selectedCount: conversationState.selectedItems.length,
                            categories: conversationState.completedCategories,
                            userChoices: conversationState.userChoices
                        }
                    };

                    // Send request to backend for ChatGPT letter generation
                    const response = await fetch('https://jam-capital-backend.azurewebsites.net/api/chat/generate-letters', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            items: selectedItems.map(item => ({
                                id: item.id,
                                creditor_name: item.creditor_name,
                                account_number: item.account_number,
                                dispute_reason: item.dispute_reason,
                                bureau: item.bureau,
                                amount: item.amount,
                                analysis_pass: item.analysis_pass,
                                confidence_level: item.confidence_level,
                                calculatedImpact: item.calculatedImpact,
                                issue_details: item.issue_details
                            })),
                            userInfo: detailedUserInfo,
                            analysisData: currentAnalysisData,
                            conversationState: {
                                selectedCount: conversationState.selectedItems.length,
                                categories: conversationState.completedCategories,
                                userChoices: conversationState.userChoices
                            }
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Letter generation failed: ${response.status} - ${errorText}`);
                    }

                    const result = await response.json();

                    hideTypingIndicator(container);

                    if (result.success) {
                        console.log('‚úÖ Letters generated successfully:', {
                            letterCount: result.letters?.length || 0,
                            hasLetters: !!result.letters,
                            bureaus: result.summary?.bureaus || []
                        });

                        // Show success message with actual letter count
                        let summary = `‚úÖ **Letter Generation Complete!**\n\n`;
                        summary += `üìã **Generated Letters:** ${result.summary?.successfulLetters || selectedItems.length}\n`;
                        if (result.summary?.bureaus) {
                            summary += `üìä **Bureaus:** ${result.summary.bureaus.join(', ')}\n`;
                        }
                        summary += `üìà **Potential Score Boost:** +${calculateScoreImpact(selectedItems.length)} points\n\n`;
                        summary += `Your personalized dispute letters have been generated by our AI system! Each letter is customized with:\n`;
                        summary += `‚Ä¢ Specific dispute reasons for each item\n`;
                        summary += `‚Ä¢ Professional legal language\n`;
                        summary += `‚Ä¢ Bureau-specific formatting\n`;
                        summary += `‚Ä¢ Your personal information\n\n`;
                        summary += `üí° **Next Steps:** Review and send your letters to the credit bureaus.`;

                        addBotMessageWithButtons(summary, [
                            { text: "üìÑ View My Letters", value: "view_letters" },
                            { text: "üìä Final Summary", value: "show_final_summary" },
                            { text: "üíæ Download PDF Letters", value: "download_letters" },
                            { text: "üìß Email Letters to Me", value: "email_letters" }
                        ]);

                        // CONSUME CREDITS: Letter generation was successful
                        const creditsConsumed = consumeCreditsAfterLetterGeneration();
                        console.log('üí≥ Credits consumed after letter generation:', creditsConsumed);

                        // Store generated letters data
                        localStorage.setItem('jamBotGeneratedLetters', JSON.stringify(result.letters || []));
                        localStorage.setItem('jamBotLastLetterGeneration', JSON.stringify({
                            timestamp: new Date().toISOString(),
                            selectedItemsCount: selectedItems.length,
                            letterCount: result.letters?.length || 0,
                            bureaus: result.summary?.bureaus || [],
                            success: true,
                            creditsConsumed: creditsConsumed
                        }));

                    } else {
                        throw new Error(result.error || 'Unknown error during letter generation');
                    }

                } catch (error) {
                    console.error('‚ùå Letter generation error:', error);

                    hideTypingIndicator(container);

                    let errorMessage = "I encountered an error while generating your dispute letters. ";

                    if (error.message.includes('authentication')) {
                        errorMessage += "Please refresh the page and try again.";
                    } else if (error.message.includes('500')) {
                        errorMessage += "There was a server error. Please try again in a few moments.";
                    } else {
                        errorMessage += "Please try again or contact support if the problem persists.";
                    }

                    addBotMessageWithButtons(errorMessage, [
                        { text: "üîÑ Try Again", value: "generate_letters" },
                        { text: "üìä Show Progress", value: "show_progress" },
                        { text: "üè† Back to Overview", value: "back_to_overview" }
                    ]);
                }

                updateMessagesDisplay(container);
                saveState();
            }

            // NEW: Helper functions for letter generation actions
            async function downloadGeneratedLetters(container) {
                try {
                    const savedLetters = localStorage.getItem('jamBotGeneratedLetters');
                    if (!savedLetters) {
                        addBotMessage("No letters found. Please generate letters first.");
                        updateMessagesDisplay(container);
                        return;
                    }

                    const letters = JSON.parse(savedLetters);

                    addBotMessage("üìÑ Preparing your dispute letters as PDF files...");
                    showTypingIndicator(container);

                    // Send request to backend to generate PDFs
                    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                    const authToken = localStorage.getItem('authToken') || localStorage.getItem('token');

                    const response = await fetch('https://jam-capital-backend.azurewebsites.net/api/chat/download-letters', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            userId: userData.id,
                            letters: letters
                        })
                    });

                    hideTypingIndicator(container);

                    if (response.ok) {
                        const result = await response.json();

                        if (result.letterType === 'single_pdf') {
                            // Single PDF download
                            downloadPDFFromContent(result.pdfContent, result.filename);
                            addBotMessage(`‚úÖ Your dispute letter has been downloaded as a PDF file: "${result.filename}"! 

üìÑ This professional dispute letter is ready to mail to ${result.bureau.charAt(0).toUpperCase() + result.bureau.slice(1)} Credit Bureau.

üí° **Next Steps:**
1. Print the PDF on letterhead (if available)
2. Sign the letter by hand
3. Mail via certified mail with return receipt
4. Keep copies for your records`);
                        } else if (result.letterType === 'multiple_pdfs') {
                            // Multiple PDFs - download each one
                            let downloadCount = 0;
                            result.letters.forEach((letter, index) => {
                                setTimeout(() => {
                                    downloadPDFFromContent(letter.pdfContent, letter.filename);
                                    downloadCount++;

                                    if (downloadCount === result.letters.length) {
                                        addBotMessage(`‚úÖ All ${result.letters.length} dispute letters have been downloaded as separate PDF files!

üìÑ **Downloaded Letters:**
${result.letters.map(l => `‚Ä¢ ${l.filename} (${l.bureau.charAt(0).toUpperCase() + l.bureau.slice(1)} - ${l.itemCount} items)`).join('\n')}

üí° **Next Steps:**
1. Print each PDF on letterhead (if available)
2. Sign each letter by hand  
3. Mail to respective credit bureaus via certified mail
4. Keep copies for your records

üéØ **Pro Tip:** Send all letters on the same day for maximum impact!`);
                                        updateMessagesDisplay(container);
                                    }
                                }, index * 1000); // Stagger downloads by 1 second
                            });

                            if (result.letters.length > 1) {
                                addBotMessage(`üì• Downloading ${result.letters.length} PDF files (one for each bureau: ${result.downloadInfo.bureaus.join(', ')})...`);
                            }
                        }
                    } else {
                        throw new Error('Download failed');
                    }

                } catch (error) {
                    hideTypingIndicator(container);
                    addBotMessage("‚ùå Sorry, I couldn't download your letters. Please try again or contact support.");
                }

                updateMessagesDisplay(container);
            }

            // NEW: Helper function to convert PDF content to downloadable file
            function downloadPDFFromContent(pdfContent, filename) {
                try {
                    // Check if jsPDF is available
                    if (typeof window.jsPDF === 'undefined') {
                        console.error('jsPDF not available - cannot generate PDF');
                        throw new Error('PDF generation library not available');
                    }

                    // Create new PDF document
                    const { jsPDF } = window.jsPDF;
                    const doc = new jsPDF('p', 'pt', 'letter');

                    // Set up fonts and styling
                    doc.setFont('helvetica');

                    // Add header
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text(pdfContent.title, 72, 100);

                    // Add date
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Date: ${pdfContent.date}`, 450, 100);

                    // Add horizontal line
                    doc.setLineWidth(1);
                    doc.line(72, 120, 540, 120);

                    // Add main content with proper text wrapping
                    doc.setFontSize(12);
                    const contentLines = doc.splitTextToSize(pdfContent.content, 468); // 540-72 = 468pt width
                    doc.text(contentLines, 72, 150);

                    // Calculate position for footer
                    const contentHeight = contentLines.length * 14; // Approximate line height
                    const footerY = Math.max(150 + contentHeight + 50, 650); // Minimum footer position

                    // Add footer line
                    doc.setLineWidth(0.5);
                    doc.line(72, footerY, 540, footerY);

                    // Add footer text
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'italic');
                    doc.text(pdfContent.footer, 72, footerY + 20);
                    doc.text(`Generated on: ${new Date().toLocaleString()}`, 72, footerY + 35);

                    // Download the PDF
                    doc.save(filename);

                    console.log(`üìÑ Downloaded PDF: ${filename}`);
                } catch (error) {
                    console.error('Error generating PDF:', error);
                    addBotMessage("‚ùå Error generating PDF. Please try again or contact support for assistance.");
                }
            }

            async function emailGeneratedLetters(container) {
                try {
                    const savedLetters = localStorage.getItem('jamBotGeneratedLetters');
                    if (!savedLetters) {
                        addBotMessage("No letters found. Please generate letters first.");
                        updateMessagesDisplay(container);
                        return;
                    }

                    const letters = JSON.parse(savedLetters);
                    const userData = JSON.parse(localStorage.getItem('userData') || '{}');

                    addBotMessage(`üìß Emailing your dispute letters to ${userData.email}...`);
                    showTypingIndicator(container);

                    const authToken = localStorage.getItem('authToken') || localStorage.getItem('token');

                    const response = await fetch('https://jam-capital-backend.azurewebsites.net/api/chat/email-letters', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            userId: userData.id,
                            userEmail: userData.email,
                            letters: letters
                        })
                    });

                    hideTypingIndicator(container);

                    if (response.ok) {
                        addBotMessage(`‚úÖ Your dispute letters have been emailed to ${userData.email}! Please check your inbox (and spam folder).`);
                    } else {
                        throw new Error('Email failed');
                    }

                } catch (error) {
                    hideTypingIndicator(container);
                    addBotMessage("‚ùå Sorry, I couldn't email your letters. Please try the download option or contact support.");
                }

                updateMessagesDisplay(container);
            }

            function showFinalDisputeSummary(container) {
                const selectedCount = conversationState.selectedItems.length;
                const totalCount = currentAnalysisData?.extractedItems?.length || 0;
                const scoreImpact = calculateScoreImpact(selectedCount);
                const grouped = conversationState.groupedItems;

                let summary = `üéâ **Dispute Process Complete!**\n\n`;
                summary += `üìä **Your Results:**\n`;
                summary += `‚Ä¢ **Total Items Found:** ${totalCount}\n`;
                summary += `‚Ä¢ **Selected for Dispute:** ${selectedCount}\n`;
                summary += `‚Ä¢ **Success Rate:** 60-75% average\n`;
                summary += `‚Ä¢ **Potential Score Boost:** +${scoreImpact} points\n\n`;

                if (grouped) {
                    summary += `**Category Breakdown:**\n`;
                    ['high_impact', 'medium_impact', 'low_impact'].forEach(level => {
                        const category = grouped[level];
                        const selectedFromCategory = conversationState.selectedItems.filter(item => {
                            const impact = item.calculatedImpact;
                            return level === 'high_impact' ? impact >= 65 :
                                level === 'medium_impact' ? (impact >= 35 && impact < 65) :
                                    impact < 35;
                        });
                        summary += `‚Ä¢ ${category.emoji} ${category.level}: ${selectedFromCategory.length}/${category.totalItems}\n`;
                    });
                }

                summary += `\nüí° **Next Steps:**\n`;
                summary += `1. Review your generated letters\n`;
                summary += `2. Print and mail to credit bureaus\n`;
                summary += `3. Keep copies for your records\n`;
                summary += `4. Follow up in 30-45 days\n\n`;
                summary += `üéØ **Great job taking control of your credit!**`;

                addBotMessageWithButtons(summary, [
                    { text: "üìÑ View Letters", value: "view_letters" },
                    { text: "üíæ Download PDF Letters", value: "download_letters" },
                    { text: "üîÑ Start New Analysis", value: "restart_analysis" }
                ]);

                updateMessagesDisplay(container);
                saveState();
            }

            function restartAnalysisProcess(container) {
                // Clear conversation state
                conversationState = {
                    phase: 'overview',
                    currentCategory: null,
                    currentItemIndex: 0,
                    selectedItems: [],
                    skippedItems: [],
                    completedCategories: [],
                    userChoices: {},
                    groupedItems: null,
                    categoryOrder: ['high_impact', 'medium_impact', 'low_impact']
                };

                // Clear analysis data
                currentAnalysisData = null;
                localStorage.removeItem('jamBotLastAnalysis');
                localStorage.removeItem('jamBotGeneratedLetters');

                addBotMessage("üîÑ Starting fresh! Let me analyze your credit reports again to find new opportunities.");

                // Restart the analysis process
                setTimeout(() => {
                    checkForUploadedReports().then(hasReports => {
                        if (hasReports.hasReports) {
                            addBotMessageWithButtons(
                                "Ready to analyze your credit reports for potential dispute items?",
                                [
                                    { text: "Yes, analyze my reports", value: "analyze_reports" },
                                    { text: "Upload new reports first", value: "upload_reports" }
                                ]
                            );
                            updateMessagesDisplay(container);
                        } else {
                            addBotMessage("Please upload your credit reports first so I can analyze them for dispute opportunities.");
                            updateMessagesDisplay(container);
                        }
                    });
                }, 1000);

                updateMessagesDisplay(container);
                saveState();
            }

            // Legacy functions for backward compatibility
            function handleStartDispute(container) {
                if (!currentAnalysisData || !currentAnalysisData.extractedItems) {
                    addBotMessage("I don't have any analysis data. Please analyze your reports first.");
                    return;
                }

                const items = currentAnalysisData.extractedItems;
                if (items.length === 0) {
                    addBotMessage("I didn't find any items to dispute in your credit reports.");
                    return;
                }

                // Use new conversation flow instead
                startDisputeConversationFlow(container);
            }

            function showHighPriorityItems(container) {
                if (!currentAnalysisData || !currentAnalysisData.extractedItems) {
                    addBotMessage("I don't have any analysis data. Please analyze your reports first.");
                    return;
                }

                const items = currentAnalysisData.extractedItems;
                const highPriorityItems = items.filter(item =>
                    item.confidence_level === 'high' ||
                    item.priority === 'high' ||
                    item.dispute_reason?.toLowerCase().includes('error') ||
                    item.dispute_reason?.toLowerCase().includes('inaccurate')
                );

                if (highPriorityItems.length === 0) {
                    addBotMessage("I didn't find any high priority items. Let me show you all items instead.");
                    showAllItems(container);
                    return;
                }

                let message = `Here are the ${highPriorityItems.length} high priority items I found:\n\n`;

                highPriorityItems.forEach((item, index) => {
                    message += `${index + 1}. **${item.creditor_name || 'Unknown Creditor'}**\n`;
                    message += `   Account: ${item.account_number || 'N/A'}\n`;
                    message += `   Issue: ${item.dispute_reason || 'General dispute'}\n`;
                    message += `   Priority: ${item.confidence_level || 'N/A'}\n`;
                    message += `   Bureau: ${item.bureau || 'N/A'}\n\n`;
                });

                addBotMessage(message);

                addBotMessageWithButtons(
                    "Would you like to generate dispute letters for these items?",
                    [
                        { text: "Yes, generate letters", value: "view_letters" },
                        { text: "Show me all items first", value: "show_all_items" },
                        { text: "üéØ Use Smart Dispute Flow", value: "start_dispute" }
                    ]
                );
            }

            function showAllItems(container) {
                if (!currentAnalysisData || !currentAnalysisData.extractedItems) {
                    addBotMessage("I don't have any analysis data. Please analyze your reports first.");
                    return;
                }

                const items = currentAnalysisData.extractedItems;

                if (items.length === 0) {
                    addBotMessage("I didn't find any items to dispute in your credit reports.");
                    return;
                }

                let message = `Here are all ${items.length} items I found:\n\n`;

                items.forEach((item, index) => {
                    message += `${index + 1}. **${item.creditor_name || 'Unknown Creditor'}**\n`;
                    message += `   Account: ${item.account_number || 'N/A'}\n`;
                    message += `   Issue: ${item.dispute_reason || 'General dispute'}\n`;
                    message += `   Priority: ${item.confidence_level || 'N/A'}\n`;
                    message += `   Bureau: ${item.bureau || 'N/A'}\n\n`;
                });

                addBotMessage(message);

                addBotMessageWithButtons(
                    "This is a lot of items! Would you like me to guide you through them strategically?",
                    [
                        { text: "üéØ Yes, guide me through", value: "start_dispute" },
                        { text: "üìÑ Generate letters for all", value: "view_letters" }
                    ]
                );
            }

            // Initialize the module
            function init(container, parent = null) {
                debugLog('init', 'STARTED');

                if (isInitialized) {
                    debugLog('init', 'ALREADY_INITIALIZED - Checking if interface exists');

                    // Check if the interface actually exists in the container
                    const existingInterface = container.querySelector('.Bot-chat-container');
                    if (existingInterface) {
                        debugLog('init', 'INTERFACE_EXISTS - Updating display');
                        updateMessagesDisplay(container);
                        return true;
                    } else {
                        debugLog('init', 'INTERFACE_MISSING - Re-rendering');
                        // Interface doesn't exist, so we need to render it
                        // Don't return early, continue with initialization
                    }
                }

                try {
                    parentModule = parent;

                    // UPDATED: Always start fresh - clear all chat history when returning
                    console.log('üîÑ ChatModule: Starting fresh conversation');
                    messages = [];
                    currentAnalysisData = null;
                    conversationState = {
                        phase: 'overview',
                        currentCategory: null,
                        currentItemIndex: 0,
                        selectedItems: [],
                        skippedItems: [],
                        completedCategories: [],
                        userChoices: {},
                        groupedItems: null,
                        categoryOrder: ['high_impact', 'medium_impact', 'low_impact']
                    };

                    // Stop any active waiting animations from previous sessions
                    stopContinuousWaiting();

                    // Clear any saved chat state
                    localStorage.removeItem('jamBotChatMessages');
                    localStorage.removeItem('jamBotChatState');

                    // Always render the interface (even if already initialized)
                    renderChatInterface(container);

                    // NEW: Start with subscription-aware welcome message
                    startSubscriptionAwareConversation(container);

                    updateMessagesDisplay(container);
                    isInitialized = true;

                    debugLog('init', 'SUCCESS - Fresh conversation started');
                    return true;

                } catch (error) {
                    debugLog('init', 'ERROR', { error: error.message });
                    console.error('Error initializing ChatModule:', error);
                    return false;
                }
            }

            // NEW: Show payment modal directly in chat
            function showPaymentModal(planType, container) {
                console.log(`üí≥ Opening payment modal for plan: ${planType}`);

                const plan = PLAN_DETAILS[planType];
                if (!plan) {
                    console.error('Invalid plan type:', planType);
                    return;
                }

                selectedPlanType = planType;

                // Show confirmation in chat
                addBotMessage(`Perfect! Let me set up your ${plan.name} payment. Opening secure payment modal...`);
                updateMessagesDisplay(container);

                // Create and show modal
                createPaymentModal(planType, container);
            }

            // NEW: Create payment modal
            function createPaymentModal(planType, container) {
                const plan = PLAN_DETAILS[planType];

                // Remove existing modal if present
                const existingModal = document.getElementById('Bot-payment-modal');
                if (existingModal) {
                    existingModal.remove();
                }

                // Create modal element
                paymentModal = document.createElement('div');
                paymentModal.id = 'Bot-payment-modal';
                paymentModal.className = 'Bot-payment-modal';
                paymentModal.innerHTML = `
                    <div class="Bot-payment-modal-content">
                        <div class="Bot-payment-modal-header">
                            <h3>Complete Your ${plan.name} Purchase</h3>
                            <span class="Bot-payment-modal-close" onclick="ChatModule.closePaymentModal()">&times;</span>
                        </div>
                        <div class="Bot-payment-modal-body">
                            <div class="Bot-plan-summary">
                                <h4>${plan.name}</h4>
                                <div class="Bot-price-display">${plan.price}<span>/month</span></div>
                                <ul class="Bot-plan-features-summary">
                                    ${plan.features.slice(0, 5).map(feature => `
                                        <li><i class="fas fa-check"></i> ${feature}</li>
                                    `).join('')}
                                    ${plan.features.length > 5 ? '<li><i class="fas fa-plus"></i> And more...</li>' : ''}
                                </ul>
                            </div>
                            
                            <div class="Bot-payment-security">
                                <p><i class="fas fa-shield-alt"></i> Secure payment processing</p>
                                <p><i class="fas fa-lock"></i> 256-bit SSL encryption</p>
                            </div>
                            
                            <div class="Bot-payment-action-container">
                                <button class="Bot-proceed-payment-btn" onclick="ChatModule.proceedToPayment('${planType}')">
                                    <i class="fas fa-credit-card"></i>
                                    Proceed to Secure Payment
                                </button>
                                <p class="Bot-payment-note">You'll be redirected to our secure payment processor</p>
                            </div>
                            
                            <div class="Bot-payment-footer">
                                <p class="Bot-guarantee-text">
                                    <i class="fas fa-medal"></i> 
                                    30-day money-back guarantee
                                </p>
                                <button class="Bot-cancel-payment-btn" onclick="ChatModule.closePaymentModal()">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;

                // Add to container
                container.appendChild(paymentModal);

                // Show modal with animation
                setTimeout(() => {
                    paymentModal.style.display = 'flex';
                }, 100);

                // Setup modal event listeners
                setupPaymentModalEventListeners();
            }

            // NEW: Setup payment modal event listeners
            function setupPaymentModalEventListeners() {
                // Close when clicking outside the modal content
                if (paymentModal) {
                    paymentModal.addEventListener('click', function (e) {
                        if (e.target === paymentModal) {
                            closePaymentModal();
                        }
                    });

                    // Close on Escape key
                    document.addEventListener('keydown', function handleEscape(e) {
                        if (e.key === 'Escape') {
                            closePaymentModal();
                            document.removeEventListener('keydown', handleEscape);
                        }
                    });
                }
            }

            // NEW: Proceed to payment
            function proceedToPayment(planType) {
                if (!PAYMENT_LINKS[planType]) {
                    console.error('No payment link found for plan:', planType);
                    return;
                }

                const plan = PLAN_DETAILS[planType];
                const proceedBtn = document.querySelector('.Bot-proceed-payment-btn');

                if (proceedBtn) {
                    // Show loading state
                    proceedBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Opening secure payment...';
                    proceedBtn.disabled = true;
                }

                // Open payment in new window
                const paymentWindow = window.open(
                    PAYMENT_LINKS[planType],
                    'payment',
                    'width=800,height=700,scrollbars=yes,resizable=yes,toolbar=no,menubar=no'
                );

                // Check if popup was blocked
                if (!paymentWindow || paymentWindow.closed || typeof paymentWindow.closed == 'undefined') {
                    // Popup blocked, show alternative
                    showPopupBlockedInModal(planType);
                } else {
                    // Monitor the payment window
                    monitorPaymentWindow(paymentWindow, planType);
                }
            }

            // NEW: Handle popup blocked scenario in modal
            function showPopupBlockedInModal(planType) {
                if (!paymentModal || !PAYMENT_LINKS[planType]) return;

                const modalContent = paymentModal.querySelector('.Bot-payment-modal-content');
                if (modalContent) {
                    modalContent.innerHTML = `
                        <div class="Bot-payment-modal-header">
                            <h3>Complete Your Payment</h3>
                            <span class="Bot-payment-modal-close" onclick="ChatModule.closePaymentModal()">&times;</span>
                        </div>
                        <div class="Bot-payment-modal-body">
                            <div class="Bot-popup-blocked-message">
                                <i class="fas fa-exclamation-triangle" style="color: #ffc107; font-size: 3rem; margin-bottom: 1rem;"></i>
                                <h4>Popup Blocked</h4>
                                <p>Your browser blocked the payment window. Please:</p>
                                <ol>
                                    <li>Allow popups for this site, or</li>
                                    <li>Click the button below to open payment in a new tab</li>
                                </ol>
                                
                                <div class="Bot-payment-options">
                                    <a href="${PAYMENT_LINKS[planType]}" target="_blank" class="Bot-proceed-payment-btn">
                                        <i class="fas fa-external-link-alt"></i>
                                        Open Payment in New Tab
                                    </a>
                                    <button class="Bot-cancel-payment-btn" onclick="ChatModule.retryPayment('${planType}')">Try Again</button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            // NEW: Monitor payment window for completion
            function monitorPaymentWindow(paymentWindow, planType) {
                const checkClosed = setInterval(function () {
                    if (paymentWindow.closed) {
                        clearInterval(checkClosed);
                        // Show completion message in modal
                        showPaymentCompletionInModal(planType);
                    }
                }, 1000);
            }

            // NEW: Show payment completion message in modal
            function showPaymentCompletionInModal(planType) {
                if (!paymentModal) return;

                const modalContent = paymentModal.querySelector('.Bot-payment-modal-content');
                if (modalContent) {
                    modalContent.innerHTML = `
                        <div class="Bot-payment-modal-header">
                            <h3>Payment Status</h3>
                            <span class="Bot-payment-modal-close" onclick="ChatModule.closePaymentModal()">&times;</span>
                        </div>
                        <div class="Bot-payment-modal-body">
                            <div class="Bot-payment-status-message">
                                <i class="fas fa-info-circle" style="color: #09ccfc; font-size: 3rem; margin-bottom: 1rem;"></i>
                                <h4>Payment Window Closed</h4>
                                <p>If you completed your payment, you should receive a confirmation email shortly.</p>
                                <p>If you didn't complete the payment, you can try again anytime.</p>
                                
                                <div class="Bot-status-options">
                                    <button class="Bot-proceed-payment-btn" onclick="ChatModule.paymentCompleted('${planType}')">
                                        <i class="fas fa-check"></i>
                                        I Completed Payment
                                    </button>
                                    <button class="Bot-cancel-payment-btn" onclick="ChatModule.retryPayment('${planType}')">
                                        Try Payment Again
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            // NEW: Handle payment completed
            function paymentCompleted(planType) {
                const plan = PLAN_DETAILS[planType];

                if (!paymentModal) return;

                const modalContent = paymentModal.querySelector('.Bot-payment-modal-content');
                if (modalContent) {
                    modalContent.innerHTML = `
                        <div class="Bot-payment-modal-header">
                            <h3>Payment Successful!</h3>
                            <span class="Bot-payment-modal-close" onclick="ChatModule.closePaymentModal()">&times;</span>
                        </div>
                        <div class="Bot-payment-modal-body">
                            <div class="Bot-success-message">
                                <i class="fas fa-check-circle" style="color: #28a745; font-size: 3rem; margin-bottom: 1rem;"></i>
                                <h4>Thank you for your purchase!</h4>
                                <p>Your ${plan.name} is now active.</p>
                                <p>You now have access to all the tools and features included in your plan.</p>
                                <p>You should receive a confirmation email with login instructions shortly.</p>
                                <button class="Bot-proceed-payment-btn" onclick="ChatModule.closePaymentModal()">Continue to Dashboard</button>
                            </div>
                        </div>
                    `;
                }

                // Add success message to chat
                setTimeout(() => {
                    addBotMessage(`üéâ **Congratulations!** Your ${plan.name} subscription is now active! You can now access all premium features and start improving your credit score with professional dispute letters.`);
                    updateMessagesDisplay(document.querySelector('.Bot-chat-container'));
                }, 1500);
            }

            // NEW: Retry payment
            function retryPayment(planType) {
                createPaymentModal(planType, document.querySelector('.Bot-chat-container'));
            }

            // NEW: Close payment modal
            function closePaymentModal() {
                if (paymentModal) {
                    paymentModal.style.display = 'none';
                    paymentModal.remove();
                    paymentModal = null;
                    selectedPlanType = null;

                    // Add message to chat
                    addBotMessage("No problem! I'm here whenever you're ready to upgrade your subscription. Feel free to ask me anything about credit repair!");
                    updateMessagesDisplay(document.querySelector('.Bot-chat-container'));
                }
            }

            // Subscription-related functions
            function showSubscriptionPlans(container) {
                const plansMessage = `üí≥ **JAM Dispute Bot Subscription Plans**

üÜì **Free Trial** - $0/month
‚Ä¢ 2 dispute letters (lifetime)
‚Ä¢ Basic templates only
‚Ä¢ Email support
‚Ä¢ Limited AI analysis

üíº **DIY Starter** - $29/month  
‚Ä¢ 5 dispute letters included
‚Ä¢ All templates + AI optimization
‚Ä¢ Priority email support
‚Ä¢ $4.99 per additional letter

üöÄ **DIY Professional** - $59/month
‚Ä¢ 15 dispute letters included  
‚Ä¢ Advanced letter customization
‚Ä¢ Multi-bureau coordination
‚Ä¢ Phone + email support
‚Ä¢ $3.99 per additional letter

‚≠ê **DIY Premium** - $99/month
‚Ä¢ 50 dispute letters included
‚Ä¢ Custom letter templates
‚Ä¢ Legal review option
‚Ä¢ Dedicated support line
‚Ä¢ $2.99 per additional letter

üí° **Which plan fits your credit repair goals?**`;

                addBotMessageWithButtons(plansMessage, [
                    { text: "üÜì Stay on Free", value: "keep_free_plan" },
                    { text: "üíº Choose Starter ($29)", value: "select_starter_plan" },
                    { text: "üöÄ Choose Professional ($59)", value: "select_professional_plan" },
                    { text: "‚≠ê Choose Premium ($99)", value: "select_premium_plan" },
                    { text: "‚ùå Not Now", value: "cancel_upgrade" }
                ]);

                updateMessagesDisplay(container);
                saveState();
            }

            function checkCreditsBeforeLetterGeneration() {
                const parentBot = window.jamTipBot || window.parent?.jamTipBot;
                if (parentBot && typeof parentBot.checkCredits === 'function') {
                    const creditCheck = parentBot.checkCredits(1);
                    return creditCheck;
                }

                // Fallback: assume credits are available if parent module not found
                return { canUse: true };
            }

            function consumeCreditsAfterLetterGeneration() {
                const parentBot = window.jamTipBot || window.parent?.jamTipBot;
                if (parentBot && typeof parentBot.consumeCredits === 'function') {
                    return parentBot.consumeCredits(1);
                }
                return true;
            }

            // Public API
            return {
                init: init,

                // Public methods for adding messages
                addBotMessage: function (content, container, buttons = null) {
                    const message = addBotMessage(content, buttons);
                    if (container) {
                        updateMessagesDisplay(container);
                    }
                    // Don't auto-save since we want fresh conversations
                    return message;
                },

                addUserMessage: function (content, container) {
                    const message = addUserMessage(content);
                    if (container) {
                        updateMessagesDisplay(container);
                    }
                    // Don't auto-save since we want fresh conversations
                    return message;
                },

                // Public methods for state management
                setChatMessages: function (savedMessages) {
                    if (Array.isArray(savedMessages)) {
                        messages = savedMessages;
                    }
                },

                updateView: function (container) {
                    if (container) {
                        updateMessagesDisplay(container);
                    }
                },

                onReportUploaded: function (container) {
                    console.log('üîÑ ChatModule: onReportUploaded called - checking for new reports');

                    checkForUploadedReports().then(hasReports => {
                        console.log('üìä Upload check result in onReportUploaded:', hasReports);

                        if (hasReports.hasReports && hasReports.count > 0) {
                            // Check if we already have this message in the conversation
                            const hasReportMessage = messages.some(msg =>
                                msg.type === 'bot' &&
                                (msg.content.includes("I see you've uploaded your credit report") ||
                                    msg.content.includes("I see you've uploaded") && msg.content.includes("credit report"))
                            );

                            if (!hasReportMessage) {
                                console.log(`‚úÖ New reports detected (${hasReports.count} reports) - adding analysis prompt`);

                                addBotMessageWithButtons(
                                    `Great! I see you've uploaded ${hasReports.count} credit report${hasReports.count > 1 ? 's' : ''}. Would you like me to analyze them for potential items to dispute?`,
                                    [
                                        { text: "Yes, analyze my reports", value: "analyze_reports" },
                                        { text: "No, I'll ask something else", value: "skip_analysis" }
                                    ]
                                );

                                if (container) {
                                    updateMessagesDisplay(container);
                                }
                            } else {
                                console.log('‚ÑπÔ∏è Analysis prompt already shown - not adding duplicate message');
                            }
                        } else {
                            console.log(`‚ùå No credit reports found after upload event (source: ${hasReports.source})`);
                        }
                    }).catch(error => {
                        console.error('‚ùå Error checking for reports in onReportUploaded:', error);
                    });
                },

                clearChatHistory: function () {
                    messages = [];
                    currentAnalysisData = null;
                    conversationState = {
                        phase: 'overview',
                        currentCategory: null,
                        currentItemIndex: 0,
                        selectedItems: [],
                        skippedItems: [],
                        completedCategories: [],
                        userChoices: {},
                        groupedItems: null,
                        categoryOrder: ['high_impact', 'medium_impact', 'low_impact']
                    };

                    // Stop any active waiting animations
                    stopContinuousWaiting();

                    localStorage.removeItem('jamBotChatMessages');
                    localStorage.removeItem('jamBotChatState');
                    console.log('‚úÖ Chat history cleared - fresh conversation ready');
                },

                // NEW: Method to manually restart conversation
                restartConversation: function (container) {
                    this.clearChatHistory();
                    if (container) {
                        // Use subscription-aware conversation start instead of hardcoded message
                        startSubscriptionAwareConversation(container);
                    }
                },

                getChatState: function () {
                    return messages;
                },

                getCurrentAnalysisData: function () {
                    return currentAnalysisData;
                },

                // Expose handleButtonClick for onclick handlers
                handleButtonClick: handleButtonClick,

                // NEW: Expose handleUserInfoSubmit for user info collection
                handleUserInfoSubmit: handleUserInfoSubmit,

                // NEW: Expose payment modal functions
                showPaymentModal: showPaymentModal,
                closePaymentModal: closePaymentModal,
                proceedToPayment: proceedToPayment,
                paymentCompleted: paymentCompleted,
                retryPayment: retryPayment,

                // Utility methods for debugging
                debugLocalStorage: function () {
                    console.log('=== CHAT MODULE DEBUG ===');
                    console.log('Messages:', messages);
                    console.log('Current Analysis Data:', currentAnalysisData);
                    console.log('Is Initialized:', isInitialized);
                    console.log('Parent Module:', parentModule);
                }
            };
        })();

        // Make ChatModule globally available
        window.ChatModule = ChatModule;
    </script>
</body>

</html>