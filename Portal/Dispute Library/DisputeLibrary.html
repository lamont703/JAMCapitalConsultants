<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dispute Letter Library - JAM Credit Solutions</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --primary: #008080;
            --primary-dark: #006666;
            --primary-light: #e6f7f7;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-600: #6c757d;
            --gray-800: #343a40;
            --blue-dark: #002742;
            --blue-accent: #09ccfc;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--gray-100);
            color: var(--gray-800);
            line-height: 1.6;
            padding: 20px;
        }

        .dispute-library {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        .library-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .library-title {
            font-size: 2rem;
            color: #09ccfc;
            margin-bottom: 0.5rem;
        }

        .library-description {
            color: var(--gray-600);
            max-width: 800px;
            margin: 0 auto;
        }

        .search-container {
            display: flex;
            margin-bottom: 1.5rem;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .search-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: 4px 0 0 4px;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
        }

        .search-button {
            background-color: var(--blue-dark);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .search-button:hover {
            background-color: #001f36;
        }

        .filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 2rem;
            justify-content: center;
        }

        .filter-button {
            background-color: var(--gray-200);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            transition: all 0.3s;
        }

        .filter-button:hover {
            background-color: var(--gray-300);
        }

        .filter-button.active {
            background-color: var(--blue-dark);
            color: white;
        }

        .letter-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-gap: 2rem;
            margin-top: 2rem;
        }

        .letter-card {
            perspective: 1000px;
            height: auto;
            min-height: 280px;
            width: 100%;
            position: relative;
            margin-bottom: 1rem;
        }

        .letter-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transform-style: preserve-3d;
            transform-origin: center center;
        }

        .letter-card-front,
        .letter-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            background-color: var(--blue-dark);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            color: white;
            overflow: hidden;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .letter-card-front {
            border-left: 4px solid var(--blue-accent);
        }

        .letter-card-back {
            border-left: 4px solid var(--blue-accent);
            transform: rotateY(180deg);
            overflow-y: auto;
        }

        .letter-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.2rem;
            padding-bottom: 0.8rem;
            border-bottom: 2px solid rgba(9, 204, 252, 0.3);
        }

        .letter-icon {
            font-size: 1.6rem;
            margin-right: 0.8rem;
            color: var(--blue-accent);
        }

        .letter-card-header h3 {
            color: white;
            font-size: 1.2rem;
            margin: 0;
            font-weight: 600;
            line-height: 1.3;
        }

        .letter-description {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.95rem;
            line-height: 1.5;
            margin: 0.6rem 0 1.2rem;
            flex-grow: 1;
        }

        .letter-flip-btn {
            background: rgba(9, 204, 252, 0.2);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-top: auto;
            font-family: 'Montserrat', sans-serif;
        }

        .letter-flip-btn:hover {
            background: rgba(9, 204, 252, 0.4);
            transform: translateY(-2px);
        }

        .letter-actions {
            display: flex;
            justify-content: space-between;
            margin-top: auto;
        }

        .letter-action-btn {
            background: rgba(9, 204, 252, 0.2);
            color: white;
            border: none;
            padding: 0.6rem 1rem;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            flex: 1;
            margin: 0 0.3rem;
        }

        .letter-action-btn:hover {
            background: rgba(9, 204, 252, 0.4);
        }

        .letter-action-btn.preview {
            background: rgba(255, 255, 255, 0.2);
        }

        .letter-action-btn.preview:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .letter-action-btn.download {
            background: rgba(40, 167, 69, 0.2);
        }

        .letter-action-btn.download:hover {
            background: rgba(40, 167, 69, 0.3);
        }

        .letter-back-btn {
            background: transparent;
            color: white;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .letter-back-btn:hover {
            color: var(--blue-accent);
        }

        .letter-back-btn i {
            margin-right: 0.5rem;
        }

        .letter-category {
            display: inline-block;
            background-color: rgba(9, 204, 252, 0.2);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-bottom: 0.8rem;
        }

        .letter-date {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 1rem;
        }

        .letter-content {
            text-align: left;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.9);
        }

        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 3rem;
            background-color: var(--gray-100);
            border-radius: 8px;
            border: 1px dashed var(--gray-300);
        }

        .empty-state i {
            font-size: 3rem;
            color: var(--gray-600);
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            color: var(--gray-800);
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            color: var(--gray-600);
        }

        /* Loading state */
        .loading-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 3rem;
        }

        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 39, 66, 0.1);
            border-radius: 50%;
            border-top-color: var(--blue-dark);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Enhanced Mobile-First Responsive Design */

        /* Mobile Styles (default - â‰¤575px) */
        @media (max-width: 575.98px) {
            body {
                font-size: 14px;
                line-height: 1.5;
                padding: 0.5rem;
                background: linear-gradient(135deg, var(--gray-100) 0%, var(--primary-light) 100%);
            }

            .dispute-library {
                max-width: 100%;
                padding: 0;
                margin: 0;
            }

            /* Enhanced Mobile Header */
            .library-header {
                text-align: center;
                margin-bottom: 1.5rem;
                padding: 1rem;
                background: linear-gradient(135deg, white 0%, var(--primary-light) 100%);
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            }

            .library-title {
                font-size: 1.5rem;
                background: linear-gradient(135deg, var(--blue-accent) 0%, var(--primary) 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                margin-bottom: 0.75rem;
                font-weight: 700;
            }

            .library-description {
                color: var(--gray-600);
                font-size: 0.9rem;
                line-height: 1.6;
                margin: 0;
            }

            /* Touch-Optimized Search Container */
            .search-container {
                flex-direction: column;
                margin-bottom: 1.25rem;
                max-width: 100%;
                gap: 0.75rem;
            }

            .search-input {
                border-radius: 12px;
                padding: 1rem;
                font-size: 16px;
                /* Prevents zoom on iOS */
                border: 2px solid var(--gray-300);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
                transition: all 0.3s ease;
                width: 100%;
                min-height: 44px;
                touch-action: manipulation;
            }

            .search-input:focus {
                border-color: var(--primary);
                box-shadow: 0 0 0 3px rgba(0, 128, 128, 0.1);
                outline: none;
            }

            .search-button {
                border-radius: 12px;
                width: 100%;
                min-height: 44px;
                padding: 1rem;
                background: linear-gradient(135deg, var(--blue-dark) 0%, var(--primary) 100%);
                color: white;
                border: none;
                font-weight: 600;
                font-size: 0.95rem;
                box-shadow: 0 4px 12px rgba(0, 39, 66, 0.2);
                transition: all 0.3s ease;
                touch-action: manipulation;
            }

            .search-button:active {
                transform: translateY(1px);
                box-shadow: 0 2px 8px rgba(0, 39, 66, 0.3);
            }

            /* Enhanced Filter Container */
            .filter-container {
                gap: 0.5rem;
                margin-bottom: 1.5rem;
                padding: 0 0.25rem;
                justify-content: flex-start;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }

            .filter-container::-webkit-scrollbar {
                display: none;
            }

            .filter-button {
                background: white;
                border: 2px solid var(--gray-300);
                padding: 0.75rem 1rem;
                border-radius: 25px;
                cursor: pointer;
                font-family: 'Montserrat', sans-serif;
                font-size: 0.85rem;
                font-weight: 500;
                transition: all 0.3s ease;
                min-height: 44px;
                white-space: nowrap;
                flex-shrink: 0;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
                touch-action: manipulation;
            }

            .filter-button:active {
                transform: scale(0.98);
            }

            .filter-button.active {
                background: linear-gradient(135deg, var(--blue-dark) 0%, var(--primary) 100%);
                color: white;
                border-color: var(--primary);
                box-shadow: 0 4px 12px rgba(0, 128, 128, 0.2);
            }

            /* Mobile-Optimized Letter Grid */
            .letter-grid {
                display: grid;
                grid-template-columns: 1fr;
                gap: 1rem;
                margin: 0;
                padding: 0;
            }

            /* Enhanced Mobile Letter Cards */
            .letter-card {
                min-height: 320px;
                margin-bottom: 0;
                perspective: 1000px;
                width: 100%;
            }

            .letter-card-inner {
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
                border-radius: 16px;
                overflow: hidden;
                transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            }

            .letter-card-front,
            .letter-card-back {
                background: linear-gradient(135deg, var(--blue-dark) 0%, #001f36 100%);
                border-radius: 16px;
                padding: 1.25rem;
                border-left: 6px solid var(--blue-accent);
                position: relative;
                overflow: hidden;
            }

            .letter-card-front::before,
            .letter-card-back::before {
                content: '';
                position: absolute;
                top: 0;
                right: 0;
                width: 100px;
                height: 100px;
                background: radial-gradient(circle, rgba(9, 204, 252, 0.1) 0%, transparent 70%);
                pointer-events: none;
            }

            .letter-card-header {
                margin-bottom: 1rem;
                padding-bottom: 0.75rem;
                border-bottom: 2px solid rgba(9, 204, 252, 0.3);
            }

            .letter-card-header h3 {
                font-size: 1.1rem;
                line-height: 1.4;
                font-weight: 600;
                margin: 0;
                color: white;
            }

            .letter-icon {
                font-size: 1.5rem;
                margin-right: 0.75rem;
                color: var(--blue-accent);
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            }

            .letter-description {
                font-size: 0.9rem;
                line-height: 1.6;
                margin: 0.75rem 0 1rem;
                color: rgba(255, 255, 255, 0.9);
            }

            .letter-category {
                font-size: 0.75rem;
                padding: 0.4rem 0.8rem;
                border-radius: 15px;
                background: rgba(9, 204, 252, 0.2);
                color: var(--blue-accent);
                font-weight: 500;
                border: 1px solid rgba(9, 204, 252, 0.3);
            }

            /* Touch-Optimized Buttons */
            .letter-flip-btn,
            .letter-action-btn,
            .letter-back-btn {
                min-height: 44px;
                padding: 0.75rem 1.25rem;
                border-radius: 25px;
                font-weight: 600;
                font-size: 0.9rem;
                transition: all 0.3s ease;
                touch-action: manipulation;
                border: none;
                cursor: pointer;
            }

            .letter-flip-btn {
                background: rgba(9, 204, 252, 0.2);
                color: white;
                -webkit-backdrop-filter: blur(10px);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(9, 204, 252, 0.3);
                width: 100%;
                margin-top: auto;
            }

            .letter-flip-btn:active {
                transform: scale(0.98);
                background: rgba(9, 204, 252, 0.3);
            }

            .letter-actions {
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
                margin-top: auto;
            }

            .letter-action-btn {
                width: 100%;
                text-align: center;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.5rem;
            }

            .letter-action-btn.preview {
                background: rgba(255, 255, 255, 0.2);
                color: white;
                border: 1px solid rgba(255, 255, 255, 0.3);
            }

            .letter-action-btn.preview:active {
                background: rgba(255, 255, 255, 0.3);
                transform: scale(0.98);
            }

            .letter-action-btn.download {
                background: rgba(40, 167, 69, 0.2);
                color: white;
                border: 1px solid rgba(40, 167, 69, 0.3);
            }

            .letter-action-btn.download:active {
                background: rgba(40, 167, 69, 0.3);
                transform: scale(0.98);
            }

            .letter-back-btn {
                background: transparent;
                color: white;
                border: 1px solid rgba(255, 255, 255, 0.3);
                width: 100%;
                margin-top: 1rem;
            }

            .letter-back-btn:active {
                background: rgba(255, 255, 255, 0.1);
                transform: scale(0.98);
            }

            .letter-date {
                font-size: 0.75rem;
                color: rgba(255, 255, 255, 0.7);
                margin-top: 0.75rem;
                text-align: center;
            }

            /* Enhanced Letter Content for Mobile */
            .letter-content {
                font-size: 0.85rem;
                line-height: 1.6;
                margin-bottom: 1rem;
                max-height: 200px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .letter-content::-webkit-scrollbar {
                width: 4px;
            }

            .letter-content::-webkit-scrollbar-thumb {
                background: rgba(9, 204, 252, 0.3);
                border-radius: 2px;
            }

            /* Enhanced Empty and Loading States */
            .empty-state,
            .loading-state {
                padding: 2rem 1rem;
                text-align: center;
                background: white;
                border-radius: 16px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
                margin: 1rem 0;
            }

            .empty-state i,
            .loading-state i {
                font-size: 2.5rem;
                color: var(--gray-600);
                margin-bottom: 1rem;
            }

            .loading-spinner {
                width: 32px;
                height: 32px;
                border: 3px solid rgba(0, 39, 66, 0.1);
                border-top-color: var(--blue-dark);
                margin: 0 auto 1rem;
            }

            /* Dispute Card Mobile Optimizations */
            #letterGrid {
                padding: 0;
                gap: 1rem;
            }

            .dispute-prompt-card {
                width: 100%;
                height: auto;
                min-height: 400px;
                margin: 0 0 1rem 0;
                perspective: 1000px;
            }

            .dispute-card-inner {
                border-radius: 16px;
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
                transition: transform 0.6s ease;
            }

            .dispute-card-front,
            .dispute-card-back {
                border-radius: 16px;
                padding: 1.25rem;
                min-height: 380px;
            }

            .dispute-card-front {
                background: linear-gradient(135deg, white 0%, var(--gray-100) 100%);
                border-left: 6px solid var(--primary);
            }

            .dispute-card-back {
                background: linear-gradient(135deg, var(--gray-100) 0%, white 100%);
                border-left: 6px solid var(--blue-accent);
            }

            .dispute-card-header {
                margin-bottom: 1rem;
                min-height: auto;
            }

            .dispute-ai-icon {
                font-size: 1.5rem;
                color: var(--primary);
                margin-right: 0.75rem;
            }

            .dispute-card-front h3 {
                font-size: 1.1rem;
                color: var(--gray-800);
                line-height: 1.4;
                font-weight: 600;
            }

            .dispute-card-description {
                font-size: 0.9rem;
                line-height: 1.6;
                color: var(--gray-600);
                margin-bottom: 1rem;
                max-height: 180px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .dispute-flip-btn,
            .dispute-copy-btn {
                min-height: 44px;
                padding: 0.75rem 1.25rem;
                border-radius: 25px;
                font-weight: 600;
                touch-action: manipulation;
                transition: all 0.3s ease;
            }

            .dispute-flip-btn {
                background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
                color: white;
                border: none;
                width: 100%;
                margin-top: auto;
            }

            .dispute-flip-btn:active {
                transform: scale(0.98);
            }

            .dispute-copy-btn {
                background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
                color: white;
                border: none;
                width: 100%;
            }

            .dispute-copy-btn:active {
                transform: scale(0.98);
            }

            .dispute-prompt-content pre {
                font-size: 0.8rem;
                line-height: 1.5;
                max-height: 160px;
                padding: 0.75rem;
                border-radius: 12px;
                background: rgba(0, 0, 0, 0.05);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .dispute-button-container {
                margin-top: 1rem;
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
            }

            /* Mobile button visibility fixes */
            .dispute-card-back .dispute-copy-btn,
            .dispute-card-back .letter-action-btn.preview {
                background: linear-gradient(135deg, #4a6cf7 0%, #3451b2 100%) !important;
                color: white !important;
                border: 2px solid #4a6cf7 !important;
                font-weight: 600 !important;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
                box-shadow: 0 2px 8px rgba(74, 108, 247, 0.3) !important;
                min-height: 44px !important;
                font-size: 0.9rem !important;
                border-radius: 8px !important;
            }

            .dispute-card-back .letter-back-btn,
            .dispute-card-back .dispute-back-btn {
                background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%) !important;
                color: white !important;
                border: 2px solid #6c757d !important;
                font-weight: 600 !important;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
                box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3) !important;
                min-height: 44px !important;
                font-size: 0.9rem !important;
                border-radius: 8px !important;
            }

            .dispute-card-back .dispute-copy-btn:active,
            .dispute-card-back .letter-action-btn.preview:active {
                transform: scale(0.98) !important;
                box-shadow: 0 1px 4px rgba(74, 108, 247, 0.4) !important;
            }

            .dispute-card-back .letter-back-btn:active,
            .dispute-card-back .dispute-back-btn:active {
                transform: scale(0.98) !important;
                box-shadow: 0 1px 4px rgba(108, 117, 125, 0.4) !important;
            }

            /* Enhanced Mobile Card Flipping */
            .dispute-prompt-card {
                perspective: 1200px;
                -webkit-perspective: 1200px;
            }

            .dispute-card-inner {
                transform-style: preserve-3d;
                -webkit-transform-style: preserve-3d;
                transition: transform 0.6s ease;
                -webkit-transition: -webkit-transform 0.6s ease;
                will-change: transform;
            }

            .dispute-card-front,
            .dispute-card-back {
                backface-visibility: hidden;
                -webkit-backface-visibility: hidden;
                transform-origin: center center;
                -webkit-transform-origin: center center;
            }

            .dispute-card-back {
                transform: rotateY(180deg);
                -webkit-transform: rotateY(180deg);
            }

            /* Mobile Flipped State */
            .dispute-card-inner.flipped,
            .dispute-card-inner[style*="rotateY(180deg)"] {
                transform: rotateY(180deg) !important;
                -webkit-transform: rotateY(180deg) !important;
            }
        }

        /* Small Devices (landscape phones, 576px and up) */
        @media (min-width: 576px) and (max-width: 767.98px) {
            body {
                padding: 0.75rem;
                font-size: 15px;
            }

            .dispute-library {
                padding: 0.5rem;
            }

            .library-title {
                font-size: 1.75rem;
            }

            .search-container {
                flex-direction: row;
                gap: 0.75rem;
            }

            .search-input {
                flex: 1;
                border-radius: 8px;
            }

            .search-button {
                width: auto;
                border-radius: 8px;
                padding: 1rem 1.5rem;
            }

            .filter-container {
                justify-content: center;
                overflow-x: visible;
            }

            .letter-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1.25rem;
            }

            .dispute-prompt-card {
                width: calc(50% - 0.625rem);
                margin: 0 0 1.25rem 0;
            }

            #letterGrid {
                gap: 1.25rem;
                padding: 0.5rem;
            }
        }

        /* Medium Devices (tablets, 768px and up) */
        @media (min-width: 768px) and (max-width: 991.98px) {
            body {
                padding: 1rem;
            }

            .dispute-library {
                padding: 1rem;
            }

            .library-title {
                font-size: 2rem;
            }

            .letter-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1.5rem;
            }

            .letter-card {
                min-height: 300px;
            }

            .dispute-prompt-card {
                width: calc(50% - 0.75rem);
                height: 420px;
            }

            #letterGrid {
                gap: 1.5rem;
                padding: 1rem;
            }
        }

        /* Large Devices (desktops, 992px and up) */
        @media (min-width: 992px) {
            .letter-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 2rem;
            }

            .dispute-prompt-card {
                width: 320px;
                height: 450px;
                margin: 15px;
            }

            #letterGrid {
                gap: 25px;
                padding: 25px;
            }
        }

        /* Landscape Orientation Adjustments for Mobile */
        @media (max-width: 767.98px) and (orientation: landscape) {
            body {
                padding: 0.25rem 0.5rem;
            }

            .library-header {
                margin-bottom: 1rem;
                padding: 0.75rem;
            }

            .library-title {
                font-size: 1.25rem;
                margin-bottom: 0.5rem;
            }

            .library-description {
                font-size: 0.85rem;
            }

            .search-container {
                margin-bottom: 1rem;
                gap: 0.5rem;
            }

            .search-input,
            .search-button {
                padding: 0.75rem;
                min-height: 40px;
            }

            .filter-container {
                margin-bottom: 1rem;
            }

            .filter-button {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
                min-height: 40px;
            }

            .letter-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }

            .letter-card {
                min-height: 280px;
            }

            .letter-card-front,
            .letter-card-back {
                padding: 1rem;
            }

            .dispute-prompt-card {
                min-height: 300px;
            }

            .dispute-card-front,
            .dispute-card-back {
                padding: 1rem;
            }
        }

        /* Touch Device Optimizations */
        @media (hover: none) and (pointer: coarse) {

            .filter-button:hover,
            .letter-flip-btn:hover,
            .letter-action-btn:hover,
            .search-button:hover {
                background-color: initial;
                transform: none;
            }

            .letter-card-inner:hover {
                transform: none;
            }

            /* Enhanced tap targets for touch */
            .letter-flip-btn,
            .letter-action-btn,
            .letter-back-btn,
            .dispute-flip-btn,
            .dispute-copy-btn {
                -webkit-tap-highlight-color: rgba(0, 128, 128, 0.2);
            }

            /* Prevent text selection on interactive elements */
            .filter-button,
            .letter-flip-btn,
            .letter-action-btn,
            .letter-back-btn,
            .search-button,
            .dispute-flip-btn,
            .dispute-copy-btn {
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
        }

        /* High DPI Displays */
        @media (-webkit-min-device-pixel-ratio: 2),
        (min-resolution: 192dpi) {

            .letter-card-inner,
            .dispute-card-inner {
                will-change: transform;
            }

            .letter-icon,
            .dispute-ai-icon {
                text-rendering: optimizeLegibility;
            }
        }

        /* iOS Safari Specific Adjustments */
        @supports (-webkit-touch-callout: none) {
            .search-input {
                font-size: 16px;
                /* Prevent zoom on focus */
            }

            .letter-grid,
            .filter-container {
                -webkit-overflow-scrolling: touch;
            }

            /* Safe area adjustments for iPhone X+ */
            @media (max-width: 575.98px) {
                body {
                    padding-left: max(0.5rem, env(safe-area-inset-left));
                    padding-right: max(0.5rem, env(safe-area-inset-right));
                }
            }
        }

        /* Reduced Motion Preferences */
        @media (prefers-reduced-motion: reduce) {

            .letter-card-inner,
            .dispute-card-inner {
                transition: none;
            }

            .letter-flip-btn,
            .letter-action-btn,
            .filter-button,
            .search-button,
            .dispute-flip-btn,
            .dispute-copy-btn {
                transition: none;
            }

            .loading-spinner {
                animation: none;
                border: 3px solid var(--gray-300);
                border-top: 3px solid var(--blue-dark);
            }
        }

        /* Dark Mode Support 
        @media (prefers-color-scheme: dark) {
            :root {
                --gray-100: #2d2d2d;
                --gray-200: #3a3a3a;
                --gray-300: #4a4a4a;
                --gray-600: #cccccc;
                --gray-800: #ffffff;
                --primary-light: rgba(0, 128, 128, 0.2);
            }

            body {
                background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
                color: #ffffff;
            }

            .library-header {
                background: linear-gradient(135deg, #2d2d2d 0%, #3a3a3a 100%);
            }

            .search-input {
                background: #3a3a3a;
                border-color: #4a4a4a;
                color: #ffffff;
            }

            .filter-button {
                background: #3a3a3a;
                border-color: #4a4a4a;
                color: #ffffff;
            }

            .empty-state,
            .loading-state {
                background: #2d2d2d;
            }

            .dispute-card-front {
                background: linear-gradient(135deg, #2d2d2d 0%, #3a3a3a 100%);
            }

            .dispute-card-back {
                background: linear-gradient(135deg, #3a3a3a 0%, #2d2d2d 100%);
            }
        }*/

        /* Print Styles */
        @media print {
            body {
                background: white;
                color: black;
                padding: 0;
            }

            .search-container,
            .filter-container {
                display: none;
            }

            .letter-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .letter-card-inner {
                box-shadow: none;
                border: 1px solid #000;
            }

            .letter-card-back {
                display: none;
            }

            .letter-flip-btn,
            .letter-action-btn {
                display: none;
            }
        }

        /* Dispute Card Styles - Mobile First Approach - Optimized Larger Size */
        .dispute-prompt-card {
            perspective: 1200px;
            -webkit-perspective: 1200px;
            margin: 15px;
            width: 100%;
            height: auto;
            min-height: 420px;
            /* Increased from 320px */
        }

        .dispute-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            min-height: 380px;
            /* Increased from 280px */
            text-align: left;
            transition: transform 0.5s ease;
            -webkit-transition: -webkit-transform 0.5s ease;
            transform-style: preserve-3d;
            -webkit-transform-style: preserve-3d;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.12);
            border-radius: 12px;
        }

        .dispute-card-front,
        .dispute-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            min-height: 380px;
            /* Increased from 280px */
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 12px;
            padding: 24px;
            /* Increased from 20px */
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            overflow: visible;
        }

        /* Desktop and larger screens */
        @media (min-width: 576px) {
            .dispute-prompt-card {
                width: 320px;
                height: 450px;
                min-height: 450px;
            }

            .dispute-card-inner {
                min-height: 450px;
            }

            .dispute-card-front,
            .dispute-card-back {
                min-height: 450px;
                overflow: hidden;
            }
        }

        .dispute-card-front {
            background-color: #ffffff;
            color: #333;
            display: flex;
            flex-direction: column;
        }

        .dispute-card-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
            min-height: 60px;
        }

        .dispute-ai-icon {
            font-size: 24px;
            margin-right: 10px;
            color: #4a6cf7;
            margin-top: 3px;
        }

        .dispute-card-front h3 {
            margin: 0;
            font-size: 18px;
            color: #333;
            flex: 1;
            line-height: 1.4;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .dispute-card-front h3.long-title {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .dispute-card-description {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 18px;
            font-size: 15px;
            /* Increased from 14px */
            line-height: 1.7;
            /* Increased from 1.6 */
            color: #666;
            padding: 8px 8px 8px 0;
            /* Increased padding */
        }

        /* Desktop and larger screens - add max-height for description */
        @media (min-width: 576px) {
            .dispute-card-description {
                max-height: 360px;
                /* Increased from 280px */
            }
        }

        .dispute-card-description::-webkit-scrollbar {
            width: 4px;
        }

        .dispute-card-description::-webkit-scrollbar-thumb {
            background-color: #ddd;
            border-radius: 4px;
        }

        .dispute-flip-btn {
            align-self: flex-end;
            background-color: transparent;
            border: none;
            color: #4a6cf7;
            cursor: pointer;
            font-weight: 600;
            padding: 10px 0;
            transition: color 0.3s;
            margin-top: 10px;
        }

        .dispute-flip-btn:hover {
            color: #3451b2;
        }

        .dispute-card-back {
            background-color: #f8f9fa;
            color: #333;
            transform: rotateY(180deg);
            -webkit-transform: rotateY(180deg);
            display: flex;
            flex-direction: column;
        }

        /* Ensure buttons on card back are visible */
        .dispute-card-back .dispute-copy-btn,
        .dispute-card-back .letter-action-btn,
        .dispute-card-back .letter-back-btn,
        .dispute-card-back .dispute-back-btn {
            background-color: #4a6cf7 !important;
            color: white !important;
            border: 2px solid #4a6cf7 !important;
            font-weight: 600 !important;
            opacity: 1 !important;
        }

        .dispute-card-back .letter-back-btn,
        .dispute-card-back .dispute-back-btn {
            background-color: #6c757d !important;
            color: white !important;
            border: 2px solid #6c757d !important;
        }

        .dispute-card-back .dispute-copy-btn:hover,
        .dispute-card-back .letter-action-btn:hover {
            background-color: #3451b2 !important;
            border-color: #3451b2 !important;
        }

        .dispute-card-back .letter-back-btn:hover,
        .dispute-card-back .dispute-back-btn:hover {
            background-color: #5a6268 !important;
            border-color: #5a6268 !important;
        }

        /* Immediate content hiding during flip animation */
        .dispute-card-inner.flipping .dispute-card-front .letter-flip-btn,
        .dispute-card-inner.flipping .dispute-card-front .dispute-flip-btn {
            opacity: 0 !important;
            visibility: hidden !important;
            transition: none !important;
        }

        .dispute-card-inner.flipping .dispute-card-back .letter-back-btn,
        .dispute-card-inner.flipping .dispute-card-back .dispute-back-btn,
        .dispute-card-inner.flipping .dispute-card-back .dispute-copy-btn {
            opacity: 0 !important;
            visibility: hidden !important;
            transition: none !important;
        }

        /* Show content after flip animation completes */
        .dispute-card-inner:not(.flipping) .dispute-card-front .letter-flip-btn,
        .dispute-card-inner:not(.flipping) .dispute-card-front .dispute-flip-btn,
        .dispute-card-inner:not(.flipping) .dispute-card-back .letter-back-btn,
        .dispute-card-inner:not(.flipping) .dispute-card-back .dispute-back-btn,
        .dispute-card-inner:not(.flipping) .dispute-card-back .dispute-copy-btn {
            opacity: 1 !important;
            visibility: visible !important;
        }

        .dispute-prompt-content {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .dispute-prompt-content h4 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
        }

        .dispute-prompt-content pre {
            flex: 1;
            overflow-y: auto;
            background-color: #f1f3f5;
            padding: 16px;
            /* Increased from 12px */
            border-radius: 8px;
            /* Increased from 5px */
            font-family: monospace;
            font-size: 14px;
            /* Increased from 13px */
            line-height: 1.6;
            /* Increased from 1.5 */
            margin: 0 0 18px 0;
            /* Increased margin */
            white-space: pre-wrap;
            word-break: break-word;
        }

        /* Desktop and larger screens - add max-height for prompt content */
        @media (min-width: 576px) {
            .dispute-prompt-content pre {
                max-height: 380px;
                /* Increased from 300px */
            }
        }

        /* Tablet Screens - Enhanced Size */
        @media (min-width: 768px) {
            .dispute-prompt-card {
                min-height: 460px;
            }

            .dispute-card-inner,
            .dispute-card-front,
            .dispute-card-back {
                min-height: 420px;
                padding: 28px;
            }

            .dispute-card-description {
                font-size: 16px;
                line-height: 1.8;
                margin-bottom: 20px;
                max-height: 400px;
            }

            .dispute-prompt-content pre {
                font-size: 15px;
                line-height: 1.7;
                padding: 20px;
                max-height: 420px;
            }
        }

        /* Desktop Screens - Maximum Size */
        @media (min-width: 992px) {
            .dispute-prompt-card {
                min-height: 500px;
            }

            .dispute-card-inner,
            .dispute-card-front,
            .dispute-card-back {
                min-height: 460px;
                padding: 32px;
            }

            .dispute-card-description {
                font-size: 17px;
                line-height: 1.8;
                margin-bottom: 22px;
                max-height: 440px;
            }

            .dispute-prompt-content pre {
                font-size: 16px;
                line-height: 1.8;
                padding: 24px;
                max-height: 460px;
            }
        }

        .dispute-button-container {
            display: flex;
            justify-content: space-between;
            margin-top: auto;
        }

        .dispute-copy-btn {
            background-color: #4a6cf7;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            transition: background-color 0.3s;
        }

        .dispute-copy-btn:hover {
            background-color: #3451b2;
        }

        .dispute-copy-icon {
            margin-right: 5px;
        }

        /* Flipped state */
        .flipped .dispute-card-inner {
            transform: rotateY(180deg);
        }

        /* Card grid layout improvements */
        #letterGrid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 25px;
            padding: 25px;
        }
    </style>
</head>

<body>
    <!-- No HTML content needed here as it's generated by the script -->
    <script>
        // Create a module for the Dispute Library functionality
        const DisputeLibraryModule = (function () {
            // Private variables
            let isInitialized = false;
            let isDisputeCardsLoading = false;
            let currentFilter = 'all';
            let searchTerm = '';

            // Debug logging function with timestamp
            function debugLog(message, data) {
                const timestamp = new Date().toISOString().split('T')[1].split('.')[0]; // HH:MM:SS
                console.log(`[DisputeLibrary ${timestamp}] ${message}`);
                if (data !== undefined) {
                    console.log(`[DisputeLibrary ${timestamp}] Data:`, data);
                }
            }

            // Error logging function with timestamp
            function errorLog(message, error) {
                const timestamp = new Date().toISOString().split('T')[1].split('.')[0]; // HH:MM:SS
                console.error(`[DisputeLibrary ${timestamp}] ERROR: ${message}`);
                if (error) {
                    console.error(`[DisputeLibrary ${timestamp}] Error details:`, error);
                }
            }

            // Check if we have a saved state
            function getSavedState() {
                try {
                    debugLog('Checking for saved state');
                    const savedState = localStorage.getItem('jamDisputeLibraryState');
                    if (savedState) {
                        const parsedState = JSON.parse(savedState);
                        debugLog('Found saved state', parsedState);
                        return parsedState;
                    }
                    debugLog('No saved state found');
                } catch (e) {
                    errorLog('Failed to retrieve saved state', e);
                }
                return null;
            }

            // Save current state
            function saveState() {
                try {
                    const state = {
                        currentFilter: currentFilter,
                        searchTerm: searchTerm,
                        lastVisit: new Date().toISOString()
                    };
                    debugLog('Saving state', state);
                    localStorage.setItem('jamDisputeLibraryState', JSON.stringify(state));
                    debugLog('State saved successfully');
                } catch (e) {
                    errorLog('Failed to save state', e);
                }
            }

            // Initialize the module
            function init(containerId) {
                debugLog(`Initializing with container: ${containerId}`);
                debugLog(`Current initialization state: ${isInitialized}`);

                const container = document.getElementById(containerId);
                if (!container) {
                    errorLog(`Container not found: ${containerId}`);
                    return false;
                }

                debugLog('Container found, continuing initialization');

                // Restore saved state if available
                const savedState = getSavedState();
                if (savedState) {
                    currentFilter = savedState.currentFilter || 'all';
                    searchTerm = savedState.searchTerm || '';
                    debugLog('Restored state values');
                    debugLog('Data:', { currentFilter, searchTerm });
                }

                // If already initialized, check if we need to rebuild the HTML structure
                if (isInitialized) {
                    debugLog('Already initialized, refreshing content');

                    // Check if the letter grid exists
                    const letterGrid = document.getElementById('letterGrid');
                    if (!letterGrid) {
                        debugLog('Letter grid not found, rebuilding HTML structure');
                        // Insert the library HTML since it's missing
                        container.innerHTML = `
                            <div class="dispute-library">
                                <div class="library-header">
                                    <h1 class="library-title">Dispute Letter Library</h1>
                                    <p class="library-description">Browse our collection of professionally crafted dispute letter prompts for various credit reporting issues.</p>
                                </div>
                                
                                <div class="search-container">
                                    <input type="text" class="search-input" placeholder="Search for dispute letters..." value="${searchTerm}">
                                    <button class="search-button"><i class="fas fa-search"></i> Search</button>
                                </div>
                                
                                <div class="filter-container">
                                    <button class="filter-button ${currentFilter === 'all' ? 'active' : ''}" data-filter="all">All Letters</button>
                                    <button class="filter-button ${currentFilter === 'General' ? 'active' : ''}" data-filter="General">General</button>
                                    <button class="filter-button ${currentFilter === 'Late Payments' ? 'active' : ''}" data-filter="Late Payments">Late Payments</button>
                                    <button class="filter-button ${currentFilter === 'Collections' ? 'active' : ''}" data-filter="Collections">Collections</button>
                                    <button class="filter-button ${currentFilter === 'Inquiries' ? 'active' : ''}" data-filter="Inquiries">Inquiries</button>
                                    <button class="filter-button ${currentFilter === 'Identity Theft' ? 'active' : ''}" data-filter="Identity Theft">Identity Theft</button>
                                    <button class="filter-button ${currentFilter === 'Bankruptcy' ? 'active' : ''}" data-filter="Bankruptcy">Bankruptcy</button>
                                </div>
                                
                                <div class="library-content">
                                    <div class="letter-grid" id="letterGrid">
                                        <div class="loading-state">
                                            <div class="loading-spinner"></div>
                                            <h3>Loading dispute letters...</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;

                        // Set up event listeners for search and filters
                        setupEventListeners();
                    }

                    // Check if the module is still functional
                    if (window.jamDisputeCards) {
                        try {
                            // Try to call a method to verify the module is working
                            const testLetters = window.jamDisputeCards.getAllLetters();
                            if (Array.isArray(testLetters)) {
                                debugLog('DisputeCards module is functional, re-rendering');
                                renderLetters();
                                return true;
                            } else {
                                debugLog('DisputeCards module exists but returned invalid data');
                            }
                        } catch (e) {
                            errorLog('Error testing DisputeCards module functionality', e);
                        }
                    }

                    // If we get here, the module isn't functional despite being initialized
                    debugLog('Module not functional, resetting initialization state');
                    isInitialized = false;
                    // Continue with initialization below
                }

                // Insert the library HTML (for first initialization)
                debugLog('Inserting library HTML');
                container.innerHTML = `
                    <div class="dispute-library">
                        <div class="library-header">
                            <h1 class="library-title">Dispute Letter Library</h1>
                            <p class="library-description">Browse our collection of professionally crafted dispute letters for various credit reporting issues.</p>
                        </div>
                        
                        <div class="search-container">
                            <input type="text" class="search-input" placeholder="Search for dispute letters..." value="${searchTerm}">
                            <button class="search-button"><i class="fas fa-search"></i> Search</button>
                        </div>
                        
                        <div class="filter-container">
                            <button class="filter-button ${currentFilter === 'all' ? 'active' : ''}" data-filter="all">All Letters</button>
                            <button class="filter-button ${currentFilter === 'General' ? 'active' : ''}" data-filter="General">General</button>
                            <button class="filter-button ${currentFilter === 'Late Payments' ? 'active' : ''}" data-filter="Late Payments">Late Payments</button>
                            <button class="filter-button ${currentFilter === 'Collections' ? 'active' : ''}" data-filter="Collections">Collections</button>
                            <button class="filter-button ${currentFilter === 'Inquiries' ? 'active' : ''}" data-filter="Inquiries">Inquiries</button>
                            <button class="filter-button ${currentFilter === 'Identity Theft' ? 'active' : ''}" data-filter="Identity Theft">Identity Theft</button>
                            <button class="filter-button ${currentFilter === 'Bankruptcy' ? 'active' : ''}" data-filter="Bankruptcy">Bankruptcy</button>
                        </div>
                        
                        <div class="library-content">
                            <div class="letter-grid" id="letterGrid">
                                <div class="loading-state">
                                    <div class="loading-spinner"></div>
                                    <h3>Loading dispute letters...</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Set up event listeners for search and filters
                setupEventListeners();

                // Load the DisputeCards module and render letters
                loadDisputeCardsAndRender();

                // Set up visibility change listener to handle tab switching
                document.addEventListener('visibilitychange', handleVisibilityChange);

                // Set up beforeunload to save state when leaving
                window.addEventListener('beforeunload', saveState);

                isInitialized = true;
                return true;
            }

            // Handle visibility change (tab switching)
            function handleVisibilityChange() {
                debugLog(`Visibility changed to: ${document.visibilityState}`);

                if (document.visibilityState === 'visible') {
                    debugLog('Tab became visible, checking for DisputeCards module');

                    // Always re-render when coming back to the tab
                    if (isInitialized && window.jamDisputeCards) {
                        try {
                            // Try to call a method to verify the module is working
                            const testLetters = window.jamDisputeCards.getAllLetters();
                            if (Array.isArray(testLetters)) {
                                debugLog('DisputeCards module is functional, re-rendering');
                                renderLetters();
                                return;
                            }
                        } catch (e) {
                            errorLog('Error testing DisputeCards module functionality', e);
                        }
                    }

                    // If we get here, either not initialized or module not functional
                    debugLog('Module needs to be reinitialized');
                    isInitialized = false;
                    isDisputeCardsLoading = false;

                    // Re-initialize the entire module
                    init('interface-dispute-library-widget');
                } else {
                    // Tab is hidden, save the current state
                    debugLog('Tab became hidden, saving state');
                    saveState();
                }
            }

            // Function to load the DisputeCards module and render letters
            function loadDisputeCardsAndRender() {
                debugLog('loadDisputeCardsAndRender called');
                debugLog(`jamDisputeCards exists: ${!!window.jamDisputeCards}`);
                debugLog(`isDisputeCardsLoading: ${isDisputeCardsLoading}`);

                if (window.jamDisputeCards) {
                    debugLog('DisputeCards module already loaded, rendering letters');
                    // Make sure the module is initialized
                    try {
                        window.jamDisputeCards.init();
                        debugLog('DisputeCards module initialized');
                        renderLetters();
                    } catch (e) {
                        errorLog('Error initializing DisputeCards module', e);
                        reloadDisputeCardsModule();
                    }
                    return;
                }

                if (isDisputeCardsLoading) {
                    debugLog('DisputeCards module is already loading, waiting...');
                    return;
                }

                debugLog('Loading DisputeCards module');
                isDisputeCardsLoading = true;

                // Load the DisputeCards module
                loadDisputeCardsModule()
                    .then(() => {
                        debugLog('DisputeCards module loaded successfully');
                        isDisputeCardsLoading = false;
                        renderLetters();
                    })
                    .catch(error => {
                        errorLog('Failed to load DisputeCards module', error);
                        isDisputeCardsLoading = false;

                        const letterGrid = document.getElementById('letterGrid');
                        if (letterGrid) {
                            letterGrid.innerHTML = `
                                <div class="empty-state">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <h3>Error loading dispute letters</h3>
                                    <p>Please try refreshing the page or contact support if the problem persists.</p>
                                    <button class="letter-flip-btn" style="margin-top: 1rem;" onclick="window.jamDisputeLibrary.retryLoadingCards()">
                                        <i class="fas fa-sync-alt"></i> Retry
                                    </button>
                                </div>
                            `;
                        }
                    });
            }

            // Function to force reload the DisputeCards module
            function reloadDisputeCardsModule() {
                debugLog('Forcing reload of DisputeCards module');

                // Remove any existing script elements
                const existingScripts = document.querySelectorAll('script[src="Dispute Library/DisputeCards.html"]');
                existingScripts.forEach(script => script.remove());

                // Reset the module if it exists
                if (window.jamDisputeCards && typeof window.jamDisputeCards.reset === 'function') {
                    window.jamDisputeCards.reset();
                }

                // Clear from window
                window.jamDisputeCards = null;

                // Clear loading flag
                isDisputeCardsLoading = false;

                // Load the module again
                return loadDisputeCardsAndRender();
            }

            // Function to retry loading the DisputeCards module
            function retryLoadingCards() {
                debugLog('Retry loading cards requested by user');
                const letterGrid = document.getElementById('letterGrid');
                if (letterGrid) {
                    letterGrid.innerHTML = `
                        <div class="loading-state">
                            <div class="loading-spinner"></div>
                            <h3>Loading dispute letters...</h3>
                        </div>
                    `;
                }

                // Force a complete reload
                window.jamDisputeCards = undefined;
                isDisputeCardsLoading = false;

                try {
                    sessionStorage.removeItem('jamDisputeCardsScript');
                    debugLog('Cleared cached DisputeCards script for retry');
                } catch (e) {
                    errorLog('Error clearing cached script during retry', e);
                }

                loadDisputeCardsAndRender();
            }

            // Function to load the DisputeCards module
            function loadDisputeCardsModule() {
                debugLog('loadDisputeCardsModule called');

                return new Promise((resolve, reject) => {
                    // Check if the module is already loaded and functional
                    if (window.jamDisputeCards) {
                        try {
                            // Test if the module is functional
                            const testLetters = window.jamDisputeCards.getAllLetters();
                            if (Array.isArray(testLetters)) {
                                debugLog('DisputeCards module already exists and is functional');
                                resolve();
                                return;
                            } else {
                                debugLog('DisputeCards module exists but is not functional, reloading');
                                // Reset the module
                                if (typeof window.jamDisputeCards.reset === 'function') {
                                    window.jamDisputeCards.reset();
                                }
                                window.jamDisputeCards = null;
                            }
                        } catch (e) {
                            errorLog('Error testing existing DisputeCards module', e);
                            window.jamDisputeCards = null;
                        }
                    }

                    // Since we're using inline scripts, we'll create the DisputeCards module directly
                    debugLog('Creating DisputeCards module inline');

                    try {
                        // Insert the DisputeCards module code directly
                        const script = document.createElement('script');
                        script.textContent = `
                            // Create a module for the Dispute Cards functionality
                            const DisputeCardsModule = (function () {
                                // Private variables
                                let isInitialized = false;
                                let letters = [];
                            
                                // Initialize the module
                                function init() {
                                    // Check if already initialized to prevent duplicate initialization
                                    if (isInitialized) {
                                        console.log('DisputeCardsModule already initialized');
                                        return true;
                                    }
                                    
                                    console.log('Initializing DisputeCardsModule');
                                    
                                    // Load default letters
                                    loadDefaultLetters();
                                    
                                    // Set initialization flag
                                    isInitialized = true;
                                    
                                    return true;
                                }
                            
                                // Load default letters
                                function loadDefaultLetters() {
                                    letters = [
                                        {
                                            id: 1,
                                            title: "General Dispute Letter",
                                            category: "General",
                                            description: "A comprehensive letter for disputing multiple types of inaccurate information on your credit report.",
                                            fullDescription: "This general-purpose dispute letter addresses multiple inaccuracies on your credit report. It cites relevant sections of the Fair Credit Reporting Act (FCRA) and requests a thorough investigation.",
                                            date: "2023-01-15",
                                            icon: "fa-file-alt",
                                            content: "Sample letter content for general disputes..."
                                        },
                                        {
                                            id: 2,
                                            title: "Late Payment Dispute",
                                            category: "Late Payments",
                                            description: "Dispute incorrectly reported late payments with this targeted letter.",
                                            fullDescription: "This letter specifically addresses late payments that were incorrectly reported to the credit bureaus. It includes language about payment history documentation and requests removal of the inaccurate late payment marks.",
                                            date: "2023-02-10",
                                            icon: "fa-calendar-times",
                                            content: "Sample letter content for late payment disputes..."
                                        },
                                        {
                                            id: 3,
                                            title: "Collection Account Dispute",
                                            category: "Collections",
                                            description: "Challenge collection accounts that are inaccurate, outdated, or not yours.",
                                            fullDescription: "Use this letter to dispute collection accounts appearing on your credit report. It addresses issues like debt validation, time-barred debts, and accounts that don't belong to you.",
                                            date: "2023-03-05",
                                            icon: "fa-hand-holding-usd",
                                            content: "Sample letter content for collection disputes..."
                                        },
                                        {
                                            id: 4,
                                            title: "Hard Inquiry Dispute",
                                            category: "Inquiries",
                                            description: "Remove unauthorized hard inquiries from your credit report with this letter.",
                                            fullDescription: "This letter helps you dispute unauthorized hard inquiries on your credit report. It cites the FCRA requirement that credit pulls must have your permission and requests removal of inquiries made without your consent.",
                                            date: "2023-04-20",
                                            icon: "fa-search",
                                            content: "Sample letter content for inquiry disputes..."
                                        },
                                        {
                                            id: 5,
                                            title: "Identity Theft Dispute",
                                            category: "Identity Theft",
                                            description: "Comprehensive letter for disputing accounts opened fraudulently due to identity theft.",
                                            fullDescription: "This specialized letter addresses accounts and information on your credit report resulting from identity theft. It references the FTC Identity Theft Report process and requests immediate removal of fraudulent items.",
                                            date: "2023-05-12",
                                            icon: "fa-user-shield",
                                            content: "Sample letter content for identity theft disputes..."
                                        },
                                        {
                                            id: 6,
                                            title: "Bankruptcy Error Dispute",
                                            category: "Bankruptcy",
                                            description: "Correct errors in how bankruptcy information is reported on your credit file.",
                                            fullDescription: "This letter addresses errors in how bankruptcy information appears on your credit report. It helps correct discharge dates, included/excluded accounts, and other bankruptcy-related reporting errors.",
                                            date: "2023-06-30",
                                            icon: "fa-balance-scale",
                                            content: "Sample letter content for bankruptcy reporting disputes..."
                                        }
                                    ];
                                }
                            
                                // Reset the module state
                                function reset() {
                                    console.log('Resetting DisputeCardsModule');
                                    isInitialized = false;
                                    return true;
                                }
                            
                                // Get all letters
                                function getAllLetters() {
                                    return [...letters];
                                }
                            
                                // Get a letter by ID
                                function getLetterById(id) {
                                    return letters.find(letter => letter.id === id);
                                }
                            
                                // Get letters by category
                                function getLettersByCategory(category) {
                                    if (category === 'all') {
                                        return getAllLetters();
                                    }
                                    return letters.filter(letter => letter.category === category);
                                }
                            
                                // Search letters by term
                                function searchLetters(term) {
                                    if (!term) return getAllLetters();
                                    
                                    const searchTerm = term.toLowerCase();
                                    return letters.filter(letter => 
                                        letter.title.toLowerCase().includes(searchTerm) || 
                                        letter.description.toLowerCase().includes(searchTerm) ||
                                        letter.fullDescription.toLowerCase().includes(searchTerm) ||
                                        letter.category.toLowerCase().includes(searchTerm)
                                    );
                                }
                            
                                // Filter letters by category and search term
                                function filterLetters(category = 'all', searchTerm = '') {
                                    let result = getLettersByCategory(category);
                                    
                                    if (searchTerm) {
                                        result = result.filter(letter => 
                                            letter.title.toLowerCase().includes(searchTerm.toLowerCase()) || 
                                            letter.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                            letter.fullDescription.toLowerCase().includes(searchTerm.toLowerCase())
                                        );
                                    }
                                    
                                    return result;
                                }
                            
                                // Add a new letter
                                function addLetter(letter) {
                                    // Generate a new ID
                                    const newId = letters.length > 0 ? Math.max(...letters.map(l => l.id)) + 1 : 1;
                                    const newLetter = { ...letter, id: newId, date: new Date().toISOString().split('T')[0] };
                                    letters.push(newLetter);
                                    return newLetter;
                                }
                            
                                // Update an existing letter
                                function updateLetter(id, updatedData) {
                                    const index = letters.findIndex(letter => letter.id === id);
                                    if (index === -1) return false;
                                    
                                    letters[index] = { ...letters[index], ...updatedData };
                                    return letters[index];
                                }
                            
                                // Delete a letter
                                function deleteLetter(id) {
                                    const index = letters.findIndex(letter => letter.id === id);
                                    if (index === -1) return false;
                                    
                                    letters.splice(index, 1);
                                    return true;
                                }
                            
                                // Reset to default letters
                                function resetToDefault() {
                                    loadDefaultLetters();
                                    return true;
                                }
                            
                                // Flip a card
                                function flipCard(id) {
                                    const cardInner = document.querySelector(\`.dispute-card-inner[data-id="\${id}"]\`);
                                    if (!cardInner) return false;
                                    
                                    if (cardInner.style.transform === 'rotateY(180deg)') {
                                        cardInner.style.transform = 'rotateY(0deg)';
                                    } else {
                                        cardInner.style.transform = 'rotateY(180deg)';
                                    }
                                    
                                    return true;
                                }
                            
                                // Copy prompt to clipboard
                                function copyPromptToClipboard(id) {
                                    const letter = getLetterById(id);
                                    if (!letter) return false;
                                    
                                    const promptText = letter.promptText || letter.content || 'No content available';
                                    
                                    try {
                                        navigator.clipboard.writeText(promptText).then(
                                            function() {
                                                alert('Prompt copied to clipboard!');
                                            },
                                            function() {
                                                alert('Failed to copy prompt. Please try again or copy manually.');
                                            }
                                        );
                                    } catch (e) {
                                        // Fallback for older browsers
                                        const textarea = document.createElement('textarea');
                                        textarea.value = promptText;
                                        textarea.style.position = 'fixed';
                                        document.body.appendChild(textarea);
                                        textarea.focus();
                                        textarea.select();
                                        
                                        try {
                                            const successful = document.execCommand('copy');
                                            if (successful) {
                                                alert('Prompt copied to clipboard!');
                                            } else {
                                                alert('Failed to copy prompt. Please try again or copy manually.');
                                            }
                                        } catch (err) {
                                            alert('Failed to copy prompt. Please try again or copy manually.');
                                        }
                                        
                                        document.body.removeChild(textarea);
                                    }
                                    
                                    return true;
                                }
                            
                                // Public API
                                return {
                                    init: init,
                                    reset: reset,
                                    getAllLetters: getAllLetters,
                                    getLetterById: getLetterById,
                                    getLettersByCategory: getLettersByCategory,
                                    searchLetters: searchLetters,
                                    filterLetters: filterLetters,
                                    addLetter: addLetter,
                                    updateLetter: updateLetter,
                                    deleteLetter: deleteLetter,
                                    resetToDefault: resetToDefault,
                                    copyPromptToClipboard: copyPromptToClipboard,
                                    flipCard: flipCard
                                };
                            })();
                            
                            // Expose the module globally
                            window.jamDisputeCards = DisputeCardsModule;
                            
                            // Initialize the module
                            DisputeCardsModule.init();
                            
                            // Signal that the module is loaded
                            if (window.dispatchEvent) {
                                window.dispatchEvent(new CustomEvent('disputeCardsLoaded'));
                            }
                        `;

                        document.body.appendChild(script);

                        // Wait for the module to be loaded
                        const checkInterval = setInterval(() => {
                            if (window.jamDisputeCards) {
                                debugLog('DisputeCards module loaded inline');
                                clearInterval(checkInterval);
                                resolve();
                            }
                        }, 100);

                        // Set a timeout in case it doesn't load
                        setTimeout(() => {
                            if (!window.jamDisputeCards) {
                                clearInterval(checkInterval);
                                errorLog('Timeout waiting for DisputeCards module');
                                reject(new Error('Timeout waiting for module'));
                            }
                        }, 2000);
                    } catch (e) {
                        errorLog('Error creating inline DisputeCards module', e);
                        reject(new Error('Failed to create inline module'));
                    }
                });
            }

            // Set up event listeners for search and filters
            function setupEventListeners() {
                debugLog('Setting up event listeners');
                const searchButton = document.getElementById('searchButton');
                const searchInput = document.getElementById('letterSearch');
                const filterButtons = document.querySelectorAll('.filter-button');

                if (searchButton && searchInput) {
                    debugLog('Setting up search button listener');
                    searchButton.addEventListener('click', function () {
                        searchTerm = searchInput.value.toLowerCase();
                        debugLog(`Search button clicked, term: "${searchTerm}"`);
                        saveState();
                        renderLetters();
                    });
                }

                if (searchInput) {
                    debugLog('Setting up search input listener');
                    searchInput.addEventListener('keypress', function (e) {
                        if (e.key === 'Enter') {
                            searchTerm = searchInput.value.toLowerCase();
                            debugLog(`Search input enter pressed, term: "${searchTerm}"`);
                            saveState();
                            renderLetters();
                        }
                    });
                }

                if (filterButtons.length > 0) {
                    debugLog(`Setting up ${filterButtons.length} filter button listeners`);
                    filterButtons.forEach(button => {
                        button.addEventListener('click', function () {
                            filterButtons.forEach(btn => btn.classList.remove('active'));
                            this.classList.add('active');
                            currentFilter = this.getAttribute('data-filter');
                            debugLog(`Filter button clicked: ${currentFilter}`);
                            saveState();
                            renderLetters();
                        });
                    });
                }
            }

            // Render the letters based on current filter and search term
            function renderLetters() {
                debugLog('renderLetters called');

                // Check if DisputeCardsModule is available
                if (!window.jamDisputeCards) {
                    errorLog('DisputeCardsModule not available, cannot render letters');
                    return;
                }

                // Find the letter grid element
                let letterGrid = document.getElementById('letterGrid');

                // If letter grid doesn't exist, try to find the library content and create it
                if (!letterGrid) {
                    debugLog('Letter grid not found, looking for library content');
                    const libraryContent = document.querySelector('.library-content');

                    if (libraryContent) {
                        debugLog('Library content found, creating letter grid');
                        letterGrid = document.createElement('div');
                        letterGrid.id = 'letterGrid';
                        letterGrid.className = 'letter-grid';

                        // Add loading state
                        letterGrid.innerHTML = `
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <h3>Loading dispute letters...</h3>
                            </div>
                        `;

                        libraryContent.innerHTML = ''; // Clear existing content
                        libraryContent.appendChild(letterGrid);
                    } else {
                        // If library content doesn't exist, we need to rebuild the entire structure
                        debugLog('Library content not found, rebuilding entire structure');
                        const container = document.getElementById('interface-dispute-library-widget');

                        if (!container) {
                            errorLog('Container not found, cannot render letters');
                            return;
                        }

                        // Rebuild the HTML structure
                        container.innerHTML = `
                            <div class="dispute-library">
                                <div class="library-header">
                                    <h1 class="library-title">Dispute Letter Library</h1>
                                    <p class="library-description">Browse our collection of professionally crafted dispute letters for various credit reporting issues.</p>
                                </div>
                                
                                <div class="search-container">
                                    <input type="text" id="letterSearch" class="search-input" placeholder="Search for dispute letters..." value="${searchTerm}">
                                    <button id="searchButton" class="search-button"><i class="fas fa-search"></i> Search</button>
                                </div>
                                
                                <div class="filter-container">
                                    <button class="filter-button ${currentFilter === 'all' ? 'active' : ''}" data-filter="all">All Letters</button>
                                    <button class="filter-button ${currentFilter === 'General' ? 'active' : ''}" data-filter="General">General</button>
                                    <button class="filter-button ${currentFilter === 'Late Payments' ? 'active' : ''}" data-filter="Late Payments">Late Payments</button>
                                    <button class="filter-button ${currentFilter === 'Collections' ? 'active' : ''}" data-filter="Collections">Collections</button>
                                    <button class="filter-button ${currentFilter === 'Inquiries' ? 'active' : ''}" data-filter="Inquiries">Inquiries</button>
                                    <button class="filter-button ${currentFilter === 'Identity Theft' ? 'active' : ''}" data-filter="Identity Theft">Identity Theft</button>
                                    <button class="filter-button ${currentFilter === 'Bankruptcy' ? 'active' : ''}" data-filter="Bankruptcy">Bankruptcy</button>
                                </div>
                                
                                <div class="library-content">
                                    <div class="letter-grid" id="letterGrid">
                                        <div class="loading-state">
                                            <div class="loading-spinner"></div>
                                            <h3>Loading dispute letters...</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;

                        // Set up event listeners for the rebuilt structure
                        setupEventListeners();

                        // Get the letter grid from the rebuilt structure
                        letterGrid = document.getElementById('letterGrid');

                        if (!letterGrid) {
                            errorLog('Letter grid still not found after rebuilding, cannot render letters');
                            return;
                        }
                    }
                }

                // Get filtered letters from DisputeCardsModule (which has all our AI prompts)
                debugLog(`Getting filtered letters with filter: ${currentFilter}, search: ${searchTerm}`);
                const filteredLetters = window.jamDisputeCards.filterLetters(currentFilter, searchTerm);
                debugLog(`Found ${filteredLetters.length} letters after filtering`);

                // Check if we have any letters
                if (filteredLetters.length === 0) {
                    letterGrid.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-search"></i>
                            <h3>No letters found</h3>
                            <p>Try adjusting your search or filter criteria.</p>
                        </div>
                    `;
                    return;
                }

                // Render the letters using dispute card format for better mobile experience
                debugLog(`Rendering ${filteredLetters.length} letters as dispute cards`);
                letterGrid.innerHTML = filteredLetters.map(letter => `
                    <div class="dispute-prompt-card">
                        <div class="dispute-card-inner" data-id="${letter.id}">
                            <div class="dispute-card-front">
                                <div class="dispute-card-header">
                                    <span class="dispute-ai-icon">ðŸ¤–</span>
                                    <h3>${letter.title}</h3>
                                </div>
                                <span class="letter-category" style="background: rgba(9, 204, 252, 0.2); color: #09ccfc; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.8rem; margin-bottom: 0.8rem; display: inline-block;">${letter.category}</span>
                                <p class="dispute-card-description">${letter.description}</p>
                                <button class="dispute-flip-btn letter-flip-btn">View Prompt â†’</button>
                                <div class="letter-date" style="font-size: 0.8rem; color: rgba(102, 102, 102, 0.7); margin-top: 1rem;">Added: ${letter.date}</div>
                            </div>
                            <div class="dispute-card-back">
                                <div class="dispute-prompt-content">
                                    <h4>${letter.title} Prompt</h4>
                                    <pre><code>${(letter.promptText || letter.content || 'No content available')}</code></pre>
                                    <div class="dispute-button-container">
                                        <button class="dispute-copy-btn letter-action-btn preview" data-letter-id="${letter.id}">
                                            <span class="dispute-copy-icon">ðŸ“‹</span> Copy Prompt
                                    </button>
                                        <button class="letter-back-btn dispute-back-btn">â† Back</button>
                                </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                debugLog('Rendering complete, setting up event listeners');
                setupCardEventListeners();
            }

            // Set up card event listeners
            function setupCardEventListeners() {
                debugLog('Setting up card flip listeners');

                // Handle both letter cards and dispute cards - separate flip and back buttons
                const flipButtons = document.querySelectorAll('.letter-flip-btn:not(.letter-back-btn), .dispute-flip-btn:not(.dispute-back-btn)');
                const backButtons = document.querySelectorAll('.letter-back-btn, .dispute-back-btn');
                const previewButtons = document.querySelectorAll('.letter-action-btn.preview, .dispute-copy-btn');
                const downloadButtons = document.querySelectorAll('.letter-action-btn.download');

                debugLog(`Found ${flipButtons.length} flip buttons, ${backButtons.length} back buttons`);
                debugLog(`Found ${previewButtons.length} preview buttons, ${downloadButtons.length} download buttons`);

                // Handle front-to-back flip buttons
                flipButtons.forEach(btn => {
                    btn.addEventListener('click', function (e) {
                        e.preventDefault();
                        e.stopPropagation();

                        // Find the card ID from either dispute card or letter card structure
                        const disputeCard = this.closest('.dispute-prompt-card');
                        const letterCard = this.closest('.letter-card');

                        let cardId;
                        if (disputeCard) {
                            const cardInner = disputeCard.querySelector('.dispute-card-inner');
                            cardId = cardInner ? cardInner.getAttribute('data-id') : null;
                        } else if (letterCard) {
                            cardId = letterCard.getAttribute('data-id');
                        }

                        if (cardId) {
                            debugLog(`Front flip button clicked for card ${cardId}`);
                            flipCardToBack(parseInt(cardId));
                        } else {
                            errorLog('Could not find card ID for flip button');
                        }
                    });
                });

                // Handle back-to-front flip buttons  
                backButtons.forEach(btn => {
                    btn.addEventListener('click', function (e) {
                        e.preventDefault();
                        e.stopPropagation();

                        // Find the card ID from either dispute card or letter card structure
                        const disputeCard = this.closest('.dispute-prompt-card');
                        const letterCard = this.closest('.letter-card');

                        let cardId;
                        if (disputeCard) {
                            const cardInner = disputeCard.querySelector('.dispute-card-inner');
                            cardId = cardInner ? cardInner.getAttribute('data-id') : null;
                        } else if (letterCard) {
                            cardId = letterCard.getAttribute('data-id');
                        }

                        if (cardId) {
                            debugLog(`Back button clicked for card ${cardId}`);
                            flipCardToFront(parseInt(cardId));
                        } else {
                            errorLog('Could not find card ID for back button');
                        }
                    });
                });

                previewButtons.forEach(btn => {
                    btn.addEventListener('click', function (e) {
                        e.preventDefault();
                        e.stopPropagation();

                        const cardId = this.getAttribute('data-letter-id') || this.getAttribute('data-card-id');

                        if (cardId) {
                            debugLog(`Preview/Copy button clicked for card ${cardId}`);
                            previewLetter(parseInt(cardId));
                        } else {
                            errorLog('Could not find card ID for preview button');
                        }
                    });
                });

                downloadButtons.forEach(btn => {
                    btn.addEventListener('click', function (e) {
                        e.preventDefault();
                        e.stopPropagation();

                        const cardId = this.getAttribute('data-letter-id') || this.getAttribute('data-card-id');

                        if (cardId) {
                            debugLog(`Download button clicked for card ${cardId}`);
                            downloadLetter(parseInt(cardId));
                        } else {
                            errorLog('Could not find card ID for download button');
                        }
                    });
                });
            }

            function flipCard(id) {
                debugLog(`flipCard called for id: ${id}`);

                // Try to find both letter cards and dispute cards
                let card = document.querySelector(`.letter-card[data-id="${id}"] .letter-card-inner`);
                let isDisputeCard = false;

                if (!card) {
                    // Try dispute card selector
                    card = document.querySelector(`.dispute-card-inner[data-id="${id}"]`);
                    isDisputeCard = true;
                }

                if (card) {
                    debugLog(`${isDisputeCard ? 'Dispute card' : 'Letter card'} found, flipping`);

                    // Add flipping class to hide buttons during animation
                    card.classList.add('flipping');

                    // For mobile devices, use both webkit and standard transform
                    const currentTransform = card.style.transform || card.style.webkitTransform || '';
                    const isFlipped = currentTransform.includes('rotateY(180deg)');

                    if (isFlipped) {
                        card.style.transform = 'rotateY(0deg)';
                        card.style.webkitTransform = 'rotateY(0deg)';
                        card.classList.remove('flipped');
                        debugLog('Card flipped to front');
                    } else {
                        card.style.transform = 'rotateY(180deg)';
                        card.style.webkitTransform = 'rotateY(180deg)';
                        card.classList.add('flipped');
                        debugLog('Card flipped to back');
                    }

                    // Remove the flipping class after animation completes
                    setTimeout(() => {
                        card.classList.remove('flipping');
                        debugLog('Flipping animation complete');
                    }, 500); // Match the transition duration
                } else {
                    errorLog(`Card with id ${id} not found in either letter or dispute card collections`);
                }
            }

            function flipCardToBack(id) {
                debugLog(`flipCardToBack called for id: ${id}`);

                // Try to find both letter cards and dispute cards
                let card = document.querySelector(`.letter-card[data-id="${id}"] .letter-card-inner`);
                let isDisputeCard = false;

                if (!card) {
                    // Try dispute card selector
                    card = document.querySelector(`.dispute-card-inner[data-id="${id}"]`);
                    isDisputeCard = true;
                }

                if (card) {
                    debugLog(`${isDisputeCard ? 'Dispute card' : 'Letter card'} found, flipping to back`);

                    // Add flipping class to hide buttons during animation
                    card.classList.add('flipping');

                    // Always flip to back (180deg)
                    card.style.transform = 'rotateY(180deg)';
                    card.style.webkitTransform = 'rotateY(180deg)';
                    card.classList.add('flipped');
                    debugLog('Card flipped to back');

                    // Remove the flipping class after animation completes
                    setTimeout(() => {
                        card.classList.remove('flipping');
                        debugLog('Flip to back animation complete');
                    }, 500); // Match the transition duration
                } else {
                    errorLog(`Card with id ${id} not found in either letter or dispute card collections`);
                }
            }

            function flipCardToFront(id) {
                debugLog(`flipCardToFront called for id: ${id}`);

                // Try to find both letter cards and dispute cards
                let card = document.querySelector(`.letter-card[data-id="${id}"] .letter-card-inner`);
                let isDisputeCard = false;

                if (!card) {
                    // Try dispute card selector
                    card = document.querySelector(`.dispute-card-inner[data-id="${id}"]`);
                    isDisputeCard = true;
                }

                if (card) {
                    debugLog(`${isDisputeCard ? 'Dispute card' : 'Letter card'} found, flipping to front`);

                    // Add flipping class to hide buttons during animation
                    card.classList.add('flipping');

                    // Always flip to front (0deg)
                    card.style.transform = 'rotateY(0deg)';
                    card.style.webkitTransform = 'rotateY(0deg)';
                    card.classList.remove('flipped');
                    debugLog('Card flipped to front');

                    // Remove the flipping class after animation completes
                    setTimeout(() => {
                        card.classList.remove('flipping');
                        debugLog('Flip to front animation complete');
                    }, 500); // Match the transition duration
                } else {
                    errorLog(`Card with id ${id} not found in either letter or dispute card collections`);
                }
            }

            function previewLetter(id) {
                debugLog(`previewLetter called for id: ${id}`);
                if (!window.jamDisputeCards) {
                    errorLog('DisputeCards module not loaded');
                    alert('Error: Dispute cards module not loaded. Please refresh the page.');
                    return;
                }

                const letter = window.jamDisputeCards.getLetterById(id);
                if (!letter) {
                    errorLog(`Letter with id ${id} not found`);
                    alert('Error: Letter not found.');
                    return;
                }

                debugLog(`Copying prompt for letter: ${letter.title}`);

                // Get the full prompt text
                const promptText = letter.promptText || letter.content || 'No prompt available for this letter.';

                if (!promptText || promptText === 'No prompt available for this letter.') {
                    alert('No AI prompt available for this letter.');
                    return;
                }

                debugLog(`Prompt text length: ${promptText.length}`);

                // Copy to clipboard using modern API with fallback
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(promptText).then(
                        function () {
                            debugLog('âœ… Prompt copied successfully via Clipboard API');
                            showCopySuccessMessage(letter.title);
                        },
                        function (err) {
                            errorLog('âŒ Clipboard API failed', err);
                            fallbackCopyText(promptText, letter.title);
                        }
                    );
                } else {
                    debugLog('Using fallback copy method');
                    fallbackCopyText(promptText, letter.title);
                }
            }

            // Fallback copy method
            function fallbackCopyText(text, letterTitle) {
                const textArea = document.createElement("textarea");
                textArea.value = text;

                // Position off-screen
                textArea.style.top = "0";
                textArea.style.left = "0";
                textArea.style.position = "fixed";
                textArea.style.opacity = "0";

                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();

                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        debugLog('âœ… Fallback copy successful');
                        showCopySuccessMessage(letterTitle);
                    } else {
                        errorLog('âŒ Fallback copy failed');
                        alert('Failed to copy prompt. Please try selecting and copying the text manually.');
                    }
                } catch (err) {
                    errorLog('âŒ Fallback copy error', err);
                    alert('Copy failed. Please try selecting and copying the text manually.');
                }

                document.body.removeChild(textArea);
            }

            // Show success message
            function showCopySuccessMessage(letterTitle) {
                // Create or update a temporary success message
                let successDiv = document.getElementById('copy-success-message');
                if (!successDiv) {
                    successDiv = document.createElement('div');
                    successDiv.id = 'copy-success-message';
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #28a745;
                        color: white;
                        padding: 12px 20px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        z-index: 10000;
                        font-family: 'Montserrat', sans-serif;
                        font-weight: 500;
                        transition: opacity 0.3s ease;
                    `;
                    document.body.appendChild(successDiv);
                }

                successDiv.innerHTML = `
                    <i class="fas fa-check-circle" style="margin-right: 8px;"></i>
                    Prompt copied! "${letterTitle}"
                `;
                successDiv.style.opacity = '1';

                // Hide after 3 seconds
                setTimeout(() => {
                    successDiv.style.opacity = '0';
                    setTimeout(() => {
                        if (successDiv.parentNode) {
                            successDiv.parentNode.removeChild(successDiv);
                        }
                    }, 300);
                }, 3000);
            }

            function downloadLetter(id) {
                debugLog(`downloadLetter called for id: ${id}`);
                if (!window.jamDisputeCards) {
                    errorLog('DisputeCards module not loaded');
                    return;
                }

                const letter = window.jamDisputeCards.getLetterById(id);
                if (!letter) {
                    errorLog(`Letter with id ${id} not found`);
                    return;
                }

                debugLog(`Downloading letter: ${letter.title}`);
                alert(`Download started for "${letter.title}". In a real implementation, this would download a Word or PDF file.`);
                // In a real implementation, this would trigger a file download
            }

            // Reset initialization state (for reloading)
            function reset() {
                debugLog('Reset called');
                isInitialized = false;
                isDisputeCardsLoading = false;

                // Remove event listeners
                debugLog('Removing event listeners');
                document.removeEventListener('visibilitychange', handleVisibilityChange);
                window.removeEventListener('beforeunload', saveState);

                return true;
            }

            // Public API
            return {
                init: init,
                reset: reset,
                flipCard: flipCard,
                previewLetter: previewLetter,
                downloadLetter: downloadLetter,
                retryLoadingCards: retryLoadingCards
            };
        })();

        // Expose the module globally
        window.jamDisputeLibrary = DisputeLibraryModule;

        // Signal that the module is loaded
        if (window.dispatchEvent) {
            console.log('[DisputeLibrary] Dispatching disputeLibraryLoaded event');
            window.dispatchEvent(new CustomEvent('disputeLibraryLoaded'));
        }

        // Add this to the init function after loading the DisputeCards module
        window.addEventListener('disputeCardsReady', function (event) {
            debugLog(`DisputeCards module ready with ${event.detail.letterCount} letters`);
            renderLetters();
        });
    </script>
</body>

</html>