<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages Module</title>
    <style>
        /* Messages Module Styles */
        .messages-container {
            font-family: 'Roboto', sans-serif;
            max-width: 100%;
            margin: 0 auto;
        }

        .messages-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .messages-search {
            display: flex;
            align-items: center;
            background: #f5f5f5;
            border-radius: 20px;
            padding: 5px 15px;
            width: 250px;
        }

        .messages-search input {
            border: none;
            background: transparent;
            padding: 8px;
            width: 100%;
            outline: none;
        }

        .messages-filters {
            display: flex;
            gap: 10px;
        }

        .filter-btn {
            background: #f5f5f5;
            border: none;
            border-radius: 15px;
            padding: 5px 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: #09ccfc;
            color: white;
        }

        .messages-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .message-item {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
        }

        .message-item:hover {
            background-color: #f9f9f9;
        }

        .message-item.unread {
            background-color: #e6f9ff;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #09ccfc;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
        }

        .message-content {
            flex: 1;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .message-sender {
            font-weight: bold;
        }

        .message-time {
            color: #888;
            font-size: 0.8em;
        }

        .message-subject {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .message-preview {
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 500px;
        }

        .message-detail {
            padding: 20px;
            background: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: none;
        }

        .message-detail.active {
            display: block;
        }

        .message-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .message-detail-info {
            flex: 1;
        }

        .message-detail-subject {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .message-detail-meta {
            display: flex;
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .message-detail-sender {
            margin-right: 15px;
            font-weight: 500;
        }

        .message-detail-time {
            color: #888;
        }

        .message-detail-actions {
            display: flex;
            gap: 10px;
        }

        .message-detail-action {
            background: #f5f5f5;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .message-detail-action:hover {
            background: #e0e0e0;
        }

        .message-detail-action.primary {
            background: #09ccfc;
            color: white;
        }

        .message-detail-action.primary:hover {
            background: #07a3ca;
        }

        .message-detail-action.danger {
            background: #ffebee;
            color: #f44336;
        }

        .message-detail-action.danger:hover {
            background: #ffcdd2;
        }

        .message-detail-body {
            line-height: 1.6;
            color: #333;
            white-space: pre-line;
        }

        .message-compose {
            margin-top: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
        }

        .message-compose-header {
            font-weight: 600;
            margin-bottom: 15px;
        }

        .message-compose-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-weight: 500;
            color: #555;
        }

        .form-group input,
        .form-group textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #09ccfc;
            color: white;
        }

        .btn-primary:hover {
            background: #07a3ca;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #888;
        }

        .empty-state i {
            font-size: 3em;
            margin-bottom: 15px;
            color: #ddd;
        }

        .empty-state p {
            font-size: 1.1em;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .messages-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .messages-search {
                width: 100%;
            }

            .message-detail-header {
                flex-direction: column;
                gap: 15px;
            }

            .message-detail-actions {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>

<body>
    <script>
        // Messages Module
        const MessagesModule = (function () {
            // Private variables
            let isInitialized = false;
            let messages = [];
            let currentFilter = 'all';
            let activeMessageId = null;

            // Sample message data
            const sampleMessages = [
                {
                    id: 1,
                    sender: 'JAM Support',
                    avatar: 'JS',
                    subject: 'Welcome to JAM Capital Consultants',
                    body: 'Thank you for choosing JAM Capital Consultants for your credit repair needs. We\'re excited to help you improve your credit score and achieve your financial goals.\n\nOur team of experts will work closely with you to develop a personalized plan to address your specific credit issues. Please feel free to reach out if you have any questions or concerns.\n\nBest regards,\nThe JAM Support Team',
                    time: '2023-06-15T10:30:00',
                    read: true
                },
                {
                    id: 2,
                    sender: 'Credit Specialist',
                    avatar: 'CS',
                    subject: 'Your Credit Report Analysis',
                    body: 'We\'ve completed the initial analysis of your credit report. There are several items we\'ve identified that we can potentially dispute to help improve your score.\n\nI\'d like to schedule a call to discuss our findings and next steps. Please let me know what times work best for you this week.\n\nRegards,\nYour Credit Specialist',
                    time: '2023-06-18T14:45:00',
                    read: false
                },
                {
                    id: 3,
                    sender: 'Billing Department',
                    avatar: 'BD',
                    subject: 'Monthly Statement Available',
                    body: 'Your monthly statement is now available in your account. Please review it at your earliest convenience.\n\nIf you have any questions about your billing or would like to update your payment method, please don\'t hesitate to contact us.\n\nThank you,\nBilling Department',
                    time: '2023-06-20T09:15:00',
                    read: true
                },
                {
                    id: 4,
                    sender: 'JAM Updates',
                    avatar: 'JU',
                    subject: 'New Features Available',
                    body: 'We\'ve added some exciting new features to your dashboard!\n\n- Improved credit score tracking\n- Enhanced dispute management tools\n- New educational resources\n\nLog in to check them out, and let us know what you think.\n\nThe JAM Team',
                    time: '2023-06-22T16:30:00',
                    read: false
                },
                {
                    id: 5,
                    sender: 'Credit Specialist',
                    avatar: 'CS',
                    subject: 'Dispute Update',
                    body: 'Good news! We\'ve received responses for some of the disputes we filed on your behalf. Two items have been removed from your credit report, which should positively impact your score.\n\nWe\'re still waiting on responses for the remaining items and will update you as soon as we hear back.\n\nBest regards,\nYour Credit Specialist',
                    time: '2023-06-25T11:20:00',
                    read: false
                }
            ];

            // Format date for display
            function formatDate(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

                if (diffDays === 0) {
                    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                } else if (diffDays < 7) {
                    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                    return days[date.getDay()];
                } else {
                    return date.toLocaleDateString();
                }
            }

            // Function to fetch user notifications from the API
            async function fetchUserNotifications() {
                try {
                    console.log('üì® Fetching user notifications from API...');

                    // Get user ID from userData object in localStorage
                    let userId = localStorage.getItem('userId') || localStorage.getItem('user_id');

                    if (!userId) {
                        // Try to get it from userData object
                        const userData = localStorage.getItem('userData');
                        if (userData) {
                            try {
                                const parsedUserData = JSON.parse(userData);
                                userId = parsedUserData.id;
                                console.log('üîç Found user ID in userData:', userId);
                            } catch (error) {
                                console.error('Error parsing userData:', error);
                            }
                        }
                    }

                    const authToken = localStorage.getItem('authToken') ||
                        localStorage.getItem('token') ||
                        sessionStorage.getItem('authToken') ||
                        sessionStorage.getItem('token');

                    if (!userId) {
                        console.warn('‚ö†Ô∏è No user ID found in localStorage');
                        return null;
                    }

                    if (!authToken || authToken === 'demo-token') {
                        console.warn('‚ö†Ô∏è No valid auth token found');
                        return null;
                    }

                    console.log('üîç Making API request for user:', userId);

                    const response = await fetch(`http://localhost:3000/api/admin/get-user-notifications/${userId}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`API request failed: ${response.status}`);
                    }

                    const data = await response.json();

                    if (data.success && Array.isArray(data.messages)) {
                        console.log('‚úÖ Successfully fetched notifications from API:', data.messages.length);
                        return data.messages;
                    } else {
                        throw new Error('Invalid API response format');
                    }

                } catch (error) {
                    console.error('‚ùå Error fetching user notifications:', error);
                    return null;
                }
            }

            // Initialize the module
            async function init(containerId) {
                const container = document.getElementById(containerId);
                if (!container) {
                    console.error(`Container ${containerId} not found`);
                    return false;
                }

                // Only initialize once unless reset
                if (isInitialized) {
                    console.log('Messages Module already initialized');
                    return true;
                }

                console.log('Initializing Messages Module');

                // Try to fetch notifications from API, fallback to sample messages
                const apiMessages = await fetchUserNotifications();

                if (apiMessages && apiMessages.length > 0) {
                    console.log('üì® Using notifications from API');
                    messages = apiMessages;
                } else {
                    console.log('üì® Using sample messages as fallback');
                    messages = [...sampleMessages];
                }

                // Render the initial UI
                renderMessagesUI(container);

                // Set up event listeners
                setupEventListeners(container);

                // Mark as initialized
                isInitialized = true;
                return true;
            }

            // Render the messages UI
            function renderMessagesUI(container) {
                console.log('üé® Rendering messages UI with', messages.length, 'messages');

                // Create the messages container
                const messagesContainer = document.createElement('div');
                messagesContainer.className = 'messages-container';

                // Create the header with search and filters
                const header = document.createElement('div');
                header.className = 'messages-header';

                // Search box
                const searchBox = document.createElement('div');
                searchBox.className = 'messages-search';
                searchBox.innerHTML = `
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search messages..." id="message-search">
                `;

                // Filters
                const filters = document.createElement('div');
                filters.className = 'messages-filters';
                filters.innerHTML = `
                    <button class="filter-btn ${currentFilter === 'all' ? 'active' : ''}" data-filter="all">All</button>
                    <button class="filter-btn ${currentFilter === 'unread' ? 'active' : ''}" data-filter="unread">Unread</button>
                `;

                header.appendChild(searchBox);
                header.appendChild(filters);

                // Message detail view (initially hidden)
                const messageDetail = document.createElement('div');
                messageDetail.className = 'message-detail';
                messageDetail.id = 'message-detail';

                // Messages list
                const messagesList = document.createElement('ul');
                messagesList.className = 'messages-list';
                messagesList.id = 'messages-list';

                // Filter messages based on current filter
                const filteredMessages = currentFilter === 'all'
                    ? messages
                    : messages.filter(msg => !msg.read);

                if (filteredMessages.length === 0) {
                    messagesList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <p>No messages found</p>
                        </div>
                    `;
                } else {
                    messagesList.innerHTML = filteredMessages.map(message => `
                        <li class="message-item ${message.read ? '' : 'unread'}" data-id="${message.id}">
                            <div class="message-avatar">${message.avatar}</div>
                            <div class="message-content">
                                <div class="message-header">
                                    <span class="message-sender">${message.sender}</span>
                                    <span class="message-time">${formatDate(message.time)}</span>
                                </div>
                                <div class="message-subject">${message.subject}</div>
                                <div class="message-preview">${message.body.substring(0, 100)}${message.body.length > 100 ? '...' : ''}</div>
                            </div>
                        </li>
                    `).join('');
                }

                // Append all elements to the container
                messagesContainer.appendChild(header);
                messagesContainer.appendChild(messageDetail);
                messagesContainer.appendChild(messagesList);

                // Clear the container and append the messages UI
                container.innerHTML = '';
                container.appendChild(messagesContainer);

                // After rendering, automatically attach click handlers
                setTimeout(() => {
                    attachMessageClickHandlers(container);
                }, 100); // Small delay to ensure DOM is updated
            }

            // Set up event listeners
            function setupEventListeners(container) {
                console.log('üîß Setting up event listeners for Messages module');

                // Search functionality
                const searchInput = container.querySelector('.messages-search input');
                if (searchInput) {
                    console.log('‚úÖ Search input found, adding event listener');
                    searchInput.addEventListener('input', function (e) {
                        console.log('üîç Search input changed:', e.target.value);
                        filterMessages(e.target.value);
                    });
                } else {
                    console.error('‚ùå Search input not found');
                }

                // Filter buttons
                const filterButtons = container.querySelectorAll('.messages-filter-btn');
                console.log('üîß Found filter buttons:', filterButtons.length);

                filterButtons.forEach(button => {
                    console.log('‚úÖ Adding click listener to filter button:', button.textContent);
                    button.addEventListener('click', function (e) {
                        e.preventDefault();
                        const filter = this.dataset.filter;
                        console.log('üîò Filter button clicked:', filter);
                        setFilter(filter, container);
                    });
                });

                // Message item clicks - This is the key part for clicking messages
                const messagesList = container.querySelector('.messages-list');
                if (messagesList) {
                    console.log('‚úÖ Messages list found, adding click delegation');

                    messagesList.addEventListener('click', function (e) {
                        console.log('üñ±Ô∏è Click detected on messages list');
                        console.log('üñ±Ô∏è Click target:', e.target);
                        console.log('üñ±Ô∏è Click target classes:', e.target.className);

                        // Find the message item (could be clicked on child element)
                        const messageItem = e.target.closest('.message-item');
                        console.log('üñ±Ô∏è Found message item:', messageItem);

                        if (messageItem) {
                            const messageId = messageItem.dataset.id;
                            console.log('üì® Message clicked - ID:', messageId);
                            console.log('üì® Message item dataset:', messageItem.dataset);

                            // Mark as read
                            markAsRead(messageId);

                            // Show message details
                            showMessageDetails(messageId, container);
                        } else {
                            console.log('‚ùå No message item found in click path');
                        }
                    });
                } else {
                    console.error('‚ùå Messages list not found for event delegation');
                }

                // Compose button
                const composeBtn = container.querySelector('.messages-compose-btn');
                if (composeBtn) {
                    console.log('‚úÖ Compose button found, adding event listener');
                    composeBtn.addEventListener('click', function (e) {
                        e.preventDefault();
                        console.log('‚úâÔ∏è Compose button clicked');
                        showComposeModal(container);
                    });
                } else {
                    console.log('‚ö†Ô∏è Compose button not found');
                }

                console.log('üîß Event listeners setup complete');
            }

            // Mark message as read
            function markAsRead(messageId) {
                console.log('‚úÖ Marking message as read:', messageId);

                const message = messages.find(m => m.id == messageId);
                if (message) {
                    message.read = true;
                    console.log('‚úÖ Message marked as read in local array');

                    // Update the UI to reflect read status
                    const messageElement = document.querySelector(`[data-id="${messageId}"]`);
                    if (messageElement) {
                        messageElement.classList.remove('unread');
                        messageElement.classList.add('read');
                        console.log('‚úÖ Message UI updated to read status');
                    }

                    // TODO: Send API call to backend to mark as read in database
                    // This would be something like:
                    // updateMessageReadStatus(messageId, true);
                } else {
                    console.error('‚ùå Message not found for marking as read:', messageId);
                }
            }

            // Show message details
            function showMessageDetails(messageId, container) {
                console.log('üìñ showMessageDetails called with ID:', messageId);
                console.log('üìñ Available messages:', messages.length);

                const message = messages.find(m => m.id == messageId);
                console.log('üìñ Found message:', message);

                if (!message) {
                    console.error('‚ùå Message not found with ID:', messageId);
                    return;
                }

                // Look for the existing message detail panel
                let detailsPanel = container.querySelector('.message-detail');
                console.log('üìñ Looking for message detail panel:', detailsPanel);

                if (!detailsPanel) {
                    console.log('üìñ Message detail panel not found, checking for alternative selectors');
                    detailsPanel = container.querySelector('#message-detail') ||
                        container.querySelector('.message-details') ||
                        container.querySelector('[class*="detail"]');
                    console.log('üìñ Alternative detail panel found:', detailsPanel);
                }

                if (!detailsPanel) {
                    console.error('‚ùå No message details panel found in container');
                    console.log('üìñ Available elements in container:', container.querySelectorAll('*'));
                    return;
                }

                console.log('üìñ Updating details panel with message data');

                // Update the detail panel content
                detailsPanel.innerHTML = `
        <div class="message-detail-header">
            <button class="message-detail-back" onclick="closeMessageDetail()">
                <i class="fas fa-arrow-left"></i> Back to Messages
            </button>
            <div class="message-detail-actions">
                <button class="message-detail-action" data-action="mark-unread" onclick="toggleReadStatus('${messageId}')">
                    <i class="fas fa-envelope"></i> Mark as unread
                </button>
                <button class="message-detail-action" data-action="delete" onclick="deleteMessage('${messageId}')">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
        <div class="message-detail-info">
            <div class="message-detail-avatar">${message.avatar}</div>
            <div>
                <div class="message-detail-sender">${message.sender}</div>
                <div class="message-detail-time">${new Date(message.time).toLocaleString()}</div>
            </div>
        </div>
        <div class="message-detail-subject">
            <h2>${message.subject}</h2>
        </div>
        <div class="message-detail-body">
            ${message.body.replace(/\n/g, '<br>')}
        </div>
    `;

                // Show the detail panel by adding the active class
                detailsPanel.classList.add('active');
                console.log('üìñ Added active class to detail panel');

                // Hide the messages list
                const messagesList = container.querySelector('#messages-list');
                if (messagesList) {
                    messagesList.style.display = 'none';
                    console.log('üìñ Hidden messages list');
                } else {
                    console.log('‚ö†Ô∏è Messages list not found to hide');
                }

                // Set the active message ID
                activeMessageId = messageId;

                console.log('üìñ Message details updated and displayed successfully');
            }

            // Open a message
            function openMessage(messageId, container) {
                const message = messages.find(msg => msg.id === messageId);
                if (!message) return;

                // Mark as read
                if (!message.read) {
                    message.read = true;
                    // In a real app, you would send an API request to mark as read
                }

                // Store active message ID
                activeMessageId = messageId;

                // Update the message detail view
                const messageDetail = container.querySelector('#message-detail');
                if (messageDetail) {
                    messageDetail.innerHTML = `
                        <div class="message-detail-header">
                            <div class="message-detail-subject">${message.subject}</div>
                            <div class="message-detail-actions">
                                <button class="message-detail-action" data-action="back">
                                    <i class="fas fa-arrow-left"></i> Back
                                </button>
                                <button class="message-detail-action" data-action="${message.read ? 'mark-unread' : 'mark-read'}">
                                    <i class="fas ${message.read ? 'fa-envelope' : 'fa-envelope-open'}"></i> 
                                    ${message.read ? 'Mark as unread' : 'Mark as read'}
                                </button>
                                <button class="message-detail-action" data-action="delete">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                        <div class="message-detail-info">
                            <div class="message-detail-avatar">${message.avatar}</div>
                            <div>
                                <div class="message-detail-sender">${message.sender}</div>
                                <div class="message-detail-time">${new Date(message.time).toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="message-detail-body">
                            ${message.body.replace(/\n/g, '<br>')}
                        </div>
                    `;
                    messageDetail.classList.add('active');
                }

                // Hide the messages list
                const messagesList = container.querySelector('#messages-list');
                if (messagesList) {
                    messagesList.style.display = 'none';
                }

                // Update the message item in the list to reflect read status
                const messageItem = container.querySelector(`.message-item[data-id="${messageId}"]`);
                if (messageItem) {
                    messageItem.classList.remove('unread');
                }
            }

            // Close message detail function - make it globally accessible
            window.closeMessageDetail = function () {
                console.log('üîô Closing message detail');

                const container = document.querySelector('.messages-module') || document.querySelector('.messages-container');
                if (!container) {
                    console.error('‚ùå Container not found for closing message detail');
                    return;
                }

                const messageDetail = container.querySelector('.message-detail');
                if (messageDetail) {
                    messageDetail.classList.remove('active');
                    console.log('üìñ Removed active class from detail panel');
                }

                const messagesList = container.querySelector('#messages-list');
                if (messagesList) {
                    messagesList.style.display = 'block';
                    console.log('üìñ Showed messages list');
                }

                activeMessageId = null;
                console.log('üîô Message detail closed successfully');
            };

            // Toggle read status - also make it globally accessible
            window.toggleReadStatus = function (messageId) {
                console.log('üîÑ Toggle read status for message:', messageId);
                const message = messages.find(m => m.id == messageId);
                if (message) {
                    message.read = !message.read;
                    console.log('‚úÖ Message read status toggled to:', message.read);

                    // Update the UI
                    const container = document.querySelector('.messages-module') || document.querySelector('.messages-container');
                    if (container) {
                        // Re-render the message details to update the button
                        showMessageDetails(messageId, container);
                    }
                }
            };

            // Delete a message - also make it globally accessible
            window.deleteMessage = function (messageId) {
                console.log('üóëÔ∏è Delete message:', messageId);
                if (confirm('Are you sure you want to delete this message?')) {
                    // First, try to delete from the backend
                    deleteMessageFromBackend(messageId)
                        .then(success => {
                            if (success) {
                                console.log('‚úÖ Message deleted from backend successfully');

                                // Remove from local array
                                const index = messages.findIndex(m => m.id == messageId);
                                if (index > -1) {
                                    messages.splice(index, 1);
                                    console.log('‚úÖ Message deleted from local array');

                                    // Close the detail view and go back to list
                                    window.closeMessageDetail();

                                    // Re-render the messages list AND re-attach event handlers
                                    const container = document.querySelector('.messages-module') || document.querySelector('.messages-container');
                                    if (container) {
                                        renderMessagesUI(container);
                                        // Re-attach click handlers after re-rendering
                                        attachMessageClickHandlers(container);
                                    }
                                }
                            } else {
                                console.error('‚ùå Failed to delete message from backend');
                                alert('Failed to delete message. Please try again.');
                            }
                        })
                        .catch(error => {
                            console.error('‚ùå Error deleting message from backend:', error);
                            alert('Error deleting message. Please try again.');
                        });
                }
            };

            // Function to delete message from backend
            async function deleteMessageFromBackend(messageId) {
                try {
                    console.log('üåê Deleting message from backend:', messageId);

                    // Get user ID and auth token
                    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                    const userId = userData.id;
                    const authToken = localStorage.getItem('authToken') ||
                        localStorage.getItem('token') ||
                        sessionStorage.getItem('authToken') ||
                        sessionStorage.getItem('token');

                    if (!userId) {
                        console.error('‚ùå No user ID found for deleting message');
                        return false;
                    }

                    if (!authToken) {
                        console.error('‚ùå No auth token found for deleting message');
                        return false;
                    }

                    const response = await fetch(`http://localhost:3000/api/admin/delete-notification`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            notificationId: messageId,
                            userId: userId
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`HTTP error! status: ${response.status} - ${errorData.message || response.statusText}`);
                    }

                    const data = await response.json();

                    if (data.success) {
                        console.log('‚úÖ Message deleted from backend successfully');
                        return true;
                    } else {
                        console.error('‚ùå Backend returned failure:', data.message);
                        return false;
                    }

                } catch (error) {
                    console.error('‚ùå Error deleting message from backend:', error);
                    return false;
                }
            }

            // Search messages
            function searchMessages(query, container) {
                if (!query) {
                    // If query is empty, reset to current filter
                    renderMessagesUI(container);
                    return;
                }

                // Filter messages based on search query
                const filteredMessages = messages.filter(msg => {
                    const searchText = query.toLowerCase();
                    return (
                        msg.subject.toLowerCase().includes(searchText) ||
                        msg.body.toLowerCase().includes(searchText) ||
                        msg.sender.toLowerCase().includes(searchText)
                    );
                });

                // Update messages list
                const messagesList = container.querySelector('#messages-list');
                if (messagesList) {
                    if (filteredMessages.length === 0) {
                        messagesList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-search"></i>
                                <p>No messages found matching "${query}"</p>
                            </div>
                        `;
                    } else {
                        messagesList.innerHTML = filteredMessages.map(message => `
                            <li class="message-item ${message.read ? '' : 'unread'}" data-id="${message.id}">
                                <div class="message-avatar">${message.avatar}</div>
                                <div class="message-content">
                                    <div class="message-header">
                                        <span class="message-sender">${message.sender}</span>
                                        <span class="message-time">${formatDate(message.time)}</span>
                                    </div>
                                    <div class="message-subject">${message.subject}</div>
                                    <div class="message-preview">${message.body.substring(0, 100)}${message.body.length > 100 ? '...' : ''}</div>
                                </div>
                            </li>
                        `).join('');
                    }
                }
            }

            // Set filter
            function setFilter(filter, container) {
                if (filter === currentFilter) return;

                currentFilter = filter;

                // Update filter buttons
                const filterBtns = container.querySelectorAll('.filter-btn');
                filterBtns.forEach(btn => {
                    if (btn.dataset.filter === filter) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });

                // Re-render messages list
                renderMessagesUI(container);
            }

            // Reset initialization state (for reloading)
            function reset() {
                isInitialized = false;
                activeMessageId = null;
                return true;
            }

            // Function to attach click handlers to messages
            function attachMessageClickHandlers(container) {
                console.log('üîó Attaching message click handlers');

                const messagesList = container.querySelector('#messages-list');
                if (!messagesList) {
                    console.error('‚ùå Messages list not found for attaching handlers');
                    return;
                }

                // Remove any existing event listeners to prevent duplicates
                const existingHandler = messagesList.getAttribute('data-handler-attached');
                if (existingHandler) {
                    messagesList.removeEventListener('click', window.messagesClickHandler);
                }

                // Create and store the click handler function
                window.messagesClickHandler = function (event) {
                    console.log('üñ±Ô∏è Click detected on messages list');
                    console.log('üñ±Ô∏è Click target:', event.target);
                    console.log('üñ±Ô∏è Click target classes:', event.target.className);

                    // Find the closest message item
                    const messageItem = event.target.closest('.message-item');
                    console.log('üñ±Ô∏è Found message item:', messageItem);

                    if (messageItem && messageItem.dataset.id) {
                        const messageId = messageItem.dataset.id;
                        console.log('üì® Message clicked - ID:', messageId);
                        console.log('üì® Message item dataset:', messageItem.dataset);

                        // Mark as read and show details
                        markAsRead(messageId);
                        showMessageDetails(messageId, container);
                    }
                };

                // Attach the event listener
                messagesList.addEventListener('click', window.messagesClickHandler);
                messagesList.setAttribute('data-handler-attached', 'true');

                console.log('‚úÖ Message click handlers attached successfully');
            }

            // Public API
            return {
                init: init,
                reset: reset,
                openMessage: openMessage,
                closeMessageDetail: closeMessageDetail,
                toggleReadStatus: toggleReadStatus,
                deleteMessage: deleteMessage,
                searchMessages: searchMessages,
                setFilter: setFilter
            };
        })();

        // Expose the module globally
        window.jamMessages = MessagesModule;

        // Signal that the module is loaded
        if (window.dispatchEvent) {
            window.dispatchEvent(new CustomEvent('messagesModuleLoaded'));
        }
    </script>
</body>

</html>