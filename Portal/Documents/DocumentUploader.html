<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JAM Credit Solutions - Document Upload</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --primary: #008080;
            --primary-dark: #006666;
            --primary-light: #e6f7f7;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-600: #6c757d;
            --gray-800: #343a40;
            --gray-700: #6c757d;
            --gray-50: #f8f9fa;
            --primary-color: #007bff;
        }

        .document-upload-container {
            font-family: 'Montserrat', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .document-upload-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .document-upload-title {
            color: #09ccfc;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .document-upload-subtitle {
            color: #6c757d;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .document-section {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 30px;
        }

        .document-section-title {
            color: #09ccfc;
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e6f9ff;
        }

        .document-section-description {
            margin-bottom: 25px;
            line-height: 1.6;
            color: #6c757d;
        }

        .document-upload-area {
            border: 2px dashed #b3eafc;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            transition: background-color 0.3s;
            cursor: pointer;
        }

        .document-upload-area:hover {
            background-color: #e6f9ff;
        }

        .document-upload-icon {
            font-size: 3rem;
            color: #09ccfc;
            margin-bottom: 15px;
        }

        .document-upload-text {
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: #343a40;
        }

        .document-upload-subtext {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .document-list {
            margin-top: 30px;
        }

        .document-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .document-item:last-child {
            border-bottom: none;
        }

        .document-icon {
            font-size: 1.5rem;
            color: #09ccfc;
            margin-right: 15px;
        }

        .document-info {
            flex-grow: 1;
        }

        .document-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .document-meta {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .document-actions {
            display: flex;
        }

        .document-action-btn {
            background: none;
            border: none;
            color: #6c757d;
            font-size: 1rem;
            cursor: pointer;
            padding: 5px 10px;
            transition: color 0.2s;
        }

        .document-action-btn:hover {
            color: #09ccfc;
        }

        .document-action-btn.delete:hover {
            color: #dc3545;
        }

        .document-upload-btn {
            background-color: #09ccfc;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .document-upload-btn:hover {
            background-color: #07a3ca;
        }

        .document-upload-btn i {
            margin-right: 8px;
        }

        .document-upload-input {
            display: none;
        }

        .document-progress {
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            margin-top: 5px;
            overflow: hidden;
        }

        .document-progress-bar {
            height: 100%;
            background-color: #09ccfc;
            width: 0;
            transition: width 0.3s;
        }

        .document-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 10px;
        }

        .document-status.pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .document-status.success {
            background-color: #d4edda;
            color: #155724;
        }

        .document-status.error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .document-empty {
            text-align: center;
            padding: 30px;
            color: #6c757d;
        }

        .document-empty-icon {
            font-size: 3rem;
            color: #dee2e6;
            margin-bottom: 15px;
        }

        .document-empty-text {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .document-empty-subtext {
            font-size: 0.9rem;
        }

        /* SmartCredit Login Section */
        .smartcredit-login-section {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 30px;
        }

        .smartcredit-login-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .smartcredit-logo {
            max-width: 180px;
            margin-right: 20px;
        }

        .smartcredit-login-title {
            color: #09ccfc;
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .smartcredit-login-description {
            margin-bottom: 25px;
            line-height: 1.6;
            color: var(--gray-600);
        }

        .smartcredit-form {
            max-width: 600px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--gray-800);
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--gray-300);
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            border-color: var(--primary);
            outline: none;
        }

        .form-help {
            font-size: 0.85rem;
            color: var(--gray-600);
            margin-top: 5px;
        }

        .form-submit {
            background-color: #09ccfc;
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: block;
            margin: 30px auto 0;
        }

        .form-submit:hover {
            background-color: var(--primary-dark);
        }

        .submit-btn {
            background-color: #09ccfc;
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: block;
            margin: 30px auto 0;
        }

        .submit-btn:hover {
            background-color: var(--primary-dark);
        }

        .form-note {
            text-align: center;
            font-size: 0.9rem;
            color: var(--gray-600);
            margin-top: 15px;
        }

        /* Credential Status Styling */
        .credential-status {
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(40, 167, 69, 0.2);
        }

        .status-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .status-icon {
            font-size: 2rem;
            color: #28a745;
            flex-shrink: 0;
        }

        .status-info h4 {
            color: #155724;
            margin: 0 0 5px 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .status-details,
        .status-email {
            color: #155724;
            margin: 3px 0;
            font-size: 0.9rem;
        }

        .status-email {
            font-weight: 500;
        }

        .status-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .update-btn,
        .remove-btn,
        .cancel-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .update-btn {
            background: #007bff;
            color: white;
        }

        .update-btn:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .remove-btn {
            background: #dc3545;
            color: white;
        }

        .remove-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .cancel-btn {
            background: #6c757d;
            color: white;
            margin-top: 10px;
        }

        .cancel-btn:hover {
            background: #545b62;
            transform: translateY(-1px);
        }

        .update-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .update-warning i {
            color: #f39c12;
            font-size: 1.1rem;
        }

        .form-divider {
            display: flex;
            align-items: center;
            margin: 30px 0;
        }

        .form-divider-line {
            flex-grow: 1;
            height: 1px;
            background-color: var(--gray-300);
        }

        .form-divider-text {
            padding: 0 15px;
            color: var(--gray-600);
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .document-section {
                padding: 20px;
            }

            .document-upload-area {
                padding: 20px;
            }

            .smartcredit-login-header {
                flex-direction: column;
                text-align: center;
            }

            .smartcredit-logo {
                margin-right: 0;
                margin-bottom: 15px;
            }
        }

        /* Mobile Form Enhancements */
        @media (max-width: 575.98px) {

            .smartcredit-form,
            .form-group {
                margin-bottom: 15px;
            }

            .form-label {
                font-size: 0.9rem;
                margin-bottom: 6px;
                font-weight: 600;
            }

            .form-input {
                padding: 12px 14px;
                font-size: 1rem;
                border-radius: 10px;
                border: 2px solid var(--gray-300);
                transition: all 0.2s ease;
            }

            .form-input:focus {
                border-color: var(--primary);
                box-shadow: 0 0 0 3px rgba(9, 204, 252, 0.1);
                outline: none;
            }

            .form-submit,
            .submit-btn {
                width: 100%;
                padding: 14px 20px;
                font-size: 1rem;
                border-radius: 12px;
                margin: 20px 0;
                min-height: 50px;
                background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
                box-shadow: 0 4px 12px rgba(9, 204, 252, 0.3);
                transition: all 0.2s ease;
                touch-action: manipulation;
            }

            .form-submit:active,
            .submit-btn:active {
                transform: scale(0.98);
                box-shadow: 0 2px 8px rgba(9, 204, 252, 0.4);
            }

            .form-note {
                font-size: 0.8rem;
                line-height: 1.4;
                padding: 10px;
                background: var(--gray-100);
                border-radius: 8px;
                margin-top: 12px;
            }

            /* Mobile Credential Status */
            .credential-status {
                padding: 15px !important;
                margin-bottom: 15px !important;
                border-radius: 12px !important;
            }

            .status-header {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 10px !important;
                text-align: left !important;
            }

            .status-icon {
                font-size: 1.5rem !important;
                align-self: center !important;
            }

            .status-info {
                width: 100% !important;
                text-align: center !important;
            }

            .status-info h4 {
                font-size: 1rem !important;
                margin-bottom: 8px !important;
            }

            .status-details,
            .status-email {
                font-size: 0.8rem !important;
                margin: 2px 0 !important;
            }

            .status-actions {
                width: 100% !important;
                justify-content: center !important;
                gap: 8px !important;
                margin-top: 12px !important;
            }

            .update-btn,
            .remove-btn {
                flex: 1 !important;
                min-width: 120px !important;
                padding: 10px 12px !important;
                font-size: 0.8rem !important;
                justify-content: center !important;
                text-align: center !important;
            }

            .cancel-btn {
                width: 100% !important;
                margin-top: 8px !important;
                padding: 10px !important;
                font-size: 0.85rem !important;
                justify-content: center !important;
            }

            .update-warning {
                padding: 10px !important;
                margin-bottom: 15px !important;
                font-size: 0.8rem !important;
                flex-direction: column !important;
                text-align: center !important;
                gap: 6px !important;
            }

            .update-warning i {
                font-size: 1rem !important;
            }

            .form-help {
                font-size: 0.8rem;
                margin-top: 4px;
                line-height: 1.3;
            }
        }

        /* Add these styles to the existing <style> section */
        .document-item.upload-success {
            border-left: 4px solid var(--success);
        }

        .document-item.upload-error {
            border-left: 4px solid var(--danger);
        }

        .document-item.upload-progress {
            border-left: 4px solid var(--warning);
        }

        .document-item.upload-progress .document-meta {
            color: var(--warning);
        }

        .document-item.upload-error .document-meta {
            color: var(--danger);
        }

        .document-item.upload-success .document-meta {
            color: var(--success);
        }

        /* Bureau Selection Styles */
        .bureau-selection {
            margin-bottom: 20px;
            padding: 20px;
            background-color: var(--gray-100);
            border-radius: 8px;
            border: 2px solid var(--gray-200);
        }

        .bureau-selection-label {
            display: block;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .bureau-options {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .bureau-btn {
            flex: 1;
            min-width: 120px;
            padding: 15px 20px;
            border: 2px solid var(--gray-300);
            background-color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
            color: var(--gray-600);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        /* Mobile Bureau Selection Enhancement */
        @media (max-width: 575.98px) {
            .bureau-selection {
                margin-bottom: 15px;
                padding: 12px;
                border-radius: 12px;
            }

            .bureau-selection-label {
                font-size: 1rem;
                margin-bottom: 12px;
                text-align: center;
            }

            .bureau-options {
                gap: 8px;
                margin-bottom: 8px;
            }

            .bureau-btn {
                min-width: 100px;
                padding: 12px 8px;
                border-radius: 12px;
                font-size: 0.85rem;
                gap: 6px;
                min-height: 70px;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
            }

            .bureau-btn i {
                font-size: 1.2rem;
            }

            .bureau-btn.selected {
                transform: scale(1.02);
                box-shadow: 0 4px 12px rgba(0, 128, 128, 0.2);
            }

            .bureau-hint {
                font-size: 0.8rem;
                text-align: center;
                margin-top: 8px;
            }
        }

        .bureau-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 128, 128, 0.15);
        }

        .bureau-btn.selected {
            border-color: var(--primary);
            background-color: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 128, 128, 0.3);
        }

        .bureau-btn i {
            font-size: 1.5rem;
        }

        .bureau-hint {
            color: var(--gray-600);
            font-size: 0.9rem;
            margin: 0;
            text-align: center;
            font-style: italic;
        }

        /* Upload area disabled state */
        .document-upload-area[disabled] {
            opacity: 0.5;
            pointer-events: none;
        }

        /* Bureau button occupied state */
        .bureau-btn.occupied {
            background-color: #e8f5e8 !important;
            border: 2px solid #28a745 !important;
            cursor: not-allowed;
        }

        .bureau-btn.occupied:hover {
            background-color: #e8f5e8 !important;
        }

        .occupied-indicator {
            font-size: 12px;
            color: #28a745;
            font-weight: bold;
            margin-left: 5px;
        }

        /* Warning message styling */
        .bureau-limit-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        /* ID Type Selection Styling - Match Credit Bureau Style Exactly */
        .id-type-selection {
            margin-bottom: 20px;
        }

        .id-type-selection h4 {
            margin-bottom: 15px;
            color: var(--gray-700);
            font-size: 1rem;
            font-weight: 600;
        }

        .id-type-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .id-type-btn {
            flex: 1;
            min-width: 200px;
            padding: 15px 20px;
            border: 2px solid var(--gray-300);
            border-radius: 8px;
            background-color: var(--gray-50);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--gray-700);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        /* Mobile ID Type Selection Enhancement */
        @media (max-width: 575.98px) {
            .id-type-selection {
                margin-bottom: 15px;
                padding: 12px;
                background-color: var(--gray-100);
                border-radius: 12px;
                border: 2px solid var(--gray-200);
            }

            .id-type-selection h4 {
                font-size: 0.95rem;
                margin-bottom: 12px;
                text-align: center;
            }

            .id-type-buttons {
                gap: 8px;
                margin-bottom: 8px;
            }

            .id-type-btn {
                min-width: 140px;
                padding: 12px 10px;
                border-radius: 12px;
                font-size: 0.85rem;
                gap: 6px;
                min-height: 85px;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
            }

            .id-type-btn i {
                font-size: 1.5rem;
            }

            .id-type-btn.selected {
                transform: scale(1.02);
                box-shadow: 0 4px 12px rgba(0, 123, 255, 0.2);
            }

            .id-type-hint {
                font-size: 0.7rem;
                line-height: 1.2;
                margin-top: 4px;
            }

            .id-hint {
                font-size: 0.8rem;
                text-align: center;
                margin-top: 8px;
            }
        }

        .id-type-btn:hover {
            border-color: var(--primary-color);
            background-color: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
        }

        .id-type-btn.selected {
            border-color: var(--primary-color);
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .id-type-btn.occupied {
            background-color: #e8f5e8 !important;
            border: 2px solid #28a745 !important;
            cursor: not-allowed;
        }

        .id-type-btn.occupied:hover {
            background-color: #e8f5e8 !important;
            transform: none;
        }

        .id-type-hint {
            color: var(--gray-600);
            font-size: 0.9rem;
            margin: 0;
            text-align: center;
            font-style: italic;
        }

        .id-type-btn.selected .id-type-hint {
            color: rgba(255, 255, 255, 0.9);
        }

        .occupied-indicator {
            font-size: 12px;
            color: #28a745;
            font-weight: bold;
            margin-left: 5px;
        }

        /* Add hint text styling to match bureau hint */
        .id-type-selection .id-hint {
            color: var(--gray-600);
            font-size: 0.9rem;
            margin: 0;
            text-align: center;
            font-style: italic;
        }

        /* Responsive design for smaller screens */
        @media (max-width: 768px) {
            .id-type-buttons {
                flex-direction: column;
            }

            .id-type-btn {
                min-width: 100%;
            }
        }

        /* Update ID Verification section header to match Credit Reports */
        .document-section[data-section="id-verification"] .section-header h3 {
            color: #09ccfc;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .document-section[data-section="id-verification"] .section-header p {
            color: var(--gray-600);
            font-size: 0.95rem;
            margin: 0 0 20px 0;
            line-height: 1.5;
        }

        /* Make sure both sections have consistent styling */
        .document-section .section-header h3 {
            color: var(--gray-700);
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .document-section .section-header p {
            color: var(--gray-600);
            font-size: 0.95rem;
            margin: 0 0 20px 0;
            line-height: 1.5;
        }

        /* Ensure ID type selection header matches bureau selection */
        .id-type-selection h4 {
            color: var(--gray-700);
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .document-progress-bar {
            height: 100%;
            background-color: #09ccfc;
            transition: width 0.3s ease;
        }

        /* COMPREHENSIVE MOBILE RESPONSIVENESS */

        /* Base mobile styles */
        @media (max-width: 991.98px) {
            .document-upload-container {
                padding: 15px;
            }

            .document-section {
                padding: 20px;
                margin-bottom: 20px;
            }
        }

        /* Extra Small Devices (phones, up to 575px) */
        @media (max-width: 575.98px) {
            .document-upload-container {
                padding: 5px;
                max-width: 100%;
                margin: 0;
            }

            /* Mobile Header - More Compact for Interface */
            .document-upload-header {
                margin-bottom: 15px;
                text-align: center;
                padding: 0 5px;
            }

            .document-upload-title {
                font-size: 1.3rem;
                margin-bottom: 6px;
                line-height: 1.2;
                color: var(--primary);
                font-weight: 600;
            }

            .document-upload-subtitle {
                font-size: 0.9rem;
                margin-bottom: 12px;
                line-height: 1.3;
                padding: 0 8px;
                color: var(--gray-600);
            }

            /* Mobile Sections - Optimized for Interface */
            .document-section {
                padding: 12px;
                margin-bottom: 12px;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
                background: white;
                border: 1px solid var(--gray-200);
            }

            .document-section-title {
                font-size: 1.1rem;
                margin-bottom: 12px;
                padding-bottom: 6px;
                text-align: left;
                color: var(--primary);
                font-weight: 600;
                border-bottom: 2px solid var(--primary-light);
            }

            .document-section-description {
                margin-bottom: 15px;
                font-size: 0.85rem;
                line-height: 1.4;
                text-align: left;
                color: var(--gray-600);
                padding: 0;
            }

            /* Mobile Upload Area - Enhanced for Touch */
            .document-upload-area {
                padding: 16px 12px;
                border-radius: 12px;
                margin-bottom: 12px;
                min-height: 100px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                border: 2px dashed var(--primary-light);
                background: linear-gradient(135deg, #f8fdff 0%, #e6f9ff 100%);
                transition: all 0.3s ease;
                cursor: pointer;
            }

            .document-upload-area:active {
                transform: scale(0.98);
                background: var(--primary-light);
                border-color: var(--primary);
            }

            .document-upload-icon {
                font-size: 2.2rem;
                margin-bottom: 8px;
                color: var(--primary);
            }

            .document-upload-text {
                font-size: 0.9rem;
                margin-bottom: 6px;
                text-align: center;
                font-weight: 500;
                color: var(--gray-800);
            }

            .document-upload-subtext {
                font-size: 0.75rem;
                text-align: center;
                line-height: 1.3;
                color: var(--gray-600);
            }

            /* Mobile Upload Button - More Intuitive */
            .document-upload-btn {
                width: 100%;
                padding: 12px 16px;
                font-size: 0.9rem;
                border-radius: 12px;
                margin-top: 8px;
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
                touch-action: manipulation;
                background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
                border: none;
                color: white;
                font-weight: 600;
                box-shadow: 0 3px 12px rgba(9, 204, 252, 0.3);
                transition: all 0.2s ease;
            }

            .document-upload-btn:active {
                transform: scale(0.96);
                box-shadow: 0 2px 8px rgba(9, 204, 252, 0.4);
            }

            .document-upload-btn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
                transform: none;
            }

            /* Mobile Document List - Enhanced */
            .document-list {
                margin-top: 15px;
            }

            .document-item {
                padding: 10px;
                border-radius: 10px;
                margin-bottom: 6px;
                border: 1px solid var(--gray-200);
                background: white;
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
                transition: all 0.2s ease;
            }

            .document-item:active {
                transform: scale(0.98);
                box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12);
            }

            .document-item-header {
                display: flex;
                align-items: center;
                width: 100%;
                gap: 10px;
            }

            .document-icon {
                font-size: 1.2rem;
                margin-right: 0;
                flex-shrink: 0;
                color: var(--primary);
                background: var(--primary-light);
                padding: 8px;
                border-radius: 8px;
                min-width: 32px;
                min-height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .document-info {
                flex: 1;
                min-width: 0;
            }

            .document-name {
                font-size: 0.9rem;
                margin-bottom: 3px;
                word-break: break-word;
                line-height: 1.2;
                font-weight: 500;
                color: var(--gray-800);
            }

            .document-meta {
                font-size: 0.75rem;
                line-height: 1.2;
                color: var(--gray-600);
            }

            .document-actions {
                width: 100%;
                justify-content: space-between;
                gap: 8px;
                padding-top: 6px;
                border-top: 1px solid var(--gray-200);
            }

            .document-action-btn {
                flex: 1;
                padding: 6px 10px;
                border-radius: 8px;
                background: var(--gray-50);
                border: 1px solid var(--gray-300);
                font-size: 0.8rem;
                min-height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 4px;
                transition: all 0.2s ease;
                font-weight: 500;
                color: var(--gray-700);
            }

            .document-action-btn:hover {
                background: #e9ecef;
                transform: translateY(-1px);
            }

            .document-action-btn.delete {
                background: #fff5f5;
                border-color: #fed7d7;
                color: #dc3545;
            }

            .document-action-btn.delete:hover {
                background: #fed7d7;
                color: #c53030;
            }

            /* Mobile Progress Bar */
            .document-progress {
                height: 6px;
                border-radius: 3px;
                margin-top: 8px;
            }

            /* Mobile File Input Styling */
            .file-input-wrapper {
                position: relative;
                overflow: hidden;
                display: inline-block;
                width: 100%;
            }

            /* Mobile Drag and Drop */
            .document-upload-area.drag-over {
                background-color: #cce7ff;
                border-color: #09ccfc;
                transform: scale(1.02);
            }

            /* Mobile Error/Success Messages */
            .upload-message {
                padding: 12px;
                border-radius: 8px;
                margin-bottom: 15px;
                font-size: 0.9rem;
                text-align: center;
            }

            .upload-message.success {
                background: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }

            .upload-message.error {
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }

            /* Mobile Loading States - Enhanced */
            .loading-overlay {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(255, 255, 255, 0.95);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                border-radius: 12px;
                z-index: 10;
                -webkit-backdrop-filter: blur(2px);
                backdrop-filter: blur(2px);
            }

            .loading-spinner {
                width: 28px;
                height: 28px;
                border: 3px solid var(--gray-200);
                border-top: 3px solid var(--primary);
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-bottom: 8px;
            }

            .loading-text {
                font-size: 0.8rem;
                color: var(--gray-600);
                text-align: center;
                font-weight: 500;
            }

            /* Mobile Success/Error Messages */
            .upload-message {
                padding: 10px 12px;
                border-radius: 10px;
                margin-bottom: 12px;
                font-size: 0.85rem;
                text-align: center;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
                animation: slideInMessage 0.3s ease-out;
            }

            @keyframes slideInMessage {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .upload-message i {
                font-size: 1rem;
            }

            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }

                100% {
                    transform: rotate(360deg);
                }
            }

            /* Touch-friendly elements */
            .document-upload-area,
            .document-upload-btn,
            .document-action-btn {
                -webkit-tap-highlight-color: rgba(9, 204, 252, 0.2);
                touch-action: manipulation;
            }

            /* Better scrolling on mobile */
            .document-list {
                -webkit-overflow-scrolling: touch;
            }
        }

        /* Small Devices (landscape phones, 576px and up) */
        @media (min-width: 576px) and (max-width: 767.98px) {
            .document-upload-container {
                padding: 15px;
            }

            .document-upload-title {
                font-size: 1.7rem;
            }

            .document-upload-subtitle {
                font-size: 1.05rem;
            }

            .document-section {
                padding: 25px;
                margin-bottom: 25px;
            }

            .document-section-title {
                font-size: 1.3rem;
            }

            .document-upload-area {
                padding: 25px 20px;
            }

            .document-upload-btn {
                width: auto;
                min-width: 200px;
                margin: 0 auto;
                display: flex;
            }

            .document-item {
                flex-direction: row;
                align-items: center;
                padding: 15px;
            }

            .document-actions {
                width: auto;
                border-top: none;
                padding-top: 0;
            }

            .document-action-btn {
                flex: none;
                min-width: 80px;
            }
        }

        /* Medium Devices (tablets, 768px and up) */
        @media (min-width: 768px) and (max-width: 991.98px) {
            .document-upload-container {
                padding: 20px;
            }

            .document-upload-title {
                font-size: 1.8rem;
            }

            .document-section {
                padding: 30px;
            }

            .document-section-title {
                font-size: 1.4rem;
            }

            .document-upload-area {
                padding: 30px;
            }

            .document-upload-icon {
                font-size: 2.8rem;
            }

            .document-item {
                padding: 18px;
            }

            .document-actions {
                gap: 15px;
            }

            .document-action-btn {
                min-width: 100px;
                padding: 8px 16px;
            }
        }

        /* Large Devices (desktops, 992px and up) */
        @media (min-width: 992px) {
            .document-upload-container {
                max-width: 1200px;
                padding: 30px;
            }

            .document-section {
                padding: 40px;
            }

            .document-upload-area {
                padding: 40px;
            }
        }

        /* Landscape Orientation Adjustments */
        @media (max-width: 767.98px) and (orientation: landscape) {
            .document-upload-header {
                margin-bottom: 15px;
            }

            .document-upload-title {
                font-size: 1.3rem;
                margin-bottom: 5px;
            }

            .document-upload-subtitle {
                font-size: 0.9rem;
                margin-bottom: 10px;
            }

            .document-section {
                padding: 12px;
                margin-bottom: 12px;
            }

            .document-upload-area {
                padding: 15px;
                min-height: 100px;
            }

            .document-upload-icon {
                font-size: 2rem;
                margin-bottom: 8px;
            }

            .document-item {
                padding: 10px;
            }
        }

        /* Touch Device Optimizations */
        @media (hover: none) and (pointer: coarse) {
            .document-upload-area:hover {
                background-color: inherit;
            }

            .document-upload-btn:hover {
                background-color: #09ccfc;
                transform: none;
            }

            .document-action-btn:hover {
                background: inherit;
                color: inherit;
                transform: none;
            }

            .document-upload-area:active {
                background-color: #e6f9ff;
                transform: scale(0.98);
            }

            .document-action-btn:active {
                transform: scale(0.95);
            }

            /* Prevent text selection on touch devices */
            .document-upload-area,
            .document-actions {
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
        }

        /* High DPI Displays */
        @media (-webkit-min-device-pixel-ratio: 2),
        (min-resolution: 192dpi) {

            .document-upload-icon,
            .document-icon {
                transform: translateZ(0);
            }

            .loading-spinner {
                will-change: transform;
            }
        }

        /* iOS Safari specific adjustments */
        @supports (-webkit-touch-callout: none) {
            .document-upload-container {
                min-height: -webkit-fill-available;
            }

            .document-list {
                -webkit-overflow-scrolling: touch;
            }

            /* Fix for iOS input file button */
            .document-upload-input {
                position: absolute;
                left: -9999px;
            }
        }

        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {

            .document-upload-area,
            .document-upload-btn,
            .document-action-btn,
            .document-progress-bar {
                transition: none;
            }

            .loading-spinner {
                animation: none;
            }

            .document-upload-area.drag-over {
                transform: none;
            }

            .document-action-btn:hover,
            .document-upload-btn:active {
                transform: none;
            }
        }

        /* Dark Mode Support 
        @media (prefers-color-scheme: dark) {
            :root {
                --gray-100: #1a1a1a;
                --gray-200: #2d2d2d;
                --gray-300: #404040;
                --gray-600: #b0b0b0;
                --gray-800: #ffffff;
            }

            .document-upload-container {
                background: #1a1a1a;
                color: #ffffff;
            }

            .document-section {
                background: #2d2d2d;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            }

            .document-upload-area {
                border-color: #404040;
                background: #2d2d2d;
            }

            .document-upload-area:hover,
            .document-upload-area:active {
                background: #3a3a3a;
            }

            .document-item {
                border-color: #404040;
                background: #2d2d2d;
            }

            .document-action-btn {
                background: #3a3a3a;
                border-color: #555;
                color: #ffffff;
            }

            .document-action-btn:hover {
                background: #4a4a4a;
            }

            .document-action-btn.delete {
                background: #4a2a2a;
                border-color: #6a3a3a;
                color: #ff6b6b;
            }

            .document-action-btn.delete:hover {
                background: #5a3a3a;
            }

            .upload-message.success {
                background: #1a3a2a;
                color: #4ade80;
                border-color: #2a4a3a;
            }

            .upload-message.error {
                background: #3a1a1a;
                color: #f87171;
                border-color: #4a2a2a;
            }
        }*/

        /* Print Styles */
        @media print {

            .document-actions,
            .document-upload-area,
            .document-upload-btn {
                display: none;
            }

            .document-section {
                box-shadow: none;
                border: 1px solid #000;
                page-break-inside: avoid;
            }

            .document-item {
                border-bottom: 1px solid #000;
            }

            .document-upload-container {
                max-width: none;
                padding: 0;
            }
        }
    </style>
</head>

<body>
    <script>
        // Document Upload Module
        const DocumentUploadModule = (function () {
            // Private variables
            let isInitialized = false;
            let uploadedDocuments = [];
            let container = null; // Add container reference

            // Function to clean up corrupted localStorage entries
            function cleanupCorruptedEntries() {
                try {
                    console.log('ðŸ§¹ Checking for corrupted localStorage entries in DocumentUploader...');

                    // Clean up any corrupted document entries
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith('jamDocuments') && key.includes('undefined')) {
                            console.log('ðŸ—‘ï¸ Removing corrupted document entry:', key);
                            localStorage.removeItem(key);
                        }
                    });

                } catch (error) {
                    console.error('âŒ Error cleaning up corrupted entries:', error);
                }
            }

            // Function to clear duplicate documents from uploadedDocuments array
            function clearDuplicateDocuments() {
                if (uploadedDocuments.length === 0) {
                    console.log('ðŸ§¹ No documents to clean, array is empty');
                    return;
                }

                console.log(`ðŸ§¹ Cleaning duplicates from ${uploadedDocuments.length} documents`);

                const uniqueDocuments = [];
                const seenIdentifiers = new Set();

                uploadedDocuments.forEach((doc, index) => {
                    // Create multiple unique identifiers to catch all types of duplicates
                    const identifiers = [];

                    // Primary identifier based on document type
                    if (doc.isExisting) {
                        identifiers.push(`existing_${doc.backendId}`);
                        identifiers.push(`backend_${doc.backendId}`);
                    } else {
                        identifiers.push(`new_${doc.sectionType}_${doc.name}_${doc.size}`);
                        if (doc.backendId) {
                            identifiers.push(`backend_${doc.backendId}`);
                        }
                    }

                    // FIXED: More specific identifiers that include bureau/idType to prevent false positives
                    if (doc.sectionType === 'credit-report' && doc.bureau) {
                        // Bureau-specific identifiers (these should be unique per bureau)
                        identifiers.push(`credit-report_${doc.bureau}_${doc.name}_${doc.size}`);
                        identifiers.push(`bureau_${doc.bureau}_${doc.name}`);
                        // Only add generic identifier if it includes bureau info
                        identifiers.push(`${doc.sectionType}_${doc.bureau}_${doc.name}_${doc.size}`);
                    }

                    if (doc.sectionType === 'id-verification' && doc.idType) {
                        // ID type-specific identifiers (these should be unique per ID type)
                        identifiers.push(`id-verification_${doc.idType}_${doc.name}_${doc.size}`);
                        identifiers.push(`idtype_${doc.idType}_${doc.name}`);
                        // Only add generic identifier if it includes idType info
                        identifiers.push(`${doc.sectionType}_${doc.idType}_${doc.name}_${doc.size}`);
                    }

                    // REMOVED: Generic identifiers that don't include bureau/idType
                    // These were causing false positives:
                    // identifiers.push(`${doc.sectionType}_${doc.name}_${doc.size}`);

                    // Only add generic identifiers for documents that don't have bureau/idType
                    if (doc.sectionType !== 'credit-report' && doc.sectionType !== 'id-verification') {
                        // For additional documents, include backend ID to ensure uniqueness
                        if (doc.sectionType === 'additional-documents' && doc.backendId) {
                            identifiers.push(`${doc.sectionType}_${doc.backendId}_${doc.name}_${doc.size}`);
                        } else {
                            identifiers.push(`${doc.sectionType}_${doc.name}_${doc.size}`);
                        }
                    }

                    // Include ID-based identifiers (these are always unique)
                    if (doc.id) {
                        identifiers.push(`id_${doc.id}`);
                    }

                    // Check if ANY of the identifiers have been seen before
                    const isDuplicateByIdentifier = identifiers.some(id => seenIdentifiers.has(id));

                    // ENHANCED: More precise content-based duplicate checking
                    const isDuplicateByContent = uniqueDocuments.some(existingDoc => {
                        // Exact match criteria with better specificity
                        const exactMatch = (
                            existingDoc.name === doc.name &&
                            existingDoc.sectionType === doc.sectionType &&
                            existingDoc.size === doc.size &&
                            existingDoc.isExisting === doc.isExisting
                        );

                        // Backend ID match (if both have backend IDs and they match)
                        const backendIdMatch = (
                            existingDoc.backendId &&
                            doc.backendId &&
                            existingDoc.backendId === doc.backendId
                        );

                        // Credit report specific matching - MUST include bureau
                        const creditReportMatch = (
                            existingDoc.sectionType === 'credit-report' &&
                            doc.sectionType === 'credit-report' &&
                            existingDoc.bureau === doc.bureau &&  // Same bureau
                            existingDoc.name === doc.name &&
                            exactMatch  // Also require exact match
                        );

                        // ID verification specific matching - MUST include idType
                        const idVerificationMatch = (
                            existingDoc.sectionType === 'id-verification' &&
                            doc.sectionType === 'id-verification' &&
                            existingDoc.idType === doc.idType &&  // Same ID type
                            existingDoc.name === doc.name &&
                            exactMatch  // Also require exact match
                        );

                        // Only consider it a duplicate if it's an exact match OR 
                        // a backend ID match OR a specific type match with same bureau/idType
                        return backendIdMatch || creditReportMatch || idVerificationMatch;
                    });

                    if (!isDuplicateByIdentifier && !isDuplicateByContent) {
                        // Add all identifiers to the seen set
                        identifiers.forEach(id => seenIdentifiers.add(id));
                        uniqueDocuments.push(doc);

                        // Enhanced logging for debugging
                        const typeInfo = doc.bureau ? `(${doc.bureau})` : doc.idType ? `(${doc.idType})` : '';
                        console.log(`âœ… Keeping document ${index + 1}: ${doc.name} (${doc.sectionType}) ${typeInfo} - IDs: [${identifiers.slice(0, 3).join(', ')}...]`);
                    } else {
                        const reason = isDuplicateByIdentifier ? 'Identifier match' : 'Content match';
                        const typeInfo = doc.bureau ? `(${doc.bureau})` : doc.idType ? `(${doc.idType})` : '';
                        console.log(`ðŸ—‘ï¸ Removing duplicate document ${index + 1}: ${doc.name} (${doc.sectionType}) ${typeInfo} - Reason: ${reason}`);
                    }
                });

                const removedCount = uploadedDocuments.length - uniqueDocuments.length;
                uploadedDocuments = uniqueDocuments;

                console.log(`ðŸ§¹ Document cleanup complete: Removed ${removedCount} duplicates, ${uniqueDocuments.length} unique documents remaining`);
            }

            // Initialize the module
            function init(containerId) {
                console.log('Initializing Document Upload Module in container:', containerId);

                container = document.getElementById(containerId);
                if (!container) return false;

                // FIRST: Clean up any corrupted localStorage entries
                cleanupCorruptedEntries();

                // Check if this is a fresh page load or just a tab switch
                const pageLoadFlag = sessionStorage.getItem('jamDocumentUploaderPageLoaded');

                if (!pageLoadFlag) {
                    // This is a fresh page load (not just a tab switch)
                    console.log('Fresh page load detected, clearing uploaded documents');

                    // Clear the in-memory array completely on fresh page load
                    uploadedDocuments = [];

                    // Set the flag to indicate page has been loaded in this session
                    sessionStorage.setItem('jamDocumentUploaderPageLoaded', 'true');
                } else {
                    // This is a tab switch, clear any potential duplicates from the array
                    console.log('Tab switch detected, clearing duplicate documents from memory');
                    clearDuplicateDocuments();
                }

                // Check if container already has the HTML structure
                const existingContainer = container.querySelector('.document-upload-container');

                if (existingContainer && container._documentUploaderInitialized) {
                    console.log('Document Upload Module already initialized, refreshing content only');

                    // Clear duplicates and reload documents without clearing the entire structure
                    clearDuplicateDocuments();

                    // Only clear the document lists, not the entire container
                    clearDocumentLists();

                    // Reload existing documents with better timing
                    requestAnimationFrame(async () => {
                        // Ensure structure is still ready after clearing
                        const structureReady = container.querySelector('#credit-report-list') &&
                            container.querySelector('#id-verification-list');

                        if (structureReady) {
                            console.log('ðŸ—ï¸ [DEBUG] Existing structure confirmed ready, reloading documents...');
                            await reloadExistingDocuments();
                        } else {
                            console.warn('âš ï¸ [DEBUG] Existing structure not ready, retrying in 50ms...');
                            setTimeout(async () => {
                                await reloadExistingDocuments();
                            }, 50);
                        }
                    });

                    return true;
                }

                console.log(`Initializing Document Upload Module in container: ${containerId}`);

                // Clear the uploadedDocuments array to start fresh for this container
                uploadedDocuments = [];

                // DEBUGGING: Check container before HTML insertion
                console.log('ðŸ”§ [DEBUG] Container before HTML insertion:', {
                    id: container.id,
                    className: container.className,
                    innerHTML: container.innerHTML.length > 100 ?
                        container.innerHTML.substring(0, 100) + '...' : container.innerHTML
                });

                // Insert the widget HTML
                console.log('ðŸ”§ [DEBUG] Inserting HTML into container...');
                container.innerHTML = `
                    <div class="document-upload-container">
                        <div class="document-upload-header">
                            <h2 class="document-upload-title">Document Upload</h2>
                            <p class="document-upload-subtitle">
                                Please upload the required documents to help us with your credit dispute process.
                            </p>
                        </div>
                        
                        <!-- Credit Report Upload Section -->
                        <!--<div class="document-section">-->
                            <!--<h3 class="document-section-title">Credit Reports</h3>
                            <p class="document-section-description">
                                Upload your credit reports from all three bureaus (Experian, Equifax, and TransUnion).
                                PDF format is preferred. Please select which bureau report you're uploading.
                            </p>-->
                            
                            <!-- Bureau Selection -->
                            <!--<div class="bureau-selection" id="bureau-selection">
                                <label class="bureau-selection-label">Select Credit Bureau:</label>
                                <div class="bureau-options">
                                    <button type="button" class="bureau-btn" data-bureau="experian">
                                        <i class="fas fa-building"></i>
                                        Experian
                                    </button>
                                    <button type="button" class="bureau-btn" data-bureau="equifax">
                                        <i class="fas fa-shield-alt"></i>
                                        Equifax
                                    </button>
                                    <button type="button" class="bureau-btn" data-bureau="transunion">
                                        <i class="fas fa-chart-line"></i>
                                        TransUnion
                                    </button>
                                </div>
                                <p class="bureau-hint">Please select which credit bureau report you want to upload</p>
                            </div>-->
                            
                            <!--<div class="document-upload-area" data-section="credit-report" id="credit-report-upload" style="opacity: 0.5; pointer-events: none;">
                                <i class="fas fa-file-upload document-upload-icon"></i>
                                <p class="document-upload-text">Select a credit bureau first, then drag & drop your credit report here</p>
                                <p class="document-upload-subtext">or click to browse files</p>
                                <input type="file" class="document-upload-input" id="credit-report-input" multiple accept=".pdf,.jpg,.jpeg,.png" disabled>
                            </div>-->
                            
                            <!--<div class="document-list" id="credit-report-list">-->
                                <!-- Uploaded documents will appear here -->
                            <!--</div>-->
                        <!--</div>-->
                        
                        <!-- ID Verification Section -->
                        <div class="document-section" data-section="id-verification">
                            <div class="section-header">
                                <h3>ðŸ“‹ ID Verification</h3>
                                <p>Upload a valid government-issued ID and a utility bill with your current address.</p>
                            </div>

                            <!-- ID Type Selection -->
                            <div class="id-type-selection">
                                <h4>Select Document Type:</h4>
                                <div class="id-type-buttons">
                                    <button type="button" class="id-type-btn" data-id-type="government-id">
                                        <i class="fas fa-id-card"></i>
                                        Government ID
                                        <p class="id-type-hint">Driver's License, Passport, State ID</p>
                                    </button>
                                    <button type="button" class="id-type-btn" data-id-type="utility-bill">
                                        <i class="fas fa-file-invoice"></i>
                                        Utility Bill
                                        <p class="id-type-hint">Electric, Gas, Water, Internet Bill</p>
                                    </button>
                                </div>
                                <p class="id-hint">Please select which type of document you want to upload</p>
                            </div>

                            <!-- Upload Area (initially disabled) -->
                            <div class="document-upload-area" id="id-verification-upload" style="opacity: 0.5; pointer-events: none;">
                                <div class="upload-icon">ðŸ“</div>
                                <div class="document-upload-text">Select a document type first</div>
                                <input type="file" id="id-verification-input" accept=".pdf,.jpg,.jpeg,.png" multiple disabled>
                            </div>

                            <!-- Uploaded Files List -->
                            <div class="uploaded-files-section">
                                <h4>Uploaded Documents:</h4>
                                <div class="uploaded-files-list" id="id-verification-list"></div>
                            </div>
                        </div>
                        
                        <!-- Additional Documents Section -->
                        <!--<div class="document-section">-->
                            <!--<h3 class="document-section-title">Additional Documents</h3>
                            <p class="document-section-description">
                                Upload any additional documents that may help with your credit dispute process,
                                such as correspondence with creditors, payment receipts, or court documents.
                            </p>
                            
                            <div class="document-upload-area" data-section="additional-documents">
                                <i class="fas fa-file-alt document-upload-icon"></i>
                                <p class="document-upload-text">Drag & drop additional documents here</p>
                                <p class="document-upload-subtext">or click to browse files</p>
                                <input type="file" class="document-upload-input" id="additional-input" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                            </div>-->
                            
                            <!--<div class="document-list" id="additional-list">-->
                                <!-- Uploaded documents will appear here -->
                            <!--</div>-->
                        <!--</div>-->

                        <!-- SmartCredit Access Section -->
                        <div class="document-section">
                            <h3 class="document-section-title">SmartCredit Access (Optional)</h3>
                            <p class="document-section-description">
                                If you have a SmartCredit account, you can provide your login information below.
                                This will allow us to access your credit reports directly and provide faster service.
                            </p>

                            <!-- Credential Status Area -->
                            <div id="smartcredit-status" class="credential-status" style="display: none;">
                                <div class="status-header">
                                    <i class="fas fa-check-circle status-icon"></i>
                                    <div class="status-info">
                                        <h4>SmartCredit Access Active</h4>
                                        <p class="status-details">Last updated: <span id="smartcredit-last-updated">-</span></p>
                                        <p class="status-email">Email: <span id="smartcredit-current-email">-</span></p>
                                    </div>
                                </div>
                                <div class="status-actions">
                                    <button type="button" class="update-btn" id="smartcredit-update-btn">
                                        <i class="fas fa-edit"></i> Update Credentials
                                    </button>
                                    <button type="button" class="remove-btn" id="smartcredit-remove-btn">
                                        <i class="fas fa-trash"></i> Remove Access
                                    </button>
                                </div>
                            </div>

                            <form id="smartcredit-access-form" class="smartcredit-form">
                                <div class="update-warning" id="smartcredit-update-warning" style="display: none;">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <strong>Update Mode:</strong> You are updating your existing SmartCredit credentials. 
                                    The new credentials will replace the current ones.
                                </div>

                                <div class="form-group">
                                    <label for="smartcredit-email">SmartCredit Email:</label>
                                    <input type="email" id="smartcredit-email" name="email" required>
                                </div>

                                <div class="form-group">
                                    <label for="smartcredit-password">SmartCredit Password:</label>
                                    <input type="password" id="smartcredit-password" name="password" required>
                                </div>

                                <button type="submit" class="submit-btn" id="smartcredit-submit-btn">
                                    <i class="fas fa-key"></i>
                                    <span id="smartcredit-submit-text">Provide SmartCredit Access</span>
                                </button>

                                <button type="button" class="cancel-btn" id="smartcredit-cancel-btn" style="display: none;">
                                    <i class="fas fa-times"></i> Cancel Update
                                </button>

                                <p class="form-note">
                                    If you prefer not to provide login access, you can download and upload your credit reports manually below.
                                </p>
                            </form>
                        </div>

                        <!-- IdentityIQ Access Section -->
                        <div class="document-section">
                            <h3 class="document-section-title">IdentityIQ Access (Optional)</h3>
                            <p class="document-section-description">
                                If you have an IdentityIQ account, you can provide your login information below.
                                This will allow us to access your credit monitoring and identity protection data to better assist with your credit dispute process.
                            </p>

                            <!-- Credential Status Area -->
                            <div id="identityiq-status" class="credential-status" style="display: none;">
                                <div class="status-header">
                                    <i class="fas fa-check-circle status-icon"></i>
                                    <div class="status-info">
                                        <h4>IdentityIQ Access Active</h4>
                                        <p class="status-details">Last updated: <span id="identityiq-last-updated">-</span></p>
                                        <p class="status-email">Email: <span id="identityiq-current-email">-</span></p>
                                    </div>
                                </div>
                                <div class="status-actions">
                                    <button type="button" class="update-btn" id="identityiq-update-btn">
                                        <i class="fas fa-edit"></i> Update Credentials
                                    </button>
                                    <button type="button" class="remove-btn" id="identityiq-remove-btn">
                                        <i class="fas fa-trash"></i> Remove Access
                                    </button>
                                </div>
                            </div>

                            <form id="identityiq-access-form" class="smartcredit-form">
                                <div class="update-warning" id="identityiq-update-warning" style="display: none;">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <strong>Update Mode:</strong> You are updating your existing IdentityIQ credentials. 
                                    The new credentials will replace the current ones.
                                </div>
                                <div class="form-group">
                                    <label for="identityiq-email">IdentityIQ Email:</label>
                                    <input type="email" id="identityiq-email" name="email" required>
                                </div>

                                <div class="form-group">
                                    <label for="identityiq-password">IdentityIQ Password:</label>
                                    <input type="password" id="identityiq-password" name="password" required>
                                </div>

                                <button type="submit" class="submit-btn" id="identityiq-submit-btn">
                                    <i class="fas fa-shield-alt"></i>
                                    <span id="identityiq-submit-text">Provide IdentityIQ Access</span>
                                </button>

                                <button type="button" class="cancel-btn" id="identityiq-cancel-btn" style="display: none;">
                                    <i class="fas fa-times"></i> Cancel Update
                                </button>

                                <p class="form-note">
                                    Your IdentityIQ login information will be used securely to enhance our credit dispute analysis and monitoring capabilities.
                                </p>
                            </form>
                        </div>

                        <!-- MyScoreIQ Access Section -->
                        <div class="document-section">
                            <h3 class="document-section-title">MyScoreIQ Access (Optional)</h3>
                            <p class="document-section-description">
                                If you have a MyScoreIQ account, you can provide your login information below.
                                This will allow us to access your credit score tracking and analysis data to provide more comprehensive credit dispute assistance.
                            </p>

                            <!-- Credential Status Area -->
                            <div id="myscoreiq-status" class="credential-status" style="display: none;">
                                <div class="status-header">
                                    <i class="fas fa-check-circle status-icon"></i>
                                    <div class="status-info">
                                        <h4>MyScoreIQ Access Active</h4>
                                        <p class="status-details">Last updated: <span id="myscoreiq-last-updated">-</span></p>
                                        <p class="status-email">Email: <span id="myscoreiq-current-email">-</span></p>
                                    </div>
                                </div>
                                <div class="status-actions">
                                    <button type="button" class="update-btn" id="myscoreiq-update-btn">
                                        <i class="fas fa-edit"></i> Update Credentials
                                    </button>
                                    <button type="button" class="remove-btn" id="myscoreiq-remove-btn">
                                        <i class="fas fa-trash"></i> Remove Access
                                    </button>
                                </div>
                            </div>

                            <form id="myscoreiq-access-form" class="smartcredit-form">
                                <div class="update-warning" id="myscoreiq-update-warning" style="display: none;">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <strong>Update Mode:</strong> You are updating your existing MyScoreIQ credentials. 
                                    The new credentials will replace the current ones.
                                </div>
                                <div class="form-group">
                                    <label for="myscoreiq-email">MyScoreIQ Email:</label>
                                    <input type="email" id="myscoreiq-email" name="email" required>
                                </div>

                                <div class="form-group">
                                    <label for="myscoreiq-password">MyScoreIQ Password:</label>
                                    <input type="password" id="myscoreiq-password" name="password" required>
                                </div>

                                <button type="submit" class="submit-btn" id="myscoreiq-submit-btn">
                                    <i class="fas fa-chart-bar"></i>
                                    <span id="myscoreiq-submit-text">Provide MyScoreIQ Access</span>
                                </button>

                                <button type="button" class="cancel-btn" id="myscoreiq-cancel-btn" style="display: none;">
                                    <i class="fas fa-times"></i> Cancel Update
                                </button>

                                <p class="form-note">
                                    Your MyScoreIQ login information will be used securely to enhance our credit score analysis and tracking capabilities.
                                </p>
                            </form>
                        </div>

                        <!-- CFPB Access Section -->
                        <div class="document-section">
                            <h3 class="document-section-title">CFPB Access (Optional)</h3>
                            <p class="document-section-description">
                                If you have a Consumer Financial Protection Bureau account, you can provide your login information below.
                                This will allow us to access your complaint history and consumer protection resources to enhance your credit dispute process.
                            </p>

                            <!-- Credential Status Area -->
                            <div id="cfpb-status" class="credential-status" style="display: none;">
                                <div class="status-header">
                                    <i class="fas fa-check-circle status-icon"></i>
                                    <div class="status-info">
                                        <h4>CFPB Access Active</h4>
                                        <p class="status-details">Last updated: <span id="cfpb-last-updated">-</span></p>
                                        <p class="status-email">Email: <span id="cfpb-current-email">-</span></p>
                                    </div>
                                </div>
                                <div class="status-actions">
                                    <button type="button" class="update-btn" id="cfpb-update-btn">
                                        <i class="fas fa-edit"></i> Update Credentials
                                    </button>
                                    <button type="button" class="remove-btn" id="cfpb-remove-btn">
                                        <i class="fas fa-trash"></i> Remove Access
                                    </button>
                                </div>
                            </div>

                            <form id="cfpb-access-form" class="smartcredit-form">
                                <div class="update-warning" id="cfpb-update-warning" style="display: none;">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <strong>Update Mode:</strong> You are updating your existing CFPB credentials. 
                                    The new credentials will replace the current ones.
                                </div>
                                <div class="form-group">
                                    <label for="cfpb-email">CFPB Email:</label>
                                    <input type="email" id="cfpb-email" name="email" required>
                                </div>

                                <div class="form-group">
                                    <label for="cfpb-password">CFPB Password:</label>
                                    <input type="password" id="cfpb-password" name="password" required>
                                </div>

                                <button type="submit" class="submit-btn" id="cfpb-submit-btn">
                                    <i class="fas fa-shield-halved"></i>
                                    <span id="cfpb-submit-text">Provide CFPB Access</span>
                                </button>

                                <button type="button" class="cancel-btn" id="cfpb-cancel-btn" style="display: none;">
                                    <i class="fas fa-times"></i> Cancel Update
                                </button>

                                <p class="form-note">
                                    Your CFPB login information will be used securely to access complaint data and consumer protection resources for your credit dispute assistance.
                                </p>
                            </form>
                        </div>

                        <!-- AnnualCreditReport.com Access Section -->
                        <div class="document-section">
                            <h3 class="document-section-title">AnnualCreditReport.com Access (Optional)</h3>
                            <p class="document-section-description">
                                If you have an AnnualCreditReport.com account, you can provide your login information below.
                                This will allow us to access your free annual credit reports directly from the official source.
                            </p>

                            <!-- Credential Status Area -->
                            <div id="annualcreditreport-status" class="credential-status" style="display: none;">
                                <div class="status-header">
                                    <i class="fas fa-check-circle status-icon"></i>
                                    <div class="status-info">
                                        <h4>AnnualCreditReport.com Access Active</h4>
                                        <p class="status-details">Last updated: <span id="annualcreditreport-last-updated">-</span></p>
                                        <p class="status-email">Email: <span id="annualcreditreport-current-email">-</span></p>
                                    </div>
                                </div>
                                <div class="status-actions">
                                    <button type="button" class="update-btn" id="annualcreditreport-update-btn">
                                        <i class="fas fa-edit"></i> Update Credentials
                                    </button>
                                    <button type="button" class="remove-btn" id="annualcreditreport-remove-btn">
                                        <i class="fas fa-trash"></i> Remove Access
                                    </button>
                                </div>
                            </div>

                            <form id="annualcreditreport-access-form" class="smartcredit-form">
                                <div class="update-warning" id="annualcreditreport-update-warning" style="display: none;">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <strong>Update Mode:</strong> You are updating your existing AnnualCreditReport.com credentials. 
                                    The new credentials will replace the current ones.
                                </div>
                                <div class="form-group">
                                    <label for="annualcreditreport-email">AnnualCreditReport.com Email:</label>
                                    <input type="email" id="annualcreditreport-email" name="email" required>
                                </div>

                                <div class="form-group">
                                    <label for="annualcreditreport-password">AnnualCreditReport.com Password:</label>
                                    <input type="password" id="annualcreditreport-password" name="password" required>
                                </div>

                                <button type="submit" class="submit-btn" id="annualcreditreport-submit-btn">
                                    <i class="fas fa-file-invoice"></i>
                                    <span id="annualcreditreport-submit-text">Provide AnnualCreditReport.com Access</span>
                                </button>

                                <button type="button" class="cancel-btn" id="annualcreditreport-cancel-btn" style="display: none;">
                                    <i class="fas fa-times"></i> Cancel Update
                                </button>

                                <p class="form-note">
                                    Your AnnualCreditReport.com login information will be used securely to access your official annual credit reports from all three bureaus.
                                </p>
                            </form>
                        </div>
                    </div>
                `;

                // DEBUGGING: Check container after HTML insertion
                console.log('ðŸ”§ [DEBUG] Container after HTML insertion:', {
                    id: container.id,
                    className: container.className,
                    childElementCount: container.childElementCount,
                    hasDocumentUploadContainer: !!container.querySelector('.document-upload-container'),
                    hasIdentityIQForm: !!container.querySelector('#identityiq-access-form'),
                    allFormIds: Array.from(container.querySelectorAll('form')).map(f => f.id),
                    innerHTML: container.innerHTML.length > 200 ?
                        container.innerHTML.substring(0, 200) + '...' : container.innerHTML
                });

                // Set up event listeners and other initialization
                console.log('ðŸ”§ [DEBUG] Calling setupEventListeners...');
                setupEventListeners(container);

                // Check for existing credentials and update UI accordingly
                console.log('ðŸ”§ [DEBUG] Checking for existing credentials...');
                checkExistingCredentials(container);

                // Mark this container as initialized
                container._documentUploaderInitialized = true;

                // Load existing documents after initialization with better timing
                // Use requestAnimationFrame to ensure DOM is fully rendered
                requestAnimationFrame(async () => {
                    // Double check that the structure is ready
                    const structureReady = container.querySelector('#credit-report-list') &&
                        container.querySelector('#id-verification-list');

                    if (structureReady) {
                        console.log('ðŸ—ï¸ [DEBUG] DOM structure confirmed ready, loading documents...');
                        await reloadExistingDocuments();
                    } else {
                        console.warn('âš ï¸ [DEBUG] DOM structure not ready, retrying in 100ms...');
                        setTimeout(async () => {
                            await reloadExistingDocuments();
                        }, 100);
                    }
                });

                return true;
            }

            // New function to clear only document lists, not the entire structure
            function clearDocumentLists() {
                const creditReportList = container.querySelector('#credit-report-list');
                const idVerificationList = container.querySelector('#id-verification-list');
                const additionalList = container.querySelector('#additional-list');

                if (creditReportList) {
                    creditReportList.innerHTML = '';
                    console.log('ðŸ§¹ Cleared credit report list');
                }

                if (idVerificationList) {
                    idVerificationList.innerHTML = '';
                    console.log('ðŸ§¹ Cleared ID verification list');
                }

                if (additionalList) {
                    additionalList.innerHTML = '';
                    console.log('ðŸ§¹ Cleared additional documents list');
                }

                // Reset button statuses
                const bureauButtons = container.querySelectorAll('.bureau-btn');
                const idTypeButtons = container.querySelectorAll('.id-type-btn');

                bureauButtons.forEach(button => {
                    button.classList.remove('occupied', 'selected');
                    const indicator = button.querySelector('.occupied-indicator');
                    if (indicator) indicator.remove();
                    button.style.backgroundColor = '';
                    button.style.border = '';
                });

                idTypeButtons.forEach(button => {
                    button.classList.remove('occupied', 'selected');
                    const indicator = button.querySelector('.occupied-indicator');
                    if (indicator) indicator.remove();
                    button.style.backgroundColor = '';
                    button.style.border = '';
                });

                console.log('ðŸ§¹ Cleared document lists and reset button statuses');
            }

            // Section-specific clear functions to avoid clearing everything
            function clearCreditReportListOnly() {
                const creditReportList = container.querySelector('#credit-report-list');
                if (creditReportList) {
                    creditReportList.innerHTML = '';
                    console.log('ðŸ§¹ Cleared credit report list only');
                }

                // Reset only bureau button statuses
                const bureauButtons = container.querySelectorAll('.bureau-btn');
                bureauButtons.forEach(button => {
                    button.classList.remove('occupied', 'selected');
                    const indicator = button.querySelector('.occupied-indicator');
                    if (indicator) indicator.remove();
                    button.style.backgroundColor = '';
                    button.style.border = '';
                });
            }

            function clearIdVerificationListOnly() {
                const idVerificationList = container.querySelector('#id-verification-list');
                if (idVerificationList) {
                    idVerificationList.innerHTML = '';
                    console.log('ðŸ§¹ Cleared ID verification list only');
                }

                // Reset only ID type button statuses
                const idTypeButtons = container.querySelectorAll('.id-type-btn');
                idTypeButtons.forEach(button => {
                    button.classList.remove('occupied', 'selected');
                    const indicator = button.querySelector('.occupied-indicator');
                    if (indicator) indicator.remove();
                    button.style.backgroundColor = '';
                    button.style.border = '';
                });
            }

            function clearAdditionalDocumentsListOnly() {
                const additionalList = container.querySelector('#additional-list');
                if (additionalList) {
                    additionalList.innerHTML = '';
                    console.log('ðŸ§¹ Cleared additional documents list only');
                }
            }

            // Clear existing DOM elements to prevent duplicates
            function clearExistingDOMElements() {
                // This function is now replaced by clearDocumentLists()
                clearDocumentLists();
            }

            // Fetch existing documents from backend
            async function fetchExistingDocuments() {
                try {
                    console.log('ðŸ“¥ [DEBUG] Starting fetchExistingDocuments...');

                    // Get user data and auth token
                    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                    const userId = userData.id;

                    // Try multiple token locations
                    const authToken = localStorage.getItem('authToken') ||
                        localStorage.getItem('token') ||
                        sessionStorage.getItem('authToken') ||
                        sessionStorage.getItem('token');

                    console.log('ðŸ” [DEBUG] Auth check:', {
                        userId: userId ? 'Found' : 'Missing',
                        authToken: authToken ? 'Found' : 'Missing',
                        userDataKeys: Object.keys(userData),
                        localStorageKeys: Object.keys(localStorage).filter(k => k.includes('token') || k.includes('auth')),
                        sessionStorageKeys: Object.keys(sessionStorage).filter(k => k.includes('token') || k.includes('auth'))
                    });

                    if (!userId || !authToken) {
                        console.warn('âš ï¸ [DEBUG] Missing authentication - userId:', !!userId, 'authToken:', !!authToken);
                        return [];
                    }

                    const url = `https://jam-capital-backend.azurewebsites.net/api/admin/get-user-documents?userId=${userId}`;
                    console.log('ðŸŒ [DEBUG] Making API call to:', url);

                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    console.log('ðŸ“¡ [DEBUG] API response status:', response.status, response.statusText);

                    if (!response.ok) {
                        const errorText = await response.text().catch(() => 'Unable to read error');
                        console.error('âŒ [DEBUG] API error response:', {
                            status: response.status,
                            statusText: response.statusText,
                            errorText: errorText
                        });
                        throw new Error(`Failed to fetch documents: ${response.status} ${response.statusText}`);
                    }

                    const result = await response.json();
                    console.log('âœ… [DEBUG] API response received:', {
                        documentsCount: result.documents ? result.documents.length : 0,
                        resultKeys: Object.keys(result),
                        documents: result.documents
                    });

                    // Validate response structure
                    if (!result.documents || !Array.isArray(result.documents)) {
                        console.warn('âš ï¸ [DEBUG] Invalid response structure:', result);
                        return [];
                    }

                    console.log('âœ… [DEBUG] Returning', result.documents.length, 'documents');
                    return result.documents;

                } catch (error) {
                    console.error('âŒ [DEBUG] fetchExistingDocuments error:', {
                        message: error.message,
                        stack: error.stack,
                        name: error.name
                    });
                    return [];
                }
            }

            // Enhanced reload function with retry logic and better debugging
            async function reloadExistingDocuments(retryCount = 0) {
                const MAX_RETRIES = 3;
                const RETRY_DELAY = 1000;

                try {
                    console.log(`ðŸ”„ [DEBUG] reloadExistingDocuments attempt ${retryCount + 1}/${MAX_RETRIES + 1}`);

                    // Check if container and structure exist
                    if (!container) {
                        console.error('âŒ [DEBUG] Container not available');
                        return;
                    }

                    const containerStructure = container.querySelector('.document-upload-container');
                    if (!containerStructure) {
                        console.error('âŒ [DEBUG] Container structure not available');
                        return;
                    }

                    console.log('âœ… [DEBUG] Container structure validated');

                    // Clear duplicates before loading
                    const beforeClearCount = uploadedDocuments.length;
                    clearDuplicateDocuments();
                    console.log(`ðŸ§¹ [DEBUG] Cleared duplicates: ${beforeClearCount} -> ${uploadedDocuments.length}`);

                    // Clear document lists if container structure exists
                    clearDocumentLists();
                    console.log('ðŸ§¹ [DEBUG] Cleared document lists');

                    // Fetch documents with retry logic
                    console.log('ðŸ“¥ [DEBUG] Fetching existing documents...');
                    const existingDocuments = await fetchExistingDocuments();

                    console.log(`ðŸ“‹ [DEBUG] Fetched ${existingDocuments.length} total documents:`, {
                        creditReports: existingDocuments.filter(doc => doc.documentType === 'credit-report').length,
                        idVerification: existingDocuments.filter(doc => doc.documentType === 'id-verification').length,
                        additionalDocuments: existingDocuments.filter(doc => doc.documentType === 'additional-documents').length,
                        other: existingDocuments.filter(doc => !['credit-report', 'id-verification', 'additional-documents'].includes(doc.documentType)).length
                    });

                    if (existingDocuments.length > 0) {
                        console.log('ðŸ“„ [DEBUG] Processing credit reports...');
                        await displayExistingCreditReports(existingDocuments);

                        console.log('ðŸ“„ [DEBUG] Processing ID documents...');
                        await displayExistingIdDocuments(existingDocuments);

                        console.log('ðŸ“„ [DEBUG] Processing additional documents...');
                        await displayExistingAdditionalDocuments(existingDocuments);

                        console.log(`âœ… [DEBUG] Documents displayed successfully. Final uploadedDocuments count: ${uploadedDocuments.length}`);
                    } else {
                        console.log('ðŸ“‹ [DEBUG] No existing documents found to display');
                    }

                    // Clear duplicates after loading (safety check)
                    const afterLoadCount = uploadedDocuments.length;
                    clearDuplicateDocuments();
                    const finalCount = uploadedDocuments.length;

                    if (afterLoadCount !== finalCount) {
                        console.log(`ðŸ§¹ [DEBUG] Post-load cleanup: ${afterLoadCount} -> ${finalCount}`);
                    }

                    console.log('âœ… [DEBUG] reloadExistingDocuments completed successfully');

                } catch (error) {
                    console.error(`âŒ [DEBUG] reloadExistingDocuments error (attempt ${retryCount + 1}):`, {
                        message: error.message,
                        stack: error.stack
                    });

                    // Retry logic
                    if (retryCount < MAX_RETRIES) {
                        console.log(`ðŸ”„ [DEBUG] Retrying in ${RETRY_DELAY}ms... (attempt ${retryCount + 2}/${MAX_RETRIES + 1})`);
                        setTimeout(() => {
                            reloadExistingDocuments(retryCount + 1);
                        }, RETRY_DELAY);
                    } else {
                        console.error('âŒ [DEBUG] All retry attempts failed for reloadExistingDocuments');
                    }
                }
            }

            // Enhanced document display functions with better debugging
            function displayExistingCreditReports(documents) {
                return new Promise((resolve) => {
                    try {
                        const creditReports = documents.filter(doc => doc.documentType === 'credit-report');
                        console.log('ðŸ“‹ [DEBUG] displayExistingCreditReports - Processing', creditReports.length, 'credit reports');

                        if (creditReports.length === 0) {
                            console.log('ðŸ“‹ [DEBUG] No credit reports to display');
                            resolve();
                            return;
                        }

                        // FIRST: Clear any existing duplicates before processing new documents
                        const beforeClearCount = uploadedDocuments.length;
                        clearDuplicateDocuments();
                        console.log(`ðŸ§¹ [DEBUG] Credit reports - cleared duplicates: ${beforeClearCount} -> ${uploadedDocuments.length}`);

                        // SECOND: Enhanced validation and filtering with detailed logging
                        const validCreditReports = creditReports.filter((doc, index) => {
                            console.log(`ðŸ” [DEBUG] Validating credit report ${index + 1}:`, {
                                fileName: doc.fileName,
                                bureau: doc.bureau,
                                id: doc.id,
                                documentType: doc.documentType
                            });

                            // Check if document has required fields
                            if (!doc.id || !doc.fileName) {
                                console.warn(`âš ï¸ [DEBUG] Credit report ${index + 1} missing required fields:`, {
                                    hasId: !!doc.id,
                                    hasFileName: !!doc.fileName,
                                    doc: doc
                                });
                                return false;
                            }

                            // Check if bureau is defined and valid
                            const validBureaus = ['experian', 'equifax', 'transunion'];
                            if (!doc.bureau || !validBureaus.includes(doc.bureau.toLowerCase())) {
                                console.warn(`âš ï¸ [DEBUG] Credit report ${index + 1} has invalid bureau:`, {
                                    fileName: doc.fileName,
                                    bureau: doc.bureau,
                                    validBureaus: validBureaus
                                });
                                return false;
                            }

                            // Check if fileName looks valid (not corrupted)
                            if (doc.fileName.includes('undefined') || doc.fileName.match(/^\d+-\d+-\d+/)) {
                                console.warn(`âš ï¸ [DEBUG] Credit report ${index + 1} has corrupted fileName:`, doc.fileName);
                                return false;
                            }

                            console.log(`âœ… [DEBUG] Credit report ${index + 1} passed validation`);
                            return true;
                        });

                        console.log(`ðŸ“‹ [DEBUG] Valid credit reports after filtering: ${validCreditReports.length} of ${creditReports.length}`);

                        // Process each valid credit report
                        validCreditReports.forEach((report, index) => {
                            console.log(`ðŸ“„ [DEBUG] Processing credit report ${index + 1}:`, {
                                fileName: report.fileName,
                                bureau: report.bureau,
                                id: report.id
                            });

                            const listElement = container.querySelector('#credit-report-list');
                            if (!listElement) {
                                console.error('âŒ [DEBUG] Credit report list element not found');
                                return;
                            }

                            // Create unique identifier
                            const uniqueId = `existing_${report.id}`;

                            // Comprehensive duplicate checking with detailed logging
                            const duplicateChecks = [
                                uploadedDocuments.find(doc => doc.id === uniqueId),
                                uploadedDocuments.find(doc => doc.backendId === report.id),
                                uploadedDocuments.find(doc =>
                                    doc.isExisting &&
                                    doc.name === report.fileName &&
                                    doc.bureau === report.bureau &&
                                    doc.size === report.fileSize
                                ),
                                uploadedDocuments.find(doc =>
                                    doc.name === report.fileName &&
                                    doc.bureau === report.bureau &&
                                    doc.sectionType === 'credit-report'
                                )
                            ];

                            const existingDocument = duplicateChecks.find(check => check !== undefined);

                            if (existingDocument) {
                                console.log(`ðŸ“Œ [DEBUG] Credit report ${index + 1} already exists, skipping:`, {
                                    fileName: report.fileName,
                                    bureau: report.bureau,
                                    backendId: report.id,
                                    existingDocumentId: existingDocument.id,
                                    existingBackendId: existingDocument.backendId
                                });
                                return;
                            }

                            // Create document data
                            const documentData = {
                                id: uniqueId,
                                name: report.fileName,
                                size: report.fileSize || 0,
                                type: 'application/pdf',
                                uploadStatus: 'success',
                                backendId: report.id,
                                fileUrl: report.fileUrl,
                                isExisting: true,
                                bureau: report.bureau,
                                uploadDate: new Date(report.createdAt || Date.now()),
                                sectionType: 'credit-report'
                            };

                            // Final validation
                            if (!documentData.name || !documentData.bureau || !documentData.backendId) {
                                console.error(`âŒ [DEBUG] Invalid credit report data for ${index + 1}, skipping:`, documentData);
                                return;
                            }

                            // Add to array and create DOM element
                            uploadedDocuments.push(documentData);
                            const listItem = createExistingDocumentElement(documentData);
                            listElement.appendChild(listItem);

                            console.log(`âœ… [DEBUG] Added credit report ${index + 1}: ${report.fileName} (${report.bureau})`);

                            // Mark bureau as occupied
                            markBureauAsOccupied(report.bureau);
                        });

                        // Final cleanup and resolve
                        clearDuplicateDocuments();
                        console.log(`âœ… [DEBUG] displayExistingCreditReports completed. Total uploadedDocuments: ${uploadedDocuments.length}`);
                        resolve();

                    } catch (error) {
                        console.error('âŒ [DEBUG] displayExistingCreditReports error:', error);
                        resolve(); // Don't reject, just log and continue
                    }
                });
            }

            // Helper functions for authentication - Enhanced for mobile Safari compatibility
            function getUserId() {
                try {
                    console.log('ðŸ” [DEBUG] Getting user ID...');

                    // Try multiple approaches to get user ID
                    let userId = null;
                    let userData = null;

                    // Method 1: Try localStorage userData
                    try {
                        const userDataStr = localStorage.getItem('userData');
                        if (userDataStr && userDataStr !== 'undefined' && userDataStr !== 'null') {
                            userData = JSON.parse(userDataStr);
                            userId = userData.id || userData.userId || userData._id;
                            console.log('âœ… [DEBUG] Found user ID from localStorage userData:', userId);
                        }
                    } catch (e) {
                        console.warn('âš ï¸ [DEBUG] Failed to parse localStorage userData:', e);
                    }

                    // Method 2: Try sessionStorage userData as fallback
                    if (!userId) {
                        try {
                            const sessionUserDataStr = sessionStorage.getItem('userData');
                            if (sessionUserDataStr && sessionUserDataStr !== 'undefined' && sessionUserDataStr !== 'null') {
                                userData = JSON.parse(sessionUserDataStr);
                                userId = userData.id || userData.userId || userData._id;
                                console.log('âœ… [DEBUG] Found user ID from sessionStorage userData:', userId);
                            }
                        } catch (e) {
                            console.warn('âš ï¸ [DEBUG] Failed to parse sessionStorage userData:', e);
                        }
                    }

                    // Method 3: Try direct userId storage
                    if (!userId) {
                        userId = localStorage.getItem('userId') ||
                            localStorage.getItem('user_id') ||
                            sessionStorage.getItem('userId') ||
                            sessionStorage.getItem('user_id');
                        if (userId) {
                            console.log('âœ… [DEBUG] Found user ID from direct storage:', userId);
                        }
                    }

                    // Method 4: Try using global authManager if available
                    if (!userId && window.authManager) {
                        try {
                            userId = window.authManager.getUserId();
                            if (userId) {
                                console.log('âœ… [DEBUG] Found user ID from authManager:', userId);
                            }
                        } catch (e) {
                            console.warn('âš ï¸ [DEBUG] Failed to get userId from authManager:', e);
                        }
                    }

                    // Final validation
                    if (!userId || userId === 'undefined' || userId === 'null') {
                        console.error('âŒ [DEBUG] No valid user ID found');

                        // Debug information
                        console.log('ðŸ” [DEBUG] Available localStorage keys:', Object.keys(localStorage));
                        console.log('ðŸ” [DEBUG] Available sessionStorage keys:', Object.keys(sessionStorage));
                        console.log('ðŸ” [DEBUG] localStorage userData:', localStorage.getItem('userData'));
                        console.log('ðŸ” [DEBUG] sessionStorage userData:', sessionStorage.getItem('userData'));

                        return null;
                    }

                    console.log('âœ… [DEBUG] Final user ID:', userId);
                    return userId;

                } catch (error) {
                    console.error('âŒ [DEBUG] Error in getUserId:', error);
                    return null;
                }
            }

            function getAuthToken() {
                try {
                    console.log('ðŸ” [DEBUG] Getting auth token...');

                    // Try multiple token locations with validation
                    let token = null;

                    // Method 1: Try localStorage tokens
                    const localTokens = [
                        localStorage.getItem('authToken'),
                        localStorage.getItem('token'),
                        localStorage.getItem('userToken')
                    ];

                    for (let localToken of localTokens) {
                        if (localToken && localToken !== 'undefined' && localToken !== 'null' && localToken.length > 10) {
                            token = localToken;
                            console.log('âœ… [DEBUG] Found token from localStorage');
                            break;
                        }
                    }

                    // Method 2: Try sessionStorage tokens as fallback
                    if (!token) {
                        const sessionTokens = [
                            sessionStorage.getItem('authToken'),
                            sessionStorage.getItem('token'),
                            sessionStorage.getItem('userToken')
                        ];

                        for (let sessionToken of sessionTokens) {
                            if (sessionToken && sessionToken !== 'undefined' && sessionToken !== 'null' && sessionToken.length > 10) {
                                token = sessionToken;
                                console.log('âœ… [DEBUG] Found token from sessionStorage');
                                break;
                            }
                        }
                    }

                    // Method 3: Try global authManager if available
                    if (!token && window.authManager) {
                        try {
                            token = window.authManager.getAuthToken();
                            if (token) {
                                console.log('âœ… [DEBUG] Found token from authManager');
                            }
                        } catch (e) {
                            console.warn('âš ï¸ [DEBUG] Failed to get token from authManager:', e);
                        }
                    }

                    // Final validation
                    if (!token || token === 'undefined' || token === 'null' || token.length < 10) {
                        console.error('âŒ [DEBUG] No valid auth token found');

                        // Debug information
                        console.log('ðŸ” [DEBUG] Available tokens:', {
                            localStorage_authToken: localStorage.getItem('authToken'),
                            localStorage_token: localStorage.getItem('token'),
                            localStorage_userToken: localStorage.getItem('userToken'),
                            sessionStorage_authToken: sessionStorage.getItem('authToken'),
                            sessionStorage_token: sessionStorage.getItem('token'),
                            sessionStorage_userToken: sessionStorage.getItem('userToken')
                        });

                        return null;
                    }

                    // Basic token format validation
                    if (!token.includes('.')) {
                        console.warn('âš ï¸ [DEBUG] Token format appears invalid (not JWT)');
                    }

                    console.log('âœ… [DEBUG] Final auth token found:', token.substring(0, 20) + '...');
                    return token;

                } catch (error) {
                    console.error('âŒ [DEBUG] Error in getAuthToken:', error);
                    return null;
                }
            }

            // Set up event listeners
            function setupEventListeners(container) {
                // SmartCredit form submission
                const smartCreditForm = container.querySelector('#smartcredit-access-form');
                if (smartCreditForm) {
                    smartCreditForm.addEventListener('submit', async function (e) {
                        e.preventDefault();
                        const email = container.querySelector('#smartcredit-email').value;
                        const password = container.querySelector('#smartcredit-password').value;
                        const submitButton = smartCreditForm.querySelector('button[type="submit"]');

                        // Show loading state
                        const originalButtonText = submitButton.innerHTML;
                        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Storing Securely...';
                        submitButton.disabled = true;

                        try {
                            // Get user ID from session/token
                            const userId = getUserId(); // You'll need to implement this function

                            // MOBILE SAFARI FIX: Pre-validate authentication before submission
                            if (!userId || !getAuthToken()) {
                                throw new Error('Authentication required - please log in again. This can happen on mobile browsers due to storage limitations.');
                            }

                            // MOBILE SAFARI FIX: Additional validation for mobile browsers
                            if (navigator.userAgent.includes('Mobile') || navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad')) {
                                console.log('ðŸ“± [DEBUG] Mobile device detected, performing additional validation...');

                                // Try to refresh auth state if needed
                                if (!localStorage.getItem('userData') && !sessionStorage.getItem('userData')) {
                                    console.log('âš ï¸ [DEBUG] No user data found on mobile, this may cause authentication issues');
                                    throw new Error('Authentication session expired on mobile. Please refresh the page and log in again.');
                                }

                                // Validate that we have consistent user ID
                                const authToken = getAuthToken();
                                if (!authToken || authToken.length < 50) {
                                    console.log('âš ï¸ [DEBUG] Auth token appears invalid on mobile');
                                    throw new Error('Authentication token invalid on mobile. Please refresh the page and log in again.');
                                }
                            }

                            // Check if credentials already exist by getting current status
                            const statusResponse = await fetch(`https://jam-capital-backend.azurewebsites.net/api/credentials/status`, {
                                method: 'GET',
                                headers: {
                                    'Authorization': `Bearer ${getAuthToken()}`
                                }
                            });

                            const statusData = await statusResponse.json();
                            let credentialExists = false;

                            if (statusResponse.ok && statusData.success) {
                                credentialExists = statusData.data && statusData.data.smartcredit && statusData.data.smartcredit.hasCredentials;
                            }

                            // Use appropriate endpoint based on existence
                            const endpoint = credentialExists ? '/credentials/update' : '/credentials/store';
                            const method = credentialExists ? 'PUT' : 'POST';

                            console.log(`Using ${method} ${endpoint} for smartcredit (exists: ${credentialExists})...`);

                            const response = await fetch(`https://jam-capital-backend.azurewebsites.net/api${endpoint}`, {
                                method: method,
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${getAuthToken()}`
                                },
                                body: JSON.stringify({
                                    userId: getUserId(),
                                    serviceType: 'smartcredit',
                                    email: email,
                                    password: password,
                                    purpose: 'credit_monitoring'
                                })
                            });

                            const result = await response.json();

                            if (result.success) {
                                console.log('âœ… SmartCredit credentials stored/updated securely');

                                const action = credentialExists ? 'updated' : 'saved';

                                // Show updated credential status
                                const credentialData = {
                                    email: email,
                                    updatedAt: new Date().toISOString()
                                };
                                showCredentialStatus(container, 'smartcredit', credentialData);

                                // Reset form
                                smartCreditForm.reset();
                                const updateWarning = container.querySelector('#smartcredit-update-warning');
                                const cancelBtn = container.querySelector('#smartcredit-cancel-btn');
                                if (updateWarning) updateWarning.style.display = 'none';
                                if (cancelBtn) cancelBtn.style.display = 'none';

                                // Show success message
                                const successMessage = credentialExists ?
                                    'SmartCredit credentials updated successfully!' :
                                    'SmartCredit credentials stored securely! You can now update or remove them using the buttons above.';
                                showCredentialMessage(container, 'smartcredit', 'success', successMessage);
                            } else {
                                throw new Error(result.message || 'Failed to store credentials');
                            }

                        } catch (error) {
                            console.error('âŒ Error storing SmartCredit credentials:', error);

                            // Show error message
                            const errorDiv = document.createElement('div');
                            errorDiv.style.cssText = 'color: var(--danger); margin-top: 10px; padding: 10px; background-color: #f8d7da; border-radius: 5px;';
                            errorDiv.innerHTML = `
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Error:</strong> ${error.message || 'Failed to store credentials securely. Please try again.'}
                            `;

                            // Reset button and show error
                            submitButton.innerHTML = originalButtonText;
                            submitButton.disabled = false;
                            smartCreditForm.appendChild(errorDiv);

                            // Remove error message after 5 seconds
                            setTimeout(() => {
                                if (errorDiv.parentNode) {
                                    errorDiv.remove();
                                }
                            }, 5000);
                        }
                    });
                }

                // IdentityIQ form submission - WITH DEBUGGING
                console.log('ðŸ”§ [DEBUG] Setting up IdentityIQ form submission...');
                const identityIQForm = container.querySelector('#identityiq-access-form');
                console.log('ðŸ”§ [DEBUG] IdentityIQ form found:', !!identityIQForm);
                console.log('ðŸ”§ [DEBUG] IdentityIQ form element:', identityIQForm);

                if (identityIQForm) {
                    console.log('âœ… [DEBUG] IdentityIQ form found, attaching event listener...');

                    // Also add a click listener to the button directly for debugging
                    const identityIQButton = identityIQForm.querySelector('button[type="submit"]');
                    console.log('ðŸ”§ [DEBUG] IdentityIQ button found:', !!identityIQButton);
                    console.log('ðŸ”§ [DEBUG] IdentityIQ button element:', identityIQButton);

                    if (identityIQButton) {
                        identityIQButton.addEventListener('click', function (e) {
                            console.log('ðŸ”§ [DEBUG] IdentityIQ button CLICKED!', e);
                            console.log('ðŸ”§ [DEBUG] Click event target:', e.target);
                            console.log('ðŸ”§ [DEBUG] Click event currentTarget:', e.currentTarget);
                        });
                    }

                    identityIQForm.addEventListener('submit', async function (e) {
                        console.log('ðŸš€ [DEBUG] IdentityIQ form SUBMIT event triggered!', e);
                        console.log('ðŸ”§ [DEBUG] Submit event target:', e.target);
                        console.log('ðŸ”§ [DEBUG] Submit event currentTarget:', e.currentTarget);

                        e.preventDefault();
                        console.log('ðŸ”§ [DEBUG] Default prevented, continuing with custom handler...');

                        // Get form elements
                        const emailField = container.querySelector('#identityiq-email');
                        const passwordField = container.querySelector('#identityiq-password');
                        const submitButton = identityIQForm.querySelector('button[type="submit"]');

                        console.log('ðŸ”§ [DEBUG] Form elements found:', {
                            emailField: !!emailField,
                            passwordField: !!passwordField,
                            submitButton: !!submitButton
                        });

                        const email = emailField ? emailField.value : '';
                        const password = passwordField ? passwordField.value : '';

                        console.log('ðŸ”§ [DEBUG] Form values:', {
                            email: email ? 'PROVIDED' : 'EMPTY',
                            password: password ? 'PROVIDED' : 'EMPTY',
                            emailLength: email.length,
                            passwordLength: password.length
                        });

                        if (!email || !password) {
                            console.error('âŒ [DEBUG] Missing email or password');
                            alert('Please fill in both email and password fields.');
                            return;
                        }

                        // Show loading state
                        const originalButtonText = submitButton.innerHTML;
                        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Storing Securely...';
                        submitButton.disabled = true;
                        console.log('ðŸ”§ [DEBUG] Button updated to loading state');

                        try {
                            // Get user ID from session/token
                            const userId = getUserId();
                            const authToken = getAuthToken();

                            console.log('ðŸ”§ [DEBUG] Authentication check:', {
                                userId: userId ? 'FOUND' : 'MISSING',
                                authToken: authToken ? 'FOUND' : 'MISSING',
                                userIdLength: userId ? userId.length : 0,
                                authTokenLength: authToken ? authToken.length : 0
                            });

                            if (!userId || !authToken) {
                                throw new Error('Authentication required - please log in again');
                            }

                            // MOBILE SAFARI FIX: Additional validation for mobile browsers
                            if (navigator.userAgent.includes('Mobile') || navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad')) {
                                console.log('ðŸ“± [DEBUG] Mobile device detected for IdentityIQ, performing additional validation...');

                                // Try to refresh auth state if needed
                                if (!localStorage.getItem('userData') && !sessionStorage.getItem('userData')) {
                                    console.log('âš ï¸ [DEBUG] No user data found on mobile for IdentityIQ, this may cause authentication issues');
                                    throw new Error('Authentication session expired on mobile. Please refresh the page and log in again.');
                                }

                                // Validate that we have consistent user ID
                                if (!authToken || authToken.length < 50) {
                                    console.log('âš ï¸ [DEBUG] Auth token appears invalid on mobile for IdentityIQ');
                                    throw new Error('Authentication token invalid on mobile. Please refresh the page and log in again.');
                                }
                            }

                            // Check if credentials already exist by getting current status
                            const statusResponse = await fetch(`https://jam-capital-backend.azurewebsites.net/api/credentials/status`, {
                                method: 'GET',
                                headers: {
                                    'Authorization': `Bearer ${authToken}`
                                }
                            });

                            const statusData = await statusResponse.json();
                            let credentialExists = false;

                            if (statusResponse.ok && statusData.success) {
                                credentialExists = statusData.data && statusData.data.identityiq && statusData.data.identityiq.hasCredentials;
                            }

                            // Use appropriate endpoint based on existence
                            const endpoint = credentialExists ? '/credentials/update' : '/credentials/store';
                            const method = credentialExists ? 'PUT' : 'POST';

                            console.log(`Using ${method} ${endpoint} for identityiq (exists: ${credentialExists})...`);

                            const requestData = {
                                userId: getUserId(),
                                serviceType: 'identityiq',
                                email: email,
                                password: password,
                                purpose: 'credit_monitoring'
                            };

                            console.log('ðŸ”§ [DEBUG] Making API request with data:', {
                                serviceType: requestData.serviceType,
                                email: requestData.email ? 'PROVIDED' : 'MISSING',
                                password: requestData.password ? 'PROVIDED' : 'MISSING',
                                purpose: requestData.purpose
                            });

                            const response = await fetch(`https://jam-capital-backend.azurewebsites.net/api${endpoint}`, {
                                method: method,
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${authToken}`
                                },
                                body: JSON.stringify(requestData)
                            });

                            console.log('ðŸ”§ [DEBUG] API response received:', {
                                status: response.status,
                                statusText: response.statusText,
                                ok: response.ok
                            });

                            const result = await response.json();
                            console.log('ðŸ”§ [DEBUG] API response data:', result);

                            if (result.success) {
                                console.log('âœ… IdentityIQ credentials stored/updated securely');

                                // Show updated credential status
                                const credentialData = {
                                    email: email,
                                    updatedAt: new Date().toISOString()
                                };
                                showCredentialStatus(container, 'identityiq', credentialData);

                                // Reset form
                                identityIQForm.reset();
                                const updateWarning = container.querySelector('#identityiq-update-warning');
                                const cancelBtn = container.querySelector('#identityiq-cancel-btn');
                                if (updateWarning) updateWarning.style.display = 'none';
                                if (cancelBtn) cancelBtn.style.display = 'none';

                                // Show success message
                                const successMessage = credentialExists ?
                                    'IdentityIQ credentials updated successfully!' :
                                    'IdentityIQ credentials stored securely! You can now update or remove them using the buttons above.';
                                showCredentialMessage(container, 'identityiq', 'success', successMessage);
                            } else {
                                throw new Error(result.message || 'Failed to store credentials');
                            }

                        } catch (error) {
                            console.error('âŒ [DEBUG] Error in IdentityIQ form submission:', {
                                message: error.message,
                                stack: error.stack,
                                name: error.name
                            });

                            // Show error message
                            const errorDiv = document.createElement('div');
                            errorDiv.style.cssText = 'color: var(--danger); margin-top: 10px; padding: 10px; background-color: #f8d7da; border-radius: 5px;';
                            errorDiv.innerHTML = `
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Error:</strong> ${error.message || 'Failed to store credentials securely. Please try again.'}
                            `;

                            // Reset button and show error
                            submitButton.innerHTML = originalButtonText;
                            submitButton.disabled = false;
                            identityIQForm.appendChild(errorDiv);
                            console.log('ðŸ”§ [DEBUG] Error message displayed and button reset');

                            // Remove error message after 5 seconds
                            setTimeout(() => {
                                if (errorDiv.parentNode) {
                                    errorDiv.remove();
                                }
                            }, 5000);
                        }
                    });

                    console.log('âœ… [DEBUG] IdentityIQ form event listener attached successfully');

                    // Additional debugging - check button styles and visibility
                    setTimeout(() => {
                        const button = identityIQForm.querySelector('button[type="submit"]');
                        if (button) {
                            const buttonStyles = window.getComputedStyle(button);
                            console.log('ðŸ”§ [DEBUG] IdentityIQ button computed styles:', {
                                display: buttonStyles.display,
                                visibility: buttonStyles.visibility,
                                opacity: buttonStyles.opacity,
                                pointerEvents: buttonStyles.pointerEvents,
                                position: buttonStyles.position,
                                zIndex: buttonStyles.zIndex,
                                backgroundColor: buttonStyles.backgroundColor,
                                color: buttonStyles.color,
                                cursor: buttonStyles.cursor,
                                disabled: button.disabled
                            });

                            const buttonRect = button.getBoundingClientRect();
                            console.log('ðŸ”§ [DEBUG] IdentityIQ button position and size:', {
                                width: buttonRect.width,
                                height: buttonRect.height,
                                top: buttonRect.top,
                                left: buttonRect.left,
                                right: buttonRect.right,
                                bottom: buttonRect.bottom
                            });

                            // Check if button is actually visible
                            const isVisible = buttonRect.width > 0 && buttonRect.height > 0 &&
                                buttonStyles.display !== 'none' &&
                                buttonStyles.visibility !== 'hidden' &&
                                parseFloat(buttonStyles.opacity) > 0;

                            console.log('ðŸ”§ [DEBUG] IdentityIQ button visibility check:', {
                                isVisible: isVisible,
                                hasSize: buttonRect.width > 0 && buttonRect.height > 0,
                                notDisplayNone: buttonStyles.display !== 'none',
                                notVisibilityHidden: buttonStyles.visibility !== 'hidden',
                                opacityGreaterThanZero: parseFloat(buttonStyles.opacity) > 0
                            });
                        }
                    }, 1000);

                } else {
                    console.error('âŒ [DEBUG] IdentityIQ form NOT FOUND in container!');
                    console.log('ðŸ”§ [DEBUG] Container innerHTML preview:', container.innerHTML.substring(0, 500) + '...');

                    // Try to find it with different selectors
                    const allForms = container.querySelectorAll('form');
                    console.log('ðŸ”§ [DEBUG] All forms found in container:', allForms.length);
                    allForms.forEach((form, index) => {
                        console.log(`ðŸ”§ [DEBUG] Form ${index + 1}:`, {
                            id: form.id,
                            className: form.className,
                            tagName: form.tagName
                        });
                    });

                    const identityIQButtons = container.querySelectorAll('button');
                    console.log('ðŸ”§ [DEBUG] All buttons found in container:', identityIQButtons.length);
                    identityIQButtons.forEach((btn, index) => {
                        if (btn.textContent && btn.textContent.includes('IdentityIQ')) {
                            console.log(`ðŸ”§ [DEBUG] IdentityIQ-related button ${index + 1}:`, {
                                id: btn.id,
                                className: btn.className,
                                type: btn.type,
                                textContent: btn.textContent.trim(),
                                parentElement: btn.parentElement ? btn.parentElement.tagName : 'none'
                            });
                        }
                    });
                }

                // MyScoreIQ form submission
                const myScoreIQForm = container.querySelector('#myscoreiq-access-form');
                if (myScoreIQForm) {
                    myScoreIQForm.addEventListener('submit', async function (e) {
                        e.preventDefault();
                        const email = container.querySelector('#myscoreiq-email').value;
                        const password = container.querySelector('#myscoreiq-password').value;
                        const submitButton = myScoreIQForm.querySelector('button[type="submit"]');

                        // Show loading state
                        const originalButtonText = submitButton.innerHTML;
                        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Storing Securely...';
                        submitButton.disabled = true;

                        try {
                            // Get user ID from session/token
                            const userId = getUserId();

                            // MOBILE SAFARI FIX: Pre-validate authentication before submission
                            if (!userId || !getAuthToken()) {
                                throw new Error('Authentication required - please log in again. This can happen on mobile browsers due to storage limitations.');
                            }

                            // MOBILE SAFARI FIX: Additional validation for mobile browsers
                            if (navigator.userAgent.includes('Mobile') || navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad')) {
                                console.log('ðŸ“± [DEBUG] Mobile device detected for MyScoreIQ, performing additional validation...');

                                // Try to refresh auth state if needed
                                if (!localStorage.getItem('userData') && !sessionStorage.getItem('userData')) {
                                    console.log('âš ï¸ [DEBUG] No user data found on mobile for MyScoreIQ, this may cause authentication issues');
                                    throw new Error('Authentication session expired on mobile. Please refresh the page and log in again.');
                                }

                                // Validate that we have consistent user ID
                                const authToken = getAuthToken();
                                if (!authToken || authToken.length < 50) {
                                    console.log('âš ï¸ [DEBUG] Auth token appears invalid on mobile for MyScoreIQ');
                                    throw new Error('Authentication token invalid on mobile. Please refresh the page and log in again.');
                                }
                            }

                            // Check if credentials already exist by getting current status
                            const statusResponse = await fetch(`https://jam-capital-backend.azurewebsites.net/api/credentials/status`, {
                                method: 'GET',
                                headers: {
                                    'Authorization': `Bearer ${getAuthToken()}`
                                }
                            });

                            const statusData = await statusResponse.json();
                            let credentialExists = false;

                            if (statusResponse.ok && statusData.success) {
                                credentialExists = statusData.data && statusData.data.myscoreiq && statusData.data.myscoreiq.hasCredentials;
                            }

                            // Use appropriate endpoint based on existence
                            const endpoint = credentialExists ? '/credentials/update' : '/credentials/store';
                            const method = credentialExists ? 'PUT' : 'POST';

                            console.log(`Using ${method} ${endpoint} for myscoreiq (exists: ${credentialExists})...`);

                            const response = await fetch(`https://jam-capital-backend.azurewebsites.net/api${endpoint}`, {
                                method: method,
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${getAuthToken()}`
                                },
                                body: JSON.stringify({
                                    userId: getUserId(),
                                    serviceType: 'myscoreiq',
                                    email: email,
                                    password: password,
                                    purpose: 'credit_monitoring'
                                })
                            });

                            const result = await response.json();

                            if (result.success) {
                                console.log('âœ… MyScoreIQ credentials stored/updated securely');

                                // Show updated credential status
                                const credentialData = {
                                    email: email,
                                    updatedAt: new Date().toISOString()
                                };
                                showCredentialStatus(container, 'myscoreiq', credentialData);

                                // Reset form
                                myScoreIQForm.reset();
                                const updateWarning = container.querySelector('#myscoreiq-update-warning');
                                const cancelBtn = container.querySelector('#myscoreiq-cancel-btn');
                                if (updateWarning) updateWarning.style.display = 'none';
                                if (cancelBtn) cancelBtn.style.display = 'none';

                                // Show success message
                                const successMessage = credentialExists ?
                                    'MyScoreIQ credentials updated successfully!' :
                                    'MyScoreIQ credentials stored securely! You can now update or remove them using the buttons above.';
                                showCredentialMessage(container, 'myscoreiq', 'success', successMessage);
                            } else {
                                throw new Error(result.message || 'Failed to store credentials');
                            }

                        } catch (error) {
                            console.error('âŒ Error storing MyScoreIQ credentials:', error);

                            // Show error message
                            const errorDiv = document.createElement('div');
                            errorDiv.style.cssText = 'color: var(--danger); margin-top: 10px; padding: 10px; background-color: #f8d7da; border-radius: 5px;';
                            errorDiv.innerHTML = `
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Error:</strong> ${error.message || 'Failed to store credentials securely. Please try again.'}
                            `;

                            // Reset button and show error
                            submitButton.innerHTML = originalButtonText;
                            submitButton.disabled = false;
                            myScoreIQForm.appendChild(errorDiv);

                            // Remove error message after 5 seconds
                            setTimeout(() => {
                                if (errorDiv.parentNode) {
                                    errorDiv.remove();
                                }
                            }, 5000);
                        }
                    });
                }

                // CFPB form submission
                const cfpbForm = container.querySelector('#cfpb-access-form');
                if (cfpbForm) {
                    cfpbForm.addEventListener('submit', async function (e) {
                        e.preventDefault();
                        const email = container.querySelector('#cfpb-email').value;
                        const password = container.querySelector('#cfpb-password').value;
                        const submitButton = cfpbForm.querySelector('button[type="submit"]');

                        // Show loading state
                        const originalButtonText = submitButton.innerHTML;
                        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Storing Securely...';
                        submitButton.disabled = true;

                        try {
                            // Get user ID from session/token
                            const userId = getUserId();

                            // MOBILE SAFARI FIX: Pre-validate authentication before submission
                            if (!userId || !getAuthToken()) {
                                throw new Error('Authentication required - please log in again. This can happen on mobile browsers due to storage limitations.');
                            }

                            // MOBILE SAFARI FIX: Additional validation for mobile browsers
                            if (navigator.userAgent.includes('Mobile') || navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad')) {
                                console.log('ðŸ“± [DEBUG] Mobile device detected for CFPB, performing additional validation...');

                                // Try to refresh auth state if needed
                                if (!localStorage.getItem('userData') && !sessionStorage.getItem('userData')) {
                                    console.log('âš ï¸ [DEBUG] No user data found on mobile for CFPB, this may cause authentication issues');
                                    throw new Error('Authentication session expired on mobile. Please refresh the page and log in again.');
                                }

                                // Validate that we have consistent user ID
                                const authToken = getAuthToken();
                                if (!authToken || authToken.length < 50) {
                                    console.log('âš ï¸ [DEBUG] Auth token appears invalid on mobile for CFPB');
                                    throw new Error('Authentication token invalid on mobile. Please refresh the page and log in again.');
                                }
                            }

                            // Check if credentials already exist by getting current status
                            const statusResponse = await fetch(`https://jam-capital-backend.azurewebsites.net/api/credentials/status`, {
                                method: 'GET',
                                headers: {
                                    'Authorization': `Bearer ${getAuthToken()}`
                                }
                            });

                            const statusData = await statusResponse.json();
                            let credentialExists = false;

                            if (statusResponse.ok && statusData.success) {
                                credentialExists = statusData.data && statusData.data.cfpb && statusData.data.cfpb.hasCredentials;
                            }

                            // Use appropriate endpoint based on existence
                            const endpoint = credentialExists ? '/credentials/update' : '/credentials/store';
                            const method = credentialExists ? 'PUT' : 'POST';

                            console.log(`Using ${method} ${endpoint} for cfpb (exists: ${credentialExists})...`);

                            const response = await fetch(`https://jam-capital-backend.azurewebsites.net/api${endpoint}`, {
                                method: method,
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${getAuthToken()}`
                                },
                                body: JSON.stringify({
                                    userId: getUserId(),
                                    serviceType: 'cfpb',
                                    email: email,
                                    password: password,
                                    purpose: 'credit_monitoring'
                                })
                            });

                            const result = await response.json();

                            if (result.success) {
                                console.log('âœ… CFPB credentials stored/updated securely');

                                // Show updated credential status
                                const credentialData = {
                                    email: email,
                                    updatedAt: new Date().toISOString()
                                };
                                showCredentialStatus(container, 'cfpb', credentialData);

                                // Reset form
                                cfpbForm.reset();
                                const updateWarning = container.querySelector('#cfpb-update-warning');
                                const cancelBtn = container.querySelector('#cfpb-cancel-btn');
                                if (updateWarning) updateWarning.style.display = 'none';
                                if (cancelBtn) cancelBtn.style.display = 'none';

                                // Show success message
                                const successMessage = credentialExists ?
                                    'CFPB credentials updated successfully!' :
                                    'CFPB credentials stored securely! You can now update or remove them using the buttons above.';
                                showCredentialMessage(container, 'cfpb', 'success', successMessage);
                            } else {
                                throw new Error(result.message || 'Failed to store credentials');
                            }

                        } catch (error) {
                            console.error('âŒ Error storing CFPB credentials:', error);

                            // Show error message
                            const errorDiv = document.createElement('div');
                            errorDiv.style.cssText = 'color: var(--danger); margin-top: 10px; padding: 10px; background-color: #f8d7da; border-radius: 5px;';
                            errorDiv.innerHTML = `
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Error:</strong> ${error.message || 'Failed to store credentials securely. Please try again.'}
                            `;

                            // Reset button and show error
                            submitButton.innerHTML = originalButtonText;
                            submitButton.disabled = false;
                            cfpbForm.appendChild(errorDiv);

                            // Remove error message after 5 seconds
                            setTimeout(() => {
                                if (errorDiv.parentNode) {
                                    errorDiv.remove();
                                }
                            }, 5000);
                        }
                    });
                }

                // AnnualCreditReport.com form submission
                const annualCreditReportForm = container.querySelector('#annualcreditreport-access-form');
                if (annualCreditReportForm) {
                    annualCreditReportForm.addEventListener('submit', async function (e) {
                        e.preventDefault();
                        const email = container.querySelector('#annualcreditreport-email').value;
                        const password = container.querySelector('#annualcreditreport-password').value;
                        const submitButton = annualCreditReportForm.querySelector('button[type="submit"]');

                        // Show loading state
                        const originalButtonText = submitButton.innerHTML;
                        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Storing Securely...';
                        submitButton.disabled = true;

                        try {
                            // Get user ID from session/token
                            const userId = getUserId();

                            // MOBILE SAFARI FIX: Pre-validate authentication before submission
                            if (!userId || !getAuthToken()) {
                                throw new Error('Authentication required - please log in again. This can happen on mobile browsers due to storage limitations.');
                            }

                            // MOBILE SAFARI FIX: Additional validation for mobile browsers
                            if (navigator.userAgent.includes('Mobile') || navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad')) {
                                console.log('ðŸ“± [DEBUG] Mobile device detected for AnnualCreditReport.com, performing additional validation...');

                                // Try to refresh auth state if needed
                                if (!localStorage.getItem('userData') && !sessionStorage.getItem('userData')) {
                                    console.log('âš ï¸ [DEBUG] No user data found on mobile for AnnualCreditReport.com, this may cause authentication issues');
                                    throw new Error('Authentication session expired on mobile. Please refresh the page and log in again.');
                                }

                                // Validate that we have consistent user ID
                                const authToken = getAuthToken();
                                if (!authToken || authToken.length < 50) {
                                    console.log('âš ï¸ [DEBUG] Auth token appears invalid on mobile for AnnualCreditReport.com');
                                    throw new Error('Authentication token invalid on mobile. Please refresh the page and log in again.');
                                }
                            }

                            // Check if credentials already exist by getting current status
                            const statusResponse = await fetch(`https://jam-capital-backend.azurewebsites.net/api/credentials/status`, {
                                method: 'GET',
                                headers: {
                                    'Authorization': `Bearer ${getAuthToken()}`
                                }
                            });

                            const statusData = await statusResponse.json();
                            let credentialExists = false;

                            if (statusResponse.ok && statusData.success) {
                                credentialExists = statusData.data && statusData.data.annualcreditreport && statusData.data.annualcreditreport.hasCredentials;
                            }

                            // Use appropriate endpoint based on existence
                            const endpoint = credentialExists ? '/credentials/update' : '/credentials/store';
                            const method = credentialExists ? 'PUT' : 'POST';

                            console.log(`Using ${method} ${endpoint} for annualcreditreport (exists: ${credentialExists})...`);

                            const response = await fetch(`https://jam-capital-backend.azurewebsites.net/api${endpoint}`, {
                                method: method,
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${getAuthToken()}`
                                },
                                body: JSON.stringify({
                                    userId: getUserId(),
                                    serviceType: 'annualcreditreport',
                                    email: email,
                                    password: password,
                                    purpose: 'credit_monitoring'
                                })
                            });

                            const result = await response.json();

                            if (result.success) {
                                console.log('âœ… AnnualCreditReport.com credentials stored/updated securely');

                                // Show updated credential status
                                const credentialData = {
                                    email: email,
                                    updatedAt: new Date().toISOString()
                                };
                                showCredentialStatus(container, 'annualcreditreport', credentialData);

                                // Reset form
                                annualCreditReportForm.reset();
                                const updateWarning = container.querySelector('#annualcreditreport-update-warning');
                                const cancelBtn = container.querySelector('#annualcreditreport-cancel-btn');
                                if (updateWarning) updateWarning.style.display = 'none';
                                if (cancelBtn) cancelBtn.style.display = 'none';

                                // Show success message
                                const successMessage = credentialExists ?
                                    'AnnualCreditReport.com credentials updated successfully!' :
                                    'AnnualCreditReport.com credentials stored securely! You can now update or remove them using the buttons above.';
                                showCredentialMessage(container, 'annualcreditreport', 'success', successMessage);
                            } else {
                                throw new Error(result.message || 'Failed to store credentials');
                            }

                        } catch (error) {
                            console.error('âŒ Error storing AnnualCreditReport.com credentials:', error);

                            // Show error message
                            const errorDiv = document.createElement('div');
                            errorDiv.style.cssText = 'color: var(--danger); margin-top: 10px; padding: 10px; background-color: #f8d7da; border-radius: 5px;';
                            errorDiv.innerHTML = `
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Error:</strong> ${error.message || 'Failed to store credentials securely. Please try again.'}
                            `;

                            // Reset button and show error
                            submitButton.innerHTML = originalButtonText;
                            submitButton.disabled = false;
                            annualCreditReportForm.appendChild(errorDiv);

                            // Remove error message after 5 seconds
                            setTimeout(() => {
                                if (errorDiv.parentNode) {
                                    errorDiv.remove();
                                }
                            }, 5000);
                        }
                    });
                }

                // Bureau selection for credit reports
                setupBureauSelection(container);

                // ID type selection for ID verification
                setupIdTypeSelection(container);

                // Credit report upload
                setupUploadArea(container, 'credit-report', 'credit-report-input', 'credit-report-list');

                // ID verification upload
                setupUploadArea(container, 'id-verification', 'id-verification-input', 'id-verification-list');

                // Additional documents upload
                setupUploadArea(container, 'additional-documents', 'additional-input', 'additional-list');
            }

            // Update the setupBureauSelection function to check for existing reports
            function setupBureauSelection(container) {
                const bureauButtons = container.querySelectorAll('.bureau-btn');
                const uploadArea = container.querySelector('#credit-report-upload');
                const uploadInput = container.querySelector('#credit-report-input');
                let selectedBureau = null;

                bureauButtons.forEach(button => {
                    button.addEventListener('click', function () {
                        const bureau = this.getAttribute('data-bureau');

                        // Check if this bureau already has a credit report
                        const existingReport = uploadedDocuments.find(doc =>
                            doc.sectionType === 'credit-report' &&
                            doc.bureau === bureau &&
                            doc.uploadStatus === 'success'
                        );

                        if (existingReport) {
                            // Show warning message
                            showBureauLimitWarning(bureau, existingReport.name);
                            return; // Don't allow selection
                        }

                        // Remove selected class from all buttons
                        bureauButtons.forEach(btn => btn.classList.remove('selected'));

                        // Add selected class to clicked button
                        this.classList.add('selected');

                        // Store selected bureau
                        selectedBureau = bureau;

                        // Enable upload area
                        uploadArea.style.opacity = '1';
                        uploadArea.style.pointerEvents = 'auto';
                        uploadInput.disabled = false;

                        // Update upload area text
                        const uploadText = uploadArea.querySelector('.document-upload-text');
                        const bureauName = this.textContent.trim();
                        uploadText.textContent = `Drag & drop your ${bureauName} credit report here`;

                        console.log(`Selected bureau: ${selectedBureau}`);
                    });
                });

                // Store the selected bureau for use in file upload
                container.setAttribute('data-selected-bureau', '');
            }

            // Show warning when trying to upload to a bureau that already has a report
            function showBureauLimitWarning(bureau, existingFileName) {
                const bureauNames = {
                    'experian': 'Experian',
                    'equifax': 'Equifax',
                    'transunion': 'TransUnion'
                };

                const bureauDisplay = bureauNames[bureau] || bureau;

                // Create warning modal or alert
                const warningMessage = `
                    You already have a ${bureauDisplay} credit report uploaded: "${existingFileName}"
                    
                    You can only have one credit report per bureau. Would you like to:
                    1. Keep the existing report
                    2. Delete the existing report and upload a new one
                `;

                if (confirm(warningMessage + '\n\nClick OK to delete the existing report and upload a new one, or Cancel to keep the existing report.')) {
                    // User wants to replace - find and delete the existing report
                    const existingReport = uploadedDocuments.find(doc =>
                        doc.sectionType === 'credit-report' &&
                        doc.bureau === bureau &&
                        doc.uploadStatus === 'success'
                    );

                    if (existingReport) {
                        console.log(`ðŸ”„ Replacing existing ${bureau} report:`, existingReport.name);
                        removeDocument(existingReport.id);

                        // After deletion, allow the bureau selection
                        setTimeout(() => {
                            const bureauButton = document.querySelector(`[data-bureau="${bureau}"]`);
                            if (bureauButton) {
                                bureauButton.click(); // Trigger the selection again
                            }
                        }, 500);
                    }
                }
            }

            // Set up upload area functionality
            function setupUploadArea(container, sectionType, inputId, listId) {
                const uploadArea = container.querySelector(`[data-section="${sectionType}"]`);
                const uploadInput = container.querySelector(`#${inputId}`);
                const documentList = container.querySelector(`#${listId}`);

                if (uploadArea && uploadInput && documentList) {
                    console.log(`Setting up upload area for: ${sectionType}`);

                    // Click on upload area to trigger file input
                    uploadArea.addEventListener('click', function () {
                        uploadInput.click();
                    });

                    // Handle file selection
                    uploadInput.addEventListener('change', function () {
                        handleFiles(this.files, documentList);
                    });

                    // Drag and drop functionality
                    uploadArea.addEventListener('dragover', function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        uploadArea.style.backgroundColor = 'var(--primary-light)';
                    });

                    uploadArea.addEventListener('dragleave', function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        uploadArea.style.backgroundColor = '';
                    });

                    uploadArea.addEventListener('drop', function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        uploadArea.style.backgroundColor = '';
                        handleFiles(e.dataTransfer.files, documentList);
                    });

                    console.log(`âœ… Upload area setup complete for: ${sectionType}`);
                } else {
                    console.error(`âŒ Failed to setup upload area for: ${sectionType}`, {
                        uploadArea: !!uploadArea,
                        uploadInput: !!uploadInput,
                        documentList: !!documentList
                    });
                }
            }

            // Handle uploaded files
            function handleFiles(files, listElement) {
                if (!files || !listElement) return;

                // Determine section type from the upload area
                const uploadArea = listElement.closest('.document-section').querySelector('.document-upload-area');
                const sectionType = getSectionType(uploadArea);

                // For credit reports, get the selected bureau
                let selectedBureau = null;
                if (sectionType === 'credit-report') {
                    const selectedBureauBtn = container.querySelector('.bureau-btn.selected');
                    if (selectedBureauBtn) {
                        selectedBureau = selectedBureauBtn.getAttribute('data-bureau');
                    }

                    if (!selectedBureau) {
                        alert('Please select a credit bureau before uploading your report.');
                        return;
                    }
                }

                // For ID verification, get the selected ID type
                let selectedIdType = null;
                if (sectionType === 'id-verification') {
                    const selectedIdTypeBtn = container.querySelector('.id-type-btn.selected');
                    if (selectedIdTypeBtn) {
                        selectedIdType = selectedIdTypeBtn.getAttribute('data-id-type');
                    }

                    if (!selectedIdType) {
                        alert('Please select a document type (Government ID or Utility Bill) before uploading.');
                        return;
                    }
                }

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];

                    // Create a unique ID for this file
                    const fileId = 'file-' + Date.now() + '-' + i;

                    // Add to our internal array
                    const documentData = {
                        id: fileId,
                        file: file,
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        uploadDate: new Date(),
                        sectionType: sectionType,
                        uploadStatus: 'pending'
                    };

                    // Add bureau info for credit reports
                    if (sectionType === 'credit-report' && selectedBureau) {
                        documentData.bureau = selectedBureau;
                    }

                    // Add ID type info for ID verification
                    if (sectionType === 'id-verification' && selectedIdType) {
                        documentData.idType = selectedIdType;
                    }

                    uploadedDocuments.push(documentData);

                    // Create list item with bureau info for credit reports
                    const listItem = document.createElement('div');
                    listItem.className = 'document-item';
                    listItem.id = fileId;

                    // Determine icon based on file type
                    let iconClass = 'fa-file';
                    if (file.type.includes('pdf')) {
                        iconClass = 'fa-file-pdf';
                    } else if (file.type.includes('image')) {
                        iconClass = 'fa-file-image';
                    } else if (file.type.includes('word')) {
                        iconClass = 'fa-file-word';
                    }

                    // Format file size
                    const fileSize = formatFileSize(file.size);

                    // Create display name with bureau info for credit reports
                    let displayName = file.name;
                    if (sectionType === 'credit-report' && selectedBureau) {
                        const bureauNames = {
                            'experian': 'Experian',
                            'equifax': 'Equifax',
                            'transunion': 'TransUnion'
                        };
                        displayName = `${bureauNames[selectedBureau]} - ${file.name}`;
                    }

                    // Add content to list item
                    listItem.innerHTML = `
                        <i class="fas ${iconClass} document-icon"></i>
                        <div class="document-info">
                            <div class="document-name">${displayName}</div>
                            <div class="document-meta">${fileSize} â€¢ Uploaded just now</div>
                        </div>
                        <div class="document-actions">
                            <button class="document-action-btn view" data-id="${fileId}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="document-action-btn delete" data-id="${fileId}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;

                    // Add to list
                    listElement.appendChild(listItem);

                    // Add event listeners for actions
                    const deleteBtn = listItem.querySelector('.delete');
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', function () {
                            const id = this.getAttribute('data-id');
                            removeDocument(id);
                        });
                    }

                    const viewBtn = listItem.querySelector('.view');
                    if (viewBtn) {
                        viewBtn.addEventListener('click', function () {
                            const id = this.getAttribute('data-id');
                            viewDocument(id);
                        });
                    }

                    // Upload to backend after DOM is ready
                    if (sectionType === 'credit-report' || sectionType === 'id-verification' || sectionType === 'additional-documents') {
                        // Show uploading status
                        updateDocumentStatus(fileId, 'uploading', 'Please wait...');

                        // Upload to backend with appropriate parameters
                        if (sectionType === 'credit-report') {
                            uploadToBackend(file, fileId, sectionType, selectedBureau, null);
                        } else if (sectionType === 'id-verification') {
                            uploadToBackend(file, fileId, sectionType, null, selectedIdType);
                        } else {
                            uploadToBackend(file, fileId, sectionType, null, null);
                        }
                    }
                }
            }

            // Upload to backend function (updated to include bureau info)
            async function uploadToBackend(file, fileId, sectionType, bureau = null, idType = null) {
                try {
                    console.log('ðŸŒ Uploading to backend:', file.name, 'Section:', sectionType, 'Bureau:', bureau, 'ID Type:', idType);

                    // Get user data and auth token
                    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                    const userId = userData.id;
                    const authToken = localStorage.getItem('authToken') ||
                        localStorage.getItem('token') ||
                        sessionStorage.getItem('authToken') ||
                        sessionStorage.getItem('token');

                    if (!userId || !authToken) {
                        throw new Error('User authentication required');
                    }

                    // Create FormData for file upload
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('userId', userId);
                    formData.append('documentType', sectionType);
                    formData.append('fileName', file.name);

                    // Add bureau info for credit reports
                    if (sectionType === 'credit-report' && bureau) {
                        formData.append('bureau', bureau);
                    }

                    // Add ID type info for ID verification
                    if (sectionType === 'id-verification' && idType) {
                        formData.append('idType', idType);
                    }

                    // Upload to backend
                    const response = await fetch('https://jam-capital-backend.azurewebsites.net/api/admin/upload-document', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: formData
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`Upload failed: ${errorData.message || response.statusText}`);
                    }

                    const result = await response.json();
                    console.log('âœ… Upload successful:', result);

                    // Update the document item to show success
                    updateDocumentStatus(fileId, 'success', result);

                    return result;

                } catch (error) {
                    console.error('âŒ Upload failed:', error);

                    // Update the document item to show error
                    updateDocumentStatus(fileId, 'error', error.message);

                    throw error;
                }
            }

            // Function to update document status in the UI (moved inside module)
            function updateDocumentStatus(fileId, status, data) {
                const documentItem = container.querySelector(`#${fileId}`);
                if (!documentItem) return;

                const metaElement = documentItem.querySelector('.document-meta');
                if (!metaElement) return;

                if (status === 'success') {
                    metaElement.innerHTML = `${formatFileSize(data.fileSize || 0)} â€¢ Uploaded successfully`;
                    documentItem.classList.add('upload-success');
                } else if (status === 'error') {
                    metaElement.innerHTML = `Upload failed â€¢ ${data}`;
                    documentItem.classList.add('upload-error');
                } else if (status === 'uploading') {
                    metaElement.innerHTML = `Uploading... â€¢ ${data}`;
                    documentItem.classList.add('upload-progress');
                }
            }

            // Function to determine section type from upload area (moved inside module)
            function getSectionType(uploadArea) {
                const section = uploadArea.getAttribute('data-section');
                if (section) return section;

                // Fallback: determine from parent elements
                const creditSection = uploadArea.closest('[data-section="credit-report"]');
                const idSection = uploadArea.closest('[data-section="id-verification"]');
                const additionalSection = uploadArea.closest('[data-section="additional-documents"]');

                if (creditSection) return 'credit-report';
                if (idSection) return 'id-verification';
                if (additionalSection) return 'additional-documents';

                return 'general'; // fallback
            }

            // Format file size
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';

                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));

                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            // Delete a document
            function removeDocument(id) {
                const docIndex = uploadedDocuments.findIndex(doc => doc.id === id);
                if (docIndex === -1) return;

                const document = uploadedDocuments[docIndex];
                console.log('ðŸ—‘ï¸ Removing document:', document.name, 'Type:', document.sectionType);

                // If this document was successfully uploaded to backend, delete it from database
                if (document.uploadStatus === 'success' && document.backendId) {
                    // Show confirmation dialog
                    if (!confirm(`Are you sure you want to delete "${document.name}"? This action cannot be undone.`)) {
                        return;
                    }

                    // Call backend to delete from database
                    deleteDocumentFromBackend(document.backendId, document.name)
                        .then(() => {
                            console.log('âœ… Backend deletion successful, updating UI...');

                            // Remove from local array and DOM
                            uploadedDocuments = uploadedDocuments.filter(doc => doc.id !== id);

                            // FIXED: Use correct selector - elements are created with id, not data-file-id
                            const documentElement = container.querySelector(`#${id}`);
                            if (documentElement) {
                                documentElement.remove();
                                console.log('ðŸ—‘ï¸ Removed DOM element for:', document.name);
                            } else {
                                console.warn('âš ï¸ Could not find DOM element with id:', id);
                            }

                            // Handle section-specific refresh/cleanup using section-specific functions
                            if (document.sectionType === 'credit-report') {
                                console.log('ðŸ”„ Document was credit report, refreshing display (section-specific)...');
                                setTimeout(() => {
                                    refreshCreditReportDisplayOnly();
                                }, 100);
                            } else if (document.sectionType === 'id-verification') {
                                console.log('ðŸ”„ Document was ID verification, refreshing display (section-specific)...');
                                setTimeout(() => {
                                    refreshIdDocumentDisplayOnly();
                                }, 100);
                            } else if (document.sectionType === 'additional-documents') {
                                console.log('ðŸ”„ Document was additional document, refreshing display (section-specific)...');
                                setTimeout(() => {
                                    refreshAdditionalDocumentsDisplayOnly();
                                }, 100);
                            }

                            console.log('âœ… Document deleted successfully');
                        })
                        .catch(error => {
                            console.error('âŒ Failed to delete document:', error);
                            alert('Failed to delete document. Please try again.');
                        });
                } else {
                    // Document wasn't uploaded to backend yet, just remove locally
                    uploadedDocuments = uploadedDocuments.filter(doc => doc.id !== id);

                    // FIXED: Use correct selector for local documents too
                    const documentElement = container.querySelector(`#${id}`);
                    if (documentElement) {
                        documentElement.remove();
                        console.log('ðŸ—‘ï¸ Removed local DOM element for:', document.name);
                    }

                    // Handle section-specific refresh/cleanup for local documents using section-specific functions
                    if (document.sectionType === 'credit-report') {
                        setTimeout(() => {
                            refreshCreditReportDisplayOnly();
                        }, 100);
                    } else if (document.sectionType === 'id-verification') {
                        setTimeout(() => {
                            refreshIdDocumentDisplayOnly();
                        }, 100);
                    } else if (document.sectionType === 'additional-documents') {
                        setTimeout(() => {
                            refreshAdditionalDocumentsDisplayOnly();
                        }, 100);
                    }
                }
            }

            // Delete document from backend
            async function deleteDocumentFromBackend(documentId, fileName) {
                try {
                    console.log('ðŸ—‘ï¸ Deleting document from backend:', fileName);

                    // Get user data and auth token
                    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                    const userId = userData.id;
                    const authToken = localStorage.getItem('authToken') ||
                        localStorage.getItem('token') ||
                        sessionStorage.getItem('authToken') ||
                        sessionStorage.getItem('token');

                    if (!userId || !authToken) {
                        throw new Error('User authentication required');
                    }

                    const response = await fetch('https://jam-capital-backend.azurewebsites.net/api/admin/delete-document', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            documentId: documentId,
                            userId: userId
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`Delete failed: ${errorData.message || response.statusText}`);
                    }

                    const result = await response.json();
                    console.log('âœ… Document deleted from backend:', result);
                    return result;

                } catch (error) {
                    console.error('âŒ Failed to delete document from backend:', error);
                    throw error;
                }
            }

            // Mark bureau button as occupied
            function markBureauAsOccupied(bureau) {
                const bureauButton = document.querySelector(`[data-bureau="${bureau}"]`);
                if (bureauButton) {
                    bureauButton.classList.add('occupied');
                    bureauButton.innerHTML += ' <span class="occupied-indicator">âœ… Uploaded</span>';
                    bureauButton.style.backgroundColor = '#e8f5e8';
                    bureauButton.style.border = '2px solid #28a745';
                }
            }

            // Remove occupied status when document is deleted
            function removeBureauOccupiedStatus(bureau) {
                const bureauButton = document.querySelector(`[data-bureau="${bureau}"]`);
                if (bureauButton) {
                    bureauButton.classList.remove('occupied');
                    const indicator = bureauButton.querySelector('.occupied-indicator');
                    if (indicator) {
                        indicator.remove();
                    }
                    bureauButton.style.backgroundColor = '';
                    bureauButton.style.border = '';
                }
            }

            // Create DOM element for existing documents
            function createExistingDocumentElement(documentData) {
                const listItem = document.createElement('div');
                listItem.className = 'document-item existing-document';
                listItem.id = documentData.id;

                // Determine icon
                let iconClass = 'fa-file-pdf';
                if (documentData.type.includes('image')) {
                    iconClass = 'fa-file-image';
                } else if (documentData.type.includes('word')) {
                    iconClass = 'fa-file-word';
                } else if (documentData.type.includes('excel') || documentData.type.includes('spreadsheet')) {
                    iconClass = 'fa-file-excel';
                }

                // Format file size
                const fileSize = formatFileSize(documentData.size);

                // Format upload date
                const uploadDate = new Date(documentData.uploadDate).toLocaleDateString();

                // Create display name based on document type
                let displayName = documentData.name;

                if (documentData.sectionType === 'credit-report' && documentData.bureau) {
                    // Bureau display name for credit reports
                    const bureauNames = {
                        'experian': 'Experian',
                        'equifax': 'Equifax',
                        'transunion': 'TransUnion'
                    };
                    const bureauDisplay = bureauNames[documentData.bureau] || documentData.bureau;
                    displayName = `${bureauDisplay} - ${documentData.name}`;
                } else if (documentData.sectionType === 'id-verification' && documentData.idType) {
                    // ID type display name for ID verification
                    const idTypeNames = {
                        'government-id': 'Government ID',
                        'utility-bill': 'Utility Bill'
                    };
                    const idTypeDisplay = idTypeNames[documentData.idType] || documentData.idType;
                    displayName = `${idTypeDisplay} - ${documentData.name}`;
                }
                // For additional documents, just use the filename as-is

                listItem.innerHTML = `
                    <i class="fas ${iconClass} document-icon"></i>
                    <div class="document-info">
                        <div class="document-name">${displayName}</div>
                        <div class="document-meta">${fileSize} â€¢ ${uploadDate} â€¢ <span style="color: #28a745;">Saved</span></div>
                    </div>
                    <div class="document-actions">
                        <button class="document-action-btn view" data-id="${documentData.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="document-action-btn delete" data-id="${documentData.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;

                // Add event listeners
                const deleteBtn = listItem.querySelector('.delete');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', function () {
                        const id = this.getAttribute('data-id');
                        removeDocument(id);
                    });
                }

                const viewBtn = listItem.querySelector('.view');
                if (viewBtn) {
                    viewBtn.addEventListener('click', function () {
                        const id = this.getAttribute('data-id');
                        viewExistingDocument(documentData.fileUrl);
                    });
                }

                return listItem;
            }

            // View existing document
            function viewExistingDocument(fileUrl) {
                if (fileUrl) {
                    window.open(fileUrl, '_blank');
                } else {
                    alert('Document URL not available');
                }
            }

            // Updated refresh credit report display area
            function refreshCreditReportDisplay() {
                console.log('ðŸ”„ Refreshing credit report display...');

                // FIRST: Clear existing credit report displays using the new function
                clearDocumentLists();

                // SECOND: Remove ALL credit reports from uploadedDocuments array
                uploadedDocuments = uploadedDocuments.filter(doc => doc.sectionType !== 'credit-report');
                console.log('ðŸ§¹ Cleared credit reports from uploadedDocuments array');

                // THIRD: Clear any potential duplicates from remaining documents
                clearDuplicateDocuments();

                // FOURTH: Re-fetch and display existing documents
                fetchExistingDocuments()
                    .then(documents => {
                        console.log('ðŸ“‹ Fetched documents for refresh:', documents.length);
                        const creditReports = documents.filter(doc => doc.documentType === 'credit-report');
                        console.log('ðŸ“‹ Credit reports found:', creditReports.length);

                        if (creditReports.length > 0) {
                            displayExistingCreditReports(documents);
                        } else {
                            console.log('ðŸ“‹ No credit reports to display after refresh');
                        }
                        console.log('âœ… Credit report display refreshed');
                    })
                    .catch(error => {
                        console.error('âŒ Failed to refresh credit report display:', error);
                    });
            }

            // Section-specific refresh functions that don't affect other sections
            function refreshCreditReportDisplayOnly() {
                console.log('ðŸ”„ Refreshing credit report display only...');

                // FIRST: Clear only credit report displays
                clearCreditReportListOnly();

                // SECOND: Remove only credit reports from uploadedDocuments array
                uploadedDocuments = uploadedDocuments.filter(doc => doc.sectionType !== 'credit-report');
                console.log('ðŸ§¹ Cleared credit reports from uploadedDocuments array (section-specific)');

                // THIRD: Clear any potential duplicates from remaining documents
                clearDuplicateDocuments();

                // FOURTH: Re-fetch and display only credit report documents
                fetchExistingDocuments()
                    .then(documents => {
                        console.log('ðŸ“‹ Fetched documents for credit report refresh:', documents.length);
                        const creditReports = documents.filter(doc => doc.documentType === 'credit-report');
                        console.log('ðŸ“‹ Credit reports found:', creditReports.length);

                        if (creditReports.length > 0) {
                            displayExistingCreditReports(documents);
                        } else {
                            console.log('ðŸ“‹ No credit reports to display after section-specific refresh');
                        }
                        console.log('âœ… Credit report display refreshed (section-specific)');
                    })
                    .catch(error => {
                        console.error('âŒ Failed to refresh credit report display (section-specific):', error);
                    });
            }

            // Setup ID type selection for ID verification
            function setupIdTypeSelection(container) {
                const idTypeButtons = container.querySelectorAll('.id-type-btn');
                const uploadArea = container.querySelector('#id-verification-upload');
                const uploadInput = container.querySelector('#id-verification-input');
                let selectedIdType = null;

                idTypeButtons.forEach(button => {
                    button.addEventListener('click', function () {
                        const idType = this.getAttribute('data-id-type');

                        // Check if this ID type already has a document
                        const existingDocument = uploadedDocuments.find(doc =>
                            doc.sectionType === 'id-verification' &&
                            doc.idType === idType &&
                            doc.uploadStatus === 'success'
                        );

                        if (existingDocument) {
                            // Show warning message
                            showIdTypeLimitWarning(idType, existingDocument.name);
                            return; // Don't allow selection
                        }

                        // Remove selected class from all buttons
                        idTypeButtons.forEach(btn => btn.classList.remove('selected'));

                        // Add selected class to clicked button
                        this.classList.add('selected');

                        // Store selected ID type
                        selectedIdType = idType;

                        // Enable upload area
                        uploadArea.style.opacity = '1';
                        uploadArea.style.pointerEvents = 'auto';
                        uploadInput.disabled = false;

                        // Update upload area text
                        const uploadText = uploadArea.querySelector('.document-upload-text');
                        const uploadIcon = uploadArea.querySelector('.document-upload-icon');
                        const idTypeName = this.textContent.trim();

                        uploadText.textContent = `Drag & drop your ${idTypeName} here`;

                        // Update icon based on document type
                        if (idType === 'government-id') {
                            uploadIcon.className = 'fas fa-id-card document-upload-icon';
                        } else if (idType === 'utility-bill') {
                            uploadIcon.className = 'fas fa-file-invoice document-upload-icon';
                        }

                        console.log(`Selected ID type: ${selectedIdType}`);
                    });
                });

                // Store the selected ID type for use in file upload
                container.setAttribute('data-selected-id-type', '');

                // Return the selected type getter
                return () => selectedIdType;
            }

            // Show warning when trying to upload an ID type that already exists
            function showIdTypeLimitWarning(idType, existingFileName) {
                const idTypeNames = {
                    'government-id': 'Government ID',
                    'utility-bill': 'Utility Bill'
                };

                const idTypeDisplay = idTypeNames[idType] || idType;

                const warningMessage = `
                    You already have a ${idTypeDisplay} uploaded: "${existingFileName}"
                    
                    You can only have one document per type. Would you like to:
                    1. Keep the existing document
                    2. Delete the existing document and upload a new one
                `;

                if (confirm(warningMessage + '\n\nClick OK to delete the existing document and upload a new one, or Cancel to keep the existing document.')) {
                    // User wants to replace - find and delete the existing document
                    const existingDocument = uploadedDocuments.find(doc =>
                        doc.sectionType === 'id-verification' &&
                        doc.idType === idType &&
                        doc.uploadStatus === 'success'
                    );

                    if (existingDocument) {
                        console.log(`ðŸ”„ Replacing existing ${idType}:`, existingDocument.name);
                        removeDocument(existingDocument.id);
                    }
                }
            }

            // Mark ID type button as occupied
            function markIdTypeAsOccupied(idType) {
                const idTypeButton = document.querySelector(`[data-id-type="${idType}"]`);
                if (idTypeButton) {
                    idTypeButton.classList.add('occupied');
                    idTypeButton.innerHTML += ' <span class="occupied-indicator">âœ… Uploaded</span>';
                    idTypeButton.style.backgroundColor = '#e8f5e8';
                    idTypeButton.style.border = '2px solid #28a745';
                }
            }

            // Remove occupied status when document is deleted
            function removeIdTypeOccupiedStatus(idType) {
                const idTypeButton = document.querySelector(`[data-id-type="${idType}"]`);
                if (idTypeButton) {
                    idTypeButton.classList.remove('occupied');
                    const indicator = idTypeButton.querySelector('.occupied-indicator');
                    if (indicator) {
                        indicator.remove();
                    }
                    idTypeButton.style.backgroundColor = '';
                    idTypeButton.style.border = '';
                }
            }

            // Display existing ID verification documents
            function displayExistingIdDocuments(documents) {
                return new Promise((resolve) => {
                    try {
                        const idDocuments = documents.filter(doc => doc.documentType === 'id-verification');
                        console.log('ðŸ“‹ [DEBUG] displayExistingIdDocuments - Processing', idDocuments.length, 'ID documents');

                        if (idDocuments.length === 0) {
                            console.log('ðŸ“‹ [DEBUG] No ID documents to display');
                            resolve();
                            return;
                        }

                        // FIRST: Clear any existing duplicates before processing new documents
                        const beforeClearCount = uploadedDocuments.filter(doc => doc.sectionType === 'id-verification').length;
                        clearDuplicateDocuments();
                        const afterClearCount = uploadedDocuments.filter(doc => doc.sectionType === 'id-verification').length;
                        console.log(`ðŸ§¹ [DEBUG] ID documents - cleared duplicates: ${beforeClearCount} -> ${afterClearCount}`);

                        // SECOND: Enhanced validation and filtering with detailed logging
                        const validIdDocuments = idDocuments.filter((doc, index) => {
                            console.log(`ðŸ” [DEBUG] Validating ID document ${index + 1}:`, {
                                fileName: doc.fileName,
                                idType: doc.idType,
                                id: doc.id,
                                documentType: doc.documentType
                            });

                            // Check if document has required fields
                            if (!doc.id || !doc.fileName) {
                                console.warn(`âš ï¸ [DEBUG] ID document ${index + 1} missing required fields:`, {
                                    hasId: !!doc.id,
                                    hasFileName: !!doc.fileName,
                                    doc: doc
                                });
                                return false;
                            }

                            // Check if idType is defined and valid
                            const validIdTypes = ['government-id', 'utility-bill'];
                            if (!doc.idType || !validIdTypes.includes(doc.idType)) {
                                console.warn(`âš ï¸ [DEBUG] ID document ${index + 1} has invalid idType:`, {
                                    fileName: doc.fileName,
                                    idType: doc.idType,
                                    validIdTypes: validIdTypes
                                });
                                return false;
                            }

                            // Check if fileName looks valid (not corrupted)
                            if (doc.fileName.includes('undefined') || doc.fileName.match(/^\d+-\d+-\d+/)) {
                                console.warn(`âš ï¸ [DEBUG] ID document ${index + 1} has corrupted fileName:`, doc.fileName);
                                return false;
                            }

                            console.log(`âœ… [DEBUG] ID document ${index + 1} passed validation`);
                            return true;
                        });

                        console.log(`ðŸ“‹ [DEBUG] Valid ID documents after filtering: ${validIdDocuments.length} of ${idDocuments.length}`);

                        if (validIdDocuments.length > 0) {
                            // Find the ID verification list element
                            const listElement = container.querySelector('#id-verification-list');

                            if (!listElement) {
                                console.error('âŒ [DEBUG] ID verification list element not found');
                                resolve();
                                return;
                            }

                            validIdDocuments.forEach((doc, index) => {
                                console.log(`ðŸ“„ [DEBUG] Processing ID document ${index + 1}:`, {
                                    fileName: doc.fileName,
                                    idType: doc.idType,
                                    id: doc.id
                                });

                                // Create a unique identifier for this document
                                const uniqueId = `existing_${doc.id}`;

                                // Multiple comprehensive checks to prevent any possible duplicates
                                const duplicateChecks = [
                                    uploadedDocuments.find(document => document.id === uniqueId),
                                    uploadedDocuments.find(document => document.backendId === doc.id)
                                ];
                                // Note: For additional documents, we allow multiple files with the same name
                                // since users might upload different versions or related documents

                                // If ANY of the duplicate checks return a result, skip this document
                                const existingDocument = duplicateChecks.find(check => check !== undefined);

                                if (existingDocument) {
                                    console.log(`ðŸ“Œ [DEBUG] ID document ${index + 1} already exists, skipping:`, {
                                        fileName: doc.fileName,
                                        idType: doc.idType,
                                        backendId: doc.id,
                                        existingDocumentId: existingDocument.id,
                                        existingBackendId: existingDocument.backendId
                                    });
                                    return; // Skip this document as it's already in the array
                                }

                                // Add to uploadedDocuments array (no duplicates found)
                                const documentData = {
                                    id: uniqueId,
                                    name: doc.fileName,
                                    size: doc.fileSize || 0,
                                    type: doc.mimeType || 'application/pdf',
                                    uploadStatus: 'success',
                                    backendId: doc.id,
                                    fileUrl: doc.fileUrl,
                                    isExisting: true,
                                    idType: doc.idType,
                                    uploadDate: new Date(doc.createdAt || Date.now()),
                                    sectionType: 'id-verification'
                                };

                                // Validate the document data before adding
                                if (!documentData.name || !documentData.idType || !documentData.backendId) {
                                    console.error(`âŒ [DEBUG] Invalid ID document data for ${index + 1}, skipping:`, documentData);
                                    return;
                                }

                                uploadedDocuments.push(documentData);

                                // Create DOM element for existing document
                                const listItem = createExistingDocumentElement(documentData);
                                listElement.appendChild(listItem);

                                console.log(`âœ… [DEBUG] Added ID document ${index + 1}: ${doc.fileName} (${doc.idType})`);
                            });

                            // Mark ID type buttons as occupied only if we have documents for those types
                            const idTypes = ['government-id', 'utility-bill'];
                            idTypes.forEach(idType => {
                                const idDocumentsForType = uploadedDocuments.filter(doc =>
                                    doc.sectionType === 'id-verification' &&
                                    doc.idType === idType &&
                                    (doc.uploadStatus === 'success' || doc.isExisting)
                                );

                                if (idDocumentsForType.length > 0) {
                                    console.log(`ðŸ“Œ [DEBUG] Marking ${idType} as occupied`);
                                    markIdTypeAsOccupied(idType);
                                }
                            });
                        } else {
                            console.log('ðŸ“‹ [DEBUG] No valid ID documents to display');
                        }

                        // THIRD: Clear duplicates again after adding all documents (safety check)
                        clearDuplicateDocuments();
                        console.log(`âœ… [DEBUG] displayExistingIdDocuments completed. Total uploadedDocuments: ${uploadedDocuments.length}`);
                        resolve();

                    } catch (error) {
                        console.error('âŒ [DEBUG] displayExistingIdDocuments error:', error);
                        resolve(); // Don't reject, just log and continue
                    }
                });
            }

            // Updated refresh function for ID documents
            function refreshIdDocumentDisplay() {
                console.log('ðŸ”„ Refreshing ID document display...');

                // FIRST: Clear existing ID document displays using the new function
                clearDocumentLists();

                // SECOND: Remove ALL ID verification documents from uploadedDocuments array
                uploadedDocuments = uploadedDocuments.filter(doc => doc.sectionType !== 'id-verification');
                console.log('ðŸ§¹ Cleared ID documents from uploadedDocuments array');

                // THIRD: Clear any potential duplicates from remaining documents
                clearDuplicateDocuments();

                // FOURTH: Re-fetch and display existing documents
                fetchExistingDocuments()
                    .then(documents => {
                        console.log('ðŸ“‹ Fetched documents for ID refresh:', documents.length);
                        const idDocs = documents.filter(doc => doc.documentType === 'id-verification');
                        console.log('ðŸ“‹ ID documents found:', idDocs.length);

                        if (idDocs.length > 0) {
                            displayExistingIdDocuments(documents);
                        } else {
                            console.log('ðŸ“‹ No ID documents to display after refresh');
                        }
                        console.log('âœ… ID document display refreshed');
                    })
                    .catch(error => {
                        console.error('âŒ Failed to refresh ID document display:', error);
                    });
            }

            function refreshIdDocumentDisplayOnly() {
                console.log('ðŸ”„ Refreshing ID document display only...');

                // FIRST: Clear only ID verification displays
                clearIdVerificationListOnly();

                // SECOND: Remove only ID verification documents from uploadedDocuments array
                uploadedDocuments = uploadedDocuments.filter(doc => doc.sectionType !== 'id-verification');
                console.log('ðŸ§¹ Cleared ID documents from uploadedDocuments array (section-specific)');

                // THIRD: Clear any potential duplicates from remaining documents
                clearDuplicateDocuments();

                // FOURTH: Re-fetch and display only ID verification documents
                fetchExistingDocuments()
                    .then(documents => {
                        console.log('ðŸ“‹ Fetched documents for ID refresh (section-specific):', documents.length);
                        const idDocs = documents.filter(doc => doc.documentType === 'id-verification');
                        console.log('ðŸ“‹ ID documents found:', idDocs.length);

                        if (idDocs.length > 0) {
                            displayExistingIdDocuments(documents);
                        } else {
                            console.log('ðŸ“‹ No ID documents to display after section-specific refresh');
                        }
                        console.log('âœ… ID document display refreshed (section-specific)');
                    })
                    .catch(error => {
                        console.error('âŒ Failed to refresh ID document display (section-specific):', error);
                    });
            }

            function refreshAdditionalDocumentsDisplayOnly() {
                console.log('ðŸ”„ Refreshing additional documents display only...');

                // FIRST: Clear only additional documents displays
                clearAdditionalDocumentsListOnly();

                // SECOND: Remove only additional documents from uploadedDocuments array
                uploadedDocuments = uploadedDocuments.filter(doc => doc.sectionType !== 'additional-documents');
                console.log('ðŸ§¹ Cleared additional documents from uploadedDocuments array (section-specific)');

                // THIRD: Clear any potential duplicates from remaining documents
                clearDuplicateDocuments();

                // FOURTH: Re-fetch and display only additional documents
                fetchExistingDocuments()
                    .then(documents => {
                        console.log('ðŸ“‹ Fetched documents for additional docs refresh (section-specific):', documents.length);
                        const additionalDocs = documents.filter(doc => doc.documentType === 'additional-documents');
                        console.log('ðŸ“‹ Additional documents found:', additionalDocs.length);

                        if (additionalDocs.length > 0) {
                            displayExistingAdditionalDocuments(documents);
                        } else {
                            console.log('ðŸ“‹ No additional documents to display after section-specific refresh');
                        }
                        console.log('âœ… Additional documents display refreshed (section-specific)');
                    })
                    .catch(error => {
                        console.error('âŒ Failed to refresh additional documents display (section-specific):', error);
                    });
            }

            // Display existing additional documents
            function displayExistingAdditionalDocuments(documents) {
                return new Promise((resolve) => {
                    try {
                        const additionalDocuments = documents.filter(doc => doc.documentType === 'additional-documents');
                        console.log('ðŸ“‹ [DEBUG] displayExistingAdditionalDocuments - Processing', additionalDocuments.length, 'additional documents');

                        if (additionalDocuments.length === 0) {
                            console.log('ðŸ“‹ [DEBUG] No additional documents to display');
                            resolve();
                            return;
                        }

                        // FIRST: Clear any existing duplicates before processing new documents
                        const beforeClearCount = uploadedDocuments.filter(doc => doc.sectionType === 'additional-documents').length;
                        clearDuplicateDocuments();
                        const afterClearCount = uploadedDocuments.filter(doc => doc.sectionType === 'additional-documents').length;
                        console.log(`ðŸ§¹ [DEBUG] Additional documents - cleared duplicates: ${beforeClearCount} -> ${afterClearCount}`);

                        // SECOND: Enhanced validation and filtering with detailed logging
                        const validAdditionalDocuments = additionalDocuments.filter((doc, index) => {
                            console.log(`ðŸ” [DEBUG] Validating additional document ${index + 1}:`, {
                                fileName: doc.fileName,
                                id: doc.id,
                                documentType: doc.documentType
                            });

                            // Check if document has required fields
                            if (!doc.id || !doc.fileName) {
                                console.warn(`âš ï¸ [DEBUG] Additional document ${index + 1} missing required fields:`, {
                                    hasId: !!doc.id,
                                    hasFileName: !!doc.fileName,
                                    doc: doc
                                });
                                return false;
                            }

                            // Check if fileName looks valid (not corrupted)
                            if (doc.fileName.includes('undefined') || doc.fileName.match(/^\d+-\d+-\d+/)) {
                                console.warn(`âš ï¸ [DEBUG] Additional document ${index + 1} has corrupted fileName:`, doc.fileName);
                                return false;
                            }

                            console.log(`âœ… [DEBUG] Additional document ${index + 1} passed validation`);
                            return true;
                        });

                        console.log(`ðŸ“‹ [DEBUG] Valid additional documents after filtering: ${validAdditionalDocuments.length} of ${additionalDocuments.length}`);

                        if (validAdditionalDocuments.length > 0) {
                            // Find the additional documents list element
                            const listElement = container.querySelector('#additional-list');

                            if (!listElement) {
                                console.error('âŒ [DEBUG] Additional documents list element not found');
                                resolve();
                                return;
                            }

                            validAdditionalDocuments.forEach((doc, index) => {
                                console.log(`ðŸ“„ [DEBUG] Processing additional document ${index + 1}:`, {
                                    fileName: doc.fileName,
                                    id: doc.id
                                });

                                // Create a unique identifier for this document
                                const uniqueId = `existing_${doc.id}`;

                                // Multiple comprehensive checks to prevent any possible duplicates
                                const duplicateChecks = [
                                    uploadedDocuments.find(document => document.id === uniqueId),
                                    uploadedDocuments.find(document => document.backendId === doc.id)
                                ];
                                // Note: For additional documents, we allow multiple files with the same name
                                // since users might upload different versions or related documents

                                // If ANY of the duplicate checks return a result, skip this document
                                const existingDocument = duplicateChecks.find(check => check !== undefined);

                                if (existingDocument) {
                                    console.log(`ðŸ“Œ [DEBUG] Additional document ${index + 1} already exists, skipping:`, {
                                        fileName: doc.fileName,
                                        backendId: doc.id,
                                        existingDocumentId: existingDocument.id,
                                        existingBackendId: existingDocument.backendId
                                    });
                                    return; // Skip this document as it's already in the array
                                }

                                // Add to uploadedDocuments array (no duplicates found)
                                const documentData = {
                                    id: uniqueId,
                                    name: doc.fileName,
                                    size: doc.fileSize || 0,
                                    type: doc.mimeType || 'application/pdf',
                                    uploadStatus: 'success',
                                    backendId: doc.id,
                                    fileUrl: doc.fileUrl,
                                    isExisting: true,
                                    uploadDate: new Date(doc.createdAt || Date.now()),
                                    sectionType: 'additional-documents'
                                };

                                // Validate the document data before adding
                                if (!documentData.name || !documentData.backendId) {
                                    console.error(`âŒ [DEBUG] Invalid additional document data for ${index + 1}, skipping:`, documentData);
                                    return;
                                }

                                uploadedDocuments.push(documentData);

                                // Create DOM element for existing document
                                const listItem = createExistingDocumentElement(documentData);
                                listElement.appendChild(listItem);

                                console.log(`âœ… [DEBUG] Added additional document ${index + 1}: ${doc.fileName}`);
                            });
                        } else {
                            console.log('ðŸ“‹ [DEBUG] No valid additional documents to display');
                        }

                        // THIRD: Clear duplicates again after adding all documents (safety check)
                        clearDuplicateDocuments();
                        console.log(`âœ… [DEBUG] displayExistingAdditionalDocuments completed. Total uploadedDocuments: ${uploadedDocuments.length}`);
                        resolve();

                    } catch (error) {
                        console.error('âŒ [DEBUG] displayExistingAdditionalDocuments error:', error);
                        resolve(); // Don't reject, just log and continue
                    }
                });
            }

            // Check for existing credentials when the page loads (Updated Version)
            async function checkExistingCredentials(container) {
                console.log('ðŸ” [DEBUG] Checking for existing credentials on page load...');

                const services = ['smartcredit', 'identityiq', 'myscoreiq', 'cfpb', 'annualcreditreport'];
                const userId = getUserId();
                const authToken = getAuthToken();

                if (!userId || !authToken) {
                    console.log('âš ï¸ [DEBUG] No authentication found, skipping credential check');
                    return;
                }

                // Call the status endpoint once to get all credential statuses
                try {
                    console.log('ðŸ” [DEBUG] Checking existing credentials for all services...');

                    const response = await fetch(`https://jam-capital-backend.azurewebsites.net/api/credentials/status`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    const result = await response.json();
                    console.log('ðŸ” [DEBUG] All credential check results:', result);

                    if (result.success) {
                        // Process each service
                        for (const service of services) {
                            if (result.data && result.data[service] && result.data[service].hasCredentials) {
                                console.log(`âœ… [DEBUG] Found existing ${service} credentials, showing status`);

                                // Create credential data object for showCredentialStatus
                                const credentialData = {
                                    email: result.data[service].email,
                                    updatedAt: result.data[service].lastUpdated,
                                    serviceType: service
                                };

                                // Show the credential status
                                showCredentialStatus(container, service, credentialData);
                            } else {
                                console.log(`â„¹ï¸ [DEBUG] No existing ${service} credentials found`);
                            }
                        }
                    } else {
                        console.log('âš ï¸ [DEBUG] Failed to get credential status:', result.message);
                    }

                } catch (error) {
                    console.error('âŒ [DEBUG] Error checking credentials:', error);
                    // Don't show error to user for credential checks on page load
                    // This is just background checking
                }

                console.log('âœ… [DEBUG] Finished checking existing credentials');
            }

            // Show credential status in the UI
            function showCredentialStatus(container, service, credentialData) {
                const statusDiv = container.querySelector(`#${service}-status`);
                const form = container.querySelector(`#${service}-access-form`);

                if (!statusDiv || !form) {
                    console.warn(`âš ï¸ [DEBUG] Could not find status elements for ${service}`);
                    return;
                }

                // Update status information
                const lastUpdatedSpan = statusDiv.querySelector(`#${service}-last-updated`);
                const currentEmailSpan = statusDiv.querySelector(`#${service}-current-email`);

                if (lastUpdatedSpan && credentialData.updatedAt) {
                    const lastUpdated = new Date(credentialData.updatedAt).toLocaleDateString();
                    lastUpdatedSpan.textContent = lastUpdated;
                }

                if (currentEmailSpan && credentialData.email) {
                    currentEmailSpan.textContent = credentialData.email;
                }

                // Show status, hide form initially
                statusDiv.style.display = 'block';
                form.style.display = 'none';

                // Set up update and remove button event listeners
                const updateBtn = statusDiv.querySelector(`#${service}-update-btn`);
                const removeBtn = statusDiv.querySelector(`#${service}-remove-btn`);

                if (updateBtn) {
                    updateBtn.addEventListener('click', () => showUpdateForm(container, service));
                }

                if (removeBtn) {
                    removeBtn.addEventListener('click', () => removeCredentials(container, service));
                }

                console.log(`âœ… [DEBUG] Credential status shown for ${service}`);
            }

            // Show the update form
            function showUpdateForm(container, service) {
                const statusDiv = container.querySelector(`#${service}-status`);
                const form = container.querySelector(`#${service}-access-form`);
                const updateWarning = container.querySelector(`#${service}-update-warning`);
                const submitBtn = container.querySelector(`#${service}-submit-btn`);
                const submitText = submitBtn.querySelector(`#${service}-submit-text`);
                const cancelBtn = container.querySelector(`#${service}-cancel-btn`);

                // Show form, hide status
                statusDiv.style.display = 'none';
                form.style.display = 'block';

                // Show update warning and cancel button
                if (updateWarning) updateWarning.style.display = 'flex';
                if (cancelBtn) cancelBtn.style.display = 'block';

                // Update submit button text
                if (submitText) {
                    const serviceNames = {
                        'smartcredit': 'SmartCredit',
                        'identityiq': 'IdentityIQ',
                        'myscoreiq': 'MyScoreIQ',
                        'cfpb': 'CFPB',
                        'annualcreditreport': 'AnnualCreditReport.com'
                    };
                    submitText.textContent = `Update ${serviceNames[service]} Credentials`;
                }

                // Set up cancel button
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', () => {
                        // Hide form, show status
                        form.style.display = 'none';
                        statusDiv.style.display = 'block';

                        // Hide update warning and cancel button
                        if (updateWarning) updateWarning.style.display = 'none';
                        if (cancelBtn) cancelBtn.style.display = 'none';

                        // Reset form
                        form.reset();

                        // Reset submit button text
                        if (submitText) {
                            submitText.textContent = `Provide ${serviceNames[service]} Access`;
                        }
                    });
                }

                console.log(`ðŸ”§ [DEBUG] Update form shown for ${service}`);
            }

            // Remove credentials
            async function removeCredentials(container, service) {
                const serviceNames = {
                    'smartcredit': 'SmartCredit',
                    'identityiq': 'IdentityIQ',
                    'myscoreiq': 'MyScoreIQ',
                    'cfpb': 'CFPB',
                    'annualcreditreport': 'AnnualCreditReport.com'
                };

                const serviceName = serviceNames[service];

                if (!confirm(`Are you sure you want to remove your ${serviceName} credentials?\n\nThis will delete your stored login information and you'll need to provide it again if you want to use this service.`)) {
                    return;
                }

                try {
                    const userId = getUserId();
                    const authToken = getAuthToken();

                    if (!userId || !authToken) {
                        throw new Error('Authentication required');
                    }

                    const response = await fetch(`https://jam-capital-backend.azurewebsites.net/api/credentials/delete`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ serviceType: service })
                    });

                    const result = await response.json();

                    if (result.success) {
                        // Hide status, show form
                        const statusDiv = container.querySelector(`#${service}-status`);
                        const form = container.querySelector(`#${service}-access-form`);

                        if (statusDiv) statusDiv.style.display = 'none';
                        if (form) form.style.display = 'block';

                        // Show success message
                        showCredentialMessage(container, service, 'success', `${serviceName} credentials removed successfully.`);

                        console.log(`âœ… [DEBUG] ${service} credentials removed successfully`);
                    } else {
                        throw new Error(result.message || 'Failed to remove credentials');
                    }

                } catch (error) {
                    console.error(`âŒ [DEBUG] Error removing ${service} credentials:`, error);
                    showCredentialMessage(container, service, 'error', `Failed to remove ${serviceName} credentials: ${error.message}`);
                }
            }

            // Show credential-related messages
            function showCredentialMessage(container, service, type, message) {
                const form = container.querySelector(`#${service}-access-form`);
                if (!form) return;

                // Remove any existing messages
                const existingMessage = form.querySelector('.credential-message');
                if (existingMessage) {
                    existingMessage.remove();
                }

                // Create new message
                const messageDiv = document.createElement('div');
                messageDiv.className = `credential-message ${type}`;
                messageDiv.style.cssText = `
                    padding: 12px;
                    border-radius: 6px;
                    margin-bottom: 15px;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    font-size: 0.9rem;
                    ${type === 'success' ?
                        'background: #d4edda; color: #155724; border: 1px solid #c3e6cb;' :
                        'background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;'}
                `;

                const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';
                messageDiv.innerHTML = `<i class="fas ${icon}"></i> ${message}`;

                // Insert at the beginning of the form
                form.insertBefore(messageDiv, form.firstChild);

                // Remove message after 5 seconds
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.remove();
                    }
                }, 5000);
            }



            // Public API
            return {
                init: init,
                reset: reset
            };
        })();

        // Expose the module globally
        window.jamDocumentUpload = DocumentUploadModule;

        // Add debugging for module loading
        console.log('ðŸš€ [DEBUG] DocumentUploadModule loaded and exposed globally');
        console.log('ðŸš€ [DEBUG] window.jamDocumentUpload:', window.jamDocumentUpload);

        // Signal that the module is loaded
        if (window.dispatchEvent) {
            window.dispatchEvent(new CustomEvent('documentUploadLoaded'));
            console.log('ðŸš€ [DEBUG] documentUploadLoaded event dispatched');
        }

        // Add debugging for initialization calls
        console.log('ðŸš€ [DEBUG] Current page location:', window.location.href);
        console.log('ðŸš€ [DEBUG] Document ready state:', document.readyState);

        // Check if we should auto-initialize
        if (document.readyState === 'loading') {
            console.log('ðŸš€ [DEBUG] Document still loading, waiting for DOMContentLoaded');
            document.addEventListener('DOMContentLoaded', function () {
                console.log('ðŸš€ [DEBUG] DOMContentLoaded fired, checking for auto-init containers');
                checkForAutoInit();
            });
        } else {
            console.log('ðŸš€ [DEBUG] Document already loaded, checking for auto-init containers now');
            checkForAutoInit();
        }

        function checkForAutoInit() {
            // Look for common container IDs that might need the document uploader
            const possibleContainerIds = [
                'document-uploader',
                'documents-container',
                'main-content',
                'content',
                'dashboard-content'
            ];

            possibleContainerIds.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (container) {
                    console.log(`ðŸš€ [DEBUG] Found potential container: ${containerId}`, container);
                    // You might want to auto-initialize here depending on your setup
                }
            });
        }

        // Update your initialization code (add this after the existing setup)
        document.addEventListener('DOMContentLoaded', async function () {
            // ... existing initialization code ...

            // Load existing documents from backend
            try {
                const existingDocuments = await fetchExistingDocuments();
                if (existingDocuments.length > 0) {
                    console.log(`ðŸ“‹ Loading ${existingDocuments.length} existing documents`);
                    displayExistingCreditReports(existingDocuments);
                }
            } catch (error) {
                console.error('âŒ Failed to load existing documents:', error);
            }
        });

        // Delete a document
        function deleteDocument(id) {
            // Remove from DOM
            const element = container.querySelector(`#${id}`);
            if (element) {
                element.remove();
            }

            // Remove from our array
            uploadedDocuments = uploadedDocuments.filter(doc => doc.id !== id);
        }

        // View a document
        function viewDocument(id) {
            const document = uploadedDocuments.find(doc => doc.id === id);
            if (!document) return;

            // For images, we can create a URL and open it
            if (document.file.type.includes('image')) {
                const url = URL.createObjectURL(document.file);
                window.open(url, '_blank');
            } else if (document.file.type.includes('pdf')) {
                // For PDFs, we can also use URL.createObjectURL
                const url = URL.createObjectURL(document.file);
                window.open(url, '_blank');
            } else {
                // For other file types, we might need to download them
                alert('Preview not available for this file type. Please download the file to view it.');
            }
        }

        // Reset function to allow reinitialization
        function reset() {
            isInitialized = false;
            container = null;
            uploadedDocuments = [];
            return true;
        }

        // Remove a document
    </script>
</body>

</html>