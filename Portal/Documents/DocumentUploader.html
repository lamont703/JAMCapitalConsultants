<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JAM Credit Solutions - Document Upload</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --primary: #008080;
            --primary-dark: #006666;
            --primary-light: #e6f7f7;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-600: #6c757d;
            --gray-800: #343a40;
            --gray-700: #6c757d;
            --gray-50: #f8f9fa;
            --primary-color: #007bff;
        }

        .document-upload-container {
            font-family: 'Montserrat', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .document-upload-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .document-upload-title {
            color: #09ccfc;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .document-upload-subtitle {
            color: #6c757d;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .document-section {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 30px;
        }

        .document-section-title {
            color: #09ccfc;
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e6f9ff;
        }

        .document-section-description {
            margin-bottom: 25px;
            line-height: 1.6;
            color: #6c757d;
        }

        .document-upload-area {
            border: 2px dashed #b3eafc;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            transition: background-color 0.3s;
            cursor: pointer;
        }

        .document-upload-area:hover {
            background-color: #e6f9ff;
        }

        .document-upload-icon {
            font-size: 3rem;
            color: #09ccfc;
            margin-bottom: 15px;
        }

        .document-upload-text {
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: #343a40;
        }

        .document-upload-subtext {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .document-list {
            margin-top: 30px;
        }

        .document-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .document-item:last-child {
            border-bottom: none;
        }

        .document-icon {
            font-size: 1.5rem;
            color: #09ccfc;
            margin-right: 15px;
        }

        .document-info {
            flex-grow: 1;
        }

        .document-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .document-meta {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .document-actions {
            display: flex;
        }

        .document-action-btn {
            background: none;
            border: none;
            color: #6c757d;
            font-size: 1rem;
            cursor: pointer;
            padding: 5px 10px;
            transition: color 0.2s;
        }

        .document-action-btn:hover {
            color: #09ccfc;
        }

        .document-action-btn.delete:hover {
            color: #dc3545;
        }

        .document-upload-btn {
            background-color: #09ccfc;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .document-upload-btn:hover {
            background-color: #07a3ca;
        }

        .document-upload-btn i {
            margin-right: 8px;
        }

        .document-upload-input {
            display: none;
        }

        .document-progress {
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            margin-top: 5px;
            overflow: hidden;
        }

        .document-progress-bar {
            height: 100%;
            background-color: #09ccfc;
            width: 0;
            transition: width 0.3s;
        }

        .document-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 10px;
        }

        .document-status.pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .document-status.success {
            background-color: #d4edda;
            color: #155724;
        }

        .document-status.error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .document-empty {
            text-align: center;
            padding: 30px;
            color: #6c757d;
        }

        .document-empty-icon {
            font-size: 3rem;
            color: #dee2e6;
            margin-bottom: 15px;
        }

        .document-empty-text {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .document-empty-subtext {
            font-size: 0.9rem;
        }

        /* SmartCredit Login Section */
        .smartcredit-login-section {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 30px;
        }

        .smartcredit-login-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .smartcredit-logo {
            max-width: 180px;
            margin-right: 20px;
        }

        .smartcredit-login-title {
            color: #09ccfc;
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .smartcredit-login-description {
            margin-bottom: 25px;
            line-height: 1.6;
            color: var(--gray-600);
        }

        .smartcredit-form {
            max-width: 600px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--gray-800);
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--gray-300);
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            border-color: var(--primary);
            outline: none;
        }

        .form-help {
            font-size: 0.85rem;
            color: var(--gray-600);
            margin-top: 5px;
        }

        .form-submit {
            background-color: #09ccfc;
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: block;
            margin: 30px auto 0;
        }

        .form-submit:hover {
            background-color: var(--primary-dark);
        }

        .form-note {
            text-align: center;
            font-size: 0.9rem;
            color: var(--gray-600);
            margin-top: 15px;
        }

        .form-divider {
            display: flex;
            align-items: center;
            margin: 30px 0;
        }

        .form-divider-line {
            flex-grow: 1;
            height: 1px;
            background-color: var(--gray-300);
        }

        .form-divider-text {
            padding: 0 15px;
            color: var(--gray-600);
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .document-section {
                padding: 20px;
            }

            .document-upload-area {
                padding: 20px;
            }

            .smartcredit-login-header {
                flex-direction: column;
                text-align: center;
            }

            .smartcredit-logo {
                margin-right: 0;
                margin-bottom: 15px;
            }
        }

        /* Add these styles to the existing <style> section */
        .document-item.upload-success {
            border-left: 4px solid var(--success);
        }

        .document-item.upload-error {
            border-left: 4px solid var(--danger);
        }

        .document-item.upload-progress {
            border-left: 4px solid var(--warning);
        }

        .document-item.upload-progress .document-meta {
            color: var(--warning);
        }

        .document-item.upload-error .document-meta {
            color: var(--danger);
        }

        .document-item.upload-success .document-meta {
            color: var(--success);
        }

        /* Bureau Selection Styles */
        .bureau-selection {
            margin-bottom: 20px;
            padding: 20px;
            background-color: var(--gray-100);
            border-radius: 8px;
            border: 2px solid var(--gray-200);
        }

        .bureau-selection-label {
            display: block;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .bureau-options {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .bureau-btn {
            flex: 1;
            min-width: 120px;
            padding: 15px 20px;
            border: 2px solid var(--gray-300);
            background-color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
            color: var(--gray-600);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .bureau-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 128, 128, 0.15);
        }

        .bureau-btn.selected {
            border-color: var(--primary);
            background-color: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 128, 128, 0.3);
        }

        .bureau-btn i {
            font-size: 1.5rem;
        }

        .bureau-hint {
            color: var(--gray-600);
            font-size: 0.9rem;
            margin: 0;
            text-align: center;
            font-style: italic;
        }

        /* Upload area disabled state */
        .document-upload-area[disabled] {
            opacity: 0.5;
            pointer-events: none;
        }

        /* Bureau button occupied state */
        .bureau-btn.occupied {
            background-color: #e8f5e8 !important;
            border: 2px solid #28a745 !important;
            cursor: not-allowed;
        }

        .bureau-btn.occupied:hover {
            background-color: #e8f5e8 !important;
        }

        .occupied-indicator {
            font-size: 12px;
            color: #28a745;
            font-weight: bold;
            margin-left: 5px;
        }

        /* Warning message styling */
        .bureau-limit-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        /* ID Type Selection Styling - Match Credit Bureau Style Exactly */
        .id-type-selection {
            margin-bottom: 20px;
        }

        .id-type-selection h4 {
            margin-bottom: 15px;
            color: var(--gray-700);
            font-size: 1rem;
            font-weight: 600;
        }

        .id-type-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .id-type-btn {
            flex: 1;
            min-width: 200px;
            padding: 15px 20px;
            border: 2px solid var(--gray-300);
            border-radius: 8px;
            background-color: var(--gray-50);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--gray-700);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .id-type-btn:hover {
            border-color: var(--primary-color);
            background-color: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
        }

        .id-type-btn.selected {
            border-color: var(--primary-color);
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .id-type-btn.occupied {
            background-color: #e8f5e8 !important;
            border: 2px solid #28a745 !important;
            cursor: not-allowed;
        }

        .id-type-btn.occupied:hover {
            background-color: #e8f5e8 !important;
            transform: none;
        }

        .id-type-hint {
            color: var(--gray-600);
            font-size: 0.9rem;
            margin: 0;
            text-align: center;
            font-style: italic;
        }

        .id-type-btn.selected .id-type-hint {
            color: rgba(255, 255, 255, 0.9);
        }

        .occupied-indicator {
            font-size: 12px;
            color: #28a745;
            font-weight: bold;
            margin-left: 5px;
        }

        /* Add hint text styling to match bureau hint */
        .id-type-selection .id-hint {
            color: var(--gray-600);
            font-size: 0.9rem;
            margin: 0;
            text-align: center;
            font-style: italic;
        }

        /* Responsive design for smaller screens */
        @media (max-width: 768px) {
            .id-type-buttons {
                flex-direction: column;
            }

            .id-type-btn {
                min-width: 100%;
            }
        }

        /* Update ID Verification section header to match Credit Reports */
        .document-section[data-section="id-verification"] .section-header h3 {
            color: #09ccfc;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .document-section[data-section="id-verification"] .section-header p {
            color: var(--gray-600);
            font-size: 0.95rem;
            margin: 0 0 20px 0;
            line-height: 1.5;
        }

        /* Make sure both sections have consistent styling */
        .document-section .section-header h3 {
            color: var(--gray-700);
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .document-section .section-header p {
            color: var(--gray-600);
            font-size: 0.95rem;
            margin: 0 0 20px 0;
            line-height: 1.5;
        }

        /* Ensure ID type selection header matches bureau selection */
        .id-type-selection h4 {
            color: var(--gray-700);
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 15px;
        }
    </style>
</head>

<body>
    <script>
        // Document Upload Module
        const DocumentUploadModule = (function () {
            // Private variables
            let isInitialized = false;
            let uploadedDocuments = [];
            let container = null; // Add container reference

            // Function to clean up corrupted localStorage entries
            function cleanupCorruptedEntries() {
                try {
                    console.log('🧹 Checking for corrupted localStorage entries in DocumentUploader...');

                    // Clean up any corrupted document entries
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith('jamDocuments') && key.includes('undefined')) {
                            console.log('🗑️ Removing corrupted document entry:', key);
                            localStorage.removeItem(key);
                        }
                    });

                } catch (error) {
                    console.error('❌ Error cleaning up corrupted entries:', error);
                }
            }

            // Function to clear duplicate documents from uploadedDocuments array
            function clearDuplicateDocuments() {
                if (uploadedDocuments.length === 0) {
                    console.log('🧹 No documents to clean, array is empty');
                    return;
                }

                console.log(`🧹 Cleaning duplicates from ${uploadedDocuments.length} documents`);

                const uniqueDocuments = [];
                const seenIdentifiers = new Set();

                uploadedDocuments.forEach((doc, index) => {
                    // Create multiple unique identifiers to catch all types of duplicates
                    const identifiers = [];

                    // Primary identifier based on document type
                    if (doc.isExisting) {
                        identifiers.push(`existing_${doc.backendId}`);
                        identifiers.push(`backend_${doc.backendId}`);
                    } else {
                        identifiers.push(`new_${doc.sectionType}_${doc.name}_${doc.size}`);
                        if (doc.backendId) {
                            identifiers.push(`backend_${doc.backendId}`);
                        }
                    }

                    // FIXED: More specific identifiers that include bureau/idType to prevent false positives
                    if (doc.sectionType === 'credit-report' && doc.bureau) {
                        // Bureau-specific identifiers (these should be unique per bureau)
                        identifiers.push(`credit-report_${doc.bureau}_${doc.name}_${doc.size}`);
                        identifiers.push(`bureau_${doc.bureau}_${doc.name}`);
                        // Only add generic identifier if it includes bureau info
                        identifiers.push(`${doc.sectionType}_${doc.bureau}_${doc.name}_${doc.size}`);
                    }

                    if (doc.sectionType === 'id-verification' && doc.idType) {
                        // ID type-specific identifiers (these should be unique per ID type)
                        identifiers.push(`id-verification_${doc.idType}_${doc.name}_${doc.size}`);
                        identifiers.push(`idtype_${doc.idType}_${doc.name}`);
                        // Only add generic identifier if it includes idType info
                        identifiers.push(`${doc.sectionType}_${doc.idType}_${doc.name}_${doc.size}`);
                    }

                    // REMOVED: Generic identifiers that don't include bureau/idType
                    // These were causing false positives:
                    // identifiers.push(`${doc.sectionType}_${doc.name}_${doc.size}`);

                    // Only add generic identifiers for documents that don't have bureau/idType
                    if (doc.sectionType !== 'credit-report' && doc.sectionType !== 'id-verification') {
                        // For additional documents, include backend ID to ensure uniqueness
                        if (doc.sectionType === 'additional-documents' && doc.backendId) {
                            identifiers.push(`${doc.sectionType}_${doc.backendId}_${doc.name}_${doc.size}`);
                        } else {
                            identifiers.push(`${doc.sectionType}_${doc.name}_${doc.size}`);
                        }
                    }

                    // Include ID-based identifiers (these are always unique)
                    if (doc.id) {
                        identifiers.push(`id_${doc.id}`);
                    }

                    // Check if ANY of the identifiers have been seen before
                    const isDuplicateByIdentifier = identifiers.some(id => seenIdentifiers.has(id));

                    // ENHANCED: More precise content-based duplicate checking
                    const isDuplicateByContent = uniqueDocuments.some(existingDoc => {
                        // Exact match criteria with better specificity
                        const exactMatch = (
                            existingDoc.name === doc.name &&
                            existingDoc.sectionType === doc.sectionType &&
                            existingDoc.size === doc.size &&
                            existingDoc.isExisting === doc.isExisting
                        );

                        // Backend ID match (if both have backend IDs and they match)
                        const backendIdMatch = (
                            existingDoc.backendId &&
                            doc.backendId &&
                            existingDoc.backendId === doc.backendId
                        );

                        // Credit report specific matching - MUST include bureau
                        const creditReportMatch = (
                            existingDoc.sectionType === 'credit-report' &&
                            doc.sectionType === 'credit-report' &&
                            existingDoc.bureau === doc.bureau &&  // Same bureau
                            existingDoc.name === doc.name &&
                            exactMatch  // Also require exact match
                        );

                        // ID verification specific matching - MUST include idType
                        const idVerificationMatch = (
                            existingDoc.sectionType === 'id-verification' &&
                            doc.sectionType === 'id-verification' &&
                            existingDoc.idType === doc.idType &&  // Same ID type
                            existingDoc.name === doc.name &&
                            exactMatch  // Also require exact match
                        );

                        // Only consider it a duplicate if it's an exact match OR 
                        // a backend ID match OR a specific type match with same bureau/idType
                        return backendIdMatch || creditReportMatch || idVerificationMatch;
                    });

                    if (!isDuplicateByIdentifier && !isDuplicateByContent) {
                        // Add all identifiers to the seen set
                        identifiers.forEach(id => seenIdentifiers.add(id));
                        uniqueDocuments.push(doc);

                        // Enhanced logging for debugging
                        const typeInfo = doc.bureau ? `(${doc.bureau})` : doc.idType ? `(${doc.idType})` : '';
                        console.log(`✅ Keeping document ${index + 1}: ${doc.name} (${doc.sectionType}) ${typeInfo} - IDs: [${identifiers.slice(0, 3).join(', ')}...]`);
                    } else {
                        const reason = isDuplicateByIdentifier ? 'Identifier match' : 'Content match';
                        const typeInfo = doc.bureau ? `(${doc.bureau})` : doc.idType ? `(${doc.idType})` : '';
                        console.log(`🗑️ Removing duplicate document ${index + 1}: ${doc.name} (${doc.sectionType}) ${typeInfo} - Reason: ${reason}`);
                    }
                });

                const removedCount = uploadedDocuments.length - uniqueDocuments.length;
                uploadedDocuments = uniqueDocuments;

                console.log(`🧹 Document cleanup complete: Removed ${removedCount} duplicates, ${uniqueDocuments.length} unique documents remaining`);
            }

            // Initialize the module
            function init(containerId) {
                console.log('Initializing Document Upload Module in container:', containerId);

                container = document.getElementById(containerId);
                if (!container) return false;

                // FIRST: Clean up any corrupted localStorage entries
                cleanupCorruptedEntries();

                // Check if this is a fresh page load or just a tab switch
                const pageLoadFlag = sessionStorage.getItem('jamDocumentUploaderPageLoaded');

                if (!pageLoadFlag) {
                    // This is a fresh page load (not just a tab switch)
                    console.log('Fresh page load detected, clearing uploaded documents');

                    // Clear the in-memory array completely on fresh page load
                    uploadedDocuments = [];

                    // Set the flag to indicate page has been loaded in this session
                    sessionStorage.setItem('jamDocumentUploaderPageLoaded', 'true');
                } else {
                    // This is a tab switch, clear any potential duplicates from the array
                    console.log('Tab switch detected, clearing duplicate documents from memory');
                    clearDuplicateDocuments();
                }

                // Check if container already has the HTML structure
                const existingContainer = container.querySelector('.document-upload-container');

                if (existingContainer && container._documentUploaderInitialized) {
                    console.log('Document Upload Module already initialized, refreshing content only');

                    // Clear duplicates and reload documents without clearing the entire structure
                    clearDuplicateDocuments();

                    // Only clear the document lists, not the entire container
                    clearDocumentLists();

                    // Reload existing documents with better timing
                    requestAnimationFrame(async () => {
                        // Ensure structure is still ready after clearing
                        const structureReady = container.querySelector('#credit-report-list') &&
                            container.querySelector('#id-verification-list');

                        if (structureReady) {
                            console.log('🏗️ [DEBUG] Existing structure confirmed ready, reloading documents...');
                            await reloadExistingDocuments();
                        } else {
                            console.warn('⚠️ [DEBUG] Existing structure not ready, retrying in 50ms...');
                            setTimeout(async () => {
                                await reloadExistingDocuments();
                            }, 50);
                        }
                    });

                    return true;
                }

                console.log(`Initializing Document Upload Module in container: ${containerId}`);

                // Clear the uploadedDocuments array to start fresh for this container
                uploadedDocuments = [];

                // Insert the widget HTML
                container.innerHTML = `
                    <div class="document-upload-container">
                        <div class="document-upload-header">
                            <h2 class="document-upload-title">Document Upload</h2>
                            <p class="document-upload-subtitle">
                                Please upload the required documents to help us with your credit repair process.
                            </p>
                        </div>
                        
                        <!-- Credit Report Upload Section -->
                        <div class="document-section">
                            <h3 class="document-section-title">Credit Reports</h3>
                            <p class="document-section-description">
                                Upload your credit reports from all three bureaus (Experian, Equifax, and TransUnion).
                                PDF format is preferred. Please select which bureau report you're uploading.
                            </p>
                            
                            <!-- Bureau Selection -->
                            <div class="bureau-selection" id="bureau-selection">
                                <label class="bureau-selection-label">Select Credit Bureau:</label>
                                <div class="bureau-options">
                                    <button type="button" class="bureau-btn" data-bureau="experian">
                                        <i class="fas fa-building"></i>
                                        Experian
                                    </button>
                                    <button type="button" class="bureau-btn" data-bureau="equifax">
                                        <i class="fas fa-shield-alt"></i>
                                        Equifax
                                    </button>
                                    <button type="button" class="bureau-btn" data-bureau="transunion">
                                        <i class="fas fa-chart-line"></i>
                                        TransUnion
                                    </button>
                                </div>
                                <p class="bureau-hint">Please select which credit bureau report you want to upload</p>
                            </div>
                            
                            <div class="document-upload-area" data-section="credit-report" id="credit-report-upload" style="opacity: 0.5; pointer-events: none;">
                                <i class="fas fa-file-upload document-upload-icon"></i>
                                <p class="document-upload-text">Select a credit bureau first, then drag & drop your credit report here</p>
                                <p class="document-upload-subtext">or click to browse files</p>
                                <input type="file" class="document-upload-input" id="credit-report-input" multiple accept=".pdf,.jpg,.jpeg,.png" disabled>
                            </div>
                            
                            <div class="document-list" id="credit-report-list">
                                <!-- Uploaded documents will appear here -->
                            </div>
                        </div>
                        
                        <!-- ID Verification Section -->
                        <div class="document-section" data-section="id-verification">
                            <div class="section-header">
                                <h3>📋 ID Verification</h3>
                                <p>Upload a valid government-issued ID and a utility bill with your current address</p>
                            </div>

                            <!-- ID Type Selection -->
                            <div class="id-type-selection">
                                <h4>Select Document Type:</h4>
                                <div class="id-type-buttons">
                                    <button type="button" class="id-type-btn" data-id-type="government-id">
                                        <i class="fas fa-id-card"></i>
                                        Government ID
                                        <p class="id-type-hint">Driver's License, Passport, State ID</p>
                                    </button>
                                    <button type="button" class="id-type-btn" data-id-type="utility-bill">
                                        <i class="fas fa-file-invoice"></i>
                                        Utility Bill
                                        <p class="id-type-hint">Electric, Gas, Water, Internet Bill</p>
                                    </button>
                                </div>
                                <p class="id-hint">Please select which type of document you want to upload</p>
                            </div>

                            <!-- Upload Area (initially disabled) -->
                            <div class="document-upload-area" id="id-verification-upload" style="opacity: 0.5; pointer-events: none;">
                                <div class="upload-icon">📁</div>
                                <div class="document-upload-text">Select a document type first</div>
                                <input type="file" id="id-verification-input" accept=".pdf,.jpg,.jpeg,.png" multiple disabled>
                            </div>

                            <!-- Uploaded Files List -->
                            <div class="uploaded-files-section">
                                <h4>Uploaded Documents:</h4>
                                <div class="uploaded-files-list" id="id-verification-list"></div>
                            </div>
                        </div>
                        
                        <!-- Additional Documents Section -->
                        <div class="document-section">
                            <h3 class="document-section-title">Additional Documents</h3>
                            <p class="document-section-description">
                                Upload any additional documents that may help with your credit repair process,
                                such as correspondence with creditors, payment receipts, or court documents.
                            </p>
                            
                            <div class="document-upload-area" data-section="additional-documents">
                                <i class="fas fa-file-alt document-upload-icon"></i>
                                <p class="document-upload-text">Drag & drop additional documents here</p>
                                <p class="document-upload-subtext">or click to browse files</p>
                                <input type="file" class="document-upload-input" id="additional-input" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                            </div>
                            
                            <div class="document-list" id="additional-list">
                                <!-- Uploaded documents will appear here -->
                            </div>
                        </div>

                        <!-- SmartCredit Access Section -->
                        <div class="document-section">
                            <h3 class="document-section-title">SmartCredit Access (Optional)</h3>
                            <p class="document-section-description">
                                If you have a SmartCredit account, you can provide your login information below.
                                This will allow us to access your credit reports directly and provide faster service.
                            </p>

                            <form id="smartcredit-access-form" class="smartcredit-form">
                                <div class="form-group">
                                    <label for="smartcredit-email">SmartCredit Email:</label>
                                    <input type="email" id="smartcredit-email" name="email" required>
                                </div>

                                <div class="form-group">
                                    <label for="smartcredit-password">SmartCredit Password:</label>
                                    <input type="password" id="smartcredit-password" name="password" required>
                                </div>

                                <button type="submit" class="submit-btn">
                                    <i class="fas fa-key"></i>
                                    Provide SmartCredit Access
                                </button>

                                <p class="form-note">
                                    If you prefer not to provide login access, you can download and upload your credit reports manually below.
                                </p>
                            </div>
                        </div>

                        <!-- IdentityIQ Access Section -->
                        <div class="document-section">
                            <h3 class="document-section-title">IdentityIQ Access (Optional)</h3>
                            <p class="document-section-description">
                                If you have an IdentityIQ account, you can provide your login information below.
                                This will allow us to access your credit monitoring and identity protection data to better assist with your credit repair process.
                            </p>

                            <form id="identityiq-access-form" class="smartcredit-form">
                                <div class="form-group">
                                    <label for="identityiq-email">IdentityIQ Email:</label>
                                    <input type="email" id="identityiq-email" name="email" required>
                                </div>

                                <div class="form-group">
                                    <label for="identityiq-password">IdentityIQ Password:</label>
                                    <input type="password" id="identityiq-password" name="password" required>
                                </div>

                                <button type="submit" class="submit-btn">
                                    <i class="fas fa-shield-alt"></i>
                                    Provide IdentityIQ Access
                                </button>

                                <p class="form-note">
                                    Your IdentityIQ login information will be used securely to enhance our credit repair analysis and monitoring capabilities.
                                </p>
                            </form>
                        </div>

                        <!-- MyScoreIQ Access Section -->
                        <div class="document-section">
                            <h3 class="document-section-title">MyScoreIQ Access (Optional)</h3>
                            <p class="document-section-description">
                                If you have a MyScoreIQ account, you can provide your login information below.
                                This will allow us to access your credit score tracking and analysis data to provide more comprehensive credit repair assistance.
                            </p>

                            <form id="myscoreiq-access-form" class="smartcredit-form">
                                <div class="form-group">
                                    <label for="myscoreiq-email">MyScoreIQ Email:</label>
                                    <input type="email" id="myscoreiq-email" name="email" required>
                                </div>

                                <div class="form-group">
                                    <label for="myscoreiq-password">MyScoreIQ Password:</label>
                                    <input type="password" id="myscoreiq-password" name="password" required>
                                </div>

                                <button type="submit" class="submit-btn">
                                    <i class="fas fa-chart-bar"></i>
                                    Provide MyScoreIQ Access
                                </button>

                                <p class="form-note">
                                    Your MyScoreIQ login information will be used securely to enhance our credit score analysis and tracking capabilities.
                                </p>
                            </form>
                        </div>
                    </div>
                `;

                // Set up event listeners and other initialization
                setupEventListeners(container);

                // Mark this container as initialized
                container._documentUploaderInitialized = true;

                // Load existing documents after initialization with better timing
                // Use requestAnimationFrame to ensure DOM is fully rendered
                requestAnimationFrame(async () => {
                    // Double check that the structure is ready
                    const structureReady = container.querySelector('#credit-report-list') &&
                        container.querySelector('#id-verification-list');

                    if (structureReady) {
                        console.log('🏗️ [DEBUG] DOM structure confirmed ready, loading documents...');
                        await reloadExistingDocuments();
                    } else {
                        console.warn('⚠️ [DEBUG] DOM structure not ready, retrying in 100ms...');
                        setTimeout(async () => {
                            await reloadExistingDocuments();
                        }, 100);
                    }
                });

                return true;
            }

            // New function to clear only document lists, not the entire structure
            function clearDocumentLists() {
                const creditReportList = container.querySelector('#credit-report-list');
                const idVerificationList = container.querySelector('#id-verification-list');
                const additionalList = container.querySelector('#additional-list');

                if (creditReportList) {
                    creditReportList.innerHTML = '';
                    console.log('🧹 Cleared credit report list');
                }

                if (idVerificationList) {
                    idVerificationList.innerHTML = '';
                    console.log('🧹 Cleared ID verification list');
                }

                if (additionalList) {
                    additionalList.innerHTML = '';
                    console.log('🧹 Cleared additional documents list');
                }

                // Reset button statuses
                const bureauButtons = container.querySelectorAll('.bureau-btn');
                const idTypeButtons = container.querySelectorAll('.id-type-btn');

                bureauButtons.forEach(button => {
                    button.classList.remove('occupied', 'selected');
                    const indicator = button.querySelector('.occupied-indicator');
                    if (indicator) indicator.remove();
                    button.style.backgroundColor = '';
                    button.style.border = '';
                });

                idTypeButtons.forEach(button => {
                    button.classList.remove('occupied', 'selected');
                    const indicator = button.querySelector('.occupied-indicator');
                    if (indicator) indicator.remove();
                    button.style.backgroundColor = '';
                    button.style.border = '';
                });

                console.log('🧹 Cleared document lists and reset button statuses');
            }

            // Section-specific clear functions to avoid clearing everything
            function clearCreditReportListOnly() {
                const creditReportList = container.querySelector('#credit-report-list');
                if (creditReportList) {
                    creditReportList.innerHTML = '';
                    console.log('🧹 Cleared credit report list only');
                }

                // Reset only bureau button statuses
                const bureauButtons = container.querySelectorAll('.bureau-btn');
                bureauButtons.forEach(button => {
                    button.classList.remove('occupied', 'selected');
                    const indicator = button.querySelector('.occupied-indicator');
                    if (indicator) indicator.remove();
                    button.style.backgroundColor = '';
                    button.style.border = '';
                });
            }

            function clearIdVerificationListOnly() {
                const idVerificationList = container.querySelector('#id-verification-list');
                if (idVerificationList) {
                    idVerificationList.innerHTML = '';
                    console.log('🧹 Cleared ID verification list only');
                }

                // Reset only ID type button statuses
                const idTypeButtons = container.querySelectorAll('.id-type-btn');
                idTypeButtons.forEach(button => {
                    button.classList.remove('occupied', 'selected');
                    const indicator = button.querySelector('.occupied-indicator');
                    if (indicator) indicator.remove();
                    button.style.backgroundColor = '';
                    button.style.border = '';
                });
            }

            function clearAdditionalDocumentsListOnly() {
                const additionalList = container.querySelector('#additional-list');
                if (additionalList) {
                    additionalList.innerHTML = '';
                    console.log('🧹 Cleared additional documents list only');
                }
            }

            // Clear existing DOM elements to prevent duplicates
            function clearExistingDOMElements() {
                // This function is now replaced by clearDocumentLists()
                clearDocumentLists();
            }

            // Fetch existing documents from backend
            async function fetchExistingDocuments() {
                try {
                    console.log('📥 [DEBUG] Starting fetchExistingDocuments...');

                    // Get user data and auth token
                    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                    const userId = userData.id;

                    // Try multiple token locations
                    const authToken = localStorage.getItem('authToken') ||
                        localStorage.getItem('token') ||
                        sessionStorage.getItem('authToken') ||
                        sessionStorage.getItem('token');

                    console.log('🔐 [DEBUG] Auth check:', {
                        userId: userId ? 'Found' : 'Missing',
                        authToken: authToken ? 'Found' : 'Missing',
                        userDataKeys: Object.keys(userData),
                        localStorageKeys: Object.keys(localStorage).filter(k => k.includes('token') || k.includes('auth')),
                        sessionStorageKeys: Object.keys(sessionStorage).filter(k => k.includes('token') || k.includes('auth'))
                    });

                    if (!userId || !authToken) {
                        console.warn('⚠️ [DEBUG] Missing authentication - userId:', !!userId, 'authToken:', !!authToken);
                        return [];
                    }

                    const url = `http://localhost:3000/api/admin/get-user-documents?userId=${userId}`;
                    console.log('🌐 [DEBUG] Making API call to:', url);

                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    console.log('📡 [DEBUG] API response status:', response.status, response.statusText);

                    if (!response.ok) {
                        const errorText = await response.text().catch(() => 'Unable to read error');
                        console.error('❌ [DEBUG] API error response:', {
                            status: response.status,
                            statusText: response.statusText,
                            errorText: errorText
                        });
                        throw new Error(`Failed to fetch documents: ${response.status} ${response.statusText}`);
                    }

                    const result = await response.json();
                    console.log('✅ [DEBUG] API response received:', {
                        documentsCount: result.documents ? result.documents.length : 0,
                        resultKeys: Object.keys(result),
                        documents: result.documents
                    });

                    // Validate response structure
                    if (!result.documents || !Array.isArray(result.documents)) {
                        console.warn('⚠️ [DEBUG] Invalid response structure:', result);
                        return [];
                    }

                    console.log('✅ [DEBUG] Returning', result.documents.length, 'documents');
                    return result.documents;

                } catch (error) {
                    console.error('❌ [DEBUG] fetchExistingDocuments error:', {
                        message: error.message,
                        stack: error.stack,
                        name: error.name
                    });
                    return [];
                }
            }

            // Enhanced reload function with retry logic and better debugging
            async function reloadExistingDocuments(retryCount = 0) {
                const MAX_RETRIES = 3;
                const RETRY_DELAY = 1000;

                try {
                    console.log(`🔄 [DEBUG] reloadExistingDocuments attempt ${retryCount + 1}/${MAX_RETRIES + 1}`);

                    // Check if container and structure exist
                    if (!container) {
                        console.error('❌ [DEBUG] Container not available');
                        return;
                    }

                    const containerStructure = container.querySelector('.document-upload-container');
                    if (!containerStructure) {
                        console.error('❌ [DEBUG] Container structure not available');
                        return;
                    }

                    console.log('✅ [DEBUG] Container structure validated');

                    // Clear duplicates before loading
                    const beforeClearCount = uploadedDocuments.length;
                    clearDuplicateDocuments();
                    console.log(`🧹 [DEBUG] Cleared duplicates: ${beforeClearCount} -> ${uploadedDocuments.length}`);

                    // Clear document lists if container structure exists
                    clearDocumentLists();
                    console.log('🧹 [DEBUG] Cleared document lists');

                    // Fetch documents with retry logic
                    console.log('📥 [DEBUG] Fetching existing documents...');
                    const existingDocuments = await fetchExistingDocuments();

                    console.log(`📋 [DEBUG] Fetched ${existingDocuments.length} total documents:`, {
                        creditReports: existingDocuments.filter(doc => doc.documentType === 'credit-report').length,
                        idVerification: existingDocuments.filter(doc => doc.documentType === 'id-verification').length,
                        additionalDocuments: existingDocuments.filter(doc => doc.documentType === 'additional-documents').length,
                        other: existingDocuments.filter(doc => !['credit-report', 'id-verification', 'additional-documents'].includes(doc.documentType)).length
                    });

                    if (existingDocuments.length > 0) {
                        console.log('📄 [DEBUG] Processing credit reports...');
                        await displayExistingCreditReports(existingDocuments);

                        console.log('📄 [DEBUG] Processing ID documents...');
                        await displayExistingIdDocuments(existingDocuments);

                        console.log('📄 [DEBUG] Processing additional documents...');
                        await displayExistingAdditionalDocuments(existingDocuments);

                        console.log(`✅ [DEBUG] Documents displayed successfully. Final uploadedDocuments count: ${uploadedDocuments.length}`);
                    } else {
                        console.log('📋 [DEBUG] No existing documents found to display');
                    }

                    // Clear duplicates after loading (safety check)
                    const afterLoadCount = uploadedDocuments.length;
                    clearDuplicateDocuments();
                    const finalCount = uploadedDocuments.length;

                    if (afterLoadCount !== finalCount) {
                        console.log(`🧹 [DEBUG] Post-load cleanup: ${afterLoadCount} -> ${finalCount}`);
                    }

                    console.log('✅ [DEBUG] reloadExistingDocuments completed successfully');

                } catch (error) {
                    console.error(`❌ [DEBUG] reloadExistingDocuments error (attempt ${retryCount + 1}):`, {
                        message: error.message,
                        stack: error.stack
                    });

                    // Retry logic
                    if (retryCount < MAX_RETRIES) {
                        console.log(`🔄 [DEBUG] Retrying in ${RETRY_DELAY}ms... (attempt ${retryCount + 2}/${MAX_RETRIES + 1})`);
                        setTimeout(() => {
                            reloadExistingDocuments(retryCount + 1);
                        }, RETRY_DELAY);
                    } else {
                        console.error('❌ [DEBUG] All retry attempts failed for reloadExistingDocuments');
                    }
                }
            }

            // Enhanced document display functions with better debugging
            function displayExistingCreditReports(documents) {
                return new Promise((resolve) => {
                    try {
                        const creditReports = documents.filter(doc => doc.documentType === 'credit-report');
                        console.log('📋 [DEBUG] displayExistingCreditReports - Processing', creditReports.length, 'credit reports');

                        if (creditReports.length === 0) {
                            console.log('📋 [DEBUG] No credit reports to display');
                            resolve();
                            return;
                        }

                        // FIRST: Clear any existing duplicates before processing new documents
                        const beforeClearCount = uploadedDocuments.length;
                        clearDuplicateDocuments();
                        console.log(`🧹 [DEBUG] Credit reports - cleared duplicates: ${beforeClearCount} -> ${uploadedDocuments.length}`);

                        // SECOND: Enhanced validation and filtering with detailed logging
                        const validCreditReports = creditReports.filter((doc, index) => {
                            console.log(`🔍 [DEBUG] Validating credit report ${index + 1}:`, {
                                fileName: doc.fileName,
                                bureau: doc.bureau,
                                id: doc.id,
                                documentType: doc.documentType
                            });

                            // Check if document has required fields
                            if (!doc.id || !doc.fileName) {
                                console.warn(`⚠️ [DEBUG] Credit report ${index + 1} missing required fields:`, {
                                    hasId: !!doc.id,
                                    hasFileName: !!doc.fileName,
                                    doc: doc
                                });
                                return false;
                            }

                            // Check if bureau is defined and valid
                            const validBureaus = ['experian', 'equifax', 'transunion'];
                            if (!doc.bureau || !validBureaus.includes(doc.bureau.toLowerCase())) {
                                console.warn(`⚠️ [DEBUG] Credit report ${index + 1} has invalid bureau:`, {
                                    fileName: doc.fileName,
                                    bureau: doc.bureau,
                                    validBureaus: validBureaus
                                });
                                return false;
                            }

                            // Check if fileName looks valid (not corrupted)
                            if (doc.fileName.includes('undefined') || doc.fileName.match(/^\d+-\d+-\d+/)) {
                                console.warn(`⚠️ [DEBUG] Credit report ${index + 1} has corrupted fileName:`, doc.fileName);
                                return false;
                            }

                            console.log(`✅ [DEBUG] Credit report ${index + 1} passed validation`);
                            return true;
                        });

                        console.log(`📋 [DEBUG] Valid credit reports after filtering: ${validCreditReports.length} of ${creditReports.length}`);

                        // Process each valid credit report
                        validCreditReports.forEach((report, index) => {
                            console.log(`📄 [DEBUG] Processing credit report ${index + 1}:`, {
                                fileName: report.fileName,
                                bureau: report.bureau,
                                id: report.id
                            });

                            const listElement = container.querySelector('#credit-report-list');
                            if (!listElement) {
                                console.error('❌ [DEBUG] Credit report list element not found');
                                return;
                            }

                            // Create unique identifier
                            const uniqueId = `existing_${report.id}`;

                            // Comprehensive duplicate checking with detailed logging
                            const duplicateChecks = [
                                uploadedDocuments.find(doc => doc.id === uniqueId),
                                uploadedDocuments.find(doc => doc.backendId === report.id),
                                uploadedDocuments.find(doc =>
                                    doc.isExisting &&
                                    doc.name === report.fileName &&
                                    doc.bureau === report.bureau &&
                                    doc.size === report.fileSize
                                ),
                                uploadedDocuments.find(doc =>
                                    doc.name === report.fileName &&
                                    doc.bureau === report.bureau &&
                                    doc.sectionType === 'credit-report'
                                )
                            ];

                            const existingDocument = duplicateChecks.find(check => check !== undefined);

                            if (existingDocument) {
                                console.log(`📌 [DEBUG] Credit report ${index + 1} already exists, skipping:`, {
                                    fileName: report.fileName,
                                    bureau: report.bureau,
                                    backendId: report.id,
                                    existingDocumentId: existingDocument.id,
                                    existingBackendId: existingDocument.backendId
                                });
                                return;
                            }

                            // Create document data
                            const documentData = {
                                id: uniqueId,
                                name: report.fileName,
                                size: report.fileSize || 0,
                                type: 'application/pdf',
                                uploadStatus: 'success',
                                backendId: report.id,
                                fileUrl: report.fileUrl,
                                isExisting: true,
                                bureau: report.bureau,
                                uploadDate: new Date(report.createdAt || Date.now()),
                                sectionType: 'credit-report'
                            };

                            // Final validation
                            if (!documentData.name || !documentData.bureau || !documentData.backendId) {
                                console.error(`❌ [DEBUG] Invalid credit report data for ${index + 1}, skipping:`, documentData);
                                return;
                            }

                            // Add to array and create DOM element
                            uploadedDocuments.push(documentData);
                            const listItem = createExistingDocumentElement(documentData);
                            listElement.appendChild(listItem);

                            console.log(`✅ [DEBUG] Added credit report ${index + 1}: ${report.fileName} (${report.bureau})`);

                            // Mark bureau as occupied
                            markBureauAsOccupied(report.bureau);
                        });

                        // Final cleanup and resolve
                        clearDuplicateDocuments();
                        console.log(`✅ [DEBUG] displayExistingCreditReports completed. Total uploadedDocuments: ${uploadedDocuments.length}`);
                        resolve();

                    } catch (error) {
                        console.error('❌ [DEBUG] displayExistingCreditReports error:', error);
                        resolve(); // Don't reject, just log and continue
                    }
                });
            }

            // Set up event listeners
            function setupEventListeners(container) {
                // SmartCredit form submission
                const smartCreditForm = container.querySelector('#smartcredit-access-form');
                if (smartCreditForm) {
                    smartCreditForm.addEventListener('submit', function (e) {
                        e.preventDefault();
                        const email = container.querySelector('#smartcredit-email').value;
                        const password = container.querySelector('#smartcredit-password').value;

                        // Here you would normally send this data securely to your backend
                        console.log('SmartCredit access submitted');

                        // Show success message
                        smartCreditForm.innerHTML = `
                            <div style="text-align: center; padding: 20px;">
                                <i class="fas fa-check-circle" style="font-size: 3rem; color: var(--success); margin-bottom: 15px;"></i>
                                <h3 style="color: var(--success); margin-bottom: 10px;">Access Information Received</h3>
                                <p>Thank you for providing your SmartCredit access. Our team will use this to help with your credit repair process.</p>
                            </div>
                        `;
                    });
                }

                // IdentityIQ form submission
                const identityIQForm = container.querySelector('#identityiq-access-form');
                if (identityIQForm) {
                    identityIQForm.addEventListener('submit', function (e) {
                        e.preventDefault();
                        const email = container.querySelector('#identityiq-email').value;
                        const password = container.querySelector('#identityiq-password').value;

                        // Here you would normally send this data securely to your backend
                        console.log('IdentityIQ access submitted');

                        // Show success message
                        identityIQForm.innerHTML = `
                            <div style="text-align: center; padding: 20px;">
                                <i class="fas fa-check-circle" style="font-size: 3rem; color: var(--success); margin-bottom: 15px;"></i>
                                <h3 style="color: var(--success); margin-bottom: 10px;">Access Information Received</h3>
                                <p>Thank you for providing your IdentityIQ access. Our team will use this to enhance your credit monitoring and repair process.</p>
                            </div>
                        `;
                    });
                }

                // MyScoreIQ form submission
                const myScoreIQForm = container.querySelector('#myscoreiq-access-form');
                if (myScoreIQForm) {
                    myScoreIQForm.addEventListener('submit', function (e) {
                        e.preventDefault();
                        const email = container.querySelector('#myscoreiq-email').value;
                        const password = container.querySelector('#myscoreiq-password').value;

                        // Here you would normally send this data securely to your backend
                        console.log('MyScoreIQ access submitted');

                        // Show success message
                        myScoreIQForm.innerHTML = `
                            <div style="text-align: center; padding: 20px;">
                                <i class="fas fa-check-circle" style="font-size: 3rem; color: var(--success); margin-bottom: 15px;"></i>
                                <h3 style="color: var(--success); margin-bottom: 10px;">Access Information Received</h3>
                                <p>Thank you for providing your MyScoreIQ access. Our team will use this to enhance our credit score analysis and tracking capabilities.</p>
                            </div>
                        `;
                    });
                }

                // Bureau selection for credit reports
                setupBureauSelection(container);

                // ID type selection for ID verification
                setupIdTypeSelection(container);

                // Credit report upload
                setupUploadArea(container, 'credit-report', 'credit-report-input', 'credit-report-list');

                // ID verification upload
                setupUploadArea(container, 'id-verification', 'id-verification-input', 'id-verification-list');

                // Additional documents upload
                setupUploadArea(container, 'additional-documents', 'additional-input', 'additional-list');
            }

            // Update the setupBureauSelection function to check for existing reports
            function setupBureauSelection(container) {
                const bureauButtons = container.querySelectorAll('.bureau-btn');
                const uploadArea = container.querySelector('#credit-report-upload');
                const uploadInput = container.querySelector('#credit-report-input');
                let selectedBureau = null;

                bureauButtons.forEach(button => {
                    button.addEventListener('click', function () {
                        const bureau = this.getAttribute('data-bureau');

                        // Check if this bureau already has a credit report
                        const existingReport = uploadedDocuments.find(doc =>
                            doc.sectionType === 'credit-report' &&
                            doc.bureau === bureau &&
                            doc.uploadStatus === 'success'
                        );

                        if (existingReport) {
                            // Show warning message
                            showBureauLimitWarning(bureau, existingReport.name);
                            return; // Don't allow selection
                        }

                        // Remove selected class from all buttons
                        bureauButtons.forEach(btn => btn.classList.remove('selected'));

                        // Add selected class to clicked button
                        this.classList.add('selected');

                        // Store selected bureau
                        selectedBureau = bureau;

                        // Enable upload area
                        uploadArea.style.opacity = '1';
                        uploadArea.style.pointerEvents = 'auto';
                        uploadInput.disabled = false;

                        // Update upload area text
                        const uploadText = uploadArea.querySelector('.document-upload-text');
                        const bureauName = this.textContent.trim();
                        uploadText.textContent = `Drag & drop your ${bureauName} credit report here`;

                        console.log(`Selected bureau: ${selectedBureau}`);
                    });
                });

                // Store the selected bureau for use in file upload
                container.setAttribute('data-selected-bureau', '');
            }

            // Show warning when trying to upload to a bureau that already has a report
            function showBureauLimitWarning(bureau, existingFileName) {
                const bureauNames = {
                    'experian': 'Experian',
                    'equifax': 'Equifax',
                    'transunion': 'TransUnion'
                };

                const bureauDisplay = bureauNames[bureau] || bureau;

                // Create warning modal or alert
                const warningMessage = `
                    You already have a ${bureauDisplay} credit report uploaded: "${existingFileName}"
                    
                    You can only have one credit report per bureau. Would you like to:
                    1. Keep the existing report
                    2. Delete the existing report and upload a new one
                `;

                if (confirm(warningMessage + '\n\nClick OK to delete the existing report and upload a new one, or Cancel to keep the existing report.')) {
                    // User wants to replace - find and delete the existing report
                    const existingReport = uploadedDocuments.find(doc =>
                        doc.sectionType === 'credit-report' &&
                        doc.bureau === bureau &&
                        doc.uploadStatus === 'success'
                    );

                    if (existingReport) {
                        console.log(`🔄 Replacing existing ${bureau} report:`, existingReport.name);
                        removeDocument(existingReport.id);

                        // After deletion, allow the bureau selection
                        setTimeout(() => {
                            const bureauButton = document.querySelector(`[data-bureau="${bureau}"]`);
                            if (bureauButton) {
                                bureauButton.click(); // Trigger the selection again
                            }
                        }, 500);
                    }
                }
            }

            // Set up upload area functionality
            function setupUploadArea(container, sectionType, inputId, listId) {
                const uploadArea = container.querySelector(`[data-section="${sectionType}"]`);
                const uploadInput = container.querySelector(`#${inputId}`);
                const documentList = container.querySelector(`#${listId}`);

                if (uploadArea && uploadInput && documentList) {
                    console.log(`Setting up upload area for: ${sectionType}`);

                    // Click on upload area to trigger file input
                    uploadArea.addEventListener('click', function () {
                        uploadInput.click();
                    });

                    // Handle file selection
                    uploadInput.addEventListener('change', function () {
                        handleFiles(this.files, documentList);
                    });

                    // Drag and drop functionality
                    uploadArea.addEventListener('dragover', function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        uploadArea.style.backgroundColor = 'var(--primary-light)';
                    });

                    uploadArea.addEventListener('dragleave', function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        uploadArea.style.backgroundColor = '';
                    });

                    uploadArea.addEventListener('drop', function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        uploadArea.style.backgroundColor = '';
                        handleFiles(e.dataTransfer.files, documentList);
                    });

                    console.log(`✅ Upload area setup complete for: ${sectionType}`);
                } else {
                    console.error(`❌ Failed to setup upload area for: ${sectionType}`, {
                        uploadArea: !!uploadArea,
                        uploadInput: !!uploadInput,
                        documentList: !!documentList
                    });
                }
            }

            // Handle uploaded files
            function handleFiles(files, listElement) {
                if (!files || !listElement) return;

                // Determine section type from the upload area
                const uploadArea = listElement.closest('.document-section').querySelector('.document-upload-area');
                const sectionType = getSectionType(uploadArea);

                // For credit reports, get the selected bureau
                let selectedBureau = null;
                if (sectionType === 'credit-report') {
                    const selectedBureauBtn = container.querySelector('.bureau-btn.selected');
                    if (selectedBureauBtn) {
                        selectedBureau = selectedBureauBtn.getAttribute('data-bureau');
                    }

                    if (!selectedBureau) {
                        alert('Please select a credit bureau before uploading your report.');
                        return;
                    }
                }

                // For ID verification, get the selected ID type
                let selectedIdType = null;
                if (sectionType === 'id-verification') {
                    const selectedIdTypeBtn = container.querySelector('.id-type-btn.selected');
                    if (selectedIdTypeBtn) {
                        selectedIdType = selectedIdTypeBtn.getAttribute('data-id-type');
                    }

                    if (!selectedIdType) {
                        alert('Please select a document type (Government ID or Utility Bill) before uploading.');
                        return;
                    }
                }

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];

                    // Create a unique ID for this file
                    const fileId = 'file-' + Date.now() + '-' + i;

                    // Add to our internal array
                    const documentData = {
                        id: fileId,
                        file: file,
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        uploadDate: new Date(),
                        sectionType: sectionType,
                        uploadStatus: 'pending'
                    };

                    // Add bureau info for credit reports
                    if (sectionType === 'credit-report' && selectedBureau) {
                        documentData.bureau = selectedBureau;
                    }

                    // Add ID type info for ID verification
                    if (sectionType === 'id-verification' && selectedIdType) {
                        documentData.idType = selectedIdType;
                    }

                    uploadedDocuments.push(documentData);

                    // Create list item with bureau info for credit reports
                    const listItem = document.createElement('div');
                    listItem.className = 'document-item';
                    listItem.id = fileId;

                    // Determine icon based on file type
                    let iconClass = 'fa-file';
                    if (file.type.includes('pdf')) {
                        iconClass = 'fa-file-pdf';
                    } else if (file.type.includes('image')) {
                        iconClass = 'fa-file-image';
                    } else if (file.type.includes('word')) {
                        iconClass = 'fa-file-word';
                    }

                    // Format file size
                    const fileSize = formatFileSize(file.size);

                    // Create display name with bureau info for credit reports
                    let displayName = file.name;
                    if (sectionType === 'credit-report' && selectedBureau) {
                        const bureauNames = {
                            'experian': 'Experian',
                            'equifax': 'Equifax',
                            'transunion': 'TransUnion'
                        };
                        displayName = `${bureauNames[selectedBureau]} - ${file.name}`;
                    }

                    // Add content to list item
                    listItem.innerHTML = `
                        <i class="fas ${iconClass} document-icon"></i>
                        <div class="document-info">
                            <div class="document-name">${displayName}</div>
                            <div class="document-meta">${fileSize} • Uploaded just now</div>
                        </div>
                        <div class="document-actions">
                            <button class="document-action-btn view" data-id="${fileId}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="document-action-btn delete" data-id="${fileId}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;

                    // Add to list
                    listElement.appendChild(listItem);

                    // Add event listeners for actions
                    const deleteBtn = listItem.querySelector('.delete');
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', function () {
                            const id = this.getAttribute('data-id');
                            removeDocument(id);
                        });
                    }

                    const viewBtn = listItem.querySelector('.view');
                    if (viewBtn) {
                        viewBtn.addEventListener('click', function () {
                            const id = this.getAttribute('data-id');
                            viewDocument(id);
                        });
                    }

                    // Upload to backend after DOM is ready
                    if (sectionType === 'credit-report' || sectionType === 'id-verification' || sectionType === 'additional-documents') {
                        // Show uploading status
                        updateDocumentStatus(fileId, 'uploading', 'Please wait...');

                        // Upload to backend with appropriate parameters
                        if (sectionType === 'credit-report') {
                            uploadToBackend(file, fileId, sectionType, selectedBureau, null);
                        } else if (sectionType === 'id-verification') {
                            uploadToBackend(file, fileId, sectionType, null, selectedIdType);
                        } else {
                            uploadToBackend(file, fileId, sectionType, null, null);
                        }
                    }
                }
            }

            // Upload to backend function (updated to include bureau info)
            async function uploadToBackend(file, fileId, sectionType, bureau = null, idType = null) {
                try {
                    console.log('🌐 Uploading to backend:', file.name, 'Section:', sectionType, 'Bureau:', bureau, 'ID Type:', idType);

                    // Get user data and auth token
                    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                    const userId = userData.id;
                    const authToken = localStorage.getItem('authToken') ||
                        localStorage.getItem('token') ||
                        sessionStorage.getItem('authToken') ||
                        sessionStorage.getItem('token');

                    if (!userId || !authToken) {
                        throw new Error('User authentication required');
                    }

                    // Create FormData for file upload
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('userId', userId);
                    formData.append('documentType', sectionType);
                    formData.append('fileName', file.name);

                    // Add bureau info for credit reports
                    if (sectionType === 'credit-report' && bureau) {
                        formData.append('bureau', bureau);
                    }

                    // Add ID type info for ID verification
                    if (sectionType === 'id-verification' && idType) {
                        formData.append('idType', idType);
                    }

                    // Upload to backend
                    const response = await fetch('http://localhost:3000/api/admin/upload-document', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: formData
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`Upload failed: ${errorData.message || response.statusText}`);
                    }

                    const result = await response.json();
                    console.log('✅ Upload successful:', result);

                    // Update the document item to show success
                    updateDocumentStatus(fileId, 'success', result);

                    return result;

                } catch (error) {
                    console.error('❌ Upload failed:', error);

                    // Update the document item to show error
                    updateDocumentStatus(fileId, 'error', error.message);

                    throw error;
                }
            }

            // Function to update document status in the UI (moved inside module)
            function updateDocumentStatus(fileId, status, data) {
                const documentItem = container.querySelector(`#${fileId}`);
                if (!documentItem) return;

                const metaElement = documentItem.querySelector('.document-meta');
                if (!metaElement) return;

                if (status === 'success') {
                    metaElement.innerHTML = `${formatFileSize(data.fileSize || 0)} • Uploaded successfully`;
                    documentItem.classList.add('upload-success');
                } else if (status === 'error') {
                    metaElement.innerHTML = `Upload failed • ${data}`;
                    documentItem.classList.add('upload-error');
                } else if (status === 'uploading') {
                    metaElement.innerHTML = `Uploading... • ${data}`;
                    documentItem.classList.add('upload-progress');
                }
            }

            // Function to determine section type from upload area (moved inside module)
            function getSectionType(uploadArea) {
                const section = uploadArea.getAttribute('data-section');
                if (section) return section;

                // Fallback: determine from parent elements
                const creditSection = uploadArea.closest('[data-section="credit-report"]');
                const idSection = uploadArea.closest('[data-section="id-verification"]');
                const additionalSection = uploadArea.closest('[data-section="additional-documents"]');

                if (creditSection) return 'credit-report';
                if (idSection) return 'id-verification';
                if (additionalSection) return 'additional-documents';

                return 'general'; // fallback
            }

            // Format file size
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';

                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));

                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            // Delete a document
            function removeDocument(id) {
                const docIndex = uploadedDocuments.findIndex(doc => doc.id === id);
                if (docIndex === -1) return;

                const document = uploadedDocuments[docIndex];
                console.log('🗑️ Removing document:', document.name, 'Type:', document.sectionType);

                // If this document was successfully uploaded to backend, delete it from database
                if (document.uploadStatus === 'success' && document.backendId) {
                    // Show confirmation dialog
                    if (!confirm(`Are you sure you want to delete "${document.name}"? This action cannot be undone.`)) {
                        return;
                    }

                    // Call backend to delete from database
                    deleteDocumentFromBackend(document.backendId, document.name)
                        .then(() => {
                            console.log('✅ Backend deletion successful, updating UI...');

                            // Remove from local array and DOM
                            uploadedDocuments = uploadedDocuments.filter(doc => doc.id !== id);

                            // FIXED: Use correct selector - elements are created with id, not data-file-id
                            const documentElement = container.querySelector(`#${id}`);
                            if (documentElement) {
                                documentElement.remove();
                                console.log('🗑️ Removed DOM element for:', document.name);
                            } else {
                                console.warn('⚠️ Could not find DOM element with id:', id);
                            }

                            // Handle section-specific refresh/cleanup using section-specific functions
                            if (document.sectionType === 'credit-report') {
                                console.log('🔄 Document was credit report, refreshing display (section-specific)...');
                                setTimeout(() => {
                                    refreshCreditReportDisplayOnly();
                                }, 100);
                            } else if (document.sectionType === 'id-verification') {
                                console.log('🔄 Document was ID verification, refreshing display (section-specific)...');
                                setTimeout(() => {
                                    refreshIdDocumentDisplayOnly();
                                }, 100);
                            } else if (document.sectionType === 'additional-documents') {
                                console.log('🔄 Document was additional document, refreshing display (section-specific)...');
                                setTimeout(() => {
                                    refreshAdditionalDocumentsDisplayOnly();
                                }, 100);
                            }

                            console.log('✅ Document deleted successfully');
                        })
                        .catch(error => {
                            console.error('❌ Failed to delete document:', error);
                            alert('Failed to delete document. Please try again.');
                        });
                } else {
                    // Document wasn't uploaded to backend yet, just remove locally
                    uploadedDocuments = uploadedDocuments.filter(doc => doc.id !== id);

                    // FIXED: Use correct selector for local documents too
                    const documentElement = container.querySelector(`#${id}`);
                    if (documentElement) {
                        documentElement.remove();
                        console.log('🗑️ Removed local DOM element for:', document.name);
                    }

                    // Handle section-specific refresh/cleanup for local documents using section-specific functions
                    if (document.sectionType === 'credit-report') {
                        setTimeout(() => {
                            refreshCreditReportDisplayOnly();
                        }, 100);
                    } else if (document.sectionType === 'id-verification') {
                        setTimeout(() => {
                            refreshIdDocumentDisplayOnly();
                        }, 100);
                    } else if (document.sectionType === 'additional-documents') {
                        setTimeout(() => {
                            refreshAdditionalDocumentsDisplayOnly();
                        }, 100);
                    }
                }
            }

            // Delete document from backend
            async function deleteDocumentFromBackend(documentId, fileName) {
                try {
                    console.log('🗑️ Deleting document from backend:', fileName);

                    // Get user data and auth token
                    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                    const userId = userData.id;
                    const authToken = localStorage.getItem('authToken') ||
                        localStorage.getItem('token') ||
                        sessionStorage.getItem('authToken') ||
                        sessionStorage.getItem('token');

                    if (!userId || !authToken) {
                        throw new Error('User authentication required');
                    }

                    const response = await fetch('http://localhost:3000/api/admin/delete-document', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            documentId: documentId,
                            userId: userId
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`Delete failed: ${errorData.message || response.statusText}`);
                    }

                    const result = await response.json();
                    console.log('✅ Document deleted from backend:', result);
                    return result;

                } catch (error) {
                    console.error('❌ Failed to delete document from backend:', error);
                    throw error;
                }
            }

            // Mark bureau button as occupied
            function markBureauAsOccupied(bureau) {
                const bureauButton = document.querySelector(`[data-bureau="${bureau}"]`);
                if (bureauButton) {
                    bureauButton.classList.add('occupied');
                    bureauButton.innerHTML += ' <span class="occupied-indicator">✅ Uploaded</span>';
                    bureauButton.style.backgroundColor = '#e8f5e8';
                    bureauButton.style.border = '2px solid #28a745';
                }
            }

            // Remove occupied status when document is deleted
            function removeBureauOccupiedStatus(bureau) {
                const bureauButton = document.querySelector(`[data-bureau="${bureau}"]`);
                if (bureauButton) {
                    bureauButton.classList.remove('occupied');
                    const indicator = bureauButton.querySelector('.occupied-indicator');
                    if (indicator) {
                        indicator.remove();
                    }
                    bureauButton.style.backgroundColor = '';
                    bureauButton.style.border = '';
                }
            }

            // Create DOM element for existing documents
            function createExistingDocumentElement(documentData) {
                const listItem = document.createElement('div');
                listItem.className = 'document-item existing-document';
                listItem.id = documentData.id;

                // Determine icon
                let iconClass = 'fa-file-pdf';
                if (documentData.type.includes('image')) {
                    iconClass = 'fa-file-image';
                } else if (documentData.type.includes('word')) {
                    iconClass = 'fa-file-word';
                } else if (documentData.type.includes('excel') || documentData.type.includes('spreadsheet')) {
                    iconClass = 'fa-file-excel';
                }

                // Format file size
                const fileSize = formatFileSize(documentData.size);

                // Format upload date
                const uploadDate = new Date(documentData.uploadDate).toLocaleDateString();

                // Create display name based on document type
                let displayName = documentData.name;

                if (documentData.sectionType === 'credit-report' && documentData.bureau) {
                    // Bureau display name for credit reports
                    const bureauNames = {
                        'experian': 'Experian',
                        'equifax': 'Equifax',
                        'transunion': 'TransUnion'
                    };
                    const bureauDisplay = bureauNames[documentData.bureau] || documentData.bureau;
                    displayName = `${bureauDisplay} - ${documentData.name}`;
                } else if (documentData.sectionType === 'id-verification' && documentData.idType) {
                    // ID type display name for ID verification
                    const idTypeNames = {
                        'government-id': 'Government ID',
                        'utility-bill': 'Utility Bill'
                    };
                    const idTypeDisplay = idTypeNames[documentData.idType] || documentData.idType;
                    displayName = `${idTypeDisplay} - ${documentData.name}`;
                }
                // For additional documents, just use the filename as-is

                listItem.innerHTML = `
                    <i class="fas ${iconClass} document-icon"></i>
                    <div class="document-info">
                        <div class="document-name">${displayName}</div>
                        <div class="document-meta">${fileSize} • ${uploadDate} • <span style="color: #28a745;">Saved</span></div>
                    </div>
                    <div class="document-actions">
                        <button class="document-action-btn view" data-id="${documentData.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="document-action-btn delete" data-id="${documentData.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;

                // Add event listeners
                const deleteBtn = listItem.querySelector('.delete');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', function () {
                        const id = this.getAttribute('data-id');
                        removeDocument(id);
                    });
                }

                const viewBtn = listItem.querySelector('.view');
                if (viewBtn) {
                    viewBtn.addEventListener('click', function () {
                        const id = this.getAttribute('data-id');
                        viewExistingDocument(documentData.fileUrl);
                    });
                }

                return listItem;
            }

            // View existing document
            function viewExistingDocument(fileUrl) {
                if (fileUrl) {
                    window.open(fileUrl, '_blank');
                } else {
                    alert('Document URL not available');
                }
            }

            // Updated refresh credit report display area
            function refreshCreditReportDisplay() {
                console.log('🔄 Refreshing credit report display...');

                // FIRST: Clear existing credit report displays using the new function
                clearDocumentLists();

                // SECOND: Remove ALL credit reports from uploadedDocuments array
                uploadedDocuments = uploadedDocuments.filter(doc => doc.sectionType !== 'credit-report');
                console.log('🧹 Cleared credit reports from uploadedDocuments array');

                // THIRD: Clear any potential duplicates from remaining documents
                clearDuplicateDocuments();

                // FOURTH: Re-fetch and display existing documents
                fetchExistingDocuments()
                    .then(documents => {
                        console.log('📋 Fetched documents for refresh:', documents.length);
                        const creditReports = documents.filter(doc => doc.documentType === 'credit-report');
                        console.log('📋 Credit reports found:', creditReports.length);

                        if (creditReports.length > 0) {
                            displayExistingCreditReports(documents);
                        } else {
                            console.log('📋 No credit reports to display after refresh');
                        }
                        console.log('✅ Credit report display refreshed');
                    })
                    .catch(error => {
                        console.error('❌ Failed to refresh credit report display:', error);
                    });
            }

            // Section-specific refresh functions that don't affect other sections
            function refreshCreditReportDisplayOnly() {
                console.log('🔄 Refreshing credit report display only...');

                // FIRST: Clear only credit report displays
                clearCreditReportListOnly();

                // SECOND: Remove only credit reports from uploadedDocuments array
                uploadedDocuments = uploadedDocuments.filter(doc => doc.sectionType !== 'credit-report');
                console.log('🧹 Cleared credit reports from uploadedDocuments array (section-specific)');

                // THIRD: Clear any potential duplicates from remaining documents
                clearDuplicateDocuments();

                // FOURTH: Re-fetch and display only credit report documents
                fetchExistingDocuments()
                    .then(documents => {
                        console.log('📋 Fetched documents for credit report refresh:', documents.length);
                        const creditReports = documents.filter(doc => doc.documentType === 'credit-report');
                        console.log('📋 Credit reports found:', creditReports.length);

                        if (creditReports.length > 0) {
                            displayExistingCreditReports(documents);
                        } else {
                            console.log('📋 No credit reports to display after section-specific refresh');
                        }
                        console.log('✅ Credit report display refreshed (section-specific)');
                    })
                    .catch(error => {
                        console.error('❌ Failed to refresh credit report display (section-specific):', error);
                    });
            }

            // Setup ID type selection for ID verification
            function setupIdTypeSelection(container) {
                const idTypeButtons = container.querySelectorAll('.id-type-btn');
                const uploadArea = container.querySelector('#id-verification-upload');
                const uploadInput = container.querySelector('#id-verification-input');
                let selectedIdType = null;

                idTypeButtons.forEach(button => {
                    button.addEventListener('click', function () {
                        const idType = this.getAttribute('data-id-type');

                        // Check if this ID type already has a document
                        const existingDocument = uploadedDocuments.find(doc =>
                            doc.sectionType === 'id-verification' &&
                            doc.idType === idType &&
                            doc.uploadStatus === 'success'
                        );

                        if (existingDocument) {
                            // Show warning message
                            showIdTypeLimitWarning(idType, existingDocument.name);
                            return; // Don't allow selection
                        }

                        // Remove selected class from all buttons
                        idTypeButtons.forEach(btn => btn.classList.remove('selected'));

                        // Add selected class to clicked button
                        this.classList.add('selected');

                        // Store selected ID type
                        selectedIdType = idType;

                        // Enable upload area
                        uploadArea.style.opacity = '1';
                        uploadArea.style.pointerEvents = 'auto';
                        uploadInput.disabled = false;

                        // Update upload area text
                        const uploadText = uploadArea.querySelector('.document-upload-text');
                        const uploadIcon = uploadArea.querySelector('.document-upload-icon');
                        const idTypeName = this.textContent.trim();

                        uploadText.textContent = `Drag & drop your ${idTypeName} here`;

                        // Update icon based on document type
                        if (idType === 'government-id') {
                            uploadIcon.className = 'fas fa-id-card document-upload-icon';
                        } else if (idType === 'utility-bill') {
                            uploadIcon.className = 'fas fa-file-invoice document-upload-icon';
                        }

                        console.log(`Selected ID type: ${selectedIdType}`);
                    });
                });

                // Store the selected ID type for use in file upload
                container.setAttribute('data-selected-id-type', '');

                // Return the selected type getter
                return () => selectedIdType;
            }

            // Show warning when trying to upload an ID type that already exists
            function showIdTypeLimitWarning(idType, existingFileName) {
                const idTypeNames = {
                    'government-id': 'Government ID',
                    'utility-bill': 'Utility Bill'
                };

                const idTypeDisplay = idTypeNames[idType] || idType;

                const warningMessage = `
                    You already have a ${idTypeDisplay} uploaded: "${existingFileName}"
                    
                    You can only have one document per type. Would you like to:
                    1. Keep the existing document
                    2. Delete the existing document and upload a new one
                `;

                if (confirm(warningMessage + '\n\nClick OK to delete the existing document and upload a new one, or Cancel to keep the existing document.')) {
                    // User wants to replace - find and delete the existing document
                    const existingDocument = uploadedDocuments.find(doc =>
                        doc.sectionType === 'id-verification' &&
                        doc.idType === idType &&
                        doc.uploadStatus === 'success'
                    );

                    if (existingDocument) {
                        console.log(`🔄 Replacing existing ${idType}:`, existingDocument.name);
                        removeDocument(existingDocument.id);
                    }
                }
            }

            // Mark ID type button as occupied
            function markIdTypeAsOccupied(idType) {
                const idTypeButton = document.querySelector(`[data-id-type="${idType}"]`);
                if (idTypeButton) {
                    idTypeButton.classList.add('occupied');
                    idTypeButton.innerHTML += ' <span class="occupied-indicator">✅ Uploaded</span>';
                    idTypeButton.style.backgroundColor = '#e8f5e8';
                    idTypeButton.style.border = '2px solid #28a745';
                }
            }

            // Remove occupied status when document is deleted
            function removeIdTypeOccupiedStatus(idType) {
                const idTypeButton = document.querySelector(`[data-id-type="${idType}"]`);
                if (idTypeButton) {
                    idTypeButton.classList.remove('occupied');
                    const indicator = idTypeButton.querySelector('.occupied-indicator');
                    if (indicator) {
                        indicator.remove();
                    }
                    idTypeButton.style.backgroundColor = '';
                    idTypeButton.style.border = '';
                }
            }

            // Display existing ID verification documents
            function displayExistingIdDocuments(documents) {
                return new Promise((resolve) => {
                    try {
                        const idDocuments = documents.filter(doc => doc.documentType === 'id-verification');
                        console.log('📋 [DEBUG] displayExistingIdDocuments - Processing', idDocuments.length, 'ID documents');

                        if (idDocuments.length === 0) {
                            console.log('📋 [DEBUG] No ID documents to display');
                            resolve();
                            return;
                        }

                        // FIRST: Clear any existing duplicates before processing new documents
                        const beforeClearCount = uploadedDocuments.filter(doc => doc.sectionType === 'id-verification').length;
                        clearDuplicateDocuments();
                        const afterClearCount = uploadedDocuments.filter(doc => doc.sectionType === 'id-verification').length;
                        console.log(`🧹 [DEBUG] ID documents - cleared duplicates: ${beforeClearCount} -> ${afterClearCount}`);

                        // SECOND: Enhanced validation and filtering with detailed logging
                        const validIdDocuments = idDocuments.filter((doc, index) => {
                            console.log(`🔍 [DEBUG] Validating ID document ${index + 1}:`, {
                                fileName: doc.fileName,
                                idType: doc.idType,
                                id: doc.id,
                                documentType: doc.documentType
                            });

                            // Check if document has required fields
                            if (!doc.id || !doc.fileName) {
                                console.warn(`⚠️ [DEBUG] ID document ${index + 1} missing required fields:`, {
                                    hasId: !!doc.id,
                                    hasFileName: !!doc.fileName,
                                    doc: doc
                                });
                                return false;
                            }

                            // Check if idType is defined and valid
                            const validIdTypes = ['government-id', 'utility-bill'];
                            if (!doc.idType || !validIdTypes.includes(doc.idType)) {
                                console.warn(`⚠️ [DEBUG] ID document ${index + 1} has invalid idType:`, {
                                    fileName: doc.fileName,
                                    idType: doc.idType,
                                    validIdTypes: validIdTypes
                                });
                                return false;
                            }

                            // Check if fileName looks valid (not corrupted)
                            if (doc.fileName.includes('undefined') || doc.fileName.match(/^\d+-\d+-\d+/)) {
                                console.warn(`⚠️ [DEBUG] ID document ${index + 1} has corrupted fileName:`, doc.fileName);
                                return false;
                            }

                            console.log(`✅ [DEBUG] ID document ${index + 1} passed validation`);
                            return true;
                        });

                        console.log(`📋 [DEBUG] Valid ID documents after filtering: ${validIdDocuments.length} of ${idDocuments.length}`);

                        if (validIdDocuments.length > 0) {
                            // Find the ID verification list element
                            const listElement = container.querySelector('#id-verification-list');

                            if (!listElement) {
                                console.error('❌ [DEBUG] ID verification list element not found');
                                resolve();
                                return;
                            }

                            validIdDocuments.forEach((doc, index) => {
                                console.log(`📄 [DEBUG] Processing ID document ${index + 1}:`, {
                                    fileName: doc.fileName,
                                    idType: doc.idType,
                                    id: doc.id
                                });

                                // Create a unique identifier for this document
                                const uniqueId = `existing_${doc.id}`;

                                // Multiple comprehensive checks to prevent any possible duplicates
                                const duplicateChecks = [
                                    uploadedDocuments.find(document => document.id === uniqueId),
                                    uploadedDocuments.find(document => document.backendId === doc.id)
                                ];
                                // Note: For additional documents, we allow multiple files with the same name
                                // since users might upload different versions or related documents

                                // If ANY of the duplicate checks return a result, skip this document
                                const existingDocument = duplicateChecks.find(check => check !== undefined);

                                if (existingDocument) {
                                    console.log(`📌 [DEBUG] ID document ${index + 1} already exists, skipping:`, {
                                        fileName: doc.fileName,
                                        idType: doc.idType,
                                        backendId: doc.id,
                                        existingDocumentId: existingDocument.id,
                                        existingBackendId: existingDocument.backendId
                                    });
                                    return; // Skip this document as it's already in the array
                                }

                                // Add to uploadedDocuments array (no duplicates found)
                                const documentData = {
                                    id: uniqueId,
                                    name: doc.fileName,
                                    size: doc.fileSize || 0,
                                    type: doc.mimeType || 'application/pdf',
                                    uploadStatus: 'success',
                                    backendId: doc.id,
                                    fileUrl: doc.fileUrl,
                                    isExisting: true,
                                    idType: doc.idType,
                                    uploadDate: new Date(doc.createdAt || Date.now()),
                                    sectionType: 'id-verification'
                                };

                                // Validate the document data before adding
                                if (!documentData.name || !documentData.idType || !documentData.backendId) {
                                    console.error(`❌ [DEBUG] Invalid ID document data for ${index + 1}, skipping:`, documentData);
                                    return;
                                }

                                uploadedDocuments.push(documentData);

                                // Create DOM element for existing document
                                const listItem = createExistingDocumentElement(documentData);
                                listElement.appendChild(listItem);

                                console.log(`✅ [DEBUG] Added ID document ${index + 1}: ${doc.fileName} (${doc.idType})`);
                            });

                            // Mark ID type buttons as occupied only if we have documents for those types
                            const idTypes = ['government-id', 'utility-bill'];
                            idTypes.forEach(idType => {
                                const idDocumentsForType = uploadedDocuments.filter(doc =>
                                    doc.sectionType === 'id-verification' &&
                                    doc.idType === idType &&
                                    (doc.uploadStatus === 'success' || doc.isExisting)
                                );

                                if (idDocumentsForType.length > 0) {
                                    console.log(`📌 [DEBUG] Marking ${idType} as occupied`);
                                    markIdTypeAsOccupied(idType);
                                }
                            });
                        } else {
                            console.log('📋 [DEBUG] No valid ID documents to display');
                        }

                        // THIRD: Clear duplicates again after adding all documents (safety check)
                        clearDuplicateDocuments();
                        console.log(`✅ [DEBUG] displayExistingIdDocuments completed. Total uploadedDocuments: ${uploadedDocuments.length}`);
                        resolve();

                    } catch (error) {
                        console.error('❌ [DEBUG] displayExistingIdDocuments error:', error);
                        resolve(); // Don't reject, just log and continue
                    }
                });
            }

            // Updated refresh function for ID documents
            function refreshIdDocumentDisplay() {
                console.log('🔄 Refreshing ID document display...');

                // FIRST: Clear existing ID document displays using the new function
                clearDocumentLists();

                // SECOND: Remove ALL ID verification documents from uploadedDocuments array
                uploadedDocuments = uploadedDocuments.filter(doc => doc.sectionType !== 'id-verification');
                console.log('🧹 Cleared ID documents from uploadedDocuments array');

                // THIRD: Clear any potential duplicates from remaining documents
                clearDuplicateDocuments();

                // FOURTH: Re-fetch and display existing documents
                fetchExistingDocuments()
                    .then(documents => {
                        console.log('📋 Fetched documents for ID refresh:', documents.length);
                        const idDocs = documents.filter(doc => doc.documentType === 'id-verification');
                        console.log('📋 ID documents found:', idDocs.length);

                        if (idDocs.length > 0) {
                            displayExistingIdDocuments(documents);
                        } else {
                            console.log('📋 No ID documents to display after refresh');
                        }
                        console.log('✅ ID document display refreshed');
                    })
                    .catch(error => {
                        console.error('❌ Failed to refresh ID document display:', error);
                    });
            }

            function refreshIdDocumentDisplayOnly() {
                console.log('🔄 Refreshing ID document display only...');

                // FIRST: Clear only ID verification displays
                clearIdVerificationListOnly();

                // SECOND: Remove only ID verification documents from uploadedDocuments array
                uploadedDocuments = uploadedDocuments.filter(doc => doc.sectionType !== 'id-verification');
                console.log('🧹 Cleared ID documents from uploadedDocuments array (section-specific)');

                // THIRD: Clear any potential duplicates from remaining documents
                clearDuplicateDocuments();

                // FOURTH: Re-fetch and display only ID verification documents
                fetchExistingDocuments()
                    .then(documents => {
                        console.log('📋 Fetched documents for ID refresh (section-specific):', documents.length);
                        const idDocs = documents.filter(doc => doc.documentType === 'id-verification');
                        console.log('📋 ID documents found:', idDocs.length);

                        if (idDocs.length > 0) {
                            displayExistingIdDocuments(documents);
                        } else {
                            console.log('📋 No ID documents to display after section-specific refresh');
                        }
                        console.log('✅ ID document display refreshed (section-specific)');
                    })
                    .catch(error => {
                        console.error('❌ Failed to refresh ID document display (section-specific):', error);
                    });
            }

            function refreshAdditionalDocumentsDisplayOnly() {
                console.log('🔄 Refreshing additional documents display only...');

                // FIRST: Clear only additional documents displays
                clearAdditionalDocumentsListOnly();

                // SECOND: Remove only additional documents from uploadedDocuments array
                uploadedDocuments = uploadedDocuments.filter(doc => doc.sectionType !== 'additional-documents');
                console.log('🧹 Cleared additional documents from uploadedDocuments array (section-specific)');

                // THIRD: Clear any potential duplicates from remaining documents
                clearDuplicateDocuments();

                // FOURTH: Re-fetch and display only additional documents
                fetchExistingDocuments()
                    .then(documents => {
                        console.log('📋 Fetched documents for additional docs refresh (section-specific):', documents.length);
                        const additionalDocs = documents.filter(doc => doc.documentType === 'additional-documents');
                        console.log('📋 Additional documents found:', additionalDocs.length);

                        if (additionalDocs.length > 0) {
                            displayExistingAdditionalDocuments(documents);
                        } else {
                            console.log('📋 No additional documents to display after section-specific refresh');
                        }
                        console.log('✅ Additional documents display refreshed (section-specific)');
                    })
                    .catch(error => {
                        console.error('❌ Failed to refresh additional documents display (section-specific):', error);
                    });
            }

            // Display existing additional documents
            function displayExistingAdditionalDocuments(documents) {
                return new Promise((resolve) => {
                    try {
                        const additionalDocuments = documents.filter(doc => doc.documentType === 'additional-documents');
                        console.log('📋 [DEBUG] displayExistingAdditionalDocuments - Processing', additionalDocuments.length, 'additional documents');

                        if (additionalDocuments.length === 0) {
                            console.log('📋 [DEBUG] No additional documents to display');
                            resolve();
                            return;
                        }

                        // FIRST: Clear any existing duplicates before processing new documents
                        const beforeClearCount = uploadedDocuments.filter(doc => doc.sectionType === 'additional-documents').length;
                        clearDuplicateDocuments();
                        const afterClearCount = uploadedDocuments.filter(doc => doc.sectionType === 'additional-documents').length;
                        console.log(`🧹 [DEBUG] Additional documents - cleared duplicates: ${beforeClearCount} -> ${afterClearCount}`);

                        // SECOND: Enhanced validation and filtering with detailed logging
                        const validAdditionalDocuments = additionalDocuments.filter((doc, index) => {
                            console.log(`🔍 [DEBUG] Validating additional document ${index + 1}:`, {
                                fileName: doc.fileName,
                                id: doc.id,
                                documentType: doc.documentType
                            });

                            // Check if document has required fields
                            if (!doc.id || !doc.fileName) {
                                console.warn(`⚠️ [DEBUG] Additional document ${index + 1} missing required fields:`, {
                                    hasId: !!doc.id,
                                    hasFileName: !!doc.fileName,
                                    doc: doc
                                });
                                return false;
                            }

                            // Check if fileName looks valid (not corrupted)
                            if (doc.fileName.includes('undefined') || doc.fileName.match(/^\d+-\d+-\d+/)) {
                                console.warn(`⚠️ [DEBUG] Additional document ${index + 1} has corrupted fileName:`, doc.fileName);
                                return false;
                            }

                            console.log(`✅ [DEBUG] Additional document ${index + 1} passed validation`);
                            return true;
                        });

                        console.log(`📋 [DEBUG] Valid additional documents after filtering: ${validAdditionalDocuments.length} of ${additionalDocuments.length}`);

                        if (validAdditionalDocuments.length > 0) {
                            // Find the additional documents list element
                            const listElement = container.querySelector('#additional-list');

                            if (!listElement) {
                                console.error('❌ [DEBUG] Additional documents list element not found');
                                resolve();
                                return;
                            }

                            validAdditionalDocuments.forEach((doc, index) => {
                                console.log(`📄 [DEBUG] Processing additional document ${index + 1}:`, {
                                    fileName: doc.fileName,
                                    id: doc.id
                                });

                                // Create a unique identifier for this document
                                const uniqueId = `existing_${doc.id}`;

                                // Multiple comprehensive checks to prevent any possible duplicates
                                const duplicateChecks = [
                                    uploadedDocuments.find(document => document.id === uniqueId),
                                    uploadedDocuments.find(document => document.backendId === doc.id)
                                ];
                                // Note: For additional documents, we allow multiple files with the same name
                                // since users might upload different versions or related documents

                                // If ANY of the duplicate checks return a result, skip this document
                                const existingDocument = duplicateChecks.find(check => check !== undefined);

                                if (existingDocument) {
                                    console.log(`📌 [DEBUG] Additional document ${index + 1} already exists, skipping:`, {
                                        fileName: doc.fileName,
                                        backendId: doc.id,
                                        existingDocumentId: existingDocument.id,
                                        existingBackendId: existingDocument.backendId
                                    });
                                    return; // Skip this document as it's already in the array
                                }

                                // Add to uploadedDocuments array (no duplicates found)
                                const documentData = {
                                    id: uniqueId,
                                    name: doc.fileName,
                                    size: doc.fileSize || 0,
                                    type: doc.mimeType || 'application/pdf',
                                    uploadStatus: 'success',
                                    backendId: doc.id,
                                    fileUrl: doc.fileUrl,
                                    isExisting: true,
                                    uploadDate: new Date(doc.createdAt || Date.now()),
                                    sectionType: 'additional-documents'
                                };

                                // Validate the document data before adding
                                if (!documentData.name || !documentData.backendId) {
                                    console.error(`❌ [DEBUG] Invalid additional document data for ${index + 1}, skipping:`, documentData);
                                    return;
                                }

                                uploadedDocuments.push(documentData);

                                // Create DOM element for existing document
                                const listItem = createExistingDocumentElement(documentData);
                                listElement.appendChild(listItem);

                                console.log(`✅ [DEBUG] Added additional document ${index + 1}: ${doc.fileName}`);
                            });
                        } else {
                            console.log('📋 [DEBUG] No valid additional documents to display');
                        }

                        // THIRD: Clear duplicates again after adding all documents (safety check)
                        clearDuplicateDocuments();
                        console.log(`✅ [DEBUG] displayExistingAdditionalDocuments completed. Total uploadedDocuments: ${uploadedDocuments.length}`);
                        resolve();

                    } catch (error) {
                        console.error('❌ [DEBUG] displayExistingAdditionalDocuments error:', error);
                        resolve(); // Don't reject, just log and continue
                    }
                });
            }

            // Public API
            return {
                init: init,
                reset: reset
            };
        })();

        // Expose the module globally
        window.jamDocumentUpload = DocumentUploadModule;

        // Signal that the module is loaded
        if (window.dispatchEvent) {
            window.dispatchEvent(new CustomEvent('documentUploadLoaded'));
        }

        // Update your initialization code (add this after the existing setup)
        document.addEventListener('DOMContentLoaded', async function () {
            // ... existing initialization code ...

            // Load existing documents from backend
            try {
                const existingDocuments = await fetchExistingDocuments();
                if (existingDocuments.length > 0) {
                    console.log(`📋 Loading ${existingDocuments.length} existing documents`);
                    displayExistingCreditReports(existingDocuments);
                }
            } catch (error) {
                console.error('❌ Failed to load existing documents:', error);
            }
        });

        // Delete a document
        function deleteDocument(id) {
            // Remove from DOM
            const element = container.querySelector(`#${id}`);
            if (element) {
                element.remove();
            }

            // Remove from our array
            uploadedDocuments = uploadedDocuments.filter(doc => doc.id !== id);
        }

        // View a document
        function viewDocument(id) {
            const document = uploadedDocuments.find(doc => doc.id === id);
            if (!document) return;

            // For images, we can create a URL and open it
            if (document.file.type.includes('image')) {
                const url = URL.createObjectURL(document.file);
                window.open(url, '_blank');
            } else if (document.file.type.includes('pdf')) {
                // For PDFs, we can also use URL.createObjectURL
                const url = URL.createObjectURL(document.file);
                window.open(url, '_blank');
            } else {
                // For other file types, we might need to download them
                alert('Preview not available for this file type. Please download the file to view it.');
            }
        }

        // Reset function to allow reinitialization
        function reset() {
            isInitialized = false;
            container = null;
            uploadedDocuments = [];
            return true;
        }

        // Remove a document
    </script>
</body>

</html>