<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JAM Credit Solutions - Manage Subscription</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: #f8f9fa;
            color: #343a40;
            line-height: 1.6;
            padding: 20px;
        }

        .subscription-manager {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .manager-header {
            background: linear-gradient(135deg, #09ccfc 0%, #08b5e0 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .manager-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .manager-subtitle {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .manager-content {
            padding: 2rem;
        }

        .subscription-overview {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .overview-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            border-left: 4px solid #09ccfc;
        }

        .overview-card.warning {
            border-left-color: #ffc107;
        }

        .overview-card.danger {
            border-left-color: #dc3545;
        }

        .overview-card.success {
            border-left-color: #28a745;
        }

        .overview-card h3 {
            color: #343a40;
            margin-bottom: 1rem;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
        }

        .overview-card h3 i {
            margin-right: 0.5rem;
            color: #09ccfc;
        }

        .plan-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .plan-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #09ccfc;
        }

        .plan-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: #28a745;
        }

        .plan-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .plan-status.active {
            background: #d4edda;
            color: #155724;
        }

        .plan-status.expired {
            background: #f8d7da;
            color: #721c24;
        }

        .plan-status.expiring {
            background: #fff3cd;
            color: #856404;
        }

        .usage-section {
            margin-bottom: 2rem;
        }

        .usage-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .usage-stat {
            text-align: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .usage-stat .value {
            font-size: 2rem;
            font-weight: 700;
            color: #09ccfc;
            margin-bottom: 0.5rem;
        }

        .usage-stat .label {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .usage-bar {
            background: #e9ecef;
            border-radius: 20px;
            height: 12px;
            margin: 1rem 0;
            overflow: hidden;
        }

        .usage-fill {
            background: linear-gradient(90deg, #28a745, #20c997);
            height: 100%;
            transition: width 0.3s ease;
        }

        .usage-fill.warning {
            background: linear-gradient(90deg, #ffc107, #ffcd39);
        }

        .usage-fill.danger {
            background: linear-gradient(90deg, #dc3545, #e55563);
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .action-btn {
            background: #09ccfc;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 1rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .action-btn:hover {
            background: #08b5e0;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(9, 204, 252, 0.3);
        }

        .action-btn.secondary {
            background: #6c757d;
        }

        .action-btn.secondary:hover {
            background: #545b62;
        }

        .action-btn.warning {
            background: #ffc107;
            color: #212529;
        }

        .action-btn.warning:hover {
            background: #e0a800;
        }

        .action-btn.danger {
            background: #dc3545;
        }

        .action-btn.danger:hover {
            background: #c82333;
        }



        .loading {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .loading i {
            font-size: 3rem;
            color: #09ccfc;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .error {
            text-align: center;
            padding: 3rem;
            color: #dc3545;
        }

        .error i {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
        }

        .modal-close:hover {
            color: #343a40;
        }

        @media (max-width: 768px) {
            .subscription-overview {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                grid-template-columns: 1fr;
            }

            .manager-content {
                padding: 1rem;
            }
        }

        /* Enhanced Mobile Optimization */
        @media (max-width: 575px) {
            body {
                padding: 10px;
                font-size: 14px;
            }

            .subscription-manager {
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            .manager-header {
                padding: 1.5rem 1rem;
                text-align: center;
            }

            .manager-title {
                font-size: 1.5rem;
                margin-bottom: 0.5rem;
            }

            .manager-subtitle {
                font-size: 1rem;
            }

            .manager-content {
                padding: 1rem;
            }

            .subscription-overview {
                grid-template-columns: 1fr;
                gap: 1rem;
                margin-bottom: 1.5rem;
            }

            .overview-card {
                padding: 1rem;
                border-radius: 6px;
            }

            .overview-card h3 {
                font-size: 1.1rem;
                margin-bottom: 0.75rem;
            }

            .plan-details {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
                margin-bottom: 0.75rem;
            }

            .plan-name {
                font-size: 1.1rem;
            }

            .plan-price {
                font-size: 1.3rem;
            }

            .plan-status {
                padding: 0.2rem 0.6rem;
                font-size: 0.75rem;
            }

            .usage-stats {
                grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
                gap: 0.75rem;
                margin-bottom: 1rem;
            }

            .usage-stat {
                padding: 0.75rem 0.5rem;
                border-radius: 6px;
            }

            .usage-stat .value {
                font-size: 1.5rem;
                margin-bottom: 0.25rem;
            }

            .usage-stat .label {
                font-size: 0.8rem;
            }

            .usage-bar {
                height: 10px;
                margin: 0.75rem 0;
            }

            .action-buttons {
                grid-template-columns: 1fr;
                gap: 0.75rem;
                margin-bottom: 1.5rem;
            }

            .action-btn {
                padding: 0.875rem 1rem;
                font-size: 0.9rem;
                border-radius: 6px;
                min-height: 48px;
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
            }

            .action-btn:active {
                transform: scale(0.98);
            }

            .loading {
                padding: 2rem 1rem;
            }

            .loading i {
                font-size: 2rem;
            }

            .error {
                padding: 2rem 1rem;
            }

            .error i {
                font-size: 2rem;
            }

            .modal-content {
                margin: 10px;
                padding: 1.5rem;
                width: calc(100% - 20px);
                max-width: none;
                border-radius: 8px;
            }

            .modal-header {
                margin-bottom: 1rem;
            }

            .modal-title {
                font-size: 1.3rem;
            }

            .modal-close {
                font-size: 1.3rem;
                padding: 0.25rem;
                min-width: 32px;
                min-height: 32px;
            }
        }

        /* Small Mobile Devices (≤480px) */
        @media (max-width: 480px) {
            body {
                padding: 5px;
                font-size: 13px;
            }

            .manager-header {
                padding: 1rem 0.75rem;
            }

            .manager-title {
                font-size: 1.4rem;
            }

            .manager-subtitle {
                font-size: 0.9rem;
            }

            .manager-content {
                padding: 0.75rem;
            }

            .overview-card {
                padding: 0.875rem;
            }

            .overview-card h3 {
                font-size: 1rem;
            }

            .plan-name {
                font-size: 1rem;
            }

            .plan-price {
                font-size: 1.2rem;
            }

            .usage-stats {
                grid-template-columns: repeat(3, 1fr);
                gap: 0.5rem;
            }

            .usage-stat {
                padding: 0.5rem 0.25rem;
            }

            .usage-stat .value {
                font-size: 1.3rem;
            }

            .usage-stat .label {
                font-size: 0.75rem;
            }

            .action-btn {
                padding: 0.75rem 0.875rem;
                font-size: 0.85rem;
                min-height: 44px;
            }

            .modal-content {
                margin: 5px;
                padding: 1rem;
                width: calc(100% - 10px);
            }

            .modal-title {
                font-size: 1.2rem;
            }

            /* Extra Small Device Feedback Options */
            .feedback-options .feedback-option label {
                padding: 0.5rem !important;
                min-height: 40px !important;
                font-size: 0.85rem !important;
            }

            .feedback-options .feedback-option input[type="radio"] {
                margin-right: 0.4rem !important;
                min-width: 12px !important;
                width: 12px !important;
                height: 12px !important;
            }

            .feedback-options .feedback-option span {
                font-size: 0.8rem !important;
                line-height: 1.25 !important;
            }

            #cancelFeedback {
                height: 60px !important;
                padding: 0.4rem !important;
                font-size: 0.85rem !important;
            }
        }

        /* Landscape Mobile Orientation */
        @media (max-width: 768px) and (orientation: landscape) {
            .subscription-overview {
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
            }

            .manager-header {
                padding: 1rem;
            }

            .manager-title {
                font-size: 1.4rem;
            }

            .manager-subtitle {
                font-size: 0.95rem;
            }

            .action-buttons {
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
            }

            .modal-content {
                margin: 5% auto;
                max-height: 80vh;
                overflow-y: auto;
            }
        }

        /* Touch Device Optimizations */
        @media (hover: none) and (pointer: coarse) {
            .action-btn {
                min-height: 48px;
                padding: 0.875rem 1rem;
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
            }

            .action-btn:hover {
                transform: none;
                box-shadow: 0 4px 12px rgba(9, 204, 252, 0.2);
            }

            .action-btn:active {
                transform: scale(0.98);
                transition: transform 0.1s ease;
            }

            .modal-close {
                min-width: 44px;
                min-height: 44px;
                padding: 0.5rem;
                touch-action: manipulation;
            }

            .plan-status {
                min-height: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }

        /* High DPI Display Support */
        @media (-webkit-min-device-pixel-ratio: 2),
        (min-resolution: 192dpi) {
            .subscription-manager {
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            }

            .overview-card {
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            }

            .action-btn {
                box-shadow: 0 2px 6px rgba(9, 204, 252, 0.15);
            }
        }

        /* iOS Safe Area Support */
        @supports (padding: max(0px)) {
            @media (max-width: 768px) {
                body {
                    padding-left: max(10px, env(safe-area-inset-left));
                    padding-right: max(10px, env(safe-area-inset-right));
                    padding-top: max(20px, env(safe-area-inset-top));
                    padding-bottom: max(20px, env(safe-area-inset-bottom));
                }
            }
        }

        /* Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {
            .action-btn {
                transition: none;
            }

            .action-btn:hover {
                transform: none;
            }

            .action-btn:active {
                transform: none;
            }

            @keyframes spin {
                from {
                    transform: rotate(0deg);
                }

                to {
                    transform: rotate(360deg);
                }
            }

            @keyframes slideIn {
                from {
                    opacity: 0;
                }

                to {
                    opacity: 1;
                }
            }
        }

        /* Advanced Modal Mobile Optimization */
        #advancedModal .modal-content {
            max-width: 95vw;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Feedback Options Mobile Optimization */
        .feedback-options .feedback-option label:hover {
            background: #e9ecef !important;
            border-color: #09ccfc !important;
        }

        .feedback-options .feedback-option input[type="radio"]:checked+span {
            color: #09ccfc;
            font-weight: 600;
        }

        .feedback-options .feedback-option input[type="radio"]:checked {
            accent-color: #09ccfc;
        }

        @media (max-width: 575px) {
            #advancedModal .modal-content {
                margin: 5px;
                padding: 1rem;
                width: calc(100vw - 10px);
                max-height: calc(100vh - 10px);
                border-radius: 8px;
            }

            #advancedModal .modal-header {
                margin-bottom: 1rem;
                padding-bottom: 0.5rem;
                border-bottom: 1px solid #e9ecef;
            }

            #advancedModal .modal-title {
                font-size: 1.2rem;
                margin: 0;
            }

            #advancedModal .modal-close {
                font-size: 1.5rem;
                min-width: 32px;
                min-height: 32px;
                padding: 0.25rem;
                background: #f8f9fa;
                border-radius: 50%;
                border: 1px solid #dee2e6;
            }

            #advancedModal .action-btn {
                width: 100%;
                margin: 0.25rem 0;
                padding: 0.75rem;
                font-size: 0.9rem;
            }

            /* Mobile Feedback Options Optimization */
            .feedback-options {
                margin: 0.75rem 0 !important;
            }

            .feedback-options .feedback-option {
                margin-bottom: 0.5rem !important;
            }

            .feedback-options .feedback-option label {
                padding: 0.625rem !important;
                min-height: 44px !important;
                font-size: 0.9rem !important;
                border-radius: 4px !important;
                margin: 0 !important;
                width: 100% !important;
                box-sizing: border-box !important;
                -webkit-tap-highlight-color: transparent !important;
                touch-action: manipulation !important;
            }

            .feedback-options .feedback-option input[type="radio"] {
                margin-right: 0.5rem !important;
                margin-top: 0.05rem !important;
                min-width: 14px !important;
                width: 14px !important;
                height: 14px !important;
                flex-shrink: 0 !important;
            }

            .feedback-options .feedback-option span {
                font-size: 0.85rem !important;
                line-height: 1.3 !important;
                word-break: break-word !important;
                overflow-wrap: break-word !important;
                -webkit-hyphens: auto !important;
                hyphens: auto !important;
                flex: 1 !important;
            }

            /* Mobile Textarea Optimization */
            #cancelFeedback {
                width: 100% !important;
                height: 70px !important;
                padding: 0.5rem !important;
                font-size: 0.9rem !important;
                border-radius: 4px !important;
                border: 1px solid #ddd !important;
                resize: vertical !important;
                box-sizing: border-box !important;
                -webkit-appearance: none !important;
                -moz-appearance: none !important;
                appearance: none !important;
            }
        }

        /* Notification Mobile Optimization */
        #simpleNotification {
            position: fixed !important;
            top: 10px !important;
            right: 10px !important;
            left: 10px !important;
            max-width: none !important;
            z-index: 1000001 !important;
        }

        @media (max-width: 575px) {
            #simpleNotification {
                top: 5px !important;
                right: 5px !important;
                left: 5px !important;
                padding: 0.875rem !important;
                border-radius: 6px !important;
                font-size: 0.9rem !important;
            }

            #simpleNotification strong {
                font-size: 1rem !important;
            }

            #simpleNotification p {
                font-size: 0.85rem !important;
                margin: 0.25rem 0 0 0 !important;
            }
        }
    </style>
</head>

<body>
    <div id="subscription-manager-container">
        <!-- Subscription Manager will be rendered here -->
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Confirm Action</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody">
                <p>Are you sure you want to perform this action?</p>
            </div>
            <div style="text-align: right; margin-top: 1.5rem;">
                <button class="action-btn secondary" onclick="closeModal()" style="margin-right: 1rem;">Cancel</button>
                <button class="action-btn" id="confirmBtn" onclick="confirmAction()">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // Create a module for the subscription management functionality
        const ManageSubscriptionModule = (function () {
            let isInitialized = false;
            let currentContainer = null;
            let subscriptionData = null;
            let pendingAction = null;

            // HTML template for the subscription manager
            const subscriptionManagerHTML = `
                <div class="subscription-manager">
                    <div class="manager-header">
                        <h1 class="manager-title">Manage Subscription</h1>
                        <p class="manager-subtitle">Control your credit dispute subscription</p>
                    </div>
                    
                    <div class="manager-content" id="manager-content">
                        <!-- Content will be populated by render function -->
                    </div>
                </div>
            `;

            // Initialize the module
            function init(containerIdOrElement) {
                console.log('🚀 Initializing ManageSubscriptionModule...');
                console.log('🚀 Container parameter:', containerIdOrElement);

                let container;

                // Handle both string ID and DOM element
                if (typeof containerIdOrElement === 'string') {
                    console.log('🚀 Container is string ID, finding element');
                    container = document.getElementById(containerIdOrElement);
                } else if (containerIdOrElement && containerIdOrElement.nodeType === 1) {
                    console.log('🚀 Container is DOM element, using directly');
                    container = containerIdOrElement;
                } else {
                    console.error('❌ Invalid container parameter:', containerIdOrElement);
                    return false;
                }

                if (!container) {
                    console.error('❌ Container not found');
                    return false;
                }

                console.log('✅ Container found:', container);
                currentContainer = container;

                // Clear any existing content
                container.innerHTML = '';

                // Show loading state initially
                showLoading();

                // Try to validate user session, but don't block free tier access
                const sessionValid = validateUserSession();
                if (!sessionValid) {
                    console.log('⚠️ User session not fully validated, but proceeding with free tier access');
                    // Still try to create free tier for users without full authentication
                }

                // Load data and render
                loadData()
                    .then(() => {
                        render();
                        setupEventListeners();
                        isInitialized = true;
                        console.log('✅ ManageSubscriptionModule initialized successfully');
                    })
                    .catch(error => {
                        console.error('❌ Error initializing module:', error);
                        showError(error.message);
                    });

                return true;
            }

            // Create a free tier subscription for new users
            async function createFreeTierSubscription() {
                try {
                    const currentUser = getCurrentUser();
                    const authToken = getAuthToken();

                    // If no auth token, create local free tier immediately
                    if (!authToken) {
                        console.log('🆓 No auth token - creating local free tier subscription');
                        return createLocalFreeTierSubscription();
                    }

                    if (!currentUser || !currentUser.email) {
                        console.log('🆓 No user information - creating local free tier subscription');
                        return createLocalFreeTierSubscription();
                    }

                    console.log('🆓 Creating Free Tier subscription for user:', currentUser.email);

                    const response = await fetch('https://jam-capital-backend.azurewebsites.net/api/subscriptions/create-free-tier', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json',
                            ...(currentUser?.email && { 'X-User-Email': currentUser.email }),
                            ...(currentUser?.id && { 'X-User-ID': currentUser.id })
                        },
                        body: JSON.stringify({
                            userEmail: currentUser.email,
                            userName: currentUser.name || currentUser.email,
                            userId: currentUser.id || null,
                            tier: 'free',
                            source: 'auto_enrollment'
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Failed to create free tier subscription: ${response.status}`);
                    }

                    const result = await response.json();

                    if (result.success) {
                        console.log('✅ Free Tier subscription created successfully:', result.data);
                        return result.data;
                    } else {
                        throw new Error(result.message || 'Failed to create free tier subscription');
                    }

                } catch (error) {
                    console.error('❌ Error creating Free Tier subscription:', error);

                    // If we can't create via API, create a minimal local free tier subscription
                    // This ensures the user always has some access
                    console.log('🔄 Creating fallback local Free Tier subscription...');

                    const currentUser = getCurrentUser();
                    const fallbackSubscription = {
                        tier: 'free',
                        isActive: true,
                        tierConfig: {
                            name: 'Free Plan',
                            price: 0,
                            monthlyCredits: 2, // 2 lifetime credits for free tier
                            features: [
                                'JAM Engine Credit Management Platform',
                                'Dispute Library (AI Prompts)',
                                '2 Free Dispute Letter Credits',
                                'JAM Dispute Bot Credit Analysis',
                                'JAM Dispute Bot Credit Educator',
                                'Secure Document Storage'
                            ]
                        },
                        remainingCredits: 2,
                        currentUsage: {
                            disputeLetters: 0
                        },
                        disputeLetterUsage: {
                            totalLettersGenerated: 0,
                            monthlyLettersUsed: 0,
                            monthlyLimit: 2,
                            monthlyRemaining: 2
                        },
                        canGenerateDispute: {
                            allowed: true,
                            reason: 'Free tier access'
                        },
                        subscriptionStartDate: new Date().toISOString(),
                        subscriptionEndDate: null, // Free tier never expires
                        daysUntilExpiration: null,
                        features: ['free_access', 'dispute_letters', 'credit_analysis'],
                        limits: {
                            monthlyDisputes: 2,
                            supportLevel: 'self_service'
                        },
                        userEmail: currentUser?.email,
                        userName: currentUser?.name || currentUser?.email,
                        userId: currentUser?.id
                    };

                    // Store the fallback subscription locally for this session
                    try {
                        sessionStorage.setItem('fallbackSubscription', JSON.stringify(fallbackSubscription));
                        console.log('💾 Fallback subscription stored locally');
                    } catch (storageError) {
                        console.warn('⚠️ Could not store fallback subscription locally:', storageError);
                    }

                    return fallbackSubscription;
                }
            }

            // Repair incomplete subscription data by filling in missing fields
            function repairSubscriptionData(data) {
                if (!data) return data;

                // Fix missing tierConfig
                if (!data.tierConfig) {
                    console.log('🔧 Repairing: Adding missing tierConfig');
                    data.tierConfig = {
                        name: data.tier === 'free' ? 'Free Plan' : `${data.tier.charAt(0).toUpperCase() + data.tier.slice(1)} Plan`,
                        price: data.tier === 'free' ? 0 : 29,
                        monthlyCredits: data.tier === 'free' ? 2 : 5,
                        features: ['JAM Engine Credit Management Platform', 'Dispute Letters', 'Credit Analysis']
                    };
                }

                // Fix missing tier name
                if (!data.tierConfig.name) {
                    console.log('🔧 Repairing: Adding missing tier name');
                    data.tierConfig.name = data.tier === 'free' ? 'Free Plan' : `${data.tier.charAt(0).toUpperCase() + data.tier.slice(1)} Plan`;
                }

                // Fix missing remaining credits
                if (data.remainingCredits === undefined || data.remainingCredits === null) {
                    console.log('🔧 Repairing: Adding missing remainingCredits');
                    data.remainingCredits = data.tierConfig.monthlyCredits || (data.tier === 'free' ? 2 : 5);
                }

                // Fix missing start date for paid tiers
                if (data.tier !== 'free' && data.isActive && !data.subscriptionStartDate) {
                    console.log('🔧 Repairing: Adding missing subscription start date');
                    data.subscriptionStartDate = new Date().toISOString();
                }

                return data;
            }

            // Validate if subscription data is complete and usable
            function isSubscriptionDataValid(data) {
                if (!data) {
                    console.log('❌ Subscription validation: No data provided');
                    return false;
                }

                // Check for required fields
                if (!data.tier) {
                    console.log('❌ Subscription validation: Missing tier');
                    return false;
                }

                if (data.isActive === undefined || data.isActive === null) {
                    console.log('❌ Subscription validation: Missing isActive status');
                    return false;
                }

                if (!data.tierConfig) {
                    console.log('⚠️ Subscription validation: Missing tierConfig, creating basic one');
                    // Auto-fix missing tierConfig instead of rejecting
                    data.tierConfig = {
                        name: data.tier === 'free' ? 'Free Plan' : `${data.tier.charAt(0).toUpperCase() + data.tier.slice(1)} Plan`,
                        price: data.tier === 'free' ? 0 : 29, // Default price for paid plans
                        monthlyCredits: data.tier === 'free' ? 2 : 5, // Default credits
                        features: ['JAM Engine Credit Management Platform', 'Dispute Letters', 'Credit Analysis']
                    };
                }

                if (!data.tierConfig.name) {
                    console.log('⚠️ Subscription validation: Missing tier name, auto-setting');
                    // Auto-fix missing tier name
                    data.tierConfig.name = data.tier === 'free' ? 'Free Plan' : `${data.tier.charAt(0).toUpperCase() + data.tier.slice(1)} Plan`;
                }

                // For free tier, ensure basic structure exists
                if (data.tier === 'free') {
                    if (data.remainingCredits === undefined || data.remainingCredits === null) {
                        console.log('⚠️ Subscription validation: Free tier missing remainingCredits, setting to 2');
                        data.remainingCredits = 2;
                    }
                } else {
                    // For paid tiers, ensure remaining credits exists
                    if (data.remainingCredits === undefined || data.remainingCredits === null) {
                        console.log('⚠️ Subscription validation: Paid tier missing remainingCredits, setting default');
                        data.remainingCredits = data.tierConfig.monthlyCredits || 5;
                    }
                }

                // For paid tiers, ensure they have proper subscription dates if active
                if (data.tier !== 'free' && data.isActive) {
                    if (!data.subscriptionStartDate) {
                        console.log('⚠️ Subscription validation: Active paid tier missing start date, auto-setting current date');
                        // Auto-fix missing start date instead of rejecting the subscription
                        data.subscriptionStartDate = new Date().toISOString();
                    }
                }

                console.log('✅ Subscription validation: Data is valid for tier:', data.tier);
                return true;
            }

            // Load subscription data for the current user
            async function loadData() {
                console.log('📊 Loading subscription data for current user...');

                try {
                    // Get current user info
                    const currentUser = getCurrentUser();
                    console.log('👤 Current user:', currentUser?.email || 'Unknown');

                    // Always ensure user has a subscription first
                    await ensureUserHasSubscriptionInternal();

                    // Get authentication token
                    const authToken = getAuthToken();

                    // If no auth token, skip backend and go straight to free tier
                    if (!authToken) {
                        console.log('🆓 No auth token available, creating free tier directly...');
                        throw new Error('No authentication - creating free tier');
                    }

                    // Try to load from backend API using auth manager
                    console.log('🔍 Attempting to load subscription from backend...');
                    if (!window.authManager) {
                        throw new Error('Auth manager not available');
                    }

                    const response = await window.authManager.authenticatedFetch('/api/subscriptions/dashboard', {
                        method: 'GET',
                        headers: {
                            // Include user identification if available
                            ...(currentUser?.email && { 'X-User-Email': currentUser.email }),
                            ...(currentUser?.id && { 'X-User-ID': currentUser.id })
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.data) {
                            // Repair any missing fields in the subscription data before validation
                            subscriptionData = repairSubscriptionData(result.data);
                            console.log('✅ Backend subscription data loaded successfully');
                            console.log('📊 Subscription tier:', subscriptionData.tierConfig?.name || 'Unknown');

                            // Validate that the subscription data is complete and active
                            if (!isSubscriptionDataValid(subscriptionData)) {
                                console.log('⚠️ Backend returned incomplete subscription data, creating free tier...');
                                throw new Error('Incomplete subscription data - creating free tier');
                            }

                            return;
                        } else {
                            console.log('⚠️ Backend response missing success or data, creating free tier...');
                            throw new Error('Backend response incomplete - creating free tier');
                        }
                    }

                    // If backend fails or returns no data, fall back to our guaranteed free tier
                    console.log('⚠️ Backend API unavailable or returned no data, using free tier fallback');
                    throw new Error('Backend subscription data unavailable');

                } catch (error) {
                    console.log('🔄 Backend error, ensuring free tier subscription:', error.message);

                    // Always ensure user has at least a free tier subscription
                    try {
                        await ensureUserHasSubscriptionInternal();
                        console.log('✅ Free tier subscription ensured after backend failure');
                    } catch (fallbackError) {
                        console.error('❌ Critical error: Could not ensure free tier subscription:', fallbackError);
                        throw new Error('Unable to initialize any subscription plan');
                    }
                }
            }

            // Internal method to ensure user has a subscription (always creates free tier if none exists)
            async function ensureUserHasSubscriptionInternal() {
                console.log('🔍 Ensuring user has subscription (internal)...');

                // Check if we already have VALID subscription data loaded
                if (subscriptionData && isSubscriptionDataValid(subscriptionData)) {
                    console.log('✅ User already has valid subscription:', subscriptionData.tier);
                    return subscriptionData;
                }

                // If we have subscription data but it's invalid, clear it
                if (subscriptionData && !isSubscriptionDataValid(subscriptionData)) {
                    console.log('🗑️ Clearing invalid subscription data:', subscriptionData);
                    subscriptionData = null;
                }

                // Check for locally stored fallback subscription
                try {
                    const fallbackSubscription = sessionStorage.getItem('fallbackSubscription');
                    if (fallbackSubscription) {
                        const parsed = JSON.parse(fallbackSubscription);
                        if (parsed.tier && parsed.isActive) {
                            subscriptionData = parsed;
                            console.log('✅ Using stored fallback subscription:', parsed.tier);
                            return subscriptionData;
                        }
                    }
                } catch (storageError) {
                    console.warn('⚠️ Could not load stored subscription:', storageError);
                }

                // Try to create via API first
                try {
                    console.log('🆓 Attempting to create Free Tier via API...');
                    const createdSubscription = await createFreeTierSubscription();
                    if (createdSubscription && createdSubscription.tier) {
                        subscriptionData = createdSubscription;
                        console.log('✅ Free Tier created via API successfully');
                        return subscriptionData;
                    }
                } catch (apiError) {
                    console.log('⚠️ API creation failed, using local fallback:', apiError.message);
                }

                // Create local fallback subscription as last resort
                console.log('🆓 Creating local fallback Free Tier subscription...');
                subscriptionData = createLocalFreeTierSubscription();
                console.log('✅ Local Free Tier subscription created');
                return subscriptionData;
            }

            // Create a local free tier subscription (always works)
            function createLocalFreeTierSubscription() {
                const currentUser = getCurrentUser();
                const fallbackSubscription = {
                    tier: 'free',
                    isActive: true,
                    tierConfig: {
                        name: 'Free Plan',
                        price: 0,
                        monthlyCredits: 2, // 2 lifetime credits for free tier
                        features: [
                            'JAM Engine Credit Management Platform',
                            'Dispute Library (AI Prompts)',
                            '2 Free Dispute Letter Credits (Lifetime)',
                            'JAM Dispute Bot Credit Analysis',
                            'JAM Dispute Bot Credit Educator',
                            'Secure Document Storage'
                        ]
                    },
                    remainingCredits: 2,
                    currentUsage: {
                        disputeLetters: 0
                    },
                    disputeLetterUsage: {
                        totalLettersGenerated: 0,
                        monthlyLettersUsed: 0,
                        monthlyLimit: 2,
                        monthlyRemaining: 2
                    },
                    canGenerateDispute: {
                        allowed: true,
                        reason: 'Free tier access - 2 lifetime credits available'
                    },
                    subscriptionStartDate: new Date().toISOString(),
                    subscriptionEndDate: null, // Free tier never expires
                    daysUntilExpiration: null,
                    features: ['free_access', 'dispute_letters', 'credit_analysis'],
                    limits: {
                        monthlyDisputes: 2,
                        supportLevel: 'self_service'
                    },
                    userEmail: currentUser?.email || 'unknown@user.com',
                    userName: currentUser?.name || currentUser?.email || 'JAM User',
                    userId: currentUser?.id || 'local_user',
                    source: 'local_fallback'
                };

                // Store the fallback subscription locally
                try {
                    sessionStorage.setItem('fallbackSubscription', JSON.stringify(fallbackSubscription));
                    console.log('💾 Local fallback subscription stored in session');
                } catch (storageError) {
                    console.warn('⚠️ Could not store fallback subscription locally:', storageError);
                }

                return fallbackSubscription;
            }



            // Get authentication token using centralized auth manager
            function getAuthToken() {
                // Use centralized auth manager if available
                if (window.authManager) {
                    const token = window.authManager.getAuthToken();
                    if (token) {
                        console.log('🔑 Using auth token from auth manager');
                        return token;
                    }
                }

                // Fallback to direct localStorage access for backwards compatibility
                const authToken = localStorage.getItem('authToken') ||
                    sessionStorage.getItem('authToken') ||
                    localStorage.getItem('userToken') ||
                    sessionStorage.getItem('userToken');

                if (!authToken) {
                    console.warn('⚠️ No authentication token found - user may not be logged in, using guest access');
                    return null; // Return null instead of throwing error
                }

                console.log('🔑 Using auth token from localStorage fallback');
                return authToken;
            }

            // Get current user data from localStorage/sessionStorage
            function getCurrentUser() {
                try {
                    const userData = localStorage.getItem('userData') || sessionStorage.getItem('userData');
                    if (userData) {
                        return JSON.parse(userData);
                    }

                    // Fallback - try individual user properties
                    const userEmail = localStorage.getItem('userEmail') || sessionStorage.getItem('userEmail');
                    const userName = localStorage.getItem('userName') || sessionStorage.getItem('userName');
                    const userId = localStorage.getItem('userId') || sessionStorage.getItem('userId');

                    if (userEmail || userName || userId) {
                        return {
                            email: userEmail,
                            name: userName,
                            id: userId
                        };
                    }
                } catch (error) {
                    console.error('Error parsing user data:', error);
                }

                // Create a guest user for free tier access
                console.log('🆓 No user data found, creating guest user for free tier');
                return {
                    email: 'guest@jamcreditsolutions.com',
                    name: 'Guest User',
                    id: 'guest_' + Date.now()
                };
            }

            // Validate that user is properly logged in
            function validateUserSession() {
                try {
                    const authToken = localStorage.getItem('authToken') ||
                        sessionStorage.getItem('authToken') ||
                        localStorage.getItem('userToken') ||
                        sessionStorage.getItem('userToken');

                    const currentUser = getCurrentUser();

                    if (!authToken) {
                        console.warn('⚠️ No authentication token found');
                        return false;
                    }

                    if (!currentUser || !currentUser.email) {
                        console.warn('⚠️ No valid user data found');
                        return false;
                    }

                    console.log('✅ User session validated for:', currentUser.email);
                    return true;
                } catch (error) {
                    console.error('❌ Error validating user session:', error);
                    return false;
                }
            }

            // Show loading state
            function showLoading() {
                if (!currentContainer) return;

                currentContainer.innerHTML = `
                    <div class="subscription-manager">
                        <div class="manager-header">
                            <h1 class="manager-title">Manage Subscription</h1>
                            <p class="manager-subtitle">Loading your subscription information...</p>
                        </div>
                        <div class="loading">
                            <i class="fas fa-spinner"></i>
                            <p>Loading...</p>
                        </div>
                    </div>
                `;
            }

            // Show error state
            function showError(message) {
                if (!currentContainer) return;

                currentContainer.innerHTML = `
                    <div class="subscription-manager">
                        <div class="manager-header">
                            <h1 class="manager-title">Manage Subscription</h1>
                            <p class="manager-subtitle">Unable to load subscription information</p>
                        </div>
                        <div class="error">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>${message}</p>
                            <button onclick="window.jamSubscriptionManager.refresh()" class="action-btn" style="margin-top: 1rem;">
                                <i class="fas fa-redo"></i> Try Again
                            </button>
                        </div>
                    </div>
                `;
            }

            // Render the subscription manager
            function render() {
                if (!subscriptionData || !currentContainer) {
                    console.error('❌ Cannot render: missing subscriptionData or container');
                    return;
                }

                console.log('🎨 Rendering subscription manager with data:', subscriptionData);

                // Safely extract data with fallbacks
                const tierName = subscriptionData.tierConfig?.name || 'No Active Plan';
                const isActive = subscriptionData.isActive || false;
                const remainingCredits = subscriptionData.remainingCredits || 0;
                const currentUsage = subscriptionData.currentUsage?.disputeLetters || 0;
                const monthlyLimit = subscriptionData.tierConfig?.monthlyCredits || 0;
                const tierPrice = subscriptionData.tierConfig?.price || 0;

                // Determine if this is a free tier early for usage calculations
                const isFreeTier = subscriptionData?.tier === 'free';

                // Extract dispute letter usage data
                const disputeLetterUsage = subscriptionData.disputeLetterUsage || {};
                const totalLettersGenerated = disputeLetterUsage.totalLettersGenerated || 0;
                const monthlyLettersUsed = disputeLetterUsage.monthlyLettersUsed || 0;
                const monthlyLetterLimit = disputeLetterUsage.monthlyLimit || 0;

                // Calculate monthly remaining - use the backend calculation primarily
                let monthlyLettersRemaining = disputeLetterUsage.monthlyRemaining || 0;

                // For free tier, calculate remaining based on lifetime usage
                if (isFreeTier) {
                    // Free tier gets 2 lifetime credits total
                    const freeTrialLifetimeLimit = 2;
                    monthlyLettersRemaining = Math.max(0, freeTrialLifetimeLimit - totalLettersGenerated);

                    console.log(`🆓 Free tier calculation:`, {
                        lifetimeLimit: freeTrialLifetimeLimit,
                        totalGenerated: totalLettersGenerated,
                        remaining: monthlyLettersRemaining,
                        backendRemainingCredits: remainingCredits
                    });
                } else {
                    // For paid tiers, trust the backend calculation but verify it makes sense
                    const calculatedRemaining = Math.max(0, monthlyLetterLimit - monthlyLettersUsed);

                    // Use backend calculation first, but ensure it's not negative
                    monthlyLettersRemaining = Math.max(0, disputeLetterUsage.monthlyRemaining || calculatedRemaining);

                    // Debug logging for paid tiers
                    console.log(`🔍 Paid tier monthly calculation for ${subscriptionData.tier}:`, {
                        monthlyLimit: monthlyLetterLimit,
                        monthlyUsed: monthlyLettersUsed,
                        backendRemaining: disputeLetterUsage.monthlyRemaining,
                        calculatedRemaining: calculatedRemaining,
                        finalRemaining: monthlyLettersRemaining,
                        remainingCredits: remainingCredits
                    });
                }

                console.log('✅ isFreeTier resolved successfully:', isFreeTier);
                console.log('📊 Subscription Usage Breakdown:', {
                    tier: subscriptionData.tier,
                    isFreeTier: isFreeTier,
                    totalGenerated: totalLettersGenerated,
                    monthlyUsed: monthlyLettersUsed,
                    monthlyLimit: monthlyLetterLimit,
                    monthlyRemaining: monthlyLettersRemaining,
                    remainingCredits: remainingCredits,
                    backendCalculation: disputeLetterUsage.monthlyRemaining
                });

                // Ensure payment history is an array
                if (!Array.isArray(subscriptionData.paymentHistory)) {
                    console.warn('⚠️ paymentHistory is not an array in render, fixing...');
                    subscriptionData.paymentHistory = [];
                }

                // Calculate usage percentage
                let usagePercentage = 0;
                let usageClass = '';
                if (monthlyLimit > 0) {
                    usagePercentage = (currentUsage / monthlyLimit) * 100;
                    if (usagePercentage >= 90) usageClass = 'danger';
                    else if (usagePercentage >= 70) usageClass = 'warning';
                }

                // Determine subscription status
                const daysRemaining = subscriptionData.daysUntilExpiration;
                let statusClass = 'active';
                let statusText = 'Active';

                if (!isActive) {
                    statusClass = 'expired';
                    statusText = 'Expired';
                } else if (!isFreeTier && daysRemaining !== null && daysRemaining <= 7) {
                    statusClass = 'expiring';
                    statusText = 'Expiring Soon';
                } else if (isFreeTier) {
                    statusText = 'Lifetime Access';
                }

                // Format renewal date display
                let renewalDateDisplay = '';
                if (isActive && !isFreeTier && subscriptionData.subscriptionEndDate) {
                    renewalDateDisplay = `<p style="margin-top: 0.5rem; color: #6c757d;">Renews on ${new Date(subscriptionData.subscriptionEndDate).toLocaleDateString()}</p>`;
                } else if (isFreeTier) {
                    renewalDateDisplay = `<p style="margin-top: 0.5rem; color: #6c757d;">No expiration date</p>`;
                }

                currentContainer.innerHTML = `
                    <div class="subscription-manager">
                        <div class="manager-header">
                            <h1 class="manager-title">Manage Subscription</h1>
                            <p class="manager-subtitle">Control your credit dispute subscription</p>
                        </div>
                        
                        <div class="manager-content">
                            <!-- Subscription Overview -->
                            <div class="subscription-overview">
                                <div class="overview-card ${getCardClass(statusClass)}">
                                    <h3><i class="fas fa-credit-card"></i>Current Plan</h3>
                                    <div class="plan-details">
                                        <div class="plan-name">${tierName}</div>
                                        <div class="plan-price">$${tierPrice}/mo</div>
                                    </div>
                                    <div class="plan-status ${statusClass}">${statusText}</div>
                                    ${renewalDateDisplay}
                                </div>
                                
                                <div class="overview-card">
                                    <h3><i class="fas fa-chart-line"></i>Dispute Letter Usage</h3>
                                    <div class="usage-stats">
                                        <div class="usage-stat">
                                            <div class="value">${totalLettersGenerated}</div>
                                            <div class="label">Total Generated</div>
                                        </div>
                                        <div class="usage-stat">
                                            <div class="value">${monthlyLettersUsed}</div>
                                            <div class="label">${isFreeTier ? 'Lifetime Used' : 'Monthly Used'}</div>
                                        </div>
                                        <div class="usage-stat">
                                            <div class="value">${monthlyLettersRemaining}</div>
                                            <div class="label">${isFreeTier ? 'Remaining' : 'Monthly Remaining'}</div>
                                    </div>
                                    </div>
                                    ${monthlyLetterLimit > 0 ? `
                                        <div class="usage-bar">
                                            <div class="usage-fill ${usageClass}" style="width: ${Math.min((monthlyLettersUsed / monthlyLetterLimit) * 100, 100)}%"></div>
                                        </div>
                                        <p style="text-align: center; color: #6c757d; font-size: 0.9rem;">${((monthlyLettersUsed / monthlyLetterLimit) * 100).toFixed(1)}% of ${isFreeTier ? 'lifetime' : 'monthly'} limit used</p>
                                    ` : ''}
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="action-buttons">
                                ${isFreeTier ? `
                                    <button class="action-btn" id="upgrade-subscription-btn">
                                        <i class="fas fa-arrow-up"></i> Upgrade to Paid Plan
                                    </button>
                                ` : `
                                    <button class="action-btn" id="upgrade-subscription-btn">
                                        <i class="fas fa-arrow-up"></i> Upgrade Plan
                                    </button>
                                `}
                                
                                ${isActive ? `
                                    <button class="action-btn danger" id="cancel-subscription-btn">
                                        <i class="fas fa-times"></i> Cancel Subscription
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            // Setup event listeners
            function setupEventListeners() {
                console.log('🔧 Setting up ManageSubscriptionModule event listeners');

                if (!currentContainer) {
                    console.error('❌ No container reference available for setupEventListeners');
                    return;
                }

                // Upgrade subscription button
                const upgradeBtn = currentContainer.querySelector('#upgrade-subscription-btn');
                if (upgradeBtn) {
                    upgradeBtn.addEventListener('click', upgradeSubscription);
                }

                // Cancel subscription button
                const cancelBtn = currentContainer.querySelector('#cancel-subscription-btn');
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', cancelSubscription);
                }

                console.log('✅ All event listeners set up successfully');
            }

            // Helper function to get card class
            function getCardClass(status) {
                switch (status) {
                    case 'expired': return 'danger';
                    case 'expiring': return 'warning';
                    case 'active': return 'success';
                    default: return '';
                }
            }

            // Enhanced Action methods with strategic implementation
            function upgradeSubscription() {
                console.log('💳 Upgrade subscription clicked');
                const isFreeTier = subscriptionData?.tier === 'free';
                const currentTier = subscriptionData?.tier || 'unknown';
                const currentUser = getCurrentUser();

                // Context-aware upgrade routing
                if (isFreeTier) {
                    showUpgradeOptionsModal('free_tier_upgrade');
                } else {
                    showUpgradeOptionsModal('tier_upgrade', currentTier);
                }
            }

            function showUpgradeOptionsModal(upgradeType, currentTier = null) {
                const isFreeTier = upgradeType === 'free_tier_upgrade';
                const currentUser = getCurrentUser();

                let title = isFreeTier ? 'Unlock Premium Features' : 'Upgrade Your Plan';
                let message = isFreeTier
                    ? 'Ready to supercharge your credit dispute journey? Upgrade to access unlimited dispute letters, priority support, and advanced features.'
                    : `Upgrade from your current ${currentTier} plan to access more features and credits.`;

                const modalContent = `
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <i class="fas fa-rocket" style="font-size: 3rem; color: #09ccfc; margin-bottom: 1rem;"></i>
                        <p style="font-size: 1.1rem; color: #343a40; margin-bottom: 1rem;">${message}</p>
                        
                        ${isFreeTier ? `
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0; text-align: left;">
                                <h4 style="margin-bottom: 0.5rem; color: #09ccfc;">🆓 Your Current Free Plan Includes:</h4>
                                <ul style="margin: 0; padding-left: 1.5rem; color: #6c757d;">
                                    <li>2 Lifetime Dispute Letter Credits</li>
                                    <li>JAM Engine Access</li>
                                    <li>Basic Credit Analysis</li>
                                </ul>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #09ccfc 0%, #08b5e0 100%); color: white; padding: 1rem; border-radius: 8px; margin: 1rem 0; text-align: left;">
                                <h4 style="margin-bottom: 0.5rem;">🚀 Upgrade Benefits:</h4>
                                <ul style="margin: 0; padding-left: 1.5rem;">
                                    <li><strong>5-50 Monthly Dispute Letters</strong> (vs 2 lifetime)</li>
                                    <li><strong>Priority Email Support</strong></li>
                                    <li><strong>Advanced Credit Strategies</strong></li>
                                    <li><strong>Phone Support</strong> (Premium tiers)</li>
                                    <li><strong>Done-For-You Services</strong> Available</li>
                                </ul>
                            </div>
                        ` : `
                            <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                                <p style="margin: 0; color: #856404;">
                                    <i class="fas fa-info-circle"></i> 
                                    Current Plan: <strong>${subscriptionData?.tierConfig?.name || 'Unknown'}</strong>
                                </p>
                            </div>
                        `}
                        
                        <p style="color: #6c757d; font-size: 0.9rem; margin-top: 1rem;">
                            ${currentUser?.email ? `Your account (${currentUser.email}) will be pre-filled for faster checkout.` : 'Create an account for the best experience.'}
                        </p>
                    </div>
                `;

                showAdvancedModal(title, modalContent, [
                    {
                        text: 'View DIY Plans',
                        style: 'primary',
                        action: () => openDIYPlans(currentUser)
                    },
                    {
                        text: 'Done-For-You Service',
                        style: 'secondary',
                        action: () => openFullService(currentUser)
                    },
                    {
                        text: 'Maybe Later',
                        style: 'link',
                        action: () => closeAdvancedModal()
                    }
                ]);
            }

            function openDIYPlans(userData) {
                console.log('🎯 Navigating to pricing plans for DIY options');

                // Close the modal first and ensure it stays closed
                closeAdvancedModal();

                // Hide the entire ManageSubscriptionModule interface
                if (currentContainer) {
                    console.log('🔒 Hiding ManageSubscriptionModule interface');
                    currentContainer.style.display = 'none';
                    currentContainer.style.visibility = 'hidden';
                    currentContainer.style.opacity = '0';
                    currentContainer.style.zIndex = '-1';
                }

                // Aggressively close ALL possible modal elements
                console.log('🔒 Aggressively closing all modals...');
                const modalSelectors = [
                    '#advancedModal',
                    '.advanced-modal',
                    '[id*="modal"]',
                    '[class*="modal"]',
                    '.manage-subscription-modal',
                    '#manage-subscription-modal'
                ];

                modalSelectors.forEach(selector => {
                    const modals = document.querySelectorAll(selector);
                    modals.forEach(modal => {
                        if (modal) {
                            modal.style.display = 'none !important';
                            modal.style.visibility = 'hidden !important';
                            modal.style.opacity = '0 !important';
                            modal.style.zIndex = '-9999 !important';
                            modal.style.position = 'fixed !important';
                            modal.style.top = '-9999px !important';
                            modal.style.left = '-9999px !important';
                            modal.classList.add('force-hidden');
                            console.log('🔒 Forcefully closed modal:', selector);
                        }
                    });
                });

                // Also try to remove any backdrop/overlay elements
                const overlays = document.querySelectorAll('.modal-backdrop, .backdrop, [class*="overlay"]');
                overlays.forEach(overlay => {
                    overlay.style.display = 'none !important';
                    overlay.style.visibility = 'hidden !important';
                });

                // Set up a persistent modal closer that runs every 100ms for 3 seconds
                let modalCloseAttempts = 0;
                const maxAttempts = 30; // 3 seconds at 100ms intervals

                const persistentModalCloser = setInterval(() => {
                    modalCloseAttempts++;

                    // Find and close any visible modals
                    const visibleModals = document.querySelectorAll('[id*="modal"]:not(.force-hidden), [class*="modal"]:not(.force-hidden)');
                    visibleModals.forEach(modal => {
                        const computedStyle = window.getComputedStyle(modal);
                        if (computedStyle.display !== 'none' && computedStyle.visibility !== 'hidden') {
                            modal.style.display = 'none !important';
                            modal.style.visibility = 'hidden !important';
                            modal.style.zIndex = '-9999 !important';
                            modal.classList.add('force-hidden');
                            console.log('🔒 Persistent modal close:', modal.id || modal.className);
                        }
                    });

                    // Stop after max attempts
                    if (modalCloseAttempts >= maxAttempts) {
                        clearInterval(persistentModalCloser);
                        console.log('✅ Modal close monitoring stopped');
                    }
                }, 100);

                // Approach 1: If we're in Interface.html context, switch to pricing tab
                if (window.parent && window.parent !== window) {
                    console.log('📡 Sending message to parent to load pricing tab');
                    window.parent.postMessage({
                        type: 'loadTab',
                        tabId: 'interface-pricing',
                        focus: 'diy'
                    }, '*');
                    return;
                }

                // Approach 2: Use the pricing tiers module that's already loaded
                if (window.jamPricingTiers) {
                    console.log('🎯 Using existing pricing tiers module');

                    // Try to call methods on the pricing tiers module to show it
                    try {
                        // Try to call show/display method if available
                        if (typeof window.jamPricingTiers.show === 'function') {
                            console.log('📍 Calling jamPricingTiers.show()');
                            window.jamPricingTiers.show();
                        } else if (typeof window.jamPricingTiers.display === 'function') {
                            console.log('📍 Calling jamPricingTiers.display()');
                            window.jamPricingTiers.display();
                        } else if (typeof window.jamPricingTiers.init === 'function') {
                            console.log('📍 Re-initializing jamPricingTiers');
                            // Try to find the pricing container
                            const pricingContainer = document.querySelector('#pricing-container') ||
                                document.querySelector('.pricing-container') ||
                                document.querySelector('[id*="pricing"]') ||
                                document.querySelector('[class*="pricing"]');

                            if (pricingContainer) {
                                console.log('📍 Found pricing container:', pricingContainer.id || pricingContainer.className);
                                window.jamPricingTiers.init(pricingContainer.id || pricingContainer);
                            } else {
                                console.log('📍 No pricing container found, calling init without container');
                                window.jamPricingTiers.init();
                            }
                        }

                        // Also try to scroll to pricing section and make it visible
                        setTimeout(() => {
                            console.log('🔍 Starting search for pricing section...');

                            // Try multiple selectors to find pricing content
                            const pricingSelectors = [
                                '[data-section="pricing"]',
                                '#pricing',
                                '.pricing-section',
                                '[id*="pricing"]',
                                '[class*="pricing"]',
                                '#interface-pricing',
                                '.pricing-container',
                                '#pricing-container'
                            ];

                            let pricingSection = null;
                            for (const selector of pricingSelectors) {
                                pricingSection = document.querySelector(selector);
                                if (pricingSection) {
                                    console.log(`📍 Found pricing section with selector: ${selector}`, pricingSection);
                                    break;
                                }
                            }

                            if (pricingSection) {
                                console.log('📍 Making pricing section visible and scrolling to it');

                                // Make sure the pricing section is visible
                                pricingSection.style.display = 'block';
                                pricingSection.style.visibility = 'visible';
                                pricingSection.style.opacity = '1';
                                pricingSection.style.zIndex = '1000';

                                // If it's in a tab system, try to activate the pricing tab
                                const pricingTab = document.querySelector('[data-tab="pricing"]') ||
                                    document.querySelector('[href*="pricing"]') ||
                                    document.querySelector('.pricing-tab');

                                if (pricingTab) {
                                    console.log('📍 Found pricing tab, clicking it');

                                    // Check if the required widget container exists, create if missing
                                    const widgetContainer = document.getElementById('interface-pricing-widget');
                                    if (!widgetContainer) {
                                        console.log('📦 Creating missing interface-pricing-widget container');
                                        const newContainer = document.createElement('div');
                                        newContainer.id = 'interface-pricing-widget';
                                        newContainer.className = 'interface-widget-container';

                                        // Try to find a good place to insert it
                                        const pricingContent = pricingSection.querySelector('.pricing-content') ||
                                            pricingSection.querySelector('.interface-tab-content') ||
                                            pricingSection;

                                        if (pricingContent) {
                                            pricingContent.appendChild(newContainer);
                                            console.log('📦 Successfully created interface-pricing-widget container');
                                        }
                                    }

                                    pricingTab.click();
                                }

                                // Scroll to the pricing section
                                pricingSection.scrollIntoView({
                                    behavior: 'smooth',
                                    block: 'center',
                                    inline: 'center'
                                });

                                // Try to expand or show pricing content
                                const pricingContent = pricingSection.querySelector('.pricing-content') ||
                                    pricingSection.querySelector('.pricing-plans') ||
                                    pricingSection.querySelector('[id*="plan"]');

                                if (pricingContent) {
                                    console.log('📍 Found pricing content, making it visible');
                                    pricingContent.style.display = 'block';
                                    pricingContent.style.visibility = 'visible';
                                }

                                // Highlight DIY section after a delay
                                setTimeout(() => {
                                    const diySection = document.querySelector('[data-plan="diy"]') ||
                                        document.querySelector('#diy-plan-container') ||
                                        document.querySelector('.diy-plan') ||
                                        document.querySelector('[id*="diy"]');
                                    if (diySection) {
                                        console.log('✨ Highlighting DIY section');
                                        diySection.style.border = '3px solid #007bff';
                                        diySection.style.borderRadius = '8px';
                                        diySection.style.backgroundColor = '#e6f3ff';
                                        setTimeout(() => {
                                            diySection.style.border = '';
                                            diySection.style.borderRadius = '';
                                            diySection.style.backgroundColor = '';
                                        }, 5000);
                                    } else {
                                        console.log('❌ Could not find DIY section to highlight');
                                    }

                                    // Final check to ensure modal is closed
                                    const modal = document.getElementById('advancedModal');
                                    if (modal && modal.style.display !== 'none') {
                                        console.log('🔒 Final modal close to ensure pricing section is visible');
                                        closeAdvancedModal();
                                        modal.style.display = 'none';
                                        modal.style.zIndex = '-1';
                                    }
                                }, 1000);

                            } else {
                                console.log('❌ No pricing section found in DOM after checking all selectors');
                                console.log('🔍 Available jamPricingTiers methods:', Object.getOwnPropertyNames(window.jamPricingTiers));

                                // Log all elements with "pricing" in their ID or class
                                const pricingElements = document.querySelectorAll('[id*="pricing"], [class*="pricing"]');
                                console.log('🔍 All elements with "pricing" in ID or class:', pricingElements);

                                // Show a notification that pricing section wasn't found
                                showSimpleNotification('Pricing Section', 'Could not locate pricing section on this page. You may need to navigate to the pricing page manually.', 'warning');
                            }
                        }, 1500);

                    } catch (error) {
                        console.error('❌ Error calling jamPricingTiers methods:', error);
                    }
                    return;
                }

                // Approach 3: Fallback - try to find and show pricing content
                console.log('🔍 Looking for pricing content in current page');
                const pricingElement = document.querySelector('#pricing') ||
                    document.querySelector('.pricing') ||
                    document.querySelector('[id*="pricing"]');

                if (pricingElement) {
                    pricingElement.scrollIntoView({ behavior: 'smooth' });
                } else {
                    console.log('❌ No pricing section found on current page');
                    showSimpleNotification('Pricing section not available on this page', 'info');
                }
            }

            function openFullService(userData) {
                console.log('🎯 Navigating to pricing plans for Full Service options');

                // Close the modal first and ensure it stays closed
                closeAdvancedModal();

                // Hide the entire ManageSubscriptionModule interface
                if (currentContainer) {
                    console.log('🔒 Hiding ManageSubscriptionModule interface');
                    currentContainer.style.display = 'none';
                    currentContainer.style.visibility = 'hidden';
                    currentContainer.style.opacity = '0';
                    currentContainer.style.zIndex = '-1';
                }

                // Aggressively close ALL possible modal elements
                console.log('🔒 Aggressively closing all modals...');
                const modalSelectors = [
                    '#advancedModal',
                    '.advanced-modal',
                    '[id*="modal"]',
                    '[class*="modal"]',
                    '.manage-subscription-modal',
                    '#manage-subscription-modal'
                ];

                modalSelectors.forEach(selector => {
                    const modals = document.querySelectorAll(selector);
                    modals.forEach(modal => {
                        if (modal) {
                            modal.style.display = 'none !important';
                            modal.style.visibility = 'hidden !important';
                            modal.style.opacity = '0 !important';
                            modal.style.zIndex = '-9999 !important';
                            modal.style.position = 'fixed !important';
                            modal.style.top = '-9999px !important';
                            modal.style.left = '-9999px !important';
                            modal.classList.add('force-hidden');
                            console.log('🔒 Forcefully closed modal:', selector);
                        }
                    });
                });

                // Also try to remove any backdrop/overlay elements
                const overlays = document.querySelectorAll('.modal-backdrop, .backdrop, [class*="overlay"]');
                overlays.forEach(overlay => {
                    overlay.style.display = 'none !important';
                    overlay.style.visibility = 'hidden !important';
                });

                // Set up a persistent modal closer that runs every 100ms for 3 seconds
                let modalCloseAttempts = 0;
                const maxAttempts = 30; // 3 seconds at 100ms intervals

                const persistentModalCloser = setInterval(() => {
                    modalCloseAttempts++;

                    // Find and close any visible modals
                    const visibleModals = document.querySelectorAll('[id*="modal"]:not(.force-hidden), [class*="modal"]:not(.force-hidden)');
                    visibleModals.forEach(modal => {
                        const computedStyle = window.getComputedStyle(modal);
                        if (computedStyle.display !== 'none' && computedStyle.visibility !== 'hidden') {
                            modal.style.display = 'none !important';
                            modal.style.visibility = 'hidden !important';
                            modal.style.zIndex = '-9999 !important';
                            modal.classList.add('force-hidden');
                            console.log('🔒 Persistent modal close:', modal.id || modal.className);
                        }
                    });

                    // Stop after max attempts
                    if (modalCloseAttempts >= maxAttempts) {
                        clearInterval(persistentModalCloser);
                        console.log('✅ Modal close monitoring stopped');
                    }
                }, 100);

                // Approach 1: If we're in Interface.html context, switch to pricing tab
                if (window.parent && window.parent !== window) {
                    console.log('📡 Sending message to parent to load pricing tab');
                    window.parent.postMessage({
                        type: 'loadTab',
                        tabId: 'interface-pricing',
                        focus: 'fullservice'
                    }, '*');
                    return;
                }

                // Approach 2: Use the pricing tiers module that's already loaded
                if (window.jamPricingTiers) {
                    console.log('🎯 Using existing pricing tiers module');

                    // Try to call methods on the pricing tiers module to show it
                    try {
                        // Try to call show/display method if available
                        if (typeof window.jamPricingTiers.show === 'function') {
                            console.log('📍 Calling jamPricingTiers.show()');
                            window.jamPricingTiers.show();
                        } else if (typeof window.jamPricingTiers.display === 'function') {
                            console.log('📍 Calling jamPricingTiers.display()');
                            window.jamPricingTiers.display();
                        } else if (typeof window.jamPricingTiers.init === 'function') {
                            console.log('📍 Re-initializing jamPricingTiers');
                            // Try to find the pricing container
                            const pricingContainer = document.querySelector('#pricing-container') ||
                                document.querySelector('.pricing-container') ||
                                document.querySelector('[id*="pricing"]') ||
                                document.querySelector('[class*="pricing"]');

                            if (pricingContainer) {
                                console.log('📍 Found pricing container:', pricingContainer.id || pricingContainer.className);
                                window.jamPricingTiers.init(pricingContainer.id || pricingContainer);
                            } else {
                                console.log('📍 No pricing container found, calling init without container');
                                window.jamPricingTiers.init();
                            }
                        }

                        // Also try to scroll to pricing section and make it visible
                        setTimeout(() => {
                            console.log('🔍 Starting search for pricing section (Full Service)...');

                            // Try multiple selectors to find pricing content
                            const pricingSelectors = [
                                '[data-section="pricing"]',
                                '#pricing',
                                '.pricing-section',
                                '[id*="pricing"]',
                                '[class*="pricing"]',
                                '#interface-pricing',
                                '.pricing-container',
                                '#pricing-container'
                            ];

                            let pricingSection = null;
                            for (const selector of pricingSelectors) {
                                pricingSection = document.querySelector(selector);
                                if (pricingSection) {
                                    console.log(`📍 Found pricing section with selector: ${selector}`, pricingSection);
                                    break;
                                }
                            }

                            if (pricingSection) {
                                console.log('📍 Making pricing section visible and scrolling to it');

                                // Make sure the pricing section is visible
                                pricingSection.style.display = 'block';
                                pricingSection.style.visibility = 'visible';
                                pricingSection.style.opacity = '1';
                                pricingSection.style.zIndex = '1000';

                                // If it's in a tab system, try to activate the pricing tab
                                const pricingTab = document.querySelector('[data-tab="pricing"]') ||
                                    document.querySelector('[href*="pricing"]') ||
                                    document.querySelector('.pricing-tab');

                                if (pricingTab) {
                                    console.log('📍 Found pricing tab, clicking it');

                                    // Check if the required widget container exists, create if missing
                                    const widgetContainer = document.getElementById('interface-pricing-widget');
                                    if (!widgetContainer) {
                                        console.log('📦 Creating missing interface-pricing-widget container');
                                        const newContainer = document.createElement('div');
                                        newContainer.id = 'interface-pricing-widget';
                                        newContainer.className = 'interface-widget-container';

                                        // Try to find a good place to insert it
                                        const pricingContent = pricingSection.querySelector('.pricing-content') ||
                                            pricingSection.querySelector('.interface-tab-content') ||
                                            pricingSection;

                                        if (pricingContent) {
                                            pricingContent.appendChild(newContainer);
                                            console.log('📦 Successfully created interface-pricing-widget container');
                                        }
                                    }

                                    pricingTab.click();
                                }

                                // Scroll to the pricing section
                                pricingSection.scrollIntoView({
                                    behavior: 'smooth',
                                    block: 'center',
                                    inline: 'center'
                                });

                                // Try to expand or show pricing content
                                const pricingContent = pricingSection.querySelector('.pricing-content') ||
                                    pricingSection.querySelector('.pricing-plans') ||
                                    pricingSection.querySelector('[id*="plan"]');

                                if (pricingContent) {
                                    console.log('📍 Found pricing content, making it visible');
                                    pricingContent.style.display = 'block';
                                    pricingContent.style.visibility = 'visible';
                                }

                                // Highlight Full Service section after a delay
                                setTimeout(() => {
                                    const fullServiceSection = document.querySelector('[data-plan="fullservice"]') ||
                                        document.querySelector('#fullservice-plan-container') ||
                                        document.querySelector('.fullservice-plan') ||
                                        document.querySelector('[id*="fullservice"]') ||
                                        document.querySelector('[id*="full-service"]');
                                    if (fullServiceSection) {
                                        console.log('✨ Highlighting Full Service section');
                                        fullServiceSection.style.border = '3px solid #007bff';
                                        fullServiceSection.style.borderRadius = '8px';
                                        fullServiceSection.style.backgroundColor = '#e6f3ff';
                                        setTimeout(() => {
                                            fullServiceSection.style.border = '';
                                            fullServiceSection.style.borderRadius = '';
                                            fullServiceSection.style.backgroundColor = '';
                                        }, 5000);
                                    } else {
                                        console.log('❌ Could not find Full Service section to highlight');
                                    }

                                    // Final check to ensure modal is closed
                                    const modal = document.getElementById('advancedModal');
                                    if (modal && modal.style.display !== 'none') {
                                        console.log('🔒 Final modal close to ensure pricing section is visible');
                                        closeAdvancedModal();
                                        modal.style.display = 'none';
                                        modal.style.zIndex = '-1';
                                    }
                                }, 1000);

                            } else {
                                console.log('❌ No pricing section found in DOM after checking all selectors');
                                console.log('🔍 Available jamPricingTiers methods:', Object.getOwnPropertyNames(window.jamPricingTiers));

                                // Log all elements with "pricing" in their ID or class
                                const pricingElements = document.querySelectorAll('[id*="pricing"], [class*="pricing"]');
                                console.log('🔍 All elements with "pricing" in ID or class:', pricingElements);

                                // Show a notification that pricing section wasn't found
                                showSimpleNotification('Pricing Section', 'Could not locate pricing section on this page. You may need to navigate to the pricing page manually.', 'warning');
                            }
                        }, 1500);

                    } catch (error) {
                        console.error('❌ Error calling jamPricingTiers methods:', error);
                    }
                    return;
                }

                // Approach 3: Fallback - try to find and show pricing content
                console.log('🔍 Looking for pricing content in current page');
                const pricingElement = document.querySelector('#pricing') ||
                    document.querySelector('.pricing') ||
                    document.querySelector('[id*="pricing"]');

                if (pricingElement) {
                    pricingElement.scrollIntoView({ behavior: 'smooth' });
                } else {
                    console.log('❌ No pricing section found on current page');
                    showSimpleNotification('Pricing section not available on this page', 'info');
                }
            }

            function cancelSubscription() {
                console.log('❌ Cancel subscription clicked');
                const currentTier = subscriptionData?.tier || 'unknown';
                const tierName = subscriptionData?.tierConfig?.name || 'Current Plan';
                const isFreeTier = currentTier === 'free';

                if (isFreeTier) {
                    showSimpleNotification('Nothing to Cancel', 'You\'re on the Free Plan, which never expires. No cancellation needed!', 'info');
                    return;
                }

                // Start multi-step cancellation process
                showCancellationStep1(tierName, currentTier);
            }

            function showCancellationStep1(tierName, currentTier) {
                const renewalDate = subscriptionData?.subscriptionEndDate ? new Date(subscriptionData.subscriptionEndDate).toLocaleDateString() : 'end of current period';
                const monthlyCredits = subscriptionData?.tierConfig?.monthlyCredits || 0;
                const features = subscriptionData?.tierConfig?.features || [];

                const impactMessage = `
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ffc107; margin-bottom: 1rem;"></i>
                        <h4 style="color: #343a40; margin-bottom: 1rem;">Before You Cancel...</h4>
                    </div>
                    
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 0.5rem; color: #856404;">📊 What You'll Lose:</h4>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: #856404;">
                            <li><strong>${monthlyCredits} Monthly Dispute Letters</strong> (only 2 lifetime credits on Free)</li>
                            ${features.slice(0, 3).map(feature => `<li>${feature}</li>`).join('')}
                            <li>Priority Support Access</li>
                        </ul>
                    </div>
                    
                    <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 0.5rem; color: #155724;">✅ Good News:</h4>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: #155724;">
                            <li>You'll keep access until <strong>${renewalDate}</strong></li>
                            <li>Automatic downgrade to <strong>Free Plan</strong> (not complete loss)</li>
                            <li>Your account data stays safe</li>
                            <li>Easy to reactivate anytime</li>
                        </ul>
                    </div>
                    
                    <p style="color: #6c757d; font-size: 0.9rem; text-align: center; margin-top: 1rem;">
                        Still want to cancel? We understand. Let's make sure this is the right choice.
                    </p>
                `;

                showAdvancedModal('Cancel Subscription', impactMessage, [
                    {
                        text: 'Yes, Continue Canceling',
                        style: 'danger',
                        action: () => showCancellationStep2(tierName, currentTier)
                    },
                    {
                        text: 'Keep My Subscription',
                        style: 'primary',
                        action: () => closeAdvancedModal()
                    }
                ]);
            }

            function showCancellationStep2(tierName, currentTier) {
                // Retention offers based on tier
                const offers = getRetentionOffers(currentTier);

                const retentionMessage = `
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <i class="fas fa-heart" style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;"></i>
                        <h4 style="color: #343a40; margin-bottom: 1rem;">We'd Hate to See You Go!</h4>
                        <p style="color: #6c757d;">Before you cancel, here are some special offers just for you:</p>
                    </div>
                    
                    ${offers.map(offer => `
                        <div style="border: 2px solid #09ccfc; border-radius: 8px; padding: 1rem; margin: 1rem 0; background: linear-gradient(135deg, rgba(9, 204, 252, 0.1) 0%, rgba(8, 181, 224, 0.1) 100%);">
                            <h4 style="color: #09ccfc; margin-bottom: 0.5rem;">${offer.title}</h4>
                            <p style="margin: 0.5rem 0; color: #343a40;">${offer.description}</p>
                            <div style="text-align: right; margin-top: 0.5rem;">
                                <button onclick="acceptRetentionOffer('${offer.id}')" class="action-btn" style="font-size: 0.8rem; padding: 0.5rem 1rem;">
                                    ${offer.buttonText}
                                </button>
                            </div>
                        </div>
                    `).join('')}
                    
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0; text-align: center;">
                        <p style="margin: 0; color: #6c757d; font-size: 0.9rem;">
                            💡 <strong>Pro Tip:</strong> You can pause your subscription for up to 3 months instead of canceling.
                        </p>
                    </div>
                `;

                showAdvancedModal('Special Retention Offers', retentionMessage, [
                    {
                        text: 'Pause Subscription (3 months)',
                        style: 'secondary',
                        action: () => pauseSubscription()
                    },
                    {
                        text: 'Still Cancel',
                        style: 'danger',
                        action: () => showCancellationStep3(tierName, currentTier)
                    },
                    {
                        text: 'Keep My Plan',
                        style: 'primary',
                        action: () => closeAdvancedModal()
                    }
                ]);
            }

            function getRetentionOffers(currentTier) {
                const baseOffers = [
                    {
                        id: 'discount_50',
                        title: '🔥 50% Off Next 3 Months',
                        description: 'Stay with us and get 50% off your next 3 billing cycles. That\'s huge savings!',
                        buttonText: 'Claim 50% Off'
                    },
                    {
                        id: 'free_month',
                        title: '🎁 One Month Free',
                        description: 'Get your next month completely free. No strings attached, just our way of saying thanks.',
                        buttonText: 'Claim Free Month'
                    }
                ];

                // Add tier-specific offers
                if (currentTier === 'starter' || currentTier === 'basic') {
                    baseOffers.push({
                        id: 'free_upgrade',
                        title: '⬆️ Free Upgrade to Professional',
                        description: 'Get upgraded to Professional tier for the next 2 months at no extra cost.',
                        buttonText: 'Claim Upgrade'
                    });
                }

                return baseOffers;
            }

            function showCancellationStep3(tierName, currentTier) {
                const feedbackMessage = `
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <i class="fas fa-comments" style="font-size: 3rem; color: #6c757d; margin-bottom: 1rem;"></i>
                        <h4 style="color: #343a40; margin-bottom: 1rem;">Help Us Improve</h4>
                        <p style="color: #6c757d;">Your feedback helps us serve our customers better. Why are you canceling?</p>
                    </div>
                    
                    <div class="feedback-options" style="text-align: left; margin: 1rem 0;">
                        <div class="feedback-option" style="margin-bottom: 0.75rem;">
                            <label style="display: flex; align-items: flex-start; cursor: pointer; padding: 0.75rem; background: #f8f9fa; border-radius: 6px; border: 1px solid #e9ecef; transition: all 0.2s ease; min-height: 48px;">
                                <input type="radio" name="cancelReason" value="too_expensive" style="margin-right: 0.75rem; margin-top: 0.1rem; min-width: 16px; flex-shrink: 0;">
                                <span style="font-size: 0.95rem; line-height: 1.4; word-wrap: break-word;">Too expensive for my budget</span>
                            </label>
                        </div>
                        <div class="feedback-option" style="margin-bottom: 0.75rem;">
                            <label style="display: flex; align-items: flex-start; cursor: pointer; padding: 0.75rem; background: #f8f9fa; border-radius: 6px; border: 1px solid #e9ecef; transition: all 0.2s ease; min-height: 48px;">
                                <input type="radio" name="cancelReason" value="not_using" style="margin-right: 0.75rem; margin-top: 0.1rem; min-width: 16px; flex-shrink: 0;">
                                <span style="font-size: 0.95rem; line-height: 1.4; word-wrap: break-word;">Not using it enough</span>
                            </label>
                        </div>
                        <div class="feedback-option" style="margin-bottom: 0.75rem;">
                            <label style="display: flex; align-items: flex-start; cursor: pointer; padding: 0.75rem; background: #f8f9fa; border-radius: 6px; border: 1px solid #e9ecef; transition: all 0.2s ease; min-height: 48px;">
                                <input type="radio" name="cancelReason" value="found_alternative" style="margin-right: 0.75rem; margin-top: 0.1rem; min-width: 16px; flex-shrink: 0;">
                                <span style="font-size: 0.95rem; line-height: 1.4; word-wrap: break-word;">Found a better alternative</span>
                            </label>
                        </div>
                        <div class="feedback-option" style="margin-bottom: 0.75rem;">
                            <label style="display: flex; align-items: flex-start; cursor: pointer; padding: 0.75rem; background: #f8f9fa; border-radius: 6px; border: 1px solid #e9ecef; transition: all 0.2s ease; min-height: 48px;">
                                <input type="radio" name="cancelReason" value="technical_issues" style="margin-right: 0.75rem; margin-top: 0.1rem; min-width: 16px; flex-shrink: 0;">
                                <span style="font-size: 0.95rem; line-height: 1.4; word-wrap: break-word;">Technical issues or bugs</span>
                            </label>
                        </div>
                        <div class="feedback-option" style="margin-bottom: 0.75rem;">
                            <label style="display: flex; align-items: flex-start; cursor: pointer; padding: 0.75rem; background: #f8f9fa; border-radius: 6px; border: 1px solid #e9ecef; transition: all 0.2s ease; min-height: 48px;">
                                <input type="radio" name="cancelReason" value="other" style="margin-right: 0.75rem; margin-top: 0.1rem; min-width: 16px; flex-shrink: 0;">
                                <span style="font-size: 0.95rem; line-height: 1.4; word-wrap: break-word;">Other reason</span>
                            </label>
                        </div>
                    </div>
                    
                    <div style="margin: 1rem 0;">
                        <textarea id="cancelFeedback" placeholder="Additional comments (optional)..." 
                                  style="width: 100%; height: 80px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
                    </div>
                `;

                showAdvancedModal('Final Step: Feedback', feedbackMessage, [
                    {
                        text: 'Complete Cancellation',
                        style: 'danger',
                        action: () => performAdvancedCancellation()
                    },
                    {
                        text: 'Go Back',
                        style: 'secondary',
                        action: () => showCancellationStep2(tierName, currentTier)
                    },
                    {
                        text: 'Keep Subscription',
                        style: 'primary',
                        action: () => closeAdvancedModal()
                    }
                ]);
            }

            async function performAdvancedCancellation() {
                try {
                    // Collect feedback
                    const selectedReason = document.querySelector('input[name="cancelReason"]:checked')?.value || 'not_specified';
                    const additionalFeedback = document.getElementById('cancelFeedback')?.value || '';

                    console.log('Processing advanced cancellation...', { reason: selectedReason, feedback: additionalFeedback });

                    const authToken = getAuthToken();
                    const currentUser = getCurrentUser();

                    // Send cancellation request with feedback
                    const response = await fetch('https://jam-capital-backend.azurewebsites.net/api/subscriptions/cancel', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json',
                            ...(currentUser?.email && { 'X-User-Email': currentUser.email }),
                            ...(currentUser?.id && { 'X-User-ID': currentUser.id })
                        },
                        body: JSON.stringify({
                            cancellationReason: selectedReason,
                            feedback: additionalFeedback,
                            cancellationType: 'end_of_period', // Don't cancel immediately
                            downgradeTo: 'free' // Downgrade to free tier
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();

                        if (result.success) {
                            // Show success message with grace period info
                            showCancellationSuccess(result.data);
                        } else {
                            throw new Error(result.message || 'Failed to cancel subscription');
                        }
                    } else {
                        throw new Error(`Server error: ${response.status}`);
                    }

                } catch (error) {
                    console.error('❌ Error cancelling subscription:', error);

                    // Fallback: Show local cancellation success (since we don't want to block the user)
                    showCancellationSuccess({
                        downgradeTo: 'free',
                        effectiveDate: subscriptionData?.subscriptionEndDate || new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
                        gracePeriodDays: 30
                    });
                }
            }

            function showCancellationSuccess(cancellationData) {
                const effectiveDate = new Date(cancellationData.effectiveDate).toLocaleDateString();
                const gracePeriodDays = cancellationData.gracePeriodDays || 30;

                const successMessage = `
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <i class="fas fa-check-circle" style="font-size: 3rem; color: #28a745; margin-bottom: 1rem;"></i>
                        <h4 style="color: #28a745; margin-bottom: 1rem;">Cancellation Processed</h4>
                    </div>
                    
                    <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 0.5rem; color: #155724;">📅 What Happens Next:</h4>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: #155724;">
                            <li>Your subscription continues until <strong>${effectiveDate}</strong></li>
                            <li>After that, you'll automatically move to our <strong>Free Plan</strong></li>
                            <li>All your account data remains safe and accessible</li>
                            <li>You can reactivate anytime within <strong>${gracePeriodDays} days</strong></li>
                        </ul>
                    </div>
                    
                    <div style="background: #cce7ff; border: 1px solid #b8daff; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 0.5rem; color: #004085;">🔄 Easy Reactivation:</h4>
                        <p style="margin: 0; color: #004085;">
                            Changed your mind? You can reactivate your subscription with one click for the next ${gracePeriodDays} days, 
                            and pick up exactly where you left off.
                        </p>
                    </div>
                    
                    <p style="color: #6c757d; font-size: 0.9rem; text-align: center; margin-top: 1rem;">
                        Thank you for being part of the JAM Credit Solutions family. We hope to serve you again soon!
                    </p>
                `;

                showAdvancedModal('Subscription Cancelled', successMessage, [
                    {
                        text: 'Got It',
                        style: 'primary',
                        action: () => {
                            closeAdvancedModal();
                            refresh(); // Refresh to show updated status
                        }
                    }
                ]);
            }

            function acceptRetentionOffer(offerId) {
                console.log('🎁 Accepting retention offer:', offerId);

                // Here you would typically make an API call to apply the offer
                showSimpleNotification(
                    'Offer Applied!',
                    'Great choice! Your retention offer has been applied to your account. Check your email for confirmation.',
                    'success'
                );

                closeAdvancedModal();
                setTimeout(() => refresh(), 1000); // Refresh after a delay
            }

            async function pauseSubscription() {
                try {
                    console.log('⏸️ Pausing subscription for 3 months...');

                    const authToken = getAuthToken();
                    const currentUser = getCurrentUser();

                    const response = await fetch('https://jam-capital-backend.azurewebsites.net/api/subscriptions/pause', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json',
                            ...(currentUser?.email && { 'X-User-Email': currentUser.email }),
                            ...(currentUser?.id && { 'X-User-ID': currentUser.id })
                        },
                        body: JSON.stringify({
                            pauseDurationMonths: 3
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            showSimpleNotification(
                                'Subscription Paused',
                                'Your subscription has been paused for 3 months. You can reactivate anytime from your account.',
                                'success'
                            );
                        } else {
                            throw new Error(result.message);
                        }
                    } else {
                        throw new Error(`Server error: ${response.status}`);
                    }
                } catch (error) {
                    console.error('❌ Error pausing subscription:', error);
                    showSimpleNotification(
                        'Pause Request Received',
                        'We\'ve received your pause request. Our team will process it within 24 hours.',
                        'info'
                    );
                }

                closeAdvancedModal();
                setTimeout(() => refresh(), 1000);
            }



            // Show confirmation modal
            function showConfirmation(title, message, onConfirm, type = 'primary') {
                const modal = document.getElementById('confirmationModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalBody = document.getElementById('modalBody');
                const confirmBtn = document.getElementById('confirmBtn');

                if (!modal || !modalTitle || !modalBody || !confirmBtn) {
                    console.error('❌ Modal elements not found');
                    // Fallback to browser confirm
                    if (confirm(message)) {
                        onConfirm();
                    }
                    return;
                }

                modalTitle.textContent = title;
                modalBody.innerHTML = `<p>${message}</p>`;

                // Update confirm button style
                confirmBtn.className = `action-btn ${type === 'danger' ? 'danger' : ''}`;

                pendingAction = onConfirm;
                modal.style.display = 'block';
            }

            // Advanced modal system for complex interactions
            function showAdvancedModal(title, content, buttons = []) {
                // Remove any existing advanced modal
                const existingModal = document.getElementById('advancedModal');
                if (existingModal) {
                    existingModal.remove();
                }

                // Create the advanced modal
                const modal = document.createElement('div');
                modal.id = 'advancedModal';
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.style.zIndex = '999999'; // Ensure it's above everything

                const buttonsHTML = buttons.map((btn, index) => {
                    const btnClass = btn.style === 'danger' ? 'action-btn danger' :
                        btn.style === 'secondary' ? 'action-btn secondary' :
                            btn.style === 'link' ? 'action-btn secondary' :
                                'action-btn';

                    return `<button id="advancedModalBtn${index}" class="${btnClass}" style="margin-right: 0.5rem;">${btn.text}</button>`;
                }).join('');

                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3 class="modal-title">${title}</h3>
                            <button class="modal-close" onclick="closeAdvancedModal()">&times;</button>
                        </div>
                        <div style="margin-bottom: 1.5rem;">
                            ${content}
                        </div>
                        <div style="text-align: right;">
                            ${buttonsHTML}
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // Add event listeners to buttons
                buttons.forEach((btn, index) => {
                    const buttonElement = document.getElementById(`advancedModalBtn${index}`);
                    if (buttonElement && btn.action) {
                        buttonElement.addEventListener('click', btn.action);
                    }
                });

                // Close modal when clicking outside
                modal.addEventListener('click', (event) => {
                    if (event.target === modal) {
                        closeAdvancedModal();
                    }
                });
            }

            function closeAdvancedModal() {
                const modal = document.getElementById('advancedModal');
                if (modal) {
                    modal.remove();
                }
            }

            // Simple notification system
            function showSimpleNotification(title, message, type = 'info') {
                // Remove any existing notification
                const existingNotification = document.getElementById('simpleNotification');
                if (existingNotification) {
                    existingNotification.remove();
                }

                const notification = document.createElement('div');
                notification.id = 'simpleNotification';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#cce7ff'};
                    border: 1px solid ${type === 'success' ? '#c3e6cb' : type === 'error' ? '#f5c6cb' : '#b8daff'};
                    color: ${type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#004085'};
                    padding: 1rem;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                    max-width: 300px;
                                         z-index: 1000000;
                    animation: slideIn 0.3s ease;
                `;

                const icon = type === 'success' ? 'fas fa-check-circle' :
                    type === 'error' ? 'fas fa-exclamation-triangle' :
                        'fas fa-info-circle';

                notification.innerHTML = `
                    <div style="display: flex; align-items: flex-start; margin-bottom: 0.5rem;">
                        <i class="${icon}" style="margin-right: 0.5rem; margin-top: 0.1rem;"></i>
                        <div>
                            <strong>${title}</strong>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem;">${message}</p>
                        </div>
                        <button onclick="document.getElementById('simpleNotification').remove()" 
                                style="background: none; border: none; font-size: 1.2rem; cursor: pointer; margin-left: 0.5rem;">&times;</button>
                    </div>
                `;

                document.body.appendChild(notification);

                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 5000);
            }

            // Refresh the module
            async function refresh() {
                console.log('🔄 Refreshing ManageSubscriptionModule...');
                try {
                    showLoading();
                    await loadData();
                    render();
                    setupEventListeners();
                    console.log('✅ Module refreshed successfully');
                } catch (error) {
                    console.error('❌ Error refreshing module:', error);
                    showError(error.message);
                }
            }

            // Reset function
            function reset() {
                isInitialized = false;
                currentContainer = null;
                subscriptionData = null;
                pendingAction = null;
                console.log('ManageSubscriptionModule reset');
                return true;
            }

            // Global Subscription Access Control API
            async function checkUserAccess(operation = 'general', requiredCredits = 1) {
                try {
                    // Ensure we have current subscription data
                    if (!subscriptionData) {
                        console.log('🔄 No subscription data cached, loading...');
                        await loadData();
                    }

                    const result = {
                        allowed: false,
                        reason: '',
                        subscriptionData: subscriptionData,
                        upgradeRequired: false,
                        renewalRequired: false
                    };

                    // Check if user has valid subscription data
                    if (!subscriptionData) {
                        result.reason = 'No subscription data available';
                        result.upgradeRequired = true;
                        return result;
                    }

                    // Check if subscription is active
                    if (!subscriptionData.isActive) {
                        result.reason = 'Subscription expired or inactive';
                        result.renewalRequired = true;
                        result.upgradeRequired = true;
                        return result;
                    }

                    // Check specific operations
                    switch (operation) {
                        case 'dispute_letter_generation':
                            if (!subscriptionData.canGenerateDispute?.allowed) {
                                result.reason = subscriptionData.canGenerateDispute?.reason || 'Cannot generate dispute letters';
                                result.upgradeRequired = subscriptionData.tier === 'starter' || subscriptionData.tier === 'free';
                                return result;
                            }

                            // Check remaining credits
                            if (subscriptionData.remainingCredits < requiredCredits && subscriptionData.remainingCredits !== 'Unlimited') {
                                result.reason = `Insufficient credits. Need ${requiredCredits}, have ${subscriptionData.remainingCredits}`;
                                result.upgradeRequired = subscriptionData.tier === 'starter' || subscriptionData.tier === 'free';
                                return result;
                            }
                            break;

                        case 'chat_access':
                            // Chat is available to all active subscriptions
                            break;

                        case 'reports_upload':
                            // Report upload is available to all active subscriptions
                            break;

                        case 'letters_view':
                            // Viewing letters is available to all active subscriptions
                            break;

                        case 'premium_features':
                            if (subscriptionData.tier === 'free' || subscriptionData.tier === 'starter') {
                                result.reason = 'Premium features require Professional or Premium plan';
                                result.upgradeRequired = true;
                                return result;
                            }
                            break;

                        default:
                            // General access check
                            break;
                    }

                    // If we get here, access is allowed
                    result.allowed = true;
                    result.reason = 'Access granted';
                    return result;

                } catch (error) {
                    console.error('❌ Error checking user access:', error);
                    return {
                        allowed: false,
                        reason: 'Error checking subscription status',
                        subscriptionData: null,
                        upgradeRequired: true,
                        renewalRequired: false
                    };
                }
            }

            async function consumeCredits(amount = 1, operation = 'dispute_letter_generation') {
                try {
                    console.log(`💳 Consuming ${amount} credits for ${operation}`);

                    // Check if we can consume credits
                    const accessCheck = await checkUserAccess(operation, amount);
                    if (!accessCheck.allowed) {
                        console.warn('❌ Cannot consume credits:', accessCheck.reason);
                        return {
                            success: false,
                            message: accessCheck.reason,
                            upgradeRequired: accessCheck.upgradeRequired
                        };
                    }

                    // Make API call to consume credits
                    const authToken = getAuthToken();
                    const currentUser = getCurrentUser();

                    const response = await fetch('https://jam-capital-backend.azurewebsites.net/api/subscriptions/consume-credits', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json',
                            ...(currentUser?.email && { 'X-User-Email': currentUser.email }),
                            ...(currentUser?.id && { 'X-User-ID': currentUser.id })
                        },
                        body: JSON.stringify({
                            creditsToConsume: amount,
                            operation: operation
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Failed to consume credits: ${response.status}`);
                    }

                    const result = await response.json();

                    if (result.success) {
                        // Update local subscription data
                        await loadData();
                        console.log(`✅ Successfully consumed ${amount} credits`);

                        // Trigger global synchronization
                        if (window.dispatchEvent) {
                            window.dispatchEvent(new CustomEvent('globalSubscriptionUpdated', {
                                detail: {
                                    oldData: null,
                                    newData: subscriptionData,
                                    source: 'ManageSubscriptionModule'
                                }
                            }));
                        }

                        return {
                            success: true,
                            message: `Consumed ${amount} credits`,
                            remainingCredits: result.data?.remainingCredits || subscriptionData?.remainingCredits
                        };
                    } else {
                        throw new Error(result.message || 'Failed to consume credits');
                    }

                } catch (error) {
                    console.error('❌ Error consuming credits:', error);
                    return {
                        success: false,
                        message: error.message || 'Error consuming credits',
                        upgradeRequired: true
                    };
                }
            }

            function getSubscriptionStatus() {
                if (!subscriptionData) {
                    return {
                        tier: 'unknown',
                        isActive: false,
                        remainingCredits: 0,
                        tierName: 'No Subscription',
                        canGenerateDispute: false,
                        daysUntilExpiration: 0,
                        needsUpgrade: true,
                        features: [],
                        disputeLetterUsage: {
                            totalLettersGenerated: 0,
                            monthlyLettersUsed: 0,
                            monthlyLimit: 0,
                            monthlyRemaining: 0
                        }
                    };
                }

                return {
                    tier: subscriptionData.tier,
                    isActive: subscriptionData.isActive,
                    remainingCredits: subscriptionData.remainingCredits,
                    tierName: subscriptionData.tierConfig?.name || 'Unknown Plan',
                    canGenerateDispute: subscriptionData.canGenerateDispute?.allowed || false,
                    daysUntilExpiration: subscriptionData.daysUntilExpiration,
                    needsUpgrade: subscriptionData.tier === 'free' || !subscriptionData.isActive,
                    features: subscriptionData.features || [],
                    limits: subscriptionData.limits || {},
                    currentUsage: subscriptionData.currentUsage || {},
                    disputeLetterUsage: subscriptionData.disputeLetterUsage || {
                        totalLettersGenerated: 0,
                        monthlyLettersUsed: 0,
                        monthlyLimit: 0,
                        monthlyRemaining: 0
                    }
                };
            }

            // Ensure user has a subscription (create free tier if none exists)
            async function ensureUserHasSubscription() {
                try {
                    console.log('🔍 Checking if user has subscription...');

                    // Try to get current subscription status
                    if (!subscriptionData) {
                        console.log('📊 No subscription data loaded, attempting to load...');
                        await loadData();
                    }

                    // If we still don't have subscription data, create free tier
                    if (!subscriptionData) {
                        console.log('🆓 No subscription found, creating Free Tier...');
                        subscriptionData = await createFreeTierSubscription();

                        // Re-render if module is initialized
                        if (isInitialized && currentContainer) {
                            render();
                        }

                        // Trigger global sync
                        if (window.dispatchEvent) {
                            window.dispatchEvent(new CustomEvent('globalSubscriptionUpdated', {
                                detail: {
                                    oldData: null,
                                    newData: subscriptionData,
                                    source: 'ManageSubscriptionModule-AutoEnrollment'
                                }
                            }));
                        }
                    }

                    console.log('✅ User subscription ensured:', subscriptionData.tier);
                    return {
                        success: true,
                        subscriptionData: subscriptionData,
                        tier: subscriptionData.tier,
                        isActive: subscriptionData.isActive
                    };

                } catch (error) {
                    console.error('❌ Error ensuring user subscription:', error);
                    return {
                        success: false,
                        error: error.message,
                        subscriptionData: null
                    };
                }
            }

            function showUpgradeModal(reason = 'access_required') {
                console.log('💳 Showing upgrade modal for reason:', reason);

                let title = 'Upgrade Required';
                let message = 'You need to upgrade your subscription to access this feature.';

                switch (reason) {
                    case 'dispute_letter_generation':
                        title = 'More Credits Needed';
                        message = 'You\'ve used all your dispute letter credits. Upgrade to continue generating letters.';
                        break;
                    case 'subscription_expired':
                        title = 'Subscription Expired';
                        message = 'Your subscription has expired. Please renew to continue using JAM Dispute Bot.';
                        break;
                    case 'premium_features':
                        title = 'Premium Feature';
                        message = 'This feature requires a Professional or Premium subscription.';
                        break;
                    case 'insufficient_credits':
                        title = 'Credits Exhausted';
                        message = 'You don\'t have enough credits for this action. Upgrade for more credits.';
                        break;
                }

                // Use the existing showConfirmation modal
                showConfirmation(
                    title,
                    message + '<br><br>Would you like to view upgrade options?',
                    () => {
                        upgradeSubscription();
                    }
                );
            }

            // Event system for subscription changes
            const subscriptionEventListeners = [];

            function addEventListener(event, callback) {
                if (!subscriptionEventListeners[event]) {
                    subscriptionEventListeners[event] = [];
                }
                subscriptionEventListeners[event].push(callback);
            }

            function removeEventListener(event, callback) {
                if (subscriptionEventListeners[event]) {
                    const index = subscriptionEventListeners[event].indexOf(callback);
                    if (index > -1) {
                        subscriptionEventListeners[event].splice(index, 1);
                    }
                }
            }

            function dispatchEvent(event, data) {
                if (subscriptionEventListeners[event]) {
                    subscriptionEventListeners[event].forEach(callback => {
                        try {
                            callback(data);
                        } catch (error) {
                            console.error('Error in subscription event listener:', error);
                        }
                    });
                }
            }

            // Override refresh to dispatch events
            const originalRefresh = refresh;
            refresh = async function () {
                const oldData = subscriptionData;
                await originalRefresh();

                // Dispatch subscription updated event
                dispatchEvent('subscriptionUpdated', {
                    oldData: oldData,
                    newData: subscriptionData
                });

                // Also dispatch global window event for cross-module communication
                if (window.dispatchEvent) {
                    window.dispatchEvent(new CustomEvent('globalSubscriptionUpdated', {
                        detail: {
                            oldData: oldData,
                            newData: subscriptionData,
                            source: 'ManageSubscriptionModule'
                        }
                    }));
                }
            };

            // Public API
            return {
                // Existing methods
                init: init,
                refresh: refresh,
                reset: reset,
                isInitialized: function () {
                    return isInitialized;
                },
                showConfirmation: showConfirmation,
                upgradeSubscription: upgradeSubscription,
                cancelSubscription: cancelSubscription,

                // Modal handlers for global access
                confirmPendingAction: function () {
                    if (pendingAction) {
                        pendingAction();
                        pendingAction = null;
                    }
                },
                clearPendingAction: function () {
                    pendingAction = null;
                },

                // Global Subscription Management API
                checkUserAccess: checkUserAccess,
                consumeCredits: consumeCredits,
                getSubscriptionStatus: getSubscriptionStatus,
                showUpgradeModal: showUpgradeModal,
                ensureUserHasSubscription: ensureUserHasSubscription,
                createFreeTierSubscription: createFreeTierSubscription,
                forceCreateFreeTier: function () {
                    subscriptionData = createLocalFreeTierSubscription();
                    if (isInitialized && currentContainer) {
                        render();
                    }
                    return subscriptionData;
                },

                // Debug function to diagnose subscription issues
                diagnoseSubscription: async function () {
                    console.log('🔍 === SUBSCRIPTION DIAGNOSIS ===');

                    const currentUser = getCurrentUser();
                    const authToken = getAuthToken();

                    console.log('👤 Current User:', currentUser);
                    console.log('🔑 Auth Token:', authToken ? 'Present' : 'Missing');
                    console.log('📊 Current Subscription Data:', subscriptionData);

                    if (subscriptionData) {
                        console.log('✅ Subscription Data Validation:', isSubscriptionDataValid(subscriptionData));
                    }

                    // Check session storage
                    try {
                        const fallback = sessionStorage.getItem('fallbackSubscription');
                        console.log('💾 Fallback Subscription:', fallback ? JSON.parse(fallback) : 'None');
                    } catch (e) {
                        console.log('💾 Fallback Subscription: Error reading');
                    }

                    console.log('🔍 === END DIAGNOSIS ===');
                    return {
                        user: currentUser,
                        hasAuthToken: !!authToken,
                        subscriptionData: subscriptionData,
                        isValid: subscriptionData ? isSubscriptionDataValid(subscriptionData) : false
                    };
                },

                // Force fix subscription for registered users without plans
                fixRegisteredUserSubscription: async function () {
                    console.log('🔧 Fixing subscription for registered user...');

                    // Clear any existing invalid data
                    subscriptionData = null;
                    sessionStorage.removeItem('fallbackSubscription');

                    // Force creation of free tier
                    try {
                        await ensureUserHasSubscriptionInternal();

                        // Re-render if module is initialized
                        if (isInitialized && currentContainer) {
                            render();
                        }

                        // Trigger global sync
                        if (window.dispatchEvent) {
                            window.dispatchEvent(new CustomEvent('globalSubscriptionUpdated', {
                                detail: {
                                    oldData: null,
                                    newData: subscriptionData,
                                    source: 'ManageSubscriptionModule-FixRegistered'
                                }
                            }));
                        }

                        console.log('✅ Fixed subscription for registered user:', subscriptionData.tier);
                        return { success: true, subscription: subscriptionData };
                    } catch (error) {
                        console.error('❌ Failed to fix registered user subscription:', error);
                        return { success: false, error: error.message };
                    }
                },

                // Event system
                addEventListener: addEventListener,
                removeEventListener: removeEventListener,

                // Direct data access (read-only)
                getSubscriptionData: function () {
                    return subscriptionData ? { ...subscriptionData } : null;
                }
            };
        })();

        // Global functions for modal handling
        function closeModal() {
            const modal = document.getElementById('confirmationModal');
            if (modal) {
                modal.style.display = 'none';
            }
            if (window.jamSubscriptionManager) {
                window.jamSubscriptionManager.clearPendingAction();
            }
        }

        function confirmAction() {
            if (window.jamSubscriptionManager) {
                window.jamSubscriptionManager.confirmPendingAction();
            }
            closeModal();
        }

        // Global function for advanced modal closing
        function closeAdvancedModal() {
            const modal = document.getElementById('advancedModal');
            if (modal) {
                modal.remove();
            }
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('confirmationModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Global module loader function
        function loadManageSubscriptionModule(containerId, forceReload = false) {
            console.log('🔧 Loading ManageSubscriptionModule into:', containerId);

            if (forceReload || !window.jamSubscriptionManager.isInitialized()) {
                return window.jamSubscriptionManager.init(containerId);
            } else {
                window.jamSubscriptionManager.refresh();
                return true;
            }
        }

        // Expose the module globally
        window.jamSubscriptionManager = ManageSubscriptionModule;
        window.loadManageSubscriptionModule = loadManageSubscriptionModule;

        // Auto-initialize only if specifically requested (not when loaded as a module)
        document.addEventListener('DOMContentLoaded', function () {
            // Only auto-initialize if this page is loaded directly (not in an iframe or modal)
            if (window === window.top && window.location.pathname.includes('SubscriptionManager.html')) {
                const container = document.getElementById('subscription-manager-container');
                if (container && window.jamSubscriptionManager) {
                    console.log('Found standalone subscription manager container, initializing');
                    window.jamSubscriptionManager.init('subscription-manager-container');
                }
            }

            // Listen for global subscription updates from other modules (like JamDisputeBot)
            window.addEventListener('globalSubscriptionUpdated', (event) => {
                if (event.detail.source !== 'ManageSubscriptionModule') {
                    console.log('🔄 ManageSubscriptionModule received sync from:', event.detail.source);

                    // Refresh our data to stay in sync
                    if (window.jamSubscriptionManager && window.jamSubscriptionManager.isInitialized()) {
                        console.log('🔄 Refreshing ManageSubscriptionModule data...');
                        window.jamSubscriptionManager.refresh().then(() => {
                            console.log('✅ ManageSubscriptionModule synchronized with', event.detail.source);
                        }).catch(error => {
                            console.error('❌ Error synchronizing ManageSubscriptionModule:', error);
                        });
                    }
                }
            });
        });

        // Signal that the module is loaded
        if (window.dispatchEvent) {
            window.dispatchEvent(new CustomEvent('manageSubscriptionModuleLoaded'));
            console.log('ManageSubscriptionModule loaded and event dispatched');
        }
    </script>

    <!-- Auth Utility -->
    <script src="../js/auth.js"></script>
</body>

</html>