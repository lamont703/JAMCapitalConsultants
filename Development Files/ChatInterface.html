<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JAM AI Chat Interface</title>
    <style>
        /* Basic styling */
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }

        .chat-container {
            max-width: 800px;
            margin: 20px auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            height: 80vh;
        }

        .chat-header {
            padding: 15px;
            background-color: #0056b3;
            color: white;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 70%;
            word-wrap: break-word;
        }

        .user-message {
            background-color: #e6f2ff;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .bot-message {
            background-color: #f0f0f0;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }

        .typing-indicator {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin: 10px 0;
            padding: 12px 16px;
            background-color: #f0f0f0;
            border-radius: 18px;
            max-width: 80%;
        }

        .typing-message {
            margin-bottom: 8px;
            font-size: 14px;
            color: #555;
        }

        .typing-dots {
            display: flex;
        }

        .typing-dots span {
            height: 8px;
            width: 8px;
            margin: 0 2px;
            background-color: #999;
            border-radius: 50%;
            display: inline-block;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(0);
            }
        }

        .chat-input-container {
            display: flex;
            padding: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }

        .send-button {
            background-color: #0056b3;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 20px;
            margin-left: 10px;
            cursor: pointer;
        }

        .file-upload {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .file-upload input {
            display: none;
        }

        .file-upload label {
            background-color: #e0e0e0;
            color: #333;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            margin-right: 10px;
        }

        .file-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .file-item {
            background-color: #f0f0f0;
            padding: 5px 10px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            font-size: 14px;
        }

        .file-item button {
            background: none;
            border: none;
            color: #ff4d4d;
            cursor: pointer;
            margin-left: 5px;
            font-size: 16px;
        }

        .button-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .action-button {
            background-color: #0056b3;
            color: white;
            border: none;
            border-radius: 15px;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 14px;
        }

        .dispute-item {
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
            display: flex;
            align-items: flex-start;
        }

        .dispute-item input[type="checkbox"] {
            margin-right: 10px;
            margin-top: 3px;
        }

        .dispute-submit-btn,
        .save-letters-btn,
        .download-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 15px 2px;
            cursor: pointer;
            border-radius: 4px;
        }

        .dispute-letters {
            margin-top: 15px;
        }

        .dispute-letter {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .dispute-letter pre {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            background-color: white;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
        }

        .letter-editor {
            margin-bottom: 20px;
        }

        .letter-content {
            width: 100%;
            padding: 10px;
            font-family: 'Courier New', monospace;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .formatted-content {
            font-family: Arial, sans-serif;
            line-height: 1.5;
        }

        .formatted-content h1 {
            font-size: 1.8em;
            color: #2c3e50;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }

        .formatted-content h2 {
            font-size: 1.5em;
            color: #3498db;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }

        .formatted-content h3 {
            font-size: 1.2em;
            color: #2980b9;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }

        .formatted-content strong {
            font-weight: bold;
            color: #e74c3c;
        }

        .formatted-content ul,
        .formatted-content ol {
            margin-left: 1.5em;
            margin-bottom: 1em;
        }

        .formatted-content li {
            margin-bottom: 0.5em;
        }
    </style>
</head>

<body>
    <div class="chat-container">
        <div class="chat-header">
            <h2>JAM AI Credit Repair Assistant</h2>
        </div>

        <div class="chat-messages" id="chat-messages">
            <!-- Messages will be added here dynamically -->
        </div>

        <div class="typing-indicator" id="typing-indicator">
            <span></span>
            <span></span>
            <span></span>
        </div>

        <div class="file-upload">
            <input type="file" id="file-input" accept=".pdf,.jpg,.jpeg,.png" multiple>
            <label for="file-input">Upload Credit Reports</label>
            <div class="file-list" id="file-list"></div>
        </div>

        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chat-input" placeholder="Type your message here...">
            <button class="send-button" id="send-button">Send</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            console.log('ChatInterface: DOM loaded, initializing chat interface');

            // DOM elements
            const chatMessages = document.querySelector('.chat-messages');
            const chatInput = document.querySelector('.chat-input');
            const sendButton = document.querySelector('.send-button');
            const fileInput = document.querySelector('#file-input');
            const fileList = document.querySelector('.file-list');
            const typingIndicator = document.querySelector('.typing-indicator');

            // State variables
            let messages = [];
            let uploadedFiles = [];
            let sessionPageLoadFlag = true;

            // Function to scroll to bottom of chat
            function scrollToBottom() {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // Function to show typing indicator
            function showTypingIndicator() {
                console.log('ChatInterface: Showing typing indicator');
                typingIndicator.style.display = 'block';
                scrollToBottom();
            }

            // Function to hide typing indicator
            function hideTypingIndicator() {
                console.log('ChatInterface: Hiding typing indicator');
                typingIndicator.style.display = 'none';
            }

            // Function to add a user message
            function addUserMessage(message) {
                console.log('ChatInterface: Adding user message:', message);

                messages.push({
                    type: 'user',
                    content: message,
                    timestamp: new Date()
                });

                // Add to UI
                const messageElement = document.createElement('div');
                messageElement.className = 'message user-message';
                messageElement.textContent = message;
                chatMessages.appendChild(messageElement);

                // Scroll to bottom
                scrollToBottom();

                // Save to localStorage
                localStorage.setItem('jamBotChatMessages', JSON.stringify(messages));
            }

            // Add this function to convert markdown-like text to HTML
            function markdownToHtml(text) {
                // Handle headings
                text = text.replace(/^# (.*$)/gm, '<h1>$1</h1>');
                text = text.replace(/^## (.*$)/gm, '<h2>$1</h2>');
                text = text.replace(/^### (.*$)/gm, '<h3>$1</h3>');

                // Handle bold text
                text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

                // Handle list items (assuming they start with numbers followed by a period)
                text = text.replace(/^\d+\. (.*$)/gm, '<div class="list-item">$1</div>');

                // Handle indented list items (assuming they start with a dash)
                text = text.replace(/^- (.*$)/gm, '<div class="list-item-detail">$1</div>');

                // Handle paragraphs (any line that's not a heading or list item)
                const lines = text.split('\n');
                let inParagraph = false;
                let result = '';

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];

                    // Skip empty lines
                    if (line.trim() === '') {
                        if (inParagraph) {
                            result += '</p>\n';
                            inParagraph = false;
                        }
                        continue;
                    }

                    // If the line is already processed as a heading or list item, add it as is
                    if (line.startsWith('<h') || line.startsWith('<div class="list-item') || line.includes('<strong>')) {
                        if (inParagraph) {
                            result += '</p>\n';
                            inParagraph = false;
                        }
                        result += line + '\n';
                    } else {
                        // Otherwise, treat it as part of a paragraph
                        if (!inParagraph) {
                            result += '<p>';
                            inParagraph = true;
                        } else {
                            result += ' ';
                        }
                        result += line;
                    }
                }

                // Close any open paragraph
                if (inParagraph) {
                    result += '</p>\n';
                }

                return result;
            }

            // Modify the addBotMessage function to handle markdown content
            function addBotMessage(message, buttons = []) {
                console.log('ChatInterface: Adding bot message:', message);

                const messageDiv = document.createElement('div');
                messageDiv.className = 'bot-message';

                // Check if the message contains markdown-like formatting
                if (message.includes('# ') || message.includes('## ') || message.includes('### ') ||
                    message.includes('**') || /^\d+\. /.test(message)) {

                    // Convert markdown to HTML
                    const formattedContent = document.createElement('div');
                    formattedContent.className = 'formatted-content';
                    formattedContent.innerHTML = markdownToHtml(message);

                    messageDiv.appendChild(formattedContent);
                } else if (message.includes('<h1>') || message.includes('<h2>') || message.includes('<h3>') ||
                    message.includes('<br>') || message.includes('<strong>')) {

                    // Handle already formatted HTML
                    const formattedContent = document.createElement('div');
                    formattedContent.className = 'formatted-content';
                    formattedContent.innerHTML = message;

                    messageDiv.appendChild(formattedContent);
                } else {
                    // For regular text messages
                    const textDiv = document.createElement('div');
                    textDiv.textContent = message;
                    messageDiv.appendChild(textDiv);
                }

                // Add buttons if provided
                if (buttons.length > 0) {
                    const buttonsDiv = document.createElement('div');
                    buttonsDiv.className = 'message-buttons';

                    buttons.forEach(button => {
                        const buttonElement = document.createElement('button');
                        buttonElement.textContent = button.text;
                        buttonElement.onclick = () => handleButtonClick(button.value);
                        buttonsDiv.appendChild(buttonElement);
                    });

                    messageDiv.appendChild(buttonsDiv);
                }

                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // Function to redraw all messages
            function redrawMessages() {
                console.log('ChatInterface: Redrawing messages');

                // Clear chat messages
                chatMessages.innerHTML = '';

                // Redraw all messages
                messages.forEach(msg => {
                    if (msg.type === 'user') {
                        const messageElement = document.createElement('div');
                        messageElement.className = 'message user-message';
                        messageElement.textContent = msg.content;
                        chatMessages.appendChild(messageElement);
                    } else if (msg.type === 'bot') {
                        const messageElement = document.createElement('div');
                        messageElement.className = 'message bot-message';
                        messageElement.textContent = msg.content;

                        // Add buttons if provided
                        if (msg.buttons && msg.buttons.length > 0) {
                            const buttonContainer = document.createElement('div');
                            buttonContainer.className = 'button-container';

                            msg.buttons.forEach(button => {
                                const buttonElement = document.createElement('button');
                                buttonElement.className = 'action-button';
                                buttonElement.textContent = button.text;
                                buttonElement.addEventListener('click', () => handleButtonClick(button.value));
                                buttonContainer.appendChild(buttonElement);
                            });

                            messageElement.appendChild(buttonContainer);
                        }

                        chatMessages.appendChild(messageElement);
                    }
                });

                // Scroll to bottom
                scrollToBottom();
                console.log('ChatInterface: Messages redrawn successfully');
            }

            // Function to check if reports have been uploaded
            function checkForUploadedReports() {
                console.log('ChatInterface: Checking for uploaded reports');

                try {
                    // Check if we have the flag in localStorage
                    const hasUploadedReportsFlag = localStorage.getItem('jamBotHasUploadedReports');

                    // Check if we have any reports in localStorage
                    const savedReportsJson = localStorage.getItem('jamBotUploadedReports');
                    let hasReports = false;

                    if (savedReportsJson) {
                        const savedReports = JSON.parse(savedReportsJson);
                        hasReports = savedReports.length > 0;
                        console.log(`ChatInterface: Found ${savedReports.length} reports in localStorage`);
                    }

                    const result = hasUploadedReportsFlag === 'true' || hasReports;
                    console.log('ChatInterface: hasUploadedReports result:', result);
                    return result;
                } catch (e) {
                    console.error('ChatInterface: Error checking for uploaded reports:', e);
                    return false;
                }
            }

            // Function to add a file to the UI
            function addFileToUI(fileId, fileName) {
                console.log(`ChatInterface: Adding file to UI: ${fileName} (${fileId})`);

                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.dataset.id = fileId;

                fileItem.innerHTML = `
                    <div class="file-icon">📄</div>
                    <div class="file-name">${fileName}</div>
                    <button class="file-delete" data-id="${fileId}">×</button>
                `;

                fileList.appendChild(fileItem);

                // Add event listener to delete button
                const deleteButton = fileItem.querySelector('.file-delete');
                deleteButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    deleteFile(fileId);
                });
            }

            // Function to delete a file
            function deleteFile(fileId) {
                console.log(`ChatInterface: Deleting file: ${fileId}`);

                // Remove from uploadedFiles array
                uploadedFiles = uploadedFiles.filter(file => file.id !== fileId);

                // Remove from localStorage
                localStorage.removeItem(`jamBotFile_${fileId}`);

                // Remove from UI
                const fileItem = fileList.querySelector(`.file-item[data-id="${fileId}"]`);
                if (fileItem) {
                    fileList.removeChild(fileItem);
                }

                // Update uploadedReports in localStorage
                const uploadedReports = uploadedFiles.map(file => ({
                    id: file.id,
                    name: file.name,
                    size: file.size,
                    uploadDate: new Date().toISOString()
                }));

                localStorage.setItem('jamBotUploadedReports', JSON.stringify(uploadedReports));

                // If no files left, remove the hasUploadedReports flag
                if (uploadedFiles.length === 0) {
                    console.log('ChatInterface: No files left, removing hasUploadedReports flag');
                    localStorage.removeItem('jamBotHasUploadedReports');

                    // Also remove the report message from chat if it exists
                    const hasReportMessage = messages.some(msg =>
                        msg.type === 'bot' && msg.content.includes("I see you've uploaded your credit reports")
                    );

                    if (hasReportMessage) {
                        console.log('ChatInterface: Removing report message from chat');

                        // Filter out the report message and related responses
                        messages = messages.filter(msg => {
                            const shouldKeep = !(
                                (msg.type === 'bot' && msg.content.includes("I see you've uploaded your credit reports")) ||
                                (msg.type === 'user' && (
                                    msg.content.includes("Yes, analyze my reports") ||
                                    msg.content.includes("No, I'll ask something else")
                                ))
                            );

                            if (!shouldKeep) {
                                console.log('ChatInterface: Filtering out message:', msg.content.substring(0, 50) + '...');
                            }

                            return shouldKeep;
                        });

                        // Save to localStorage
                        localStorage.setItem('jamBotChatMessages', JSON.stringify(messages));

                        // Redraw messages
                        redrawMessages();
                    }
                }

                console.log('ChatInterface: File deleted successfully');
            }

            // Function to send reports for analysis
            async function sendReportsForAnalysis(reportFiles, forceRefresh = false) {
                console.log(`ChatInterface: Sending ${reportFiles.length} report files for analysis${forceRefresh ? ' (forced refresh)' : ''}`);

                // Create a FormData object to send the files
                const formData = new FormData();
                let filesAdded = 0;

                // Add each file to the FormData
                for (const file of reportFiles) {
                    console.log('ChatInterface: Processing file:', file);

                    // If file is a File object directly
                    if (file instanceof File) {
                        formData.append('file', file, file.name);
                        console.log(`ChatInterface: Added File object directly: ${file.name}`);
                        filesAdded++;
                        continue;
                    }

                    // If file has a file property that is a File object
                    if (file.file instanceof File) {
                        formData.append('file', file.file, file.name);
                        console.log(`ChatInterface: Added file from file property: ${file.name}`);
                        filesAdded++;
                        continue;
                    }

                    // If file has an id, try to get it from localStorage
                    if (file.id) {
                        const fileData = localStorage.getItem(file.id);
                        if (fileData) {
                            try {
                                const parsedData = JSON.parse(fileData);
                                if (parsedData.data && parsedData.data.startsWith('data:')) {
                                    const base64Data = parsedData.data.split(',')[1];
                                    const byteCharacters = atob(base64Data);
                                    const byteArrays = [];

                                    for (let i = 0; i < byteCharacters.length; i++) {
                                        byteArrays.push(byteCharacters.charCodeAt(i));
                                    }

                                    const byteArray = new Uint8Array(byteArrays);
                                    const blob = new Blob([byteArray], { type: parsedData.type || 'application/pdf' });

                                    formData.append('file', blob, parsedData.name || file.name);
                                    console.log(`ChatInterface: Added file from localStorage: ${parsedData.name || file.name}`);
                                    filesAdded++;
                                    continue;
                                }
                            } catch (e) {
                                console.error('ChatInterface: Error processing file from localStorage:', e);
                            }
                        }
                    }

                    console.error('ChatInterface: Could not process file:', file.name);
                }

                console.log(`ChatInterface: Successfully added ${filesAdded} files to FormData`);

                if (filesAdded === 0) {
                    console.error('ChatInterface: No valid files could be processed');
                    return {
                        summary: "I couldn't process any of your credit report files. Please make sure they're in a supported format.",
                        fullAnalysis: "There was an error processing your files. Please try uploading them again or contact support.",
                        hasFindings: false
                    };
                }

                // Add the forceRefresh parameter if needed
                if (forceRefresh) {
                    formData.append('forceRefresh', 'true');
                }

                // Send the request to the backend
                console.log('ChatInterface: Sending files to backend...');

                try {
                    // Send the request and wait for the response
                    const response = await fetch('http://localhost:3000/api/chatGptService/analyzeReports', {
                        method: 'POST',
                        body: formData
                    });

                    console.log(`ChatInterface: Backend response status:`, response.status);

                    // Handle non-OK responses
                    if (!response.ok) {
                        console.error(`ChatInterface: Server error with status ${response.status}`);
                        return {
                            summary: "I encountered an error while analyzing your reports.",
                            fullAnalysis: `The server responded with status code ${response.status}. Please try again later or contact support.`,
                            hasFindings: false
                        };
                    }

                    // Get the response data
                    console.log('ChatInterface: Reading response data...');
                    const responseData = await response.json();
                    console.log('ChatInterface: Response data received:', responseData);

                    // Create a properly structured result object
                    const result = {
                        summary: responseData.summary || "I've analyzed your credit reports and found several items that could potentially be disputed.",
                        fullAnalysis: responseData.formattedAnalysis || responseData.analysis || responseData.detailedAnalysis || "Would you like me to explain the specific items I found?",
                        hasFindings: responseData.foundItems || true,
                        fromCache: responseData.fromCache || false
                    };

                    console.log(`ChatInterface: Returning structured result:`, result);
                    return result;
                } catch (error) {
                    console.error('ChatInterface: Error in sendReportsForAnalysis:', error);
                    return {
                        summary: "I encountered an error while analyzing your reports.",
                        fullAnalysis: `Error: ${error.message}. Please try again later or contact support.`,
                        hasFindings: false
                    };
                }
            }

            // Function to show typing indicator
            function showTypingIndicator() {
                const typingIndicator = document.createElement('div');
                typingIndicator.className = 'typing-indicator';
                typingIndicator.id = 'typing-indicator';

                // Add message div
                const messageDiv = document.createElement('div');
                messageDiv.className = 'typing-message';
                messageDiv.textContent = 'Analyzing your credit reports...';
                typingIndicator.appendChild(messageDiv);

                // Add dots container
                const dotsDiv = document.createElement('div');
                dotsDiv.className = 'typing-dots';
                dotsDiv.innerHTML = '<span></span><span></span><span></span>';
                typingIndicator.appendChild(dotsDiv);

                chatMessages.appendChild(typingIndicator);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // Function to update typing indicator message
            function updateTypingIndicatorMessage(message) {
                const messageDiv = document.querySelector('.typing-message');
                if (messageDiv) {
                    messageDiv.textContent = message;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }

            // Function to handle button clicks
            function handleButtonClick(value) {
                console.log('ChatInterface: Button clicked with value:', value);

                if (value === 'analyze_reports') {
                    console.log('ChatInterface: User clicked to analyze reports');

                    // Add user message
                    addUserMessage("Yes, analyze my reports");

                    // Show typing indicator with initial message
                    showTypingIndicator();
                    updateTypingIndicatorMessage("Starting analysis of your credit reports...");

                    // Get the credit report files
                    const reportFiles = uploadedFiles;

                    if (reportFiles.length === 0) {
                        console.error('ChatInterface: No report files found');
                        hideTypingIndicator();
                        addBotMessage("I couldn't find any credit report files to analyze. Please make sure you've uploaded your reports.");
                        return;
                    }

                    // Define analysis steps with appropriate timing for a ~20 second process
                    const analysisSteps = [
                        { message: "Checking for cached analysis...", time: 0 },
                        { message: "Extracting text from your credit reports...", time: 2000 },
                        { message: "Processing account information...", time: 6000 },
                        { message: "Identifying potential dispute items...", time: 10000 },
                        { message: "Analyzing credit history patterns...", time: 14000 },
                        { message: "Finalizing your credit report analysis...", time: 18000 }
                    ];

                    // Set up timers for each step
                    const stepTimers = analysisSteps.map(step => {
                        return setTimeout(() => {
                            updateTypingIndicatorMessage(step.message);
                        }, step.time);
                    });

                    // Add a dot animation for continuous feedback
                    let dots = 0;
                    const dotsInterval = setInterval(() => {
                        dots = (dots + 1) % 4;
                        const currentMessage = document.querySelector('.typing-message')?.textContent || '';
                        const baseMessage = currentMessage.replace(/\.{1,3}$/, '');
                        updateTypingIndicatorMessage(`${baseMessage}${'.'.repeat(dots)}`);
                    }, 500);

                    // Use async/await with proper cleanup
                    (async () => {
                        try {
                            console.log('ChatInterface: Starting analysis...');
                            const response = await sendReportsForAnalysis(reportFiles);
                            console.log('ChatInterface: Analysis complete:', response);

                            // Clear all timers
                            stepTimers.forEach(timer => clearTimeout(timer));
                            clearInterval(dotsInterval);

                            // Hide typing indicator
                            hideTypingIndicator();

                            // Add bot message with the summary and buttons
                            addBotMessage(
                                (response.fromCache ? "📋 Using previously analyzed results: " : "") + response.summary,
                                [
                                    { text: "Show me the details", value: "show_analysis_details" },
                                    { text: "Help me dispute these items", value: "start_disputes" }
                                ]
                            );

                            // Store the full analysis for later
                            sessionStorage.setItem('creditReportAnalysis', response.fullAnalysis);
                        } catch (error) {
                            // Clear all timers
                            stepTimers.forEach(timer => clearTimeout(timer));
                            clearInterval(dotsInterval);

                            console.error('ChatInterface: Error in analysis process:', error);
                            hideTypingIndicator();
                            addBotMessage("I encountered an error while analyzing your reports. Please try again later or contact support if the problem persists.");
                        }
                    })();
                } else if (value === 'show_analysis_details') {
                    // Add user message
                    addUserMessage("Show me the details");

                    // Retrieve the stored full analysis
                    const fullAnalysis = sessionStorage.getItem('creditReportAnalysis');
                    if (fullAnalysis) {
                        // Add the full analysis with proper formatting
                        addBotMessage(fullAnalysis, [
                            { text: "Help me dispute these items", value: "start_disputes" }
                        ]);
                    } else {
                        addBotMessage("I'm sorry, I couldn't retrieve the detailed analysis. Would you like me to analyze your reports again?", [
                            { text: "Analyze again", value: "analyze_reports" }
                        ]);
                    }
                } else if (value === 'refresh_analysis') {
                    // Add user message
                    addUserMessage("Please refresh my analysis");

                    // Show typing indicator
                    showTypingIndicator();
                    updateTypingIndicatorMessage("Starting a fresh analysis of your credit reports...");

                    // Get the credit report files
                    const reportFiles = uploadedFiles;

                    if (reportFiles.length === 0) {
                        hideTypingIndicator();
                        addBotMessage("I couldn't find any credit report files to analyze. Please make sure you've uploaded your reports.");
                        return;
                    }

                    // Similar to analyze_reports but with forceRefresh=true
                    // ... (similar code to analyze_reports with forceRefresh=true)
                } else if (value === 'start_disputes') {
                    // Add user message
                    addUserMessage("Help me dispute these items");

                    // Get the full analysis from session storage
                    const fullAnalysis = sessionStorage.getItem('creditReportAnalysis');
                    if (!fullAnalysis) {
                        addBotMessage("I couldn't find your credit report analysis. Let's analyze your reports first.", [
                            { text: "Analyze my reports", value: "analyze_reports" }
                        ]);
                        return;
                    }

                    // Extract dispute items from the analysis
                    const disputeItems = extractDisputeItems(fullAnalysis);

                    // Show typing indicator briefly
                    showTypingIndicator();

                    // Use setTimeout to simulate processing time
                    setTimeout(() => {
                        hideTypingIndicator();

                        // Add bot message explaining the dispute process
                        addBotMessage(
                            "I've identified the following items from your credit report that you might want to dispute. " +
                            "Please select the items you'd like to generate dispute letters for:",
                            []
                        );

                        // Show the dispute item selection interface
                        handleDisputeItemSelection(disputeItems);
                    }, 1500);
                } else if (value === 'edit_letters') {
                    // Add user message
                    addUserMessage("I'd like to edit the letters");

                    // Get the letters from session storage
                    const letters = JSON.parse(sessionStorage.getItem('disputeLetters') || '[]');
                    if (letters.length === 0) {
                        addBotMessage("I couldn't find any dispute letters. Let's create some first.", [
                            { text: "Start disputes", value: "start_disputes" }
                        ]);
                        return;
                    }

                    // Show letter editing interface
                    // This would be a more complex UI component that allows editing letter content
                    addBotMessage(
                        "You can edit your dispute letters below. When you're done, click 'Save Changes' to update the letters.",
                        []
                    );

                    // Create editable letter interface
                    const editInterface = document.createElement('div');
                    editInterface.className = 'letter-edit-interface';

                    letters.forEach((letter, index) => {
                        const letterEditor = document.createElement('div');
                        letterEditor.className = 'letter-editor';

                        const letterHeader = document.createElement('h4');
                        letterHeader.textContent = `Letter ${index + 1}: ${letter.recipient || 'Credit Bureau'}`;

                        const letterTextarea = document.createElement('textarea');
                        letterTextarea.className = 'letter-content';
                        letterTextarea.id = `letter-${index}`;
                        letterTextarea.rows = 15;
                        letterTextarea.value = letter.content;

                        letterEditor.appendChild(letterHeader);
                        letterEditor.appendChild(letterTextarea);
                        editInterface.appendChild(letterEditor);
                    });

                    const saveButton = document.createElement('button');
                    saveButton.className = 'save-letters-btn';
                    saveButton.textContent = 'Save Changes';
                    saveButton.onclick = () => {
                        const updatedLetters = [];

                        letters.forEach((letter, index) => {
                            const textarea = document.getElementById(`letter-${index}`);
                            updatedLetters.push({
                                ...letter,
                                content: textarea.value
                            });
                        });

                        // Save updated letters
                        sessionStorage.setItem('disputeLetters', JSON.stringify(updatedLetters));

                        // Confirm to user
                        addBotMessage("Your changes have been saved. You can now download your updated letters.", [
                            { text: "Show my letters", value: "show_letters" }
                        ]);
                    };

                    editInterface.appendChild(saveButton);
                    chatMessages.appendChild(editInterface);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                } else if (value === 'show_letters') {
                    // Add user message
                    addUserMessage("Show my letters");

                    // Get the letters from session storage
                    const letters = JSON.parse(sessionStorage.getItem('disputeLetters') || '[]');
                    if (letters.length === 0) {
                        addBotMessage("I couldn't find any dispute letters. Let's create some first.", [
                            { text: "Start disputes", value: "start_disputes" }
                        ]);
                        return;
                    }

                    // Display the letters
                    const lettersHtml = `
                        <h3>Your Dispute Letters</h3>
                        <div class="dispute-letters">
                            ${letters.map((letter, index) => `
                                <div class="dispute-letter">
                                    <h4>Letter ${index + 1}: ${letter.recipient || 'Credit Bureau'}</h4>
                                    <pre>${letter.content}</pre>
                                    <button class="download-btn" onclick="downloadLetter(${index})">Download as PDF</button>
                                </div>
                            `).join('')}
                        </div>
                    `;

                    addBotMessage(lettersHtml, [
                        { text: "Start over", value: "start_over" },
                        { text: "Edit letters", value: "edit_letters" }
                    ]);
                } else if (value === 'start_over') {
                    // Add user message
                    addUserMessage("I'd like to start over");

                    // Clear any stored analysis and letters
                    sessionStorage.removeItem('creditReportAnalysis');
                    sessionStorage.removeItem('disputeLetters');

                    // Welcome message with options
                    addBotMessage(
                        "Let's start fresh! What would you like to do?",
                        [
                            { text: "Analyze my credit reports", value: "analyze_reports" },
                            { text: "Ask a question about credit repair", value: "ask_question" }
                        ]
                    );
                }
            }

            // Helper function to convert markdown to HTML
            function convertMarkdownToHtml(markdown) {
                // This is a simple implementation - you might want to use a proper markdown library
                return markdown
                    .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                    .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                    .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                    .replace(/\*\*(.*)\*\*/gm, '<strong>$1</strong>')
                    .replace(/\*(.*)\*/gm, '<em>$1</em>')
                    .replace(/\n/gm, '<br>');
            }

            // Function to load uploaded files
            function loadUploadedFiles() {
                console.log('ChatInterface: Loading uploaded files');

                try {
                    // Clear existing files
                    uploadedFiles = [];
                    fileList.innerHTML = '';

                    // Get saved reports from localStorage
                    const savedReportsJson = localStorage.getItem('jamBotUploadedReports');
                    if (!savedReportsJson) {
                        console.log('ChatInterface: No saved reports found in localStorage');
                        return;
                    }

                    const savedReports = JSON.parse(savedReportsJson);
                    console.log(`ChatInterface: Found ${savedReports.length} saved reports`);

                    // Load each file
                    savedReports.forEach(report => {
                        const fileDataKey = 'jamBotFile_' + report.id;
                        const fileDataJson = localStorage.getItem(fileDataKey);

                        if (fileDataJson) {
                            try {
                                const fileData = JSON.parse(fileDataJson);

                                console.log(`ChatInterface: Loaded file from localStorage: ${report.name} (${report.id})`);

                                // Add to uploadedFiles array
                                uploadedFiles.push({
                                    id: report.id,
                                    name: report.name,
                                    type: fileData.type,
                                    size: fileData.size,
                                    data: fileData.data
                                });

                                // Add to UI
                                addFileToUI(report.id, report.name);
                            } catch (e) {
                                console.error(`ChatInterface: Error parsing file data for ${report.name}:`, e);
                            }
                        } else {
                            console.log(`ChatInterface: No file data found for report: ${report.name}`);
                        }
                    });
                } catch (e) {
                    console.error('ChatInterface: Error loading uploaded files:', e);
                }
            }

            // Function to load saved messages
            function loadSavedMessages() {
                console.log('ChatInterface: Loading saved messages from localStorage');

                try {
                    const savedMessagesJson = localStorage.getItem('jamBotChatMessages');
                    if (savedMessagesJson) {
                        const savedMessages = JSON.parse(savedMessagesJson);
                        console.log(`ChatInterface: Found ${savedMessages.length} saved messages`);

                        // Check if we have the report message but no reports
                        const hasReportMessage = savedMessages.some(msg =>
                            msg.type === 'bot' && msg.content.includes("I see you've uploaded your credit reports")
                        );

                        console.log('ChatInterface: Has report message:', hasReportMessage);

                        if (hasReportMessage) {
                            const hasReports = checkForUploadedReports();
                            console.log('ChatInterface: hasUploadedReports result:', hasReports);

                            if (!hasReports) {
                                console.log('ChatInterface: Filtering out report messages');

                                // Filter out the report message and related responses
                                messages = savedMessages.filter(msg => {
                                    const shouldKeep = !(
                                        (msg.type === 'bot' && msg.content.includes("I see you've uploaded your credit reports")) ||
                                        (msg.type === 'user' && (
                                            msg.content.includes("Yes, analyze my reports") ||
                                            msg.content.includes("No, I'll ask something else")
                                        ))
                                    );

                                    if (!shouldKeep) {
                                        console.log('ChatInterface: Filtering out message:', msg.content.substring(0, 50) + '...');
                                    }

                                    return shouldKeep;
                                });

                                // Save the filtered messages back to localStorage
                                localStorage.setItem('jamBotChatMessages', JSON.stringify(messages));
                            } else {
                                messages = savedMessages;
                            }
                        } else {
                            messages = savedMessages;
                        }

                        // Redraw messages
                        redrawMessages();
                    } else {
                        console.log('ChatInterface: No saved messages found');

                        // Add welcome message
                        addBotMessage("Hi there! I'm your JAM AI assistant. How can I help you with credit repair today?");

                        // Check if reports have been uploaded
                        const hasUploadedReports = checkForUploadedReports();
                        console.log('ChatInterface: hasUploadedReports result:', hasUploadedReports);

                        if (hasUploadedReports) {
                            console.log('ChatInterface: Adding report analysis prompt');

                            // Add the report analysis prompt
                            addBotMessage(
                                "I see you've uploaded your credit reports. Would you like me to analyze them for potential items to dispute?",
                                [
                                    { text: "Yes, analyze my reports", value: "analyze_reports" },
                                    { text: "No, I'll ask something else", value: "skip_analysis" }
                                ]
                            );
                        }
                    }
                } catch (e) {
                    console.error('ChatInterface: Error loading saved messages:', e);

                    // Add welcome message as fallback
                    addBotMessage("Hi there! I'm your JAM AI assistant. How can I help you with credit repair today?");
                }
            }

            // Function to debug localStorage
            function debugLocalStorage() {
                console.log('--- ChatInterface localStorage Debug ---');

                // Get all localStorage keys
                const keys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    keys.push(localStorage.key(i));
                }

                console.log('All localStorage keys:');
                keys.forEach((key, index) => {
                    const size = localStorage.getItem(key).length;
                    console.log(`${index + 1}. ${key}: ${size} bytes`);
                });

                // Check for JAM Bot specific items
                const jamBotItems = keys.filter(key => key.startsWith('jamBot'));
                console.log(`\nSummary:`);
                console.log(`Total localStorage items: ${keys.length}`);
                console.log(`JAM Bot items: ${jamBotItems.length}`);
                console.log(`------------------------`);
            }

            // Set up event listeners
            sendButton.addEventListener('click', function () {
                const message = chatInput.value.trim();
                if (message) {
                    // Add user message
                    addUserMessage(message);

                    // Clear input
                    chatInput.value = '';

                    // Show typing indicator
                    showTypingIndicator();

                    // Send message to backend
                    fetch('http://localhost:3000/api/chatGptService/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ message })
                    })
                        .then(response => response.json())
                        .then(data => {
                            // Hide typing indicator
                            hideTypingIndicator();

                            // Add bot response
                            addBotMessage(data.response);
                        })
                        .catch(error => {
                            console.error('ChatInterface: Error sending message to backend:', error);

                            // Hide typing indicator
                            hideTypingIndicator();

                            // Add error message
                            addBotMessage("I'm sorry, I encountered an error. Please try again later.");
                        });
                }
            });

            chatInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    sendButton.click();
                }
            });

            fileInput.addEventListener('change', function (e) {
                const files = e.target.files;
                if (files.length > 0) {
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];

                        // Check if file is a valid type (PDF, JPG, PNG)
                        if (!['application/pdf', 'image/jpeg', 'image/png'].includes(file.type)) {
                            console.error(`ChatInterface: Invalid file type: ${file.type}`);
                            alert('Please upload only PDF, JPG, or PNG files.');
                            continue;
                        }

                        console.log(`ChatInterface: Processing file: ${file.name} (${file.type})`);

                        // Generate a unique ID for the file
                        const fileId = 'file_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);

                        // Add to uploadedFiles array
                        uploadedFiles.push({
                            id: fileId,
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            file: file
                        });

                        // Add to UI
                        addFileToUI(fileId, file.name);

                        // Read file as base64
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            // Store in localStorage
                            try {
                                localStorage.setItem(`jamBotFile_${fileId}`, JSON.stringify({
                                    id: fileId,
                                    name: file.name,
                                    type: file.type,
                                    size: file.size,
                                    data: e.target.result
                                }));

                                console.log(`ChatInterface: File stored in localStorage: ${fileId}`);

                                // Update uploadedReports in localStorage
                                const uploadedReports = uploadedFiles.map(file => ({
                                    id: file.id,
                                    name: file.name,
                                    size: file.size,
                                    uploadDate: new Date().toISOString()
                                }));

                                localStorage.setItem('jamBotUploadedReports', JSON.stringify(uploadedReports));
                                localStorage.setItem('jamBotHasUploadedReports', 'true');

                                // Check if we need to add the report message
                                const hasReportMessage = messages.some(msg =>
                                    msg.type === 'bot' && msg.content.includes("I see you've uploaded your credit reports")
                                );

                                if (!hasReportMessage) {
                                    console.log('ChatInterface: Adding report analysis prompt');

                                    // Add the report analysis prompt
                                    addBotMessage(
                                        "I see you've uploaded your credit reports. Would you like me to analyze them for potential items to dispute?",
                                        [
                                            { text: "Yes, analyze my reports", value: "analyze_reports" },
                                            { text: "No, I'll ask something else", value: "skip_analysis" }
                                        ]
                                    );
                                }
                            } catch (e) {
                                console.error(`ChatInterface: Error storing file in localStorage: ${e.message}`);
                                alert('Error storing file. The file might be too large for localStorage.');
                            }
                        };

                        reader.readAsDataURL(file);
                    }

                    // Reset file input
                    fileInput.value = '';
                }
            });

            // Initialize
            debugLocalStorage();
            loadSavedMessages();
            loadUploadedFiles();
            console.log('ChatInterface: Initialization complete');
        });

        // Add this function to handle dispute item selection
        function handleDisputeItemSelection(items) {
            // Create a message with selectable dispute items
            const disputeItemsMessage = document.createElement('div');
            disputeItemsMessage.className = 'bot-message';

            // Create header
            const header = document.createElement('h3');
            header.textContent = 'Select items to dispute:';
            disputeItemsMessage.appendChild(header);

            // Create form with checkboxes for each item
            const form = document.createElement('form');
            form.id = 'dispute-items-form';

            items.forEach((item, index) => {
                const itemContainer = document.createElement('div');
                itemContainer.className = 'dispute-item';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `dispute-item-${index}`;
                checkbox.value = index;

                const label = document.createElement('label');
                label.htmlFor = `dispute-item-${index}`;
                label.innerHTML = item.description || item;

                itemContainer.appendChild(checkbox);
                itemContainer.appendChild(label);
                form.appendChild(itemContainer);
            });

            // Add submit button
            const submitButton = document.createElement('button');
            submitButton.type = 'button';
            submitButton.className = 'dispute-submit-btn';
            submitButton.textContent = 'Generate Dispute Letters';
            submitButton.onclick = () => {
                const selectedItems = [];
                document.querySelectorAll('#dispute-items-form input:checked').forEach(checkbox => {
                    selectedItems.push(items[parseInt(checkbox.value)]);
                });

                if (selectedItems.length === 0) {
                    alert('Please select at least one item to dispute.');
                    return;
                }

                // Generate dispute letters for selected items
                generateDisputeLetters(selectedItems);
            };

            form.appendChild(submitButton);
            disputeItemsMessage.appendChild(form);

            // Add to chat
            chatMessages.appendChild(disputeItemsMessage);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Function to extract dispute items from analysis
        function extractDisputeItems(analysis) {
            // This is a simple implementation - you might need more sophisticated parsing
            // based on your actual analysis format
            const items = [];

            // Split by numbered items or bullet points
            const lines = analysis.split('\n');
            let currentItem = '';

            for (const line of lines) {
                // Check if line starts a new item (numbered or bullet)
                if (/^\d+[\.\)]|^•|^\-\s/.test(line.trim())) {
                    if (currentItem) {
                        items.push(currentItem.trim());
                    }
                    currentItem = line;
                } else if (currentItem) {
                    currentItem += ' ' + line;
                }
            }

            // Add the last item
            if (currentItem) {
                items.push(currentItem.trim());
            }

            return items.length > 0 ? items : [
                "Late payment on Capital One account from January 2023",
                "Collections account from ABC Collections that is over 7 years old",
                "Incorrect account balance on Chase credit card"
            ]; // Fallback items if parsing fails
        }

        // Function to generate dispute letters
        async function generateDisputeLetters(selectedItems) {
            // Show typing indicator
            showTypingIndicator();
            updateTypingIndicatorMessage("Generating dispute letters...");

            try {
                // Prepare the request
                const response = await fetch('http://localhost:3000/api/chatGptService/generateDisputeLetters', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ items: selectedItems })
                });

                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }

                const data = await response.json();
                hideTypingIndicator();

                // Display the generated letters
                const lettersHtml = `
                    <h3>Your Dispute Letters</h3>
                    <div class="dispute-letters">
                        ${data.letters.map((letter, index) => `
                            <div class="dispute-letter">
                                <h4>Letter ${index + 1}: ${letter.recipient || 'Credit Bureau'}</h4>
                                <pre>${letter.content}</pre>
                                <button class="download-btn" onclick="downloadLetter(${index})">Download as PDF</button>
                            </div>
                        `).join('')}
                    </div>
                `;

                addBotMessage(lettersHtml, [
                    { text: "Start over", value: "start_over" },
                    { text: "Edit letters", value: "edit_letters" }
                ]);

                // Store the letters in session storage
                sessionStorage.setItem('disputeLetters', JSON.stringify(data.letters));
            } catch (error) {
                console.error('Error generating dispute letters:', error);
                hideTypingIndicator();
                addBotMessage("I encountered an error while generating your dispute letters. Please try again later.");
            }
        }

        // Function to download a letter as PDF
        function downloadLetter(index) {
            const letters = JSON.parse(sessionStorage.getItem('disputeLetters') || '[]');
            if (!letters[index]) return;

            const letter = letters[index];
            const filename = `dispute_letter_${index + 1}.txt`;

            // Create a blob and download it
            const blob = new Blob([letter.content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>

</html>