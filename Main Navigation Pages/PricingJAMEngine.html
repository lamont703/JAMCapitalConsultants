<script>
    (function () {
        'use strict';

        // Add AuthManager for JAMGetStartedModule
        class AuthManager {
            constructor() {
                this.TOKEN_KEY = 'authToken';
                this.USER_DATA_KEY = 'userData';
                this.API_BASE_URL = 'https://jam-capital-backend.azurewebsites.net/api';
                this.listeners = [];
                this._initialized = false;
            }

            getAuthToken() {
                return localStorage.getItem(this.TOKEN_KEY) || sessionStorage.getItem(this.TOKEN_KEY);
            }

            setAuthToken(token) {
                if (!token) {
                    console.error('‚ùå Cannot store empty token');
                    return;
                }
                localStorage.setItem(this.TOKEN_KEY, token);
                console.log('‚úÖ Auth token stored successfully');
                this.notifyListeners('tokenUpdated', token);
            }

            getUserData() {
                try {
                    const userData = localStorage.getItem(this.USER_DATA_KEY) ||
                        sessionStorage.getItem(this.USER_DATA_KEY);

                    if (!userData) {
                        console.warn('‚ö†Ô∏è No user data found');
                        return null;
                    }
                    return JSON.parse(userData);
                } catch (error) {
                    console.error('‚ùå Error parsing user data:', error);
                    this.clearAuth();
                    return null;
                }
            }

            setUserData(userData) {
                if (!userData) {
                    console.error('‚ùå Cannot store empty user data');
                    return;
                }
                localStorage.setItem(this.USER_DATA_KEY, JSON.stringify(userData));
                console.log('‚úÖ User data stored successfully');
                this.notifyListeners('userDataUpdated', userData);
            }

            getUserId() {
                const userData = this.getUserData();
                return userData?.id || userData?.userId || userData?._id || userData?.user_id || null;
            }

            isAuthenticated() {
                const token = this.getAuthToken();
                const userData = this.getUserData();

                // Check for various possible user ID fields
                const userId = userData?.id || userData?.userId || userData?._id || userData?.user_id;

                const isAuth = !!(token && userId);
                console.log('üîç Authentication check:', isAuth ? 'AUTHENTICATED' : 'NOT AUTHENTICATED');
                console.log('üîç Token present:', !!token);
                console.log('üîç User ID found:', userId);
                console.log('üîç User data structure:', userData);

                return isAuth;
            }

            clearAuth() {
                localStorage.removeItem(this.TOKEN_KEY);
                localStorage.removeItem(this.USER_DATA_KEY);
                localStorage.removeItem('userToken');
                localStorage.removeItem('user');
                sessionStorage.removeItem(this.TOKEN_KEY);
                sessionStorage.removeItem(this.USER_DATA_KEY);
                sessionStorage.removeItem('userToken');
                sessionStorage.removeItem('user');

                console.log('üßπ Authentication data cleared');
                this.notifyListeners('authCleared');
            }

            handleLoginSuccess(data) {
                if (data.token && data.user) {
                    this.setAuthToken(data.token);
                    this.setUserData(data.user);
                    console.log('‚úÖ Login success handled');
                    this.notifyListeners('loginSuccess', data);
                } else {
                    console.error('‚ùå Invalid login response data');
                    throw new Error('Invalid login response');
                }
            }

            addListener(callback) {
                this.listeners.push(callback);
            }

            removeListener(callback) {
                const index = this.listeners.indexOf(callback);
                if (index > -1) {
                    this.listeners.splice(index, 1);
                }
            }

            notifyListeners(event, data) {
                this.listeners.forEach(callback => {
                    try {
                        callback(event, data);
                    } catch (error) {
                        console.error('‚ùå Error in auth listener:', error);
                    }
                });
            }

            init() {
                console.log('üöÄ AuthManager initialized for JAMGetStartedModule');

                if (this.isAuthenticated()) {
                    console.log('‚úÖ User is authenticated');
                } else {
                    console.log('‚ÑπÔ∏è User is not authenticated');
                }

                this._initialized = true;
            }
        }

        // Create global instance immediately 
        window.authManager = new AuthManager();

        // Initialize immediately
        window.authManager.init();

        console.log('üîß JAM Capital Auth Manager embedded for JAMGetStartedModule');

        // Create the module
        const JAMGetStartedModule = (function () {
            let isInitialized = false;
            let currentContainer = null;
            let currentStep = 1;
            const totalSteps = 7;
            let quizData = {};

            // CSS Styles as a string
            const moduleStyles = `
    .nav-quiz-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
background-color: transparent;
        z-index: 1000;
        -webkit-overflow-scrolling: touch;
        box-sizing: border-box;
        align-items: center;
        justify-content: center;
    }

    .nav-modal-content {
        position: relative;
        top: auto;
        left: auto;
        transform: none;
        background: #fff;
        padding: 1rem;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        box-sizing: border-box;
        width: 92%;
        max-width: 800px;
        height: 92vh;
        border-radius: 8px;
        margin: auto;
box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
border: 1px solid #e0e0e0;
    }

    .nav-close-button {
        position: fixed;
        top: max(env(safe-area-inset-top), 0.75rem);
        right: 0.75rem;
        padding: 0.75rem;
        font-size: 1.5rem;
        cursor: pointer;
        color: #666;
        transition: color 0.3s ease;
        z-index: 1001;
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        outline: none;
        user-select: none;
        -webkit-user-select: none;
        -webkit-tap-highlight-color: transparent;
    }

    .nav-close-button:hover {
        color: #000;
        background-color: rgba(255, 255, 255, 1);
        transform: scale(1.1);
    }

    .nav-close-button:active {
        transform: scale(0.95);
    }

/* Mobile Responsive Styles */
@media (max-width: 575.98px) {
        .nav-quiz-button-container {
            margin: 0.5rem auto;
padding: 0 0.5rem;
max-width: 100%;
        }

        .nav-credit-quiz-btn {
padding: 1rem;
font-size: 0.9rem;
border-radius: 8px;
min-height: 44px;
touch-action: manipulation;
width: 100%;
}

.nav-credit-quiz-btn:active {
transform: scale(0.98);
        }

        .nav-modal-content {
            width: 100%;
height: 100vh;
max-height: 100vh;
            border-radius: 0;
            padding: 1rem;
margin: 0;
box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
border: 1px solid #e0e0e0;
}

.nav-close-button {
top: 0.5rem;
right: 0.5rem;
width: 36px;
height: 36px;
font-size: 1.3rem;
background-color: rgba(255, 255, 255, 0.9);
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
}
}

/* Quiz Container Styles */
    .nav-quiz-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 1rem;
        box-sizing: border-box;
        width: 100%;
        font-family: 'Poppins', sans-serif;
    }

    .nav-progress-container {
        margin: 1rem 0 2rem;
        padding: 0 1rem;
    }

    .nav-progress-bar {
        height: 8px;
        background: #f0f0f0;
        border-radius: 4px;
        overflow: hidden;
        position: relative;
    }

    .nav-progress-bar::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 0%;
        background: #008080;
        transition: width 0.3s ease;
    }

    .nav-progress-text {
        display: block;
        text-align: center;
        margin-top: 0.5rem;
        font-size: 0.875rem;
        color: #666;
    }

    .nav-question-title {
        font-size: 1.5rem;
        margin-bottom: 2rem;
        text-align: center;
        padding: 0 1rem;
    }

    .nav-options-grid {
        display: grid;
        gap: 1rem;
        padding: 0;
        margin-bottom: 2rem;
        box-sizing: border-box;
        width: 100%;
    }

    .nav-option-btn {
        background: #fff;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 1rem;
        width: 100%;
        text-align: left;
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .nav-option-btn:hover {
        border-color: #008080;
        background-color: #f7fafa;
    }

    .nav-option-btn.nav-active,
    .nav-option-btn.selected {
        border-color: #008080;
        background-color: #e6f3f3;
        position: relative;
    }

    .nav-option-btn.nav-active::after,
    .nav-option-btn.selected::after {
        content: '‚úì';
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        color: #008080;
        font-size: 1rem;
        font-weight: bold;
    }

    .nav-option-icon {
        font-size: 1.5rem;
        min-width: 2rem;
        text-align: center;
    }

    .nav-option-text {
        font-size: 1rem;
        flex: 1;
    }

    .nav-quiz-navigation {
        display: flex;
        justify-content: space-between;
        padding: 1rem;
        gap: 1rem;
        margin-top: 1rem;
    }

    .nav-nav-btn {
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 100px;
    }

    #nav-prevBtn {
        background-color: #f0f0f0;
        color: #666;
    }

    #nav-nextBtn {
        background-color: #008080;
        color: white;
    }

    #nav-nextBtn:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
    }

    /* Form Styles */
    .nav-contact-form {
        max-width: 400px;
        margin: 0 auto;
        padding: 0 1rem;
    }

    .nav-form-group {
        margin-bottom: 1.5rem;
    }

    .nav-form-input {
        width: 100%;
        padding: 1rem;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
box-sizing: border-box;
    }

    .nav-form-input:focus {
        outline: none;
        border-color: #008080;
    }

    .nav-registration-form {
        max-width: 500px;
        margin: 0 auto;
        padding: 1rem;
    }

    .nav-form-subtitle {
        text-align: center;
        color: #666;
        margin-bottom: 1.5rem;
    }

    .nav-form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #333;
    }

.nav-password-hint,
.nav-security-hint {
        display: block;
        font-size: 0.8rem;
        color: #666;
        margin-top: 0.25rem;
    }

    .nav-checkbox-group {
        display: flex;
        align-items: center;
    }

    .nav-checkbox-group input {
        margin-right: 0.5rem;
    }

    .nav-checkbox-group label {
        margin-bottom: 0;
        font-size: 0.9rem;
    }

    .nav-checkbox-group a {
        color: #008080;
        text-decoration: none;
    }

    .nav-checkbox-group a:hover {
        text-decoration: underline;
    }

/* Alert Styles */
.nav-alert {
            padding: 1rem;
            border-radius: 8px;
margin-bottom: 1rem;
            display: flex;
            align-items: center;
gap: 0.5rem;
font-size: 0.9rem;
}

.nav-alert-error {
background-color: #fee;
color: #c53030;
border: 1px solid #feb2b2;
}

.nav-alert-success {
background-color: #f0fff4;
color: #38a169;
border: 1px solid #9ae6b4;
}

.nav-alert i {
font-size: 1rem;
}

/* Additional Mobile Optimizations */
@media (max-width: 575.98px) {
        .nav-quiz-navigation {
            position: sticky;
            bottom: 0;
            background: #fff;
            padding: 1rem 0.5rem;
            margin: 0 -1rem;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 0.5rem;
        }

        .nav-nav-btn {
            flex: 1;
            min-height: 44px;
            font-size: 0.9rem;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            touch-action: manipulation;
        }

        .nav-nav-btn:active {
            transform: scale(0.98);
        }

        .nav-options-grid {
display: flex;
flex-direction: column;
gap: 0.75rem;
}

.nav-option-btn {
            padding: 1rem;
font-size: 0.9rem;
min-height: 44px;
touch-action: manipulation;
        }

        .nav-question-title {
font-size: 1.2rem;
margin-bottom: 1.5rem;
line-height: 1.3;
}

.nav-alert {
            padding: 0.75rem;
            font-size: 0.85rem;
            margin-bottom: 1rem;
border-radius: 6px;
}

.nav-form-input {
padding: 0.875rem;
font-size: 16px; /* Prevents zoom on iOS */
border-radius: 6px;
}

.nav-password-hint,
.nav-security-hint {
            font-size: 0.75rem;
margin-top: 0.25rem;
        }
    }

    /* Touch Device Optimizations */
    @media (hover: none) and (pointer: coarse) {
        .nav-credit-quiz-btn:hover {
            background-color: #09ccfc;
            transform: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

.nav-option-btn:hover {
            background-color: #ffffff;
border-color: #e0e0e0;
        }

        .nav-credit-quiz-btn,
.nav-option-btn,
.nav-nav-btn {
            -webkit-tap-highlight-color: rgba(9, 204, 252, 0.2);
        }
}
`;

            // HTML Template
            const moduleHTML = `
<div id="nav-quizModal" class="nav-quiz-modal">
    <div class="nav-modal-content">
        <span class="nav-close-button">&times;</span>
        <div id="navQuizContent" class="nav-quiz-container">
            <div class="nav-progress-container">
                <div class="nav-progress-bar" id="nav-quizProgress"></div>
                <span class="nav-progress-text">Progress: <span id="nav-progressPercentage">0%</span></span>
            </div>

            <div class="nav-quiz-steps" id="nav-quizSteps">
                <!-- Step 1 -->
                <div class="nav-quiz-step" data-step="1">
                    <h2 class="nav-question-title">Which best describes your current credit situation?</h2>
                    <div class="nav-options-grid">
                        <button class="nav-option-btn" data-value="no_credit">
                            <span class="nav-option-icon">üìä</span>
                            <span class="nav-option-text">I have no credit history</span>
                        </button>
                        <button class="nav-option-btn" data-value="below_580">
                            <span class="nav-option-icon">üìâ</span>
                            <span class="nav-option-text">My score is below 580</span>
                        </button>
                        <button class="nav-option-btn" data-value="580_669">
                            <span class="nav-option-icon">üìà</span>
                            <span class="nav-option-text">My score is between 580-669</span>
                        </button>
                        <button class="nav-option-btn" data-value="670_739">
                            <span class="nav-option-icon">üìä</span>
                            <span class="nav-option-text">My score is between 670-739</span>
                        </button>
                        <button class="nav-option-btn" data-value="above_740">
                            <span class="nav-option-icon">üåü</span>
                            <span class="nav-option-text">My score is above 740</span>
                        </button>
                    </div>
                </div>

                <!-- Step 2 -->
                <div class="nav-quiz-step" data-step="2" style="display: none;">
                    <h2 class="nav-question-title">What's your main credit goal right now?</h2>
                    <div class="nav-options-grid">
                        <button class="nav-option-btn" data-value="buy_home">
                            <span class="nav-option-icon">üè†</span>
                            <span class="nav-option-text">Buy a home</span>
                        </button>
                        <button class="nav-option-btn" data-value="new_car">
                            <span class="nav-option-icon">üöó</span>
                            <span class="nav-option-text">Get a new car</span>
                        </button>
                        <button class="nav-option-btn" data-value="credit_card">
                            <span class="nav-option-icon">üí≥</span>
                            <span class="nav-option-text">Get a credit card or loan</span>
                        </button>
                        <button class="nav-option-btn" data-value="improve_score">
                            <span class="nav-option-icon">üìà</span>
                            <span class="nav-option-text">Improve my credit score overall</span>
                        </button>
                        <button class="nav-option-btn" data-value="remove_negative">
                            <span class="nav-option-icon">üéØ</span>
                            <span class="nav-option-text">Remove negative items from my report</span>
                        </button>
                    </div>
                </div>

                <!-- Step 3 -->
                <div class="nav-quiz-step" data-step="3" style="display: none;">
                    <h2 class="nav-question-title">How many active credit cards or loans do you currently have?</h2>
                    <div class="nav-options-grid">
                        <button class="nav-option-btn" data-value="none">
                            <span class="nav-option-icon">0Ô∏è‚É£</span>
                            <span class="nav-option-text">None</span>
                        </button>
                        <button class="nav-option-btn" data-value="1-2">
                            <span class="nav-option-icon">1Ô∏è‚É£</span>
                            <span class="nav-option-text">1‚Äì2</span>
                        </button>
                        <button class="nav-option-btn" data-value="3-5">
                            <span class="nav-option-icon">3Ô∏è‚É£</span>
                            <span class="nav-option-text">3‚Äì5</span>
                        </button>
                        <button class="nav-option-btn" data-value="6+">
                            <span class="nav-option-icon">6Ô∏è‚É£</span>
                            <span class="nav-option-text">6 or more</span>
                        </button>
                        <button class="nav-option-btn" data-value="not_sure">
                            <span class="nav-option-icon">‚ùì</span>
                            <span class="nav-option-text">Not sure</span>
                        </button>
                    </div>
                </div>

                <!-- Step 4 -->
                <div class="nav-quiz-step" data-step="4" style="display: none;">
                    <h2 class="nav-question-title">Have you checked your credit report in the last 6 months?</h2>
                    <div class="nav-options-grid">
                        <button class="nav-option-btn" data-value="yes">
                            <span class="nav-option-icon">‚úÖ</span>
                            <span class="nav-option-text">Yes</span>
                        </button>
                        <button class="nav-option-btn" data-value="no">
                            <span class="nav-option-icon">‚ùå</span>
                            <span class="nav-option-text">No</span>
                        </button>
                        <button class="nav-option-btn" data-value="not_sure">
                            <span class="nav-option-icon">‚ùì</span>
                            <span class="nav-option-text">I'm not sure</span>
                        </button>
                    </div>
                </div>

                <!-- Step 5 -->
                <div class="nav-quiz-step" data-step="5" style="display: none;">
                    <h2 class="nav-question-title">Which of these credit issues applies to you?</h2>
                    <div class="nav-options-grid">
                        <button class="nav-option-btn" data-value="late_payments">
                            <span class="nav-option-icon">‚è∞</span>
                            <span class="nav-option-text">Late payments</span>
                        </button>
                        <button class="nav-option-btn" data-value="collections">
                            <span class="nav-option-icon">üìë</span>
                            <span class="nav-option-text">Collections accounts</span>
                        </button>
                        <button class="nav-option-btn" data-value="high_balances">
                            <span class="nav-option-icon">üí∞</span>
                            <span class="nav-option-text">High credit card balances</span>
                        </button>
                        <button class="nav-option-btn" data-value="bankruptcy">
                            <span class="nav-option-icon">‚öñÔ∏è</span>
                            <span class="nav-option-text">Bankruptcy</span>
                        </button>
                        <button class="nav-option-btn" data-value="no_issues">
                            <span class="nav-option-icon">‚ú®</span>
                            <span class="nav-option-text">No major issues ‚Äî just want to improve</span>
                        </button>
                        <button class="nav-option-btn" data-value="not_sure">
                            <span class="nav-option-icon">‚ùì</span>
                            <span class="nav-option-text">Not sure</span>
                        </button>
                    </div>
                </div>

                <!-- Step 6 -->
                <div class="nav-quiz-step" data-step="6" style="display: none;">
                    <h2 class="nav-question-title">Would you be interested in expert help to fix your credit faster?
                    </h2>
                    <div class="nav-options-grid">
                        <button class="nav-option-btn" data-value="very_interested">
                            <span class="nav-option-icon">üéØ</span>
                            <span class="nav-option-text">Yes, I'm very interested</span>
                        </button>
                        <button class="nav-option-btn" data-value="maybe">
                            <span class="nav-option-icon">ü§î</span>
                            <span class="nav-option-text">Maybe, tell me more</span>
                        </button>
                        <button class="nav-option-btn" data-value="not_now">
                            <span class="nav-option-icon">üìö</span>
                            <span class="nav-option-text">Not right now, just exploring</span>
                        </button>
                    </div>
                </div>

                <!-- Step 7 (Final) -->
                <div class="nav-quiz-step" data-step="7" style="display: none;">
                    <h2 class="nav-question-title">Create Your JAM Engine Account</h2>
                    <p class="nav-form-subtitle">Get access to your personalized credit guide and dashboard</p>
                    <div class="nav-registration-form">
                        <div class="nav-form-group">
                            <label for="nav-fullname">Full Name</label>
                            <input type="text" id="nav-fullname" class="nav-form-input"
                                placeholder="Enter your full name" required>
                        </div>
                        <div class="nav-form-group">
                            <label for="nav-email">Email Address</label>
                            <input type="email" id="nav-email" class="nav-form-input" placeholder="Enter your email"
                                required>
                        </div>
                        <div class="nav-form-group">
                            <label for="nav-phone">Phone Number</label>
                            <input type="tel" id="nav-phone" class="nav-form-input"
                                placeholder="Enter your phone number" required>
                        </div>
                        <div class="nav-form-group">
                            <label for="nav-password">Create Password</label>
                            <input type="password" id="nav-password" class="nav-form-input"
                                placeholder="Create a secure password" required>
                            <small class="nav-password-hint">Must be at least 6 characters long</small>
                        </div>
                        <div class="nav-form-group">
                            <label for="nav-security-question">Security Question</label>
                            <select id="nav-security-question" class="nav-form-input" required>
                                <option value="">Select a Security Question</option>
                                <option value="mother_maiden_name">What is your mother's maiden name?</option>
                                <option value="first_pet_name">What was the name of your first pet?</option>
                                <option value="childhood_street">What street did you grow up on?</option>
                                <option value="first_school">What was the name of your elementary school?</option>
                                <option value="favorite_teacher">What was your favorite teacher's last name?</option>
                                <option value="first_car">What was the make of your first car?</option>
                                <option value="birth_city">In what city were you born?</option>
                                <option value="childhood_friend">What was your childhood best friend's name?</option>
                            </select>
                        </div>
                        <div class="nav-form-group">
                            <label for="nav-security-answer">Security Answer</label>
                            <input type="text" id="nav-security-answer" class="nav-form-input"
                                placeholder="Enter your security answer" required>
                            <small class="nav-security-hint">This will help verify your identity if you forget your password</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="nav-quiz-navigation">
                <button id="nav-prevBtn" class="nav-nav-btn" style="display: none;">Previous</button>
                <button id="nav-nextBtn" class="nav-nav-btn">Next</button>
            </div>
        </div>
    </div>
</div>
`;

            // Initialize the module
            function init(containerIdOrElement, options = {}) {
                console.log('üöÄ Initializing JAM Get Started Module...');

                let container;
                if (typeof containerIdOrElement === 'string') {
                    container = document.getElementById(containerIdOrElement);
                } else if (containerIdOrElement && containerIdOrElement.nodeType === 1) {
                    container = containerIdOrElement;
                } else {
                    console.error('‚ùå Invalid container parameter');
                    return false;
                }

                if (!container) {
                    console.error('‚ùå Container not found');
                    return false;
                }

                currentContainer = container;

                // Inject styles
                injectStyles();

                // Insert HTML
                container.innerHTML = moduleHTML;

                // Initialize functionality
                setupEventListeners();
                updateProgress(1, totalSteps);
                showStep(1);

                isInitialized = true;
                console.log('‚úÖ JAM Get Started Module initialized successfully');
                return true;
            }

            // Inject CSS styles
            function injectStyles() {
                const styleId = 'jam-get-started-styles';
                if (!document.getElementById(styleId)) {
                    const style = document.createElement('style');
                    style.id = styleId;
                    style.textContent = moduleStyles;
                    document.head.appendChild(style);
                }
            }

            // Setup event listeners
            function setupEventListeners() {
                const quizButton = currentContainer.querySelector('.nav-credit-quiz-btn');
                const quizModal = currentContainer.querySelector('#nav-quizModal');
                const closeButton = currentContainer.querySelector('.nav-close-button');
                const nextBtn = currentContainer.querySelector('#nav-nextBtn');
                const prevBtn = currentContainer.querySelector('#nav-prevBtn');

                console.log('üîß Setting up event listeners...');
                console.log('Close button found:', !!closeButton);

                // Open modal
                if (quizButton) {
                    quizButton.addEventListener('click', openQuizModal);
                }

                // Close modal - Enhanced with better error handling
                if (closeButton) {
                    console.log('‚úÖ Close button event listener added');
                    closeButton.addEventListener('click', function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('üî¥ Close button clicked');
                        closeQuizModal();
                    });

                    // Also add touch events for mobile
                    closeButton.addEventListener('touchend', function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('üî¥ Close button touched');
                        closeQuizModal();
                    });
                } else {
                    console.error('‚ùå Close button not found!');
                }

                // Navigation buttons
                if (nextBtn) {
                    nextBtn.addEventListener('click', () => {
                        if (currentStep < totalSteps) { currentStep++; showStep(currentStep); } else { submitRegistration(); }
                    });
                } if
                    (prevBtn) {
                    prevBtn.addEventListener('click', () => {
                        if (currentStep > 1) {
                            currentStep--;
                            showStep(currentStep);
                        }
                    });
                }

                // Option buttons
                currentContainer.querySelectorAll('.nav-option-btn').forEach(button => {
                    button.addEventListener('click', handleOptionSelect);
                });

                // Form validation
                currentContainer.addEventListener('input', function (e) {
                    if (currentStep === 7) {
                        validateRegistrationForm();
                    }
                });

                // Close modal when clicking outside
                if (quizModal) {
                    quizModal.addEventListener('click', function (event) {
                        if (event.target === quizModal) {
                            console.log('üî¥ Clicked outside modal - closing');
                            closeQuizModal();
                        }
                    });
                }
            }

            // Open quiz modal
            function openQuizModal() {
                console.log('üöÄ openQuizModal() called');
                console.log('üîç currentContainer:', currentContainer);

                const quizModal = currentContainer.querySelector('#nav-quizModal');
                console.log('üîç quizModal found:', !!quizModal);

                if (quizModal) {
                    console.log('‚úÖ Setting modal display to flex');
                    quizModal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                    currentStep = 1;
                    showStep(1);

                    // Reset external container display properties
                    const externalContainer = document.getElementById('jam-get-started-module-container');
                    if (externalContainer) {
                        console.log('üîß Resetting external container display');
                        externalContainer.style.display = 'block';
                        externalContainer.style.opacity = '1';
                        externalContainer.style.visibility = 'visible';
                        externalContainer.classList.add('active');
                    }

                    console.log('‚úÖ Modal opened successfully');
                } else {
                    console.error('‚ùå Quiz modal not found in currentContainer');
                    console.log('üîç currentContainer HTML:', currentContainer.innerHTML);

                    // Try to find modal globally as fallback
                    const globalModal = document.querySelector('#nav-quizModal');
                    if (globalModal) {
                        console.log('üîß Found modal globally, updating currentContainer');
                        currentContainer = globalModal.parentElement;
                        globalModal.style.display = 'flex';
                        document.body.style.overflow = 'hidden';
                        currentStep = 1;
                        showStep(1);

                        // Reset external container display properties
                        const externalContainer = document.getElementById('jam-get-started-module-container');
                        if (externalContainer) {
                            console.log('üîß Resetting external container display (fallback)');
                            externalContainer.style.display = 'block';
                            externalContainer.style.opacity = '1';
                            externalContainer.style.visibility = 'visible';
                            externalContainer.classList.add('active');
                        }

                        console.log('‚úÖ Modal opened successfully (fallback)');
                    } else {
                        console.error('‚ùå Modal not found anywhere');
                    }
                }
            }

            // Close quiz modal
            function closeQuizModal() {
                console.log('üî¥ Closing quiz modal...');

                const quizModal = currentContainer.querySelector('#nav-quizModal');
                if (quizModal) {
                    quizModal.style.display = 'none';
                    quizModal.style.background = 'transparent';
                    document.body.style.overflow = 'auto';

                    // Reset any potential overlay styles
                    document.body.style.backgroundColor = '';
                    document.body.style.position = '';

                    // Ensure no other elements have overlay styles
                    const overlays = document.querySelectorAll('.nav-quiz-modal');
                    overlays.forEach(overlay => {
                        overlay.style.display = 'none';
                        overlay.style.background = 'transparent';
                        overlay.classList.remove('active');
                    });

                    // Clean up external container if it exists
                    const externalContainer = document.getElementById('jam-get-started-module-container');
                    if (externalContainer) {
                        console.log('üßπ Cleaning up external container');
                        externalContainer.classList.remove('active');
                        externalContainer.style.display = 'none';
                        externalContainer.style.opacity = '0';
                        externalContainer.style.visibility = 'hidden';
                    }

                    console.log('‚úÖ Quiz modal closed successfully');
                } else {
                    console.error('‚ùå Quiz modal not found for closing');
                }
            }

            // Show specific step
            function showStep(step) {
                const steps = currentContainer.querySelectorAll('.nav-quiz-step');
                steps.forEach(s => s.style.display = 'none');

                const currentStepEl = currentContainer.querySelector(`.nav-quiz-step[data-step="${step}"]`);
                if (currentStepEl) {
                    currentStepEl.style.display = 'block';

                    if (step !== 7) {
                        const questionId = `question_${step}`;
                        const selectedValue = quizData[questionId];

                        if (selectedValue) {
                            currentStepEl.querySelectorAll('.nav-option-btn').forEach(btn => {
                                btn.classList.remove('nav-active', 'selected');
                            });

                            const selectedOption = currentStepEl.querySelector(`.nav-option-btn[data-value="${selectedValue}"]`);
                            if (selectedOption) {
                                selectedOption.classList.add('nav-active', 'selected');
                            }
                        }
                    }
                }

                updateProgress(step, totalSteps);
                updateNavButtons(step, totalSteps);
            }

            // Update progress bar
            function updateProgress(current, total) {
                const progressBar = currentContainer.querySelector('.nav-progress-bar');
                const progressText = currentContainer.querySelector('.nav-progress-text');

                if (progressBar) {
                    const percentage = (current / total) * 100;
                    progressBar.style.setProperty('--progress-width', `${percentage}%`);
                    progressBar.style.background = `linear-gradient(to right, #008080 ${percentage}%, #f0f0f0 ${percentage}%)`;
                }

                if (progressText) {
                    progressText.textContent = `Step ${current} of ${total}`;
                }
            }

            // Update navigation buttons
            function updateNavButtons(current, total) {
                const prevBtn = currentContainer.querySelector('#nav-prevBtn');
                const nextBtn = currentContainer.querySelector('#nav-nextBtn');

                if (prevBtn) {
                    prevBtn.style.display = current === 1 ? 'none' : 'block';
                }

                if (nextBtn) {
                    nextBtn.textContent = current === total ? 'Create Account' : 'Next';

                    if (current === 7) {
                        validateRegistrationForm();
                    } else {
                        const questionId = `question_${current}`;
                        const hasSelection = quizData[questionId] !== undefined;
                        nextBtn.disabled = !hasSelection;
                    }
                }
            }

            // Handle option selection
            function handleOptionSelect(e) {
                e.preventDefault();
                const button = e.target.closest('.nav-option-btn');
                if (!button) return;

                const currentStepEl = currentContainer.querySelector(`.nav-quiz-step[data-step="${currentStep}"]`);
                const options = currentStepEl.querySelectorAll('.nav-option-btn');

                options.forEach(opt => {
                    opt.classList.remove('nav-active', 'selected');
                });

                button.classList.add('nav-active', 'selected');

                const value = button.getAttribute('data-value');
                const questionId = `question_${currentStep}`;
                quizData[questionId] = value;

                const nextBtn = currentContainer.querySelector('#nav-nextBtn');
                if (nextBtn) {
                    nextBtn.disabled = false;
                }
            }

            // Validate registration form
            function validateRegistrationForm() {
                const fullname = currentContainer.querySelector('#nav-fullname');
                const email = currentContainer.querySelector('#nav-email');
                const phone = currentContainer.querySelector('#nav-phone');
                const password = currentContainer.querySelector('#nav-password');
                const securityQuestion = currentContainer.querySelector('#nav-security-question');
                const securityAnswer = currentContainer.querySelector('#nav-security-answer');
                const nextBtn = currentContainer.querySelector('#nav-nextBtn');

                if (!fullname || !email || !phone || !password || !securityQuestion || !securityAnswer) {
                    return;
                }

                const isFullnameFilled = fullname.value.trim() !== '';
                const isEmailFilled = email.value.trim() !== '';
                const isPhoneFilled = phone.value.trim() !== '';
                const isPasswordFilled = password.value !== '';
                const isSecurityQuestionFilled = securityQuestion.value !== '';
                const isSecurityAnswerFilled = securityAnswer.value.trim() !== '';
                const isPasswordStrong = password.value.length >= 6;

                const passwordHint = currentContainer.querySelector('.nav-password-hint');
                if (passwordHint) {
                    if (isPasswordFilled && !isPasswordStrong) {
                        passwordHint.textContent = "Password must be at least 6 characters long";
                        passwordHint.style.color = "red";
                    } else {
                        passwordHint.textContent = "Must be at least 6 characters long";
                        passwordHint.style.color = "";
                    }
                }

                if (nextBtn) {
                    nextBtn.disabled = !(
                        isFullnameFilled &&
                        isEmailFilled &&
                        isPhoneFilled &&
                        isPasswordFilled &&
                        isSecurityQuestionFilled &&
                        isSecurityAnswerFilled &&
                        isPasswordStrong
                    );
                }
            }

            // Submit registration
            async function submitRegistration() {
                const fullname = currentContainer.querySelector('#nav-fullname').value.trim();
                const email = currentContainer.querySelector('#nav-email').value.trim();
                const phone = currentContainer.querySelector('#nav-phone').value.trim();
                const password = currentContainer.querySelector('#nav-password').value;
                const securityQuestion = currentContainer.querySelector('#nav-security-question').value;
                const securityAnswer = currentContainer.querySelector('#nav-security-answer').value.trim();
                const nextBtn = currentContainer.querySelector('#nav-nextBtn');

                // Basic validation
                if (!fullname || !email || !phone || !password || !securityQuestion || !securityAnswer) {
                    showError('Please fill in all fields');
                    return;
                }

                // Password validation
                if (password.length < 6) {
                    showError('Password must be at least 6 characters long');
                    return;
                }

                // Security answer validation
                if (securityAnswer.length < 2) {
                    showError('Security answer must be at least 2 characters long');
                    return;
                }

                // Show loading state
                if (nextBtn) {
                    nextBtn.innerHTML = 'Creating Account...';
                    nextBtn.disabled = true;
                }

                try {
                    const response = await fetch('https://jam-capital-backend.azurewebsites.net/api/auth/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            name: fullname,
                            email: email,
                            phone: phone,
                            password: password,
                            securityQuestion: securityQuestion,
                            securityAnswer: securityAnswer.toLowerCase() // Normalize for consistency
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        console.log('üéâ Registration successful! Response data:', data);

                        // Set registration flags for dashboard authentication check
                        sessionStorage.setItem('comingFromRegistration', 'true');
                        sessionStorage.setItem('registrationTimestamp', Date.now().toString());

                        // Check if authManager exists
                        if (window.authManager) {
                            console.log('‚úÖ AuthManager found, calling handleLoginSuccess');
                            try {
                                window.authManager.handleLoginSuccess(data);
                                console.log('‚úÖ handleLoginSuccess completed successfully');

                                // Verify authentication was set
                                const isAuth = window.authManager.isAuthenticated();
                                const token = window.authManager.getAuthToken();
                                const userData = window.authManager.getUserData();

                                console.log('üîç Post-registration auth check:');
                                console.log('  - Is authenticated:', isAuth);
                                console.log('  - Token present:', !!token);
                                console.log('  - User data:', userData);

                            } catch (error) {
                                console.error('‚ùå Error in handleLoginSuccess:', error);
                                showError('Authentication setup failed: ' + error.message);
                                resetButton();
                                return;
                            }
                        } else {
                            console.error('‚ùå AuthManager not found!');
                            showError('Authentication system not available');
                            resetButton();
                            return;
                        }

                        // Track successful registration
                        if (typeof analytics !== 'undefined') {
                            analytics.track('RegistrationSuccess', {
                                email: email,
                                source: 'JAMGetStartedModule',
                                quizData: quizData,
                                timestamp: new Date().toISOString()
                            });
                        }

                        // Show success message
                        showSuccess('Account created successfully! Redirecting to dashboard...');

                        // Ensure authentication data is properly stored before redirect
                        setTimeout(() => {
                            console.log('üîÑ About to redirect to dashboard...');
                            console.log('üîç Final auth check before redirect:');
                            console.log('  - Is authenticated:', window.authManager.isAuthenticated());
                            console.log('  - Token:', window.authManager.getAuthToken() ? 'Present' : 'Missing');
                            console.log('  - User data:', window.authManager.getUserData());

                            // Double-check authentication before redirect
                            if (window.authManager.isAuthenticated()) {
                                console.log('‚úÖ Authentication confirmed, redirecting to dashboard');
                                window.location.href = '/dashboard';
                            } else {
                                console.error('‚ùå Authentication failed after registration');
                                showError('Authentication failed. Please try logging in manually.');

                                // Fallback: redirect to login page
                                setTimeout(() => {
                                    window.location.href = '/login';
                                }, 2000);
                            }
                        }, 2000); // Increased delay to ensure data is stored

                    } else {
                        showError(data.message || 'Registration failed. Please try again.');
                        resetButton();
                    }

                } catch (error) {
                    console.error('Registration error:', error);
                    showError('Network error. Please check your connection and try again.');
                    resetButton();
                }

                function resetButton() {
                    if (nextBtn) {
                        nextBtn.innerHTML = 'Create Account';
                        nextBtn.disabled = false;
                    }
                }

                function showError(message) {
                    // Remove existing alerts
                    const existingAlert = currentContainer.querySelector('.nav-alert');
                    if (existingAlert) {
                        existingAlert.remove();
                    }

                    // Create error alert
                    const alert = document.createElement('div');
                    alert.className = 'nav-alert nav-alert-error';
                    alert.innerHTML = `
                        <i class="fas fa-exclamation-circle"></i>
                        <span>${message}</span>
                    `;

                    // Insert at top of quiz container
                    const quizContainer = currentContainer.querySelector('.nav-quiz-container');
                    if (quizContainer) {
                        quizContainer.insertBefore(alert, quizContainer.firstChild);
                    }

                    // Auto remove after 5 seconds
                    setTimeout(() => {
                        if (alert.parentNode) {
                            alert.remove();
                        }
                    }, 5000);
                }

                function showSuccess(message) {
                    // Remove existing alerts
                    const existingAlert = currentContainer.querySelector('.nav-alert');
                    if (existingAlert) {
                        existingAlert.remove();
                    }

                    // Create success alert
                    const alert = document.createElement('div');
                    alert.className = 'nav-alert nav-alert-success';
                    alert.innerHTML = `
                        <i class="fas fa-check-circle"></i>
                        <span>${message}</span>
                    `;

                    // Insert at top of quiz container
                    const quizContainer = currentContainer.querySelector('.nav-quiz-container');
                    if (quizContainer) {
                        quizContainer.insertBefore(alert, quizContainer.firstChild);
                    }
                }
            }

            // Reset module
            function reset() {
                console.log('üîÑ Resetting JAM Get Started Module...');
                currentStep = 1;
                quizData = {};
                isInitialized = false;

                // Clear the current container reference
                if (currentContainer) {
                    currentContainer.innerHTML = '';
                    currentContainer = null;
                }

                // Remove any existing modals from the DOM
                const existingModals = document.querySelectorAll('#nav-quizModal');
                existingModals.forEach(modal => {
                    modal.remove();
                });

                console.log('‚úÖ Module reset complete');
            }

            // Public API
            return {
                init: init,
                reset: reset,
                openQuiz: openQuizModal,
                closeQuiz: closeQuizModal,
                isInitialized: function () { return isInitialized; },
                getQuizData: function () { return { ...quizData }; },
                // Add a global close function for external access
                closeModal: function () {
                    console.log('üåê Global close function called');
                    closeQuizModal();
                }
            };
        })();

        // Expose globally
        window.JAMGetStartedModule = JAMGetStartedModule;

        // Add a global close function for easy access
        window.closeJAMModal = function () {
            if (window.JAMGetStartedModule) {
                window.JAMGetStartedModule.closeModal();
            } else {
                console.error('‚ùå JAMGetStartedModule not available');
            }
        };

        // Auto-initialize if container exists
        document.addEventListener('DOMContentLoaded', function () {
            const autoContainer = document.getElementById('jam-get-started-container');
            if (autoContainer) {
                JAMGetStartedModule.init('jam-get-started-container');
            }
        });

        // Signal module is loaded
        if (window.dispatchEvent) {
            window.dispatchEvent(new CustomEvent('jamGetStartedModuleLoaded'));
            console.log('JAM Get Started Module loaded and available globally');
        }

    })();

</script>